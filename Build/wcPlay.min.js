/*!
 * Web Cabin Play - Node based visual scripting tool.
 *
 * Dependancies:
 *  JQuery 1.11.1
 *  font-awesome 4.2.0
 *  wcMenu
 * Optional Dependencies:
 *  FileSaver.js
 *  wcUndoManager
 *
 * Author: Jeff Houde (lochemage@webcabin.org)
 * Web: https://play.webcabin.org/
 * API: https://play.api.webcabin.org/
 *
 * Licensed under
 *   MIT License http://www.opensource.org/licenses/mit-license
 *
 */
function wcPlay(e){this._compositeNodes=[],this._entryNodes=[],this._processNodes=[],this._storageNodes=[],this._properties=[],this._waitingChain=[],this._queuedChain=[],this._queuedProperties=[],this._importedScripts=[],this._updateId=0,this._isRunning=!1,this._isPaused=!1,this._isPausing=!1,this._isStepping=!1,this._editors=[],this._options={silent:!1,updateRate:25,updateLimit:100,debugging:!0};for(var t in e)this._options[t]=e[t];if(!this._updateId){var n=this;this._updateId=setInterval(function(){n.update()},this._options.updateRate)}wcPlay.INSTANCE_LIBRARY.push(this)}function wcNodeTimeoutEvent(e,t,n){this._node=e,this._timerId=0,this._callback=t,this._remaining=n,this._marker=0}(function(){var e=!1,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(){function u(){e?this.classInit&&this.classInit.apply(this,arguments[0]):this.init&&this.init.apply(this,arguments)}var n=arguments[0],r=arguments[arguments.length-1],i=this.prototype;e=!0;var s=new this(arguments);e=!1;for(var o in r)s[o]=typeof r[o]=="function"&&typeof i[o]=="function"&&t.test(r[o])?function(e,t){return function(){var n=this._super;this._super=i[e];var r=t.apply(this,arguments);return this._super=n,r}}(o,r[o]):r[o];u.prototype=s,u.prototype.constructor=u,u.extend=arguments.callee,window[n]=u}})(),wcPlay.PROPERTY={DYNAMIC:"dynamic",TOGGLE:"toggle",NUMBER:"number",STRING:"string",SELECT:"select",CUSTOM:"custom"},wcPlay.NODE={ENTRY:"entry",PROCESS:"process",STORAGE:"storage",COMPOSITE:"composite"},wcPlay.NODE_LIBRARY=[],wcPlay.INSTANCE_LIBRARY=[],wcPlay.registerNodeType=function(e,t,n,r){var i={className:e,displayName:t,category:n,nodeType:r};for(var s=0;s<wcPlay.NODE_LIBRARY.length;++s)if(wcPlay.NODE_LIBRARY[s].className===e){wcPlay.NODE_LIBRARY[s]=i;for(var o=0;o<wcPlay.INSTANCE_LIBRARY.length;++o){var u=wcPlay.INSTANCE_LIBRARY[o];for(var a=0;a<u._editors.length;++a){var f=u._editors[a];f.__setupPalette()}}return!0}return wcPlay.NODE_LIBRARY.push(i),!0},wcPlay.unregisterNodeType=function(e){for(var t=0;t<wcPlay.NODE_LIBRARY.length;++t)if(wcPlay.NODE_LIBRARY[t].className===e){wcPlay.NODE_LIBRARY.splice(t,1);for(var n=0;n<wcPlay.INSTANCE_LIBRARY.length;++n){var r=wcPlay.INSTANCE_LIBRARY[n];for(var i=0;i<r._editors.length;++i){var s=r._editors[i];s.__setupPalette()}}return!0}return!1},wcPlay.prototype={start:function(){this.reset(),this._isRunning=!0,this._isPaused=!1,this._isPausing=!1,this._isStepping=!1,this.notifyNodes("onStart",[])},stop:function(){this._isRunning=!1},isRunning:function(){return this._isRunning},reset:function(){for(var e=0;e<this._compositeNodes.length;++e)this._compositeNodes[e].reset();for(var e=0;e<this._entryNodes.length;++e)this._entryNodes[e].reset();for(var e=0;e<this._processNodes.length;++e)this._processNodes[e].reset();for(var e=0;e<this._storageNodes.length;++e)this._storageNodes[e].reset();this._queuedChain=[],this._queuedProperties=[];for(var e=0;e<this._properties.length;++e)this.property(this._properties[e].name,this._properties[e].initialValue,!0)},clear:function(){this._queuedChain=[],this._queuedProperties=[],this._waitingChain=[],this._properties=[];while(this._compositeNodes.length)this._compositeNodes[0].destroy();while(this._entryNodes.length)this._entryNodes[0].destroy();while(this._processNodes.length)this._processNodes[0].destroy();while(this._storageNodes.length)this._storageNodes[0].destroy()},save:function(){var e={version:"1.0.0"};e.properties=this.listProperties(),e.nodes=[];for(var t=0;t<this._compositeNodes.length;++t)e.nodes.push(this._compositeNodes[t].export(!0));for(var t=0;t<this._entryNodes.length;++t)e.nodes.push(this._entryNodes[t].export(!0));for(var t=0;t<this._processNodes.length;++t)e.nodes.push(this._processNodes[t].export(!0));for(var t=0;t<this._storageNodes.length;++t)e.nodes.push(this._storageNodes[t].export(!0));return JSON.stringify(e,function(e,t){return t==Infinity?"Infinity":t})},load:function(e){var t=this.save();try{var n=JSON.parse(e,function(e,t){return t==="Infinity"?Infinity:t});this.clear();for(var r=0;r<n.properties.length;++r)this.createProperty(n.properties[r].name,n.properties[r].type,n.properties[r].initialValue,n.properties[r].options);var i=[];for(var r=0;r<n.nodes.length;++r)if(window[n.nodes[r].className]){var s=new window[n.nodes[r].className](this,n.nodes[r].pos,n.nodes[r].name);s.id=n.nodes[r].id,i.push({node:s,data:n.nodes[r]})}else console.log('ERROR: Attempted to load node "'+n.nodes[r].className+'", but the constructor could not be found!');for(var r=0;r<i.length;++r)i[r].node.import(i[r].data);return this.reset(),!0}catch(o){this.load(t)}return!1},"import":function(e,t){var n=null;try{var r=JSON.parse(e,function(e,t){return t==="Infinity"?Infinity:t});return r.pos={x:0,y:0},n=new wcNodeCompositeScript(this,r.pos),n.nodeType=wcPlay.NODE.COMPOSITE,n.category="Imported",r.id=n.id,r.name=t,r.color=n.color,r.collapsed=!1,r.breakpoint=!1,r.properties=[],r.entryChains=[],r.exitChains=[],r.inputChains=[],r.outputChains=[],n.import(r,[]),n._parent=null,this.__removeNode(n),this._importedScripts.push(n),!0}catch(i){n&&n.destroy()}return!1},importedComposites:function(){return this._importedScripts},update:function(){if(this._isPaused)return;var e=Math.min(this._queuedProperties.length,this._options.updateLimit);if(this._isRunning&&!e&&this._waitingChain.length){for(var t=0;t<this._waitingChain.length;++t){var n=this._waitingChain[t];this.queueNodeEntry(n.node,n.name,n.fromNode,n.fromName,!0)}this._waitingChain=[];return}var r=e;while(r){r--;var n=this._queuedProperties.shift();n.node._meta.flash=!0,n.node._meta.broken>0&&n.node._meta.broken--,n.node.property(n.name,n.value,n.upstream?!1:undefined,n.upstream)}if(this._isRunning&&!e){e=Math.min(this._queuedChain.length,this._options.updateLimit-e),r=e;while(r){r--;var n=this._queuedChain.shift();n.node._meta.flash=!0,n.node._meta.broken>0&&n.node._meta.broken--,n.node.onActivated(n.name)}}this._isStepping&&(this._isPausing=!0)},nodeById:function(e){for(var t=0;t<this._compositeNodes.length;++t)if(this._compositeNodes[t].id===e)return this._compositeNodes[t];for(var t=0;t<this._entryNodes.length;++t)if(this._entryNodes[t].id===e)return this._entryNodes[t];for(var t=0;t<this._processNodes.length;++t)if(this._processNodes[t].id===e)return this._processNodes[t];for(var t=0;t<this._storageNodes.length;++t)if(this._storageNodes[t].id===e)return this._storageNodes[t];for(var t=0;t<this._compositeNodes.length;++t)if(this._compositeNodes[t]instanceof wcNodeCompositeScript){var n=this._compositeNodes[t].nodeById(e);if(n)return n}return null},nodesByClassName:function(e){var t=[];for(var n=0;n<this._compositeNodes.length;++n)this._compositeNodes[n].className===e&&t.push(this._compositeNodes[n]);for(var n=0;n<this._entryNodes.length;++n)this._entryNodes[n].className===e&&t.push(this._entryNodes[n]);for(var n=0;n<this._processNodes.length;++n)this._processNodes[n].className===e&&t.push(this._processNodes[n]);for(var n=0;n<this._storageNodes.length;++n)this._storageNodes[n].className===e&&t.push(this._storageNodes[n]);for(var n=0;n<this._compositeNodes.length;++n)if(this._compositeNodes[n]instanceof wcNodeCompositeScript){var r=this._compositeNodes[n].nodesByClassName(e);r.length&&t.concat(r)}return t},nodesBySearch:function(e){var t=[];for(var n=0;n<this._compositeNodes.length;++n)this._compositeNodes[n].search(e)&&t.push(this._compositeNodes[n]);for(var n=0;n<this._entryNodes.length;++n)this._entryNodes[n].search(e)&&t.push(this._entryNodes[n]);for(var n=0;n<this._processNodes.length;++n)this._processNodes[n].search(e)&&t.push(this._processNodes[n]);for(var n=0;n<this._storageNodes.length;++n)this._storageNodes[n].search(e)&&t.push(this._storageNodes[n]);for(var n=0;n<this._compositeNodes.length;++n)if(this._compositeNodes[n]instanceof wcNodeCompositeScript){var r=this._compositeNodes[n].nodesBySearch(e);r.length&&(t=t.concat(r))}return t},silent:function(e){return e!==undefined&&(this._options.silent=e?!0:!1),this._options.silent},debugging:function(e){return e!==undefined&&(this._options.debugging=e?!0:!1),this._options.debugging},paused:function(e){if(e!==undefined){e=e?!0:!1;if(this._isPaused!==e){for(var t=0;t<this._compositeNodes.length;++t)this._compositeNodes[t].paused(e);for(var t=0;t<this._entryNodes.length;++t)this._entryNodes[t].paused(e);for(var t=0;t<this._processNodes.length;++t)this._processNodes[t].paused(e);for(var t=0;t<this._storageNodes.length;++t)this._storageNodes[t].paused(e);this._isPaused=e,this._isPausing=!1}}return this._isPaused},stepping:function(e){return e!==undefined&&(this._isStepping=e?!0:!1),this._isStepping},createProperty:function(e,t,n,r){for(var i=0;i<this._properties.length;++i)if(this._properties[i].name===e)return!1;return n===undefined&&(n=0),this._properties.push({name:e,value:n,initialValue:n,type:t,options:r||{}}),!0},renameProperty:function(e,t){var n=null;for(var r=0;r<this._properties.length;++r){if(this._properties[r].name===t)return!1;this._properties[r].name===e&&(n=this._properties[r])}if(!n)return!1;n.name=t,this.notifyNodes("onGlobalPropertyRenamed",[e,t])},removeProperty:function(e){for(var t=0;t<this._properties.length;++t)if(this._properties[t].name===e)return this.notifyNodes("onGlobalPropertyRemoved",[e]),this._properties.splice(t,1),!0;return!1},property:function(e,t){var n=null;for(var r=0;r<this._properties.length;++r)if(this._properties[r].name===e){n=this._properties[r];break}if(!n)return;if(t!==undefined&&t!==n.value){var i=n.value;n.value=t,this.notifyNodes("onGlobalPropertyChanged",[n.name,i,n.value])}return n.value},initialProperty:function(e,t){var n=null;for(var r=0;r<this._properties.length;++r)if(this._properties[r].name===e){n=this._properties[r];break}if(!n)return;if(t!==undefined&&t!==n.initialValue){var i=n.initialValue;n.initialValue=t,this.notifyNodes("onGlobalInitialPropertyChanged",[n.name,i,n.initialValue]),n.value==i&&(n.value=t,this.notifyNodes("onGlobalPropertyChanged",[n.name,i,n.value]))}return n.initialValue},listProperties:function(){var e=[];for(var t=0;t<this._properties.length;++t){var n=this._properties[t];e.push({name:n.name,value:n.value,initialValue:n.initialValue,type:n.type,options:n.options})}return e},triggerEvent:function(e,t,n){for(var r=0;r<this._entryNodes.length;++r)this._entryNodes[r].type===e&&this._entryNodes[r].name===t&&this._entryNodes[r].onActivated(n)},notifyNodes:function(e,t){var n;for(var r=0;r<this._compositeNodes.length;++r)n=this._compositeNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._entryNodes.length;++r)n=this._entryNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._processNodes.length;++r)n=this._processNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._storageNodes.length;++r)n=this._storageNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._compositeNodes.length;++r)this._compositeNodes[r]instanceof wcNodeCompositeScript&&this._compositeNodes[r].notifyNodes(e,t)},notifyEditors:function(e,t){var n;for(var r=0;r<this._editors.length;++r)n=this._editors[r],typeof n[e]=="function"&&n[e].apply(n,t)},queueNodeEntry:function(e,t,n,r,i){if(!this._isRunning)return;if(!i&&this._isStepping&&this._isPaused){e.enabled()&&this._waitingChain.push({node:e,name:t,fromNode:n,fromName:r});return}if(e.enabled()){this._queuedChain.push({node:e,name:t});if(e.debugBreak()||this._isStepping)e._meta.flash=!0,e._meta.broken++,this._isPausing=!0;for(var s=0;s<e.chain.entry.length;++s)if(e.chain.entry[s].name==t){e.chain.entry[s].meta.flash=!0,(e.debugBreak()||this._isStepping)&&e.chain.entry[s].meta.broken++;break}if(n&&r)for(var s=0;s<n.chain.exit.length;++s){var o=n.chain.exit[s];if(o.name==r){n.chain.exit[s].meta.flash=!0,n._meta.flash=!0,(e.debugBreak()||this._isStepping)&&n.chain.exit[s].meta.broken++;break}}this._isPausing&&(this.paused(!0),this._isPausing=!1)}},queueNodeProperty:function(e,t,n,r){if(!this._isRunning)return;if(e.enabled()||t==="enabled"){this._queuedProperties.push({node:e,name:t,value:n,upstream:r});if(e.debugBreak()||this._isStepping)e._meta.flash=!0,e._meta.broken++,this._isPausing=!0;this._isPausing&&(this.paused(!0),this._isPausing=!1)}},destroy:function(){this.clear(),this._importedScripts=[];while(this._editors.length)this._editors[0].engine(null);this._updateId&&clearInterval(this._updateId);var e=wcPlay.INSTANCE_LIBRARY.indexOf(this);e>-1&&wcPlay.INSTANCE_LIBRARY.splice(e,1)},__addNode:function(e){e instanceof wcNodeComposite?this._compositeNodes.push(e):e instanceof wcNodeEntry?this._entryNodes.push(e):e instanceof wcNodeProcess?this._processNodes.push(e):e instanceof wcNodeStorage&&this._storageNodes.push(e)},__removeNode:function(e){var t=-1;e instanceof wcNodeComposite?(t=this._compositeNodes.indexOf(e),t>-1&&this._compositeNodes.splice(t,1)):e instanceof wcNodeEntry?(t=this._entryNodes.indexOf(e),t>-1&&this._entryNodes.splice(t,1)):e instanceof wcNodeProcess?(t=this._processNodes.indexOf(e),t>-1&&this._processNodes.splice(t,1)):e instanceof wcNodeStorage&&(t=this._storageNodes.indexOf(e),t>-1&&this._storageNodes.splice(t,1));if(t===-1)for(var n=0;n<this._compositeNodes.length;++n)if(this._compositeNodes[n]instanceof wcNodeCompositeScript&&this._compositeNodes[n].__removeNode(e))return!0;return!1}},wcNodeTimeoutEvent.prototype={pause:function(){window.clearTimeout(this._timerId),this._remaining-=(new Date).getTime()-this._marker},resume:function(){this._marker=(new Date).getTime(),window.clearTimeout(this._timerId);var e=this;this._timerId=window.setTimeout(function(){e._node.finishThread(e),e._callback&&e._callback.call(e._node),e.__clear()},this._remaining)},__clear:function(){this._node=null,this._callback=null,window.clearTimeout(this._timerId)}};var wcNodeNextID=0;Class.extend("wcNode","Node","",{init:function(e,t){this.id=++wcNodeNextID,this.color="#FFFFFF",this.name||(this.name=""),this._viewportSize=null,this.pos={x:t&&t.x||0,y:t&&t.y||0},this.chain={entry:[],exit:[]},this.properties=[],this._meta={flash:!1,flashDelta:0,color:null,broken:0,awake:!1,dirty:!0,threads:[],description:"",details:""},this._break=!1,this._log=!1,this._parent=e,this.createProperty(wcNode.PROPERTY_ENABLED,wcPlay.PROPERTY.TOGGLE,!0,{description:"Disabled nodes will be treated as if they were not there, all connections will be ignored.",input:!0,output:!0}),this._parent&&this._parent.__addNode(this)},destroy:function(){this.onDestroying();for(var e=0;e<this.chain.entry.length;++e){var t=this.chain.entry[e];this.disconnectEntry(t.name)}for(var e=0;e<this.chain.exit.length;++e){var t=this.chain.exit[e];this.disconnectExit(t.name)}for(var e=0;e<this.properties.length;++e){var t=this.properties[e];this.disconnectInput(t.name),this.disconnectOutput(t.name)}this.reset(),this._parent&&this._parent.__removeNode(this),this.onDestroyed()},reset:function(){this.onReset(),this.resetThreads(),this._meta.awake=!1,this._meta.dirty=!0,this._meta.broken=0,this._meta.paused=!1;for(var e=0;e<this.properties.length;++e)this.properties[e].value=this.properties[e].initialValue},resetThreads:function(){for(var e=0;e<this._meta.threads.length;++e)typeof this._meta.threads[e]=="number"?(clearTimeout(this._meta.threads[e]),clearInterval(this._meta.threads[e])):this._meta.threads[e]instanceof wcNodeTimeoutEvent?this._meta.threads[e].__clear():this._meta.threads[e]instanceof jqXHR?this._meta.threads[e].abort():typeof this._meta.threads[e]=="function"&&this._meta.threads[e]();this._meta.threads=[]},"import":function(e,t){this.onImporting(e,t),this.id=t&&t[e.id]||e.id,this.name=e.name,this.color=e.color,this.pos.x=e.pos.x,this.pos.y=e.pos.y,this.debugBreak(e.breakpoint),this.id>wcNodeNextID&&(wcNodeNextID=this.id);for(var n=0;n<e.properties.length;++n)this.initialProperty(e.properties[n].name,e.properties[n].initialValue),this.property(e.properties[n].name,e.properties[n].value);var r=this.engine();if(!r)return;for(var n=0;n<e.entryChains.length;++n){var i=e.entryChains[n],s=r.nodeById(t&&t[i.outNodeId]||i.outNodeId);s&&this._parent===s._parent&&this.connectEntry(i.inName,s,i.outName)}for(var n=0;n<e.exitChains.length;++n){var i=e.exitChains[n],s=r.nodeById(t&&t[i.inNodeId]||i.inNodeId);s&&this._parent===s._parent&&this.connectExit(i.outName,s,i.inName)}for(var n=0;n<e.inputChains.length;++n){var i=e.inputChains[n],s=r.nodeById(t&&t[i.outNodeId]||i.outNodeId);s&&this._parent===s._parent&&this.connectInput(i.inName,s,i.outName)}for(var n=0;n<e.outputChains.length;++n){var i=e.outputChains[n],s=r.nodeById(t&&t[i.inNodeId]||i.inNodeId);s&&this._parent===s._parent&&this.connectOutput(i.outName,s,i.inName)}this._meta.dirty=!0,this.onImported(e,t)},"export":function(e){var t={className:this.className,id:this.id,name:this.name,color:this.color,pos:{x:this.pos.x,y:this.pos.y},breakpoint:this._break,properties:this.listProperties(e),exitChains:this.listExitChains(),outputChains:this.listOutputChains()};return e?(t.entryChains=[],t.inputChains=[]):(t.entryChains=this.listEntryChains(),t.inputChains=this.listInputChains()),this.onExport(t,e),t},engine:function(){var e=this._parent;while(e&&!(e instanceof wcPlay))e=e._parent;return e||null},enabled:function(e){return e!==undefined&&(this.property(wcNode.PROPERTY_ENABLED,e?!0:!1),this._meta.dirty=!0),this.property(wcNode.PROPERTY_ENABLED)},paused:function(e){if(e!==undefined)if(e){for(var t=0;t<this._meta.threads.length;++t)this._meta.threads[t]instanceof wcNodeTimeoutEvent&&this._meta.threads[t].pause();this._meta.paused=!0}else{for(var t=0;t<this._meta.threads.length;++t)this._meta.threads[t]instanceof wcNodeTimeoutEvent&&this._meta.threads[t].resume();this._meta.paused=!1}return this._meta.paused},isBroken:function(){return this._meta.broken>0},debugLog:function(e){e!==undefined&&(this._log=e?!0:!1);var t=this.engine();return!t||t.silent()?!1:this._log},debugBreak:function(e){e!==undefined&&(this._break=e?!0:!1);var t=this.engine();return t&&t.debugging()&&this._break},description:function(e){return e!==undefined&&(this._meta.description=e),this._meta.description},details:function(e){return e!==undefined&&(this._meta.details=e),this._meta.details},search:function(e){return this.type.toLowerCase().indexOf(e)>-1||this.name.toLowerCase().indexOf(e)>-1?!0:!1},setTimeout:function(e,t){var n=new wcNodeTimeoutEvent(this,e,t);this.beginThread(n),this._meta.paused||n.resume()},setInterval:function(e,t){function n(){e&&e.call(this),this.setTimeout(n,t)}this.setTimeout(n,t)},ajax:function(e,t){function s(e,t){return function(){t&&setTimeout(function(){r.finishThread(o)},0),n||e&&e.apply(i,arguments)}}typeof e=="object"&&(t=e),t||(t={}),typeof e=="string"&&(t.url=e);var n=!1,r=this,i=t.context||this;t.success=s(t.success),t.error=s(t.error),t.complete=s(t.complete,!0);var o=$.ajax(t);o===undefined&&(o=function(){n=!0}),this.beginThread(o)},beginThread:function(e){return this._meta.threads.push(e),this._meta.flash=!0,this._meta.awake=!0,e},finishThread:function(e){var t=this._meta.threads.indexOf(e);t>-1&&(this._meta.threads.splice(t,1),this._meta.threads.length||(this._meta.awake=!1))},pos:function(e){return e!==undefined&&(this.pos.x=e.x,this.pos.y=e.y,this._meta.dirty=!0),{x:this.pos.x,y:this.pos.y}},createEntry:function(e,t){for(var n=0;n<this.chain.entry.length;++n)if(this.chain.entry[n].name===e)return!1;return this.chain.entry.push({name:e,active:!1,links:[],meta:{flash:!1,flashDelta:0,broken:0,color:"#000000",description:t}}),this._meta.dirty=!0,!0},createExit:function(e,t){for(var n=0;n<this.chain.exit.length;++n)if(this.chain.exit[n].name===e)return!1;return this.chain.exit.push({name:e,links:[],meta:{flash:!1,flashDelta:0,broken:0,color:"#000000",description:t}}),this._meta.dirty=!0,!0},createProperty:function(e,t,n,r){for(var i=0;i<this.properties.length;++i)if(this.properties[i].name===e)return!1;return n===undefined&&(n=0),this.properties.push({name:e,value:n,initialValue:n,type:t,inputs:[],outputs:[],options:r||{},inputMeta:{flash:!1,flashDelta:0,broken:0,color:"#000000"},outputMeta:{flash:!1,flashDelta:0,broken:0,color:"#000000"}}),this._meta.dirty=!0,!0},removeEntry:function(e){for(var t=0;t<this.chain.entry.length;++t)if(this.chain.entry[t].name===e&&this.disconnectEntry(e)===wcNode.CONNECT_RESULT.SUCCESS)return this.chain.entry.splice(t,1),this._meta.dirty=!0,!0;return!1},removeExit:function(e){for(var t=0;t<this.chain.exit.length;++t)if(this.chain.exit[t].name===e&&this.disconnectExit(e)===wcNode.CONNECT_RESULT.SUCCESS)return this.chain.exit.splice(t,1),this._meta.dirty=!0,!0;return!1},removeProperty:function(e){for(var t=0;t<this.properties.length;++t)if(this.properties[t].name===e&&this.disconnectInput(e)===wcNode.CONNECT_RESULT.SUCCESS&&this.disconnectOutput(e)===wcNode.CONNECT_RESULT.SUCCESS)return this.properties.splice(t,1),this._meta.dirty=!0,!0;return!1},renameEntry:function(e,t){if(!this.createEntry(t))return!1;if(this.createEntry(e))return this.removeEntry(e),this.removeEntry(t),!1;var n=this.listEntryChains(e);this.removeEntry(e);var r=this.engine();if(r)for(var i=0;i<n.length;++i)this.connectEntry(t,r.nodeById(n[i].outNodeId),n[i].outName);return this._meta.dirty=!0,!0},renameExit:function(e,t){if(!this.createExit(t))return!1;if(this.createExit(e))return this.removeExit(e),this.removeExit(t),!1;var n=this.listExitChains(e);this.removeExit(e);var r=this.engine();if(r)for(var i=0;i<n.length;++i)this.connectExit(t,r.nodeById(n[i].inNodeId),n[i].inName);return this._meta.dirty=!0,!0},renameProperty:function(e,t){var n;for(var r=0;r<this.properties.length;++r){this.properties[r].name===e&&(n=this.properties[r]);if(this.properties[r].name===t)return!1}if(!n)return!1;this.createProperty(t,n.type,n.initialValue,n.options),this.property(t,n.value,!1);var i=this.listInputChains(e),s=this.listOutputChains(e);this.removeProperty(e);var o=this.engine();if(o){for(var r=0;r<i.length;++r)this.connectInput(t,o.nodeById(i[r].outNodeId),i[r].outName);for(var r=0;r<s.length;++r)this.connectOutput(t,o.nodeById(s[r].inNodeId),s[r].inName)}return this._meta.dirty=!0,!0},connectEntry:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.chain.entry.length;++s)if(this.chain.entry[s].name===e){r=this.chain.entry[s];break}for(var s=0;s<t.chain.exit.length;++s)if(t.chain.exit[s].name===n){i=t.chain.exit[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.links.length;++s)if(r.links[s].node===t&&r.links[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.links.length;++s)if(i.links[s].node===this&&i.links[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.links.push({name:i.name,node:t}),i.links.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.ENTRY,t,i.name,wcNode.LINK_TYPE.EXIT),t.onConnect(!0,i.name,wcNode.LINK_TYPE.EXIT,this,r.name,wcNode.LINK_TYPE.ENTRY),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},connectExit:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.chain.exit.length;++s)if(this.chain.exit[s].name===e){r=this.chain.exit[s];break}for(var s=0;s<t.chain.entry.length;++s)if(t.chain.entry[s].name===n){i=t.chain.entry[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.links.length;++s)if(r.links[s].node===t&&r.links[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.links.length;++s)if(i.links[s].node===this&&i.links[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.links.push({name:i.name,node:t}),i.links.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.EXIT,t,i.name,wcNode.LINK_TYPE.ENTRY),t.onConnect(!0,i.name,wcNode.LINK_TYPE.ENTRY,this,r.name,wcNode.LINK_TYPE.EXIT),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},connectInput:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.properties.length;++s)if(this.properties[s].name===e){r=this.properties[s];break}for(var s=0;s<t.properties.length;++s)if(t.properties[s].name===n){i=t.properties[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.inputs.length;++s)if(r.inputs[s].node===t&&r.inputs[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.outputs.length;++s)if(i.outputs[s].node===this&&i.outputs[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.inputs.push({name:i.name,node:t}),i.outputs.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.INPUT,t,i.name,wcNode.LINK_TYPE.OUTPUT),t.onConnect(!0,i.name,wcNode.LINK_TYPE.OUTPUT,this,r.name,wcNode.LINK_TYPE.INPUT),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},connectOutput:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.properties.length;++s)if(this.properties[s].name===e){r=this.properties[s];break}for(var s=0;s<t.properties.length;++s)if(t.properties[s].name===n){i=t.properties[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.outputs.length;++s)if(r.outputs[s].node===t&&r.outputs[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.inputs.length;++s)if(i.inputs[s].node===this&&i.inputs[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.outputs.push({name:i.name,node:t}),i.inputs.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.OUTPUT,t,i.name,wcNode.LINK_TYPE.INPUT),t.onConnect(!0,i.name,wcNode.LINK_TYPE.INPUT,this,r.name,wcNode.LINK_TYPE.OUTPUT),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},disconnectEntry:function(e,t,n){var r=null;for(var i=0;i<this.chain.entry.length;++i)if(this.chain.entry[i].name===e){r=this.chain.entry[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.links.length;++i){var s=r.links[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.links.splice(i,1),i--,s.node.disconnectExit(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},disconnectExit:function(e,t,n){var r=null;for(var i=0;i<this.chain.exit.length;++i)if(this.chain.exit[i].name===e){r=this.chain.exit[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.links.length;++i){var s=r.links[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.links.splice(i,1),i--,s.node.disconnectEntry(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},disconnectInput:function(e,t,n){var r=null;for(var i=0;i<this.properties.length;++i)if(this.properties[i].name===e){r=this.properties[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.inputs.length;++i){var s=r.inputs[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.inputs.splice(i,1),i--,s.node.disconnectOutput(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},disconnectOutput:function(e,t,n){var r=null;for(var i=0;i<this.properties.length;++i)if(this.properties[i].name===e){r=this.properties[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.outputs.length;++i){var s=r.outputs[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.outputs.splice(i,1),i--,s.node.disconnectInput(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},activateEntry:function(e,t,n){for(var r=0;r<this.chain.entry.length;++r)if(this.chain.entry[r].name===e){var i=this.engine();return i&&i.queueNodeEntry(this,this.chain.entry[r].name,t,n,!1),!0}return!1},activateExit:function(e){if(!this.enabled())return!1;this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" ("+this.name+")":"")+'" Triggered Exit link "'+e+'"');for(var t=0;t<this.chain.exit.length;++t){var n=this.chain.exit[t];if(n.name===e){var r=!1,i=this.engine();for(var s=0;s<n.links.length;++s)n.links[s].node&&(r=!0,n.links[s].node.activateEntry(n.links[s].name,this,e));return r||(this.chain.exit[t].meta.flash=!0,this._meta.flash=!0),!0}}return!1},propertyOptions:function(e){for(var t=0;t<this.properties.length;++t){var n=this.properties[t];if(n.name===e)return this._meta.dirty=!0,n.options}return null},property:function(e,t,n,r){for(var i=0;i<this.properties.length;++i){var s=this.properties[i];if(s.name===e){if(t!==undefined){var o=s.value;switch(s.type){case wcPlay.PROPERTY.TOGGLE:t=t?!0:!1;break;case wcPlay.PROPERTY.NUMBER:var u=s.options.min!==undefined?s.options.min:-Infinity,f=s.options.max!==undefined?s.options.max:Infinity,l=Math.min(f,Math.max(u,parseInt(t)));isNaN(l)&&(t=Math.min(f,Math.max(u,0)));break;case wcPlay.PROPERTY.STRING:var c=s.options.maxlength;c&&(t=t.toString().substring(0,c));break;case wcPlay.PROPERTY.SELECT:var h=s.options.items;typeof h=="function"&&(h=h.call(this));var p=!1;if($.isArray(h))for(var i=0;i<h.length;++i)if(typeof h[i]=="object"){if(h[i].value==t){p=!0;break}}else if(h[i]==t){p=!0;break}p||(t="")}var d=this.engine();s.outputMeta.flash=!0,(this.debugBreak()||d&&d.stepping())&&s.outputMeta.broken++;if(n||s.value!==t)t=this.onPropertyChanging(s.name,o,t)||t;if(n||s.value!==t){this._meta.dirty=!0,s.value=t,this.onPropertyChanged(s.name,o,t);if(n===undefined||n)for(a=0;a<s.outputs.length;++a)s.outputs[a].node&&s.outputs[a].node.activateProperty(s.outputs[a].name,t);if(r)for(a=0;a<s.inputs.length;++a)s.inputs[a].node&&s.inputs[a].node.activateProperty(s.inputs[a].name,t,!0)}}return this.onPropertyGet(s.name)||s.value}}},initialProperty:function(e,t,n,r){for(var i=0;i<this.properties.length;++i){var s=this.properties[i];if(s.name===e){if(t!==undefined){t=this.onInitialPropertyChanging(s.name,s.initialValue,t)||t,s.value==s.initialValue&&this.property(e,t);var o=s.initialValue;if(n||s.initialValue!==t){this._meta.dirty=!0,s.initialValue=t,this.onInitialPropertyChanged(s.name,o,t),s.outputMeta.flash=!0;var u=this.engine();(this.debugBreak()||u&&u.stepping())&&s.outputMeta.broken++;if(n===undefined||n)for(a=0;a<s.outputs.length;++a)s.outputs[a].node&&s.outputs[a].node.initialProperty(s.outputs[a].name,t);if(r)for(a=0;a<s.inputs.length;++a)s.inputs[a].node&&s.inputs[a].node.initialProperty(s.inputs[a].name,t,undefined,!0)}}return this.onInitialPropertyGet(s.name)||s.initialValue}}},activateProperty:function(e,t,n){var r=this.engine();r&&r.queueNodeProperty(this,e,t,n);for(var i=0;i<this.properties.length;++i){var s=this.properties[i];s.name===e&&(s.inputMeta.flash=!0,(this.debugBreak()||r&&r.stepping())&&s.inputMeta.broken++)}},listEntryChains:function(e,t){var n=[];for(var r=0;r<this.chain.entry.length;++r)if(!e||this.chain.entry[r].name===e){var i=this.chain.entry[r];for(var s=0;s<i.links.length;++s)(!t||t.indexOf(i.links[s].node)===-1)&&n.push({inName:i.name,inNodeId:this.id,outName:i.links[s].name,outNodeId:i.links[s].node.id})}return n},listExitChains:function(e,t){var n=[];for(var r=0;r<this.chain.exit.length;++r)if(!e||this.chain.exit[r].name===e){var i=this.chain.exit[r];for(var s=0;s<i.links.length;++s)(!t||t.indexOf(i.links[s].node)===-1)&&n.push({inName:i.links[s].name,inNodeId:i.links[s].node.id,outName:i.name,outNodeId:this.id})}return n},listInputChains:function(e,t){var n=[];for(var r=0;r<this.properties.length;++r)if(!e||this.properties[r].name===e){var i=this.properties[r];for(var s=0;s<i.inputs.length;++s)(!t||t.indexOf(i.inputs[s].node)===-1)&&n.push({inName:i.name,inNodeId:this.id,outName:i.inputs[s].name,outNodeId:i.inputs[s].node.id})}return n},listOutputChains:function(e,t){var n=[];for(var r=0;r<this.properties.length;++r)if(!e||this.properties[r].name===e){var i=this.properties[r];for(var s=0;s<i.outputs.length;++s)(!t||t.indexOf(i.outputs[s].node)===-1)&&n.push({inName:i.outputs[s].name,inNodeId:i.outputs[s].node.id,outName:i.name,outNodeId:this.id})}return n},listProperties:function(e){var t=[];for(var n=0;n<this.properties.length;++n){var r=this.properties[n],i={name:r.name,initialValue:r.initialValue};e||(i.value=r.value),t.push(i)}return t},viewportSize:function(e,t){return e!==undefined&&t!==undefined&&(this._meta.dirty=!0,!e||!t?this._viewportSize=null:this._viewportSize={x:e,y:t}),{x:this._viewportSize.x,y:this._viewportSize.y}},onViewportDraw:function(e,t){},onViewportMouseEnter:function(e,t,n){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" ("+this.name+")":"")+'" mouse entered custom viewport!')},onViewportMouseLeave:function(e,t){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" ("+this.name+")":"")+'" mouse left custom viewport!')},onViewportMouseDown:function(e,t,n){},onViewportMouseUp:function(e,t,n){},onViewportMouseMove:function(e,t,n){},onViewportMouseWheel:function(e,t,n,r){},onViewportMouseClick:function(e,t,n){},onViewportMouseDoubleClick:function(e,t,n){},onConnect:function(e,t,n,r,i,s){e&&n===wcNode.LINK_TYPE.OUTPUT&&(r.activateProperty(i,this.property(t)),r.initialProperty(i,this.initialProperty(t)))},onStart:function(){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" ("+this.name+")":"")+'" started!')},onDraw:function(){},onActivated:function(e){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" ("+this.name+")":"")+'" Triggered Entry link "'+e+'"')},onMoving:function(e,t){},onMoved:function(e,t){},onNameChanging:function(e,t){},onNameChanged:function(e,t){this._meta.dirty=!0},onPropertyChanging:function(e,t,n){},onPropertyChanged:function(e,t,n){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" ("+this.name+")":"")+'" Changed Property "'+e+'" from "'+t+'" to "'+n+'"')},onPropertyGet:function(e){},onInitialPropertyChanging:function(e,t,n){},onInitialPropertyChanged:function(e,t,n){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" ("+this.name+")":"")+'" Changed Property "'+e+'" from "'+t+'" to "'+n+'"')},onInitialPropertyGet:function(e){},onImporting:function(e,t){},onImported:function(e,t){},onExport:function(e,t){},onReset:function(){},onDestroying:function(){},onDestroyed:function(){}}),wcNode.LINK_TYPE={ENTRY:"entry",EXIT:"exit",INPUT:"input",OUTPUT:"output"},wcNode.CONNECT_RESULT={NOT_FOUND:"not_found",ALREADY_CONNECTED:"already_connected",SUCCESS:"success"},wcNode.PROPERTY_ENABLED="enabled",wcNode.extend("wcNodeEntry","Entry Node","",{init:function(e,t){this._super(e,t),this.color="#CCCC00",this.createExit("out")},classInit:function(e,t,n){n&&(this.className=e,this.type=t,this.nodeType=wcPlay.NODE.ENTRY,this.category=n,wcPlay.registerNodeType(e,t,n,wcPlay.NODE.ENTRY))},onActivated:function(e){this._super(e),this.activateExit("out")}}),wcNode.extend("wcNodeProcess","Node Process","",{init:function(e,t){this._super(e,t),this.color="#007ACC",this.createEntry("in"),this.createExit("out")},classInit:function(e,t,n){n&&(this.className=e,this.type=t,this.nodeType=wcPlay.NODE.PROCESS,this.category=n,wcPlay.registerNodeType(e,t,n,wcPlay.NODE.PROCESS))}}),wcNode.extend("wcNodeStorage","Storage","",{init:function(e,t){this._super(e,t),this.color="#009900"},classInit:function(e,t,n){n&&(this.className=e,this.type=t,this.nodeType=wcPlay.NODE.STORAGE,this.category=n,wcPlay.registerNodeType(e,t,n,wcPlay.NODE.STORAGE))},onStart:function(){this._super(),this.property("value",this.property("value"),!0)}}),wcNode.extend("wcNodeComposite","Composite","",{init:function(e,t){this._super(e,t),this.color="#990099",this.removeEntry("in"),this.removeExit("out")},classInit:function(e,t,n){n&&(this.className=e,this.type=t,this.nodeType=wcPlay.NODE.COMPOSITE,this.category=n,wcPlay.registerNodeType(e,t,n,wcPlay.NODE.COMPOSITE))}}),wcNodeComposite.extend("wcNodeCompositeScript","Composite","Imported",{init:function(e,t,n){this._super(e,t),this.description("A node that contains its own set of nodes. Double click to view and edit its contents."),this.details("Composite nodes can also be generated from an external script file using the 'File->Import' option. Doing so will allow you to load the entire script into a single Composite Node that appears in the Palette on the left side."),this._entryNodes=[],this._processNodes=[],this._storageNodes=[],this._compositeNodes=[];if($.isArray(n))for(var r=0;r<n.length;++r)this.__addNode(n[r]),n[r]._parent=this},paused:function(e){var t=!1;for(var n=0;n<this._compositeNodes.length;++n)t|=this._compositeNodes[n].paused(e);for(var n=0;n<this._entryNodes.length;++n)t|=this._entryNodes[n].paused(e);for(var n=0;n<this._processNodes.length;++n)t|=this._processNodes[n].paused(e);for(var n=0;n<this._storageNodes.length;++n)t|=this._storageNodes[n].paused(e);return this._super(e)||t},compile:function(e){function t(t){for(var n=0;n<t.length;++n)this.compiledNodes.push(t[n].export(e))}this.compiledNodes=[],t.call(this,this._compositeNodes),t.call(this,this._entryNodes),t.call(this,this._storageNodes),t.call(this,this._processNodes)},decompile:function(e){this.onDestroying();var t=[];if(this.compiledNodes){for(var n=0;n<this.compiledNodes.length;++n){var r=this.compiledNodes[n];if(window[r.className]){var i=new window[r.className](this,r.pos,r.name);e?e[r.id]=i.id:i.id=r.id,t.push(i)}else console.log('ERROR: Attempted to load node "'+this.compiledNodes[n].className+'", but the constructor could not be found!'),t.push(null)}for(var n=0;n<this.compiledNodes.length;++n)if(t[n]){var r=this.compiledNodes[n];t[n].import(r,e)}}},nodeById:function(e){for(var t=0;t<this._entryNodes.length;++t)if(this._entryNodes[t].id===e)return this._entryNodes[t];for(var t=0;t<this._processNodes.length;++t)if(this._processNodes[t].id===e)return this._processNodes[t];for(var t=0;t<this._storageNodes.length;++t)if(this._storageNodes[t].id===e)return this._storageNodes[t];for(var t=0;t<this._compositeNodes.length;++t)if(this._compositeNodes[t].id===e)return this._compositeNodes[t];for(var t=0;t<this._compositeNodes.length;++t)if(this._compositeNodes[t]instanceof wcNodeCompositeScript){var n=this._compositeNodes[t].nodeById(e);if(n)return n}return null},nodesByClassName:function(e){var t=[];for(var n=0;n<this._compositeNodes.length;++n)this._compositeNodes[n].className===e&&t.push(this._compositeNodes[n]);for(var n=0;n<this._entryNodes.length;++n)this._entryNodes[n].className===e&&t.push(this._entryNodes[n]);for(var n=0;n<this._processNodes.length;++n)this._processNodes[n].className===e&&t.push(this._processNodes[n]);for(var n=0;n<this._storageNodes.length;++n)this._storageNodes[n].className===e&&t.push(this._storageNodes[n]);for(var n=0;n<this._compositeNodes.length;++n)if(this._compositeNodes[n]instanceof wcNodeCompositeScript){var r=this._compositeNodes[n].nodesByClassName(e);r.length&&t.concat(r)}return t},nodesBySearch:function(e){var t=[];for(var n=0;n<this._compositeNodes.length;++n)this._compositeNodes[n].search(e)&&t.push(this._compositeNodes[n]);for(var n=0;n<this._entryNodes.length;++n)this._entryNodes[n].search(e)&&t.push(this._entryNodes[n]);for(var n=0;n<this._processNodes.length;++n)this._processNodes[n].search(e)&&t.push(this._processNodes[n]);for(var n=0;n<this._storageNodes.length;++n)this._storageNodes[n].search(e)&&t.push(this._storageNodes[n]);for(var n=0;n<this._compositeNodes.length;++n)if(this._compositeNodes[n]instanceof wcNodeCompositeScript){var r=this._compositeNodes[n].nodesBySearch(e);r.length&&(t=t.concat(r))}return t},sortEntryLinks:function(){var e=[];for(var t=0;t<this._compositeNodes.length;++t){var n=this._compositeNodes[t];n instanceof wcNodeCompositeEntry&&e.push({name:n.name,pos:n.pos.x})}e.sort(function(e,t){return e.pos-t.pos});var r=this.chain.entry;this.chain.entry=[];for(var t=0;t<e.length;++t){var i=e[t].name;for(var s=0;s<r.length;++s)r[s].name===i&&this.chain.entry.push(r[s])}},sortExitLinks:function(){var e=[];for(var t=0;t<this._compositeNodes.length;++t){var n=this._compositeNodes[t];n instanceof wcNodeCompositeExit&&e.push({name:n.name,pos:n.pos.x})}e.sort(function(e,t){return e.pos-t.pos});var r=this.chain.exit;this.chain.exit=[];for(var t=0;t<e.length;++t){var i=e[t].name;for(var s=0;s<r.length;++s)r[s].name===i&&this.chain.exit.push(r[s])}},sortPropertyLinks:function(){var e=[];for(var t=0;t<this._compositeNodes.length;++t){var n=this._compositeNodes[t];n instanceof wcNodeCompositeProperty&&e.push({name:n.name,pos:n.pos.y})}e.sort(function(e,t){return e.pos-t.pos});var r=this.properties;this.properties=[r[0]],r.splice(0,1);for(var t=0;t<e.length;++t){var i=e[t].name;for(var s=0;s<r.length;++s)r[s].name===i&&(this.properties.push(r[s]),r.splice(s,1),s--)}},onDraw:function(){this._super(),this._meta.awake=!1;for(var e=0;e<this._entryNodes.length;++e)if(this._entryNodes[e]._meta.awake){this._meta.awake=!0,this._meta.flash=!0;return}for(var e=0;e<this._processNodes.length;++e)if(this._processNodes[e]._meta.awake){this._meta.awake=!0,this._meta.flash=!0;return}for(var e=0;e<this._storageNodes.length;++e)if(this._storageNodes[e]._meta.awake){this._meta.awake=!0,this._meta.flash=!0;return}for(var e=0;e<this._compositeNodes.length;++e){this._compositeNodes[e]instanceof wcNodeCompositeScript&&this._compositeNodes[e].onDraw();if(this._compositeNodes[e]._meta.awake){this._meta.awake=!0,this._meta.flash=!0;return}}},onActivated:function(e){this._super(e);for(var t=0;t<this._compositeNodes.length;++t){var n=this._compositeNodes[t];if(n instanceof wcNodeCompositeEntry&&n.name===e){n.activateExit("out");break}}},onPropertyChanged:function(e,t,n){this._super(e,t,n);for(var r=0;r<this._compositeNodes.length;++r){var i=this._compositeNodes[r];i instanceof wcNodeCompositeProperty&&i.name===e&&i.property("value",n,!0)}},onImporting:function(e,t){this.compiledNodes=e.nodes,this.decompile(t),this._super(e,t)},onExport:function(e,t){this._super(e,t),this.compile(t),e.nodes=this.compiledNodes},onReset:function(){this._super();for(var e=0;e<this._compositeNodes.length;++e)this._compositeNodes[e].reset();for(var e=0;e<this._entryNodes.length;++e)this._entryNodes[e].reset();for(var e=0;e<this._processNodes.length;++e)this._processNodes[e].reset();for(var e=0;e<this._storageNodes.length;++e)this._storageNodes[e].reset()},onDestroyed:function(){this._super();for(var e=0;e<this._entryNodes.length;++e)this._entryNodes[e].destroy();for(var e=0;e<this._processNodes.length;++e)this._processNodes[e].destroy();for(var e=0;e<this._storageNodes.length;++e)this._storageNodes[e].destroy();for(var e=0;e<this._compositeNodes.length;++e)this._compositeNodes[e].destroy();this._entryNodes=[],this._processNodes=[],this._storageNodes=[],this._compositeNodes=[]},notifyNodes:function(e,t){var n;for(var r=0;r<this._storageNodes.length;++r)n=this._storageNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._processNodes.length;++r)n=this._processNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._entryNodes.length;++r)n=this._entryNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._compositeNodes.length;++r)n=this._compositeNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._compositeNodes.length;++r)this._compositeNodes[r]instanceof wcNodeCompositeScript&&this._compositeNodes[r].notifyNodes(e,t)},__addNode:function(e){e instanceof wcNodeEntry?this._entryNodes.push(e):e instanceof wcNodeProcess?this._processNodes.push(e):e instanceof wcNodeStorage?this._storageNodes.push(e):e instanceof wcNodeComposite&&this._compositeNodes.push(e)},__removeNode:function(e){var t=-1;e instanceof wcNodeEntry?(t=this._entryNodes.indexOf(e),t>-1&&this._entryNodes.splice(t,1)):e instanceof wcNodeProcess?(t=this._processNodes.indexOf(e),t>-1&&this._processNodes.splice(t,1)):e instanceof wcNodeStorage?(t=this._storageNodes.indexOf(e),t>-1&&this._storageNodes.splice(t,1)):e instanceof wcNodeComposite&&(t=this._compositeNodes.indexOf(e),t>-1&&this._compositeNodes.splice(t,1));if(t===-1)for(var n=0;n<this._compositeNodes.length;++n)if(this._compositeNodes[n]instanceof wcNodeCompositeScript&&this._compositeNodes[n].__removeNode(e))return!0;return!1}}),wcNodeComposite.extend("wcNodeCompositeEntry","Entry","Linkers",{init:function(e,t,n){this._super(e,t),e instanceof wcNodeCompositeScript||(this._invalid=!0),this.description("Activates when the corresponding Entry link of the parent Composite node has been activated."),this.details("The title name for this node becomes the name of the Entry link in the parent Composite Node.\n\nAlthough this node does nothing while it is outside of a Composite Node, it can be placed within the Root level of the script. Doing so is useful if you intend to 'File->Import' this script into another."),n=n||"in";var r=n;if(!this._invalid){var i=0;for(;;){if(this._parent.createEntry(r))break;i++,r=n+i}}this.removeEntry("in"),this.createExit("out"),this.name=r},onNameChanging:function(e,t){this._super(e,t);if(this._invalid)return;for(var n=0;n<this._parent.chain.entry.length;++n)if(this._parent.chain.entry[n].name===t)return e},onNameChanged:function(e,t){this._super(e,t);if(this._invalid)return;this._parent.renameEntry(e,t),this._parent.sortEntryLinks()},onMoved:function(e,t){this._super(e,t);if(this._invalid)return;this._parent.sortEntryLinks()},onDestroyed:function(){this._super();if(this._invalid)return;this._parent.sortEntryLinks()},onImporting:function(e,t){this._super(e,t);if(!this._invalid&&e.name!==this.name){var n=e.name;this._parent.removeEntry(this.name);var r=0;for(;;){if(this._parent.createEntry(n))break;r++,n=e.name+r}e.name=n}},onImported:function(e,t){this._super(e,t);if(this._invalid)return;this._parent.sortEntryLinks()}}),wcNodeComposite.extend("wcNodeCompositeExit","Exit","Linkers",{init:function(e,t,n){this._super(e,t),e instanceof wcNodeCompositeScript||(this._invalid=!0),this.description("Activates the corresponding Exit link of the parent Composite node when it has been activated."),this.details("The title name for this node becomes the name of the Exit link in the parent Composite Node.\n\nAlthough this node does nothing while it is outside of a Composite Node, it can be placed within the Root level of the script. Doing so is useful if you intend to 'File->Import' this script into another."),n=n||"out";var r=n;if(!this._invalid){var i=0;for(;;){if(this._parent.createExit(r))break;i++,r=n+i}}this.createEntry("in"),this.removeExit("out"),this.name=r},onActivated:function(e){this._super(e);if(this._invalid)return;this._parent.activateExit(this.name)},onNameChanging:function(e,t){this._super(e,t);if(this._invalid)return;for(var n=0;n<this._parent.chain.exit.length;++n)if(this._parent.chain.exit[n].name===t)return e},onNameChanged:function(e,t){this._super(e,t);if(this._invalid)return;this._parent.renameExit(e,t),this._parent.sortExitLinks()},onMoved:function(e,t){this._super(e,t);if(this._invalid)return;this._parent.sortExitLinks()},onDestroyed:function(){this._super();if(this._invalid)return;this._parent.sortExitLinks()},onImporting:function(e,t){this._super(e,t);if(!this._invalid&&e.name!==this.name){var n=e.name;this._parent.removeExit(this.name);var r=0;for(;;){if(this._parent.createExit(n))break;r++,n=e.name+r}e.name=n}},onImported:function(e,t){this._super(e,t);if(this._invalid)return;this._parent.sortExitLinks()}}),wcNodeComposite.extend("wcNodeCompositeProperty","Property","Linkers",{init:function(e,t,n){this._super(e,t),e instanceof wcNodeCompositeScript||(this._invalid=!0),this.description("References a property from its parent Composite Node."),this.details("The title name for this node becomes the name of the Property on the parent Composite Node. Multiple Property Nodes can reference the same property value name.\n\nAlthough this node does nothing while it is outside of a Composite Node, it can be placed within the Root level of the script. Doing so is useful if you intend to 'File->Import' this script into another."),this.name=n||"value",this._invalid||this._parent&&this._parent.createProperty(this.name,wcPlay.PROPERTY.STRING,""),this.createProperty("input",wcPlay.PROPERTY.TOGGLE,!0,{description:"Assign whether the parent Composite Node can set this property's value."}),this.createProperty("output",wcPlay.PROPERTY.TOGGLE,!0,{description:"Assign whether the parent Composite Node can read this property's value."}),this.createProperty("value",wcPlay.PROPERTY.STRING,"",{input:!0,output:!0})},onNameChanged:function(e,t){this._super(e,t);if(this._invalid)return;if(t){if(this._parent){var n={};this.property("input")||(n.input=!0),this.property("output")||(n.output=!0),this._parent.createProperty(t,wcPlay.PROPERTY.STRING,"",n);var r=this._parent.listInputChains(e),i=this._parent.listOutputChains(e),s=this.engine();if(s){for(var o=0;o<r.length;++o)this._parent.connectInput(t,s.nodeById(r[o].outNodeId),r[o].outName);for(var o=0;o<i.length;++o)this._parent.connectOutput(t,s.nodeById(i[o].inNodeId),i[o].inName)}this._parent.sortPropertyLinks()}this.property("value",this.property("value"))}else this.property("value","")},onPropertyChanging:function(e,t,n){this._super(e,t,n);if(this._invalid||!this.name||!this._parent)return"";switch(e){case"value":this._parent.property(this.name,n);break;case"input":var r=this.engine(),i=this._parent.propertyOptions(this.name);i&&r&&(r.notifyEditors("onBeginUndoGroup",['Property "'+e+'" changed for Node "'+this.category+"."+this.type+'"']),i.input=!n,i.input||(r.notifyEditors("onDisconnectInputChains",[this._parent,this.name]),this._parent.disconnectInput(this.name)));break;case"output":var r=this.engine(),i=this._parent.propertyOptions(this.name);i&&r&&(r.notifyEditors("onBeginUndoGroup",['Property "'+e+'" changed for Node "'+this.category+"."+this.type+'"']),i.output=!n,i.output||(r.notifyEditors("onDisconnectOutputChains",[this._parent,this.name]),this._parent.disconnectOutput(this.name)))}},onPropertyChanged:function(e,t,n){this._super(e,t,n);if(e==="input"||e==="output"){var r=this.engine();r&&setTimeout(function(){r.notifyEditors("onEndUndoGroup")},0)}},onPropertyGet:function(e){this._super(e);if(this._invalid)return"";if(e==="value"&&this.name)return this._parent.property(this.name)},onInitialPropertyChanging:function(e,t,n){this._super(e,t,n);if(this._invalid)return"";e==="value"&&this.name&&this._parent.initialProperty(this.name,n)},onInitialPropertyGet:function(e){this._super(e);if(this._invalid)return"";if(e==="value"&&this.name)return this._parent.initialProperty(this.name)},onMoved:function(e,t){this._super(e,t);if(this._invalid)return;this._parent.sortPropertyLinks()},onDestroyed:function(){this._super();if(this._invalid)return;this._parent.sortPropertyLinks()}})