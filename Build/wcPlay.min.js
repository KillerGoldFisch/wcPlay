/*!
 * Web Cabin Play - Node based visual scripting tool.
 *
 * Dependancies:
 *  JQuery 1.11.1
 *  font-awesome 4.2.0
 *
 * Author: Jeff Houde (lochemage@webcabin.org)
 * Web: https://play.webcabin.org/
 *
 * Licensed under
 *   MIT License http://www.opensource.org/licenses/mit-license
 *
 */
function wcPlay(e){this._entryNodes=[],this._processNodes=[],this._compositeNodes=[],this._storageNodes=[],this._properties=[],this._queuedChain=[],this._queuedProperties=[],this._updateID=0,this._isPaused=!1,this._isStepping=!1;var t={silent:!1,updateRate:25};this._options={};for(var n in t)this._options[n]=t[n];for(var n in e)this._options[n]=e[n]}(function(){var e=!1,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(){function u(){e?this.classInit&&this.classInit.apply(this,arguments[0]):this.init&&this.init.apply(this,arguments)}var n=arguments[0],r=arguments[arguments.length-1],i=this.prototype;e=!0;var s=new this(arguments);e=!1;for(var o in r)s[o]=typeof r[o]=="function"&&typeof i[o]=="function"&&t.test(r[o])?function(e,t){return function(){var n=this._super;this._super=i[e];var r=t.apply(this,arguments);return this._super=n,r}}(o,r[o]):r[o];u.prototype=s,u.prototype.constructor=u,u.extend=arguments.callee,window[n]=u}})(),wcPlay.PROPERTY_TYPE={TOGGLE:"toggle",NUMBER:"number",STRING:"string",SELECT:"select",COLOR:"color"},wcPlay.NODE_TYPE={ENTRY:"entry",PROCESS:"process",COMPOSITE:"composite",STORAGE:"storage"},wcPlay.NODE_LIBRARY=[],wcPlay.registerNodeType=function(e,t,n){for(var r=0;r<wcPlay.NODE_LIBRARY.length;++r)if(wcPlay.NODE_LIBRARY[r].constructor===t)return!1;return wcPlay.NODE_LIBRARY.push({name:e,constructor:t,type:n}),!0},wcPlay.prototype={isSilent:function(){return this._options.silent},start:function(){var e=this;this._updateID=setInterval(function(){e.update()},this._options.updateRate),this.__notifyNodes("onStart",[])},update:function(){if(this._isPaused)return;var e=this._queuedProperties.length;while(e){e--;var t=this._queuedProperties.shift();t.node.property(t.name,t.value)}if(!this._queuedProperties.length){e=this._queuedChain.length;while(e){e--;var t=this._queuedChain.shift();t.node.onTriggered(t.name)}}this._isStepping&&(this._isPaused=!0)},createProperty:function(e,t,n,r){for(var i=0;i<this._properties.length;++i)if(this._properties[i].name===e)return!1;return wcPlay.PROPERTY_TYPE.hasOwnProperty(t)||(t=wcPlay.PROPERTY_TYPE.STRING),this._properties.push({name:e,value:n,defaultValue:n,controlType:t,options:r||{}}),!0},renameProperty:function(e,t){var n=null;for(var r=0;r<this._properties.length;++r){if(this._properties[r].name===t)return!1;this._properties[r].name===e&&(n=this._properties[r])}if(!n)return!1;n.name=t,this.__notifyNodes("onGlobalPropertyRenamed",[e,t])},property:function(e,t){var n=null;for(var r=0;r<this._properties.length;++r)if(this._properties[r].name===e){n=this._properties[r];break}if(!n)return;if(t!==undefined&&t!==n.value){var i=n.value;n.value=t,this.__notifyNodes("onGlobalPropertyChanged",[n.name,i,n.value])}},triggerEvent:function(e,t){for(var n=0;n<this._entryNodes.length;++n)this._entryNodes[n].name===e&&this._entryNodes[n].onTriggered(t)},queueNodeEntry:function(e,t){e.enabled()&&this._queuedChain.push({node:e,name:t})},queueNodeProperty:function(e,t,n){e.enabled()&&this._queuedProperties.push({node:e,name:t,value:n})},__addNode:function(e){e instanceof wcNodeEntry?this._entryNodes.push(e):e instanceof wcNodeProcess?this._processNodes.push(e):e instanceof wcNodeStorage?this._storageNodes.push(e):e instanceof wcNodeComposite&&this._compositeNodes.push(e)},__removeNode:function(e){e instanceof wcNodeEntry?this._entryNodes.splice(this._entryNodes.indexOf(e),1):e instanceof wcNodeProcess?this._processNodes.splice(this._processNodes.indexOf(e),1):e instanceof wcNodeStorage?this._storageNodes.splice(this._storageNodes.indexOf(e),1):e instanceof wcNodeComposite&&this._compositeNodes.splice(this._compositeNodes.indexOf(e),1)},__notifyNodes:function(e,t){var n;for(var r=0;r<this._storageNodes.length;++r)n=this._storageNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._processNodes.length;++r)n=this._processNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._compositeNodes.length;++r)n=this._compositeNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._entryNodes.length;++r)n=this._entryNodes[r],typeof n[e]=="function"&&n[e].apply(n,t)}},Class.extend("wcNode","Node","Core",{init:function(e,t,n){this.name=n||this.name,this.color=null,this.pos=t,this.chain={entry:[],exit:[]},this.properties=[],this._meta={},this._awake=!1,this._parent=e,this.createProperty(wcNode.PROPERTY.ENABLED,wcPlay.PROPERTY_TYPE.TOGGLE,!0),this.createProperty(wcNode.PROPERTY.LOG,wcPlay.PROPERTY_TYPE.TOGGLE,!1),this.createProperty(wcNode.PROPERTY.BREAK,wcPlay.PROPERTY_TYPE.TOGGLE,!1),this.engine().__addNode(this)},classInit:function(e,t,n){this.className=e,this.name=t,this.category=n,wcPlay.registerNodeType(t,e,wcPlay.NODE_TYPE.STORAGE)},destroy:function(){for(var e=0;e<this.chain.entry.length;++e){var t=this.chain.entry[e];this.disconnectEntry(t.name)}for(var e=0;e<this.chain.exit.length;++e){var t=this.chain.exit[e];this.disconnectExit(t.name)}for(var e=0;e<this.properties.length;++e){var t=this.properties[e];this.disconnectInput(t.name),this.disconnectOutput(t.name)}this.engine().__removeNode(this)},engine:function(){var e=this._parent;while(!(e instanceof wcPlay))e=e._parent;return e},enabled:function(e){return e!==undefined&&this.property(wcNode.PROPERTY.ENABLED,e?!0:!1),this.property(wcNode.PROPERTY.ENABLED)},debugLog:function(e){return e!==undefined&&this.property(wcNode.PROPERTY.LOG,e?!0:!1),this.engine().isSilent()?!1:this.property(wcNode.PROPERTY.LOG)},debugPause:function(e){return e!==undefined&&this.property(wcNode.PROPERTY.BREAK,e?!0:!1),this.property(wcNode.PROPERTY.BREAK)},wake:function(){},sleep:function(){},createEntry:function(e){e===undefined&&(e="In");for(var t=0;t<this.chain.entry.length;++t)if(this.chain.entry[t].name===e)return!1;return this.chain.entry.push({name:e,active:!1,links:[]}),!0},createExit:function(e){for(var t=0;t<this.chain.exit.length;++t)if(this.chain.exit[t].name===e)return!1;return this.chain.exit.push({name:e,links:[]}),!0},createProperty:function(e,t,n,r){for(var i=0;i<this.properties.length;++i)if(this.properties[i].name===e)return!1;return wcPlay.PROPERTY_TYPE.hasOwnProperty(t)||(t=wcPlay.PROPERTY_TYPE.STRING),this.properties.push({name:e,value:n,defaultValue:n,controlType:t,inputs:[],outputs:[],options:r||{}}),!0},removeEntry:function(e){for(var t=0;t<this.chain.entry.length;++t)if(this.chain.entry[t].name===e)return this.disconnectEntry(e)===wcNode.CONNECT_RESULT.SUCCESS;return!1},removeExit:function(e){for(var t=0;t<this.chain.exit.length;++t)if(this.chain.exit[t].name===e)return this.disconnectExit(e)===wcNode.CONNECT_RESULT.SUCCESS;return!1},removeProperty:function(e){for(var t=0;t<this.properties.length;++t)if(this.properties[t].name===e)return this.disconnectInput(e)===this.disconnectOutput(e)===wcNode.CONNECT_RESULT.SUCCESS;return!1},connectEntry:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.chain.entry.length;++s)if(this.chain.entry[s].name===e){r=this.chain.entry[s];break}for(var s=0;s<t.chain.exit.length;++s)if(t.chain.exit[s].name===n){i=t.chain.exit[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.links.length;++s)if(r.links[s].node===t&&r.links[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.links.length;++s)if(i.links[s].node===this&&i.links[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.links.push({name:i.name,node:t}),i.links.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.ENTRY,t,i.name,wcNode.LINK_TYPE.EXIT),t.onConnect(!0,i.name,wcNode.LINK_TYPE.EXIT,this,r.name,wcNode.LINK_TYPE.ENTRY),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},connectExit:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.chain.exit.length;++s)if(this.chain.exit[s].name===e){r=this.chain.exit[s];break}for(var s=0;s<t.chain.entry.length;++s)if(t.chain.entry[s].name===n){i=t.chain.entry[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.links.length;++s)if(r.links[s].node===t&&r.links[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.links.length;++s)if(i.links[s].node===this&&i.links[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.links.push({name:i.name,node:t}),i.links.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.EXIT,t,i.name,wcNode.LINK_TYPE.ENTRY),t.onConnect(!0,i.name,wcNode.LINK_TYPE.ENTRY,this,r.name,wcNode.LINK_TYPE.EXIT),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},connectInput:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.properties.length;++s)if(this.properties[s].name===e){r=this.properties[s];break}for(var s=0;s<t.properties.length;++s)if(t.properties[s].name===n){i=t.properties[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.inputs.length;++s)if(r.inputs[s].node===t&&r.inputs[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.outputs.length;++s)if(i.outputs[s].node===this&&i.outputs[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.inputs.push({name:i.name,node:t}),i.outputs.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.INPUT,t,i.name,wcNode.LINK_TYPE.OUTPUT),t.onConnect(!0,i.name,wcNode.LINK_TYPE.OUTPUT,this,r.name,wcNode.LINK_TYPE.INPUT),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},connectOutput:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.properties.length;++s)if(this.properties[s].name===e){r=this.properties[s];break}for(var s=0;s<t.properties.length;++s)if(t.properties[s].name===n){i=t.properties[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.outputs.length;++s)if(r.outputs[s].node===t&&r.outputs[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.inputs.length;++s)if(i.inputs[s].node===this&&i.inputs[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.outputs.push({name:i.name,node:t}),i.inputs.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.OUTPUT,t,i.name,wcNode.LINK_TYPE.INPUT),t.onConnect(!0,i.name,wcNode.LINK_TYPE.INPUT,this,r.name,wcNode.LINK_TYPE.OUTPUT),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},disconnectEntry:function(e,t,n){var r=null;for(var i=0;i<this.chain.entry.length;++i)if(this.chain.entry[i].name===e){r=this.chain.entry[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.links.length;++i){var s=r.links[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.links.splice(i,1),i--,s.node.disconnectExit(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},disconnectExit:function(e,t,n){var r=null;for(var i=0;i<this.chain.exit.length;++i)if(this.chain.exit[i].name===e){r=this.chain.exit[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.links.length;++i){var s=r.links[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.links.splice(i,1),i--,s.node.disconnectEntry(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},disconnectInput:function(e,t,n){var r=null;for(var i=0;i<this.properties.length;++i)if(this.properties[i].name===e){r=this.properties[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.inputs.length;++i){var s=r.inputs[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.inputs.splice(i,1),i--,s.node.disconnectOutput(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},disconnectOutput:function(e,t,n){var r=null;for(var i=0;i<this.properties.length;++i)if(this.properties[i].name===e){r=this.properties[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.outputs.length;++i){var s=r.outputs[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.outputs.splice(i,1),i--,s.node.disconnectInput(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},triggerEntry:function(e){for(var t=0;t<this.chain.entry.length;++t)if(this.chain.entry[t].name==e)return this.engine().queueNodeEntry(this,this.chain.entry[t].name),!0;return!1},triggerExit:function(e){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.name+'" Triggered Exit link "'+e+'"');for(var t=0;t<this.chain.exit.length;++t){var n=this.chain.exit[t];if(n.name==e){for(var r=0;r<n.links.length;++r)n.links[r].node&&n.links[r].node.triggerEntry(n.links[r].name);return!0}}return!1},property:function(e,t,n){for(var r=0;r<this.properties.length;++r){var i=this.properties[r];if(i.name===e){if(t!==undefined){var s=i.value;if(n||i.value!==t)t=this.onPropertyChanging(i.name,s,t)||t;if(n||i.value!==t){i.value=t,this.onPropertyChanged(i.name,s,t);var o=this.engine();for(a=0;a<i.outputs.length;++a)o.queueNodeProperty(i.outputs[a].node,i.outputs[a].name,t)}}return i.value}}},defaultValue:function(e,t){for(var n=0;n<this.properties.length;++n){var r=this.properties[n];r.name===e&&(r.defaultValue=t)}},onConnect:function(e,t,n,r,i,s){},onStart:function(){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.name+'" started!')},onTriggered:function(e){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.name+'" Triggered Entry link "'+e+'"')},onPropertyChanging:function(e,t,n){},onPropertyChanged:function(e,t,n){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.name+'" Changed Property "'+e+'" from "'+t+'" to "'+n+'"')},onPropertyGet:function(e){},onPropertyGot:function(e){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.name+'" Got Property "'+e+'"')}}),wcNode.LINK_TYPE={ENTRY:"entry",EXIT:"exit",INPUT:"input",OUTPUT:"output"},wcNode.CONNECT_RESULT={NOT_FOUND:"not_found",ALREADY_CONNECTED:"already_connected",SUCCESS:"success"},wcNode.PROPERTY={ENABLED:"enabled",LOG:"debug log",BREAK:"debug break",TRIGGER:"trigger"},wcNode.extend("wcNodeEntry","Entry Node","Core",{init:function(e,t,n){this._super(e,t,n),this.createExit("Out"),this.createProperty(wcNode.PROPERTY.TRIGGER,wcPlay.PROPERTY_TYPE.TOGGLE,!1)},classInit:function(e,t,n){this.className=e,this.name=t,this.category=n,wcPlay.registerNodeType(t,e,wcPlay.NODE_TYPE.ENTRY)},onTriggered:function(e){this.triggerCondition(e)&&this.triggerExit("Out")},triggerCondition:function(e){return!0},onPropertyChanged:function(e,t,n){this._super(e,t,n),e===wcNode.PROPERTY.TRIGGER&&n&&(this.triggerExit("Out"),this.property(wcNode.PROPERTY.TRIGGER,!1))}}),wcNode.extend("wcNodeProcess","Node Process","Core",{init:function(e,t,n){this._super(e,t,n),this.createEntry("In"),this.createExit("Out")},classInit:function(e,t,n){this.className=e,this.name=t,this.category=n,wcPlay.registerNodeType(t,e,wcPlay.NODE_TYPE.PROCESS)}}),wcNode.extend("wcNodeStorage","Storage","Core",{init:function(e,t,n){this._super(e,t,n),this.createProperty("Value",wcPlay.PROPERTY_TYPE.STRING,"")},onStart:function(){this._super(),this.property("Value",this.property("Value"),!0)}}),wcNodeEntry.extend("wcNodeEntryStart","Start","Core",{init:function(e,t,n){this._super(e,t,n)},onStart:function(){this._super(),this.onTriggered()}}),wcNodeProcess.extend("wcNodeProcessDelay","Delay","Core",{init:function(e,t,n){this._super(e,t,n),this.createExit("Finished"),this.createProperty("Milliseconds",wcPlay.PROPERTY_TYPE.NUMBER,1e3)},onTriggered:function(e){this._super(e),this.triggerExit("Out"),this.wake();var t=this,n=this.property("Milliseconds");setTimeout(function(){t.triggerExit("Finished"),t.sleep()},n)}}),wcNodeProcess.extend("wcNodeProcessLog","Log","Core",{init:function(e,t,n){this._super(e,t,n),this.createProperty("Message",wcPlay.PROPERTY_TYPE.STRING,"Log message.")},onTriggered:function(e){this._super(e);var t=this.property("Message");console.log("LOG: "+t),this.triggerExit("Out")}})