/*!
 * Web Cabin Play - Node based visual scripting tool.
 *
 * Dependancies:
 *  JQuery 1.11.1
 *  font-awesome 4.2.0
 *
 * Author: Jeff Houde (lochemage@webcabin.org)
 * Web: https://play.webcabin.org/
 * API: https://play.api.webcabin.org/
 *
 * Licensed under
 *   MIT License http://www.opensource.org/licenses/mit-license
 *
 */
function wcPlay(e){this._entryNodes=[],this._processNodes=[],this._compositeNodes=[],this._storageNodes=[],this._properties=[],this._queuedChain=[],this._queuedProperties=[],this._updateID=0,this._isPaused=!1,this._isStepping=!1,this._editors=[],this._options={silent:!1,updateRate:25,updateLimit:100,debugging:!0};for(var t in e)this._options[t]=e[t]}function wcPlayEditor(e,t){this.$container=$(e),this.$viewport=null,this._viewportContext=null,this.$palette=null,this._paletteSize=.25,this.$typeButton=[],this.$typeArea=[],this._size={x:0,y:0},this._engine=null,this._nodeLibrary={},this._font={title:{size:15,family:"Arial",weight:"bold"},titleDesc:{size:15,family:"Arial",weight:"italic"},links:{size:10,family:"Arial"},property:{size:10,family:"Arial",weight:"italic"},value:{size:10,family:"Arial",weight:"bold"},initialValue:{size:10,family:"Arial",weight:"bold italic"}},this._drawStyle={palette:{spacing:20},node:{radius:10,margin:15},title:{spacing:5,wrapL:"  ",wrapR:"  "},links:{length:12,width:8,spacing:10,padding:5,margin:10},property:{spacing:5,strLen:10,minLength:30,valueWrapL:" ",valueWrapR:"  ",initialWrapL:"[",initialWrapR:"]"}},this._lastUpdate=0,this._viewportCamera={x:0,y:0,z:1},this._viewportMovingNode=!1,this._viewportMoving=!1,this._viewportMoved=!1,this._paletteMoving=!1,this._mouse={x:0,y:0},this._highlightRect=null,this._highlightNode=null,this._selectedNode=null,this._selectedNodes=[],this._expandedNode=null,this._expandedNodeWasCollapsed=!1,this._highlightTitle=!1,this._highlightCollapser=!1,this._highlightBreakpoint=!1,this._highlightEntryLink=!1,this._highlightExitLink=!1,this._highlightInputLink=!1,this._highlightOutputLink=!1,this._highlightPropertyValue=!1,this._highlightPropertyInitialValue=!1,this._highlightViewport=!1,this._selectedEntryLink=!1,this._selectedExitLink=!1,this._selectedInputLink=!1,this._selectedOutputLink=!1,this._selectedNodeOrigins=[],this._draggingNodeData=null,this._undoManager=null,this._options={readOnly:!1};for(var n in t)this._options[n]=t[n];this.$top=$('<div class="wcPlayEditorTop">'),this.$main=$('<div class="wcPlayEditorMain">'),this.$palette=$('<div class="wcPlayPalette wcPlayNoHighlights">'),this.$paletteScroller=$('<div class="wcPlayPaletteScroller">'),this.$paletteInner=$('<div class="wcPlayPaletteInner">'),this.$viewport=$('<canvas class="wcPlayViewport">'),this._viewportContext=this.$viewport[0].getContext("2d"),this.$palette.append(this.$paletteScroller),this.$paletteScroller.append(this.$paletteInner),this.$main.append(this.$palette),this.$main.append(this.$viewport),this.$container.append(this.$top),this.$container.append(this.$main),this.onResized(),this.__setupMenu(),this.__setupPalette(),this.__setupControls(),window.requestAnimationFrame(this.__update.bind(this))}(function(){var e=!1,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(){function u(){e?this.classInit&&this.classInit.apply(this,arguments[0]):this.init&&this.init.apply(this,arguments)}var n=arguments[0],r=arguments[arguments.length-1],i=this.prototype;e=!0;var s=new this(arguments);e=!1;for(var o in r)s[o]=typeof r[o]=="function"&&typeof i[o]=="function"&&t.test(r[o])?function(e,t){return function(){var n=this._super;this._super=i[e];var r=t.apply(this,arguments);return this._super=n,r}}(o,r[o]):r[o];u.prototype=s,u.prototype.constructor=u,u.extend=arguments.callee,window[n]=u}})(),wcPlay.PROPERTY_TYPE={DYNAMIC:"dynamic",TOGGLE:"toggle",NUMBER:"number",STRING:"string",SELECT:"select"},wcPlay.NODE_TYPE={ENTRY:"entry",PROCESS:"process",STORAGE:"storage",COMPOSITE:"composite"},wcPlay.NODE_LIBRARY=[],wcPlay.registerNodeType=function(e,t,n,r){for(var i=0;i<wcPlay.NODE_LIBRARY.length;++i)if(wcPlay.NODE_LIBRARY[i].name===e)return!1;return wcPlay.NODE_LIBRARY.push({name:e,displayName:t,category:n,type:r}),!0},wcPlay.prototype={start:function(){this._isPaused=!0;for(var e=0;e<this._properties.length;++e)this._properties[e].value=this._properties[e].initialValue;for(var e=0;e<this._storageNodes.length;++e)this._storageNodes[e].reset();for(var e=0;e<this._processNodes.length;++e)this._processNodes[e].reset();for(var e=0;e<this._compositeNodes.length;++e)this._compositeNodes[e].reset();for(var e=0;e<this._entryNodes.length;++e)this._entryNodes[e].reset();this._queuedChain=[],this._queuedProperties=[],this._isPaused=!1,this._isStepping=!1;if(!this._updateId){var t=this;this._updateID=setInterval(function(){t.update()},this._options.updateRate)}this.__notifyNodes("onStart",[])},clear:function(){this._queuedChain=[],this._queuedProperties=[],this._properties=[];while(this._storageNodes.length)this._storageNodes[0].destroy();while(this._processNodes.length)this._processNodes[0].destroy();while(this._compositeNodes.length)this._compositeNodes[0].destroy();while(this._entryNodes.length)this._entryNodes[0].destroy()},update:function(){if(this._isPaused)return;var e=Math.min(this._queuedProperties.length,this._options.updateLimit);while(e){e--;var t=this._queuedProperties.shift();t.node._meta.flash=!0,t.node._meta.paused=!1,t.node.property(t.name,t.value)}if(!this._queuedProperties.length){e=Math.min(this._queuedChain.length,this._options.updateLimit-e);while(e){e--;var t=this._queuedChain.shift();t.node._meta.flash=!0,t.node._meta.paused=!1,t.node.onTriggered(t.name)}}this._isStepping&&(this._isPaused=!0)},nodeById:function(e){for(var t=0;t<this._storageNodes.length;++t)if(this._storageNodes[t].id===e)return this._storageNodes[t];for(var t=0;t<this._processNodes.length;++t)if(this._processNodes[t].id===e)return this._processNodes[t];for(var t=0;t<this._compositeNodes.length;++t)if(this._compositeNodes[t].id===e)return this._compositeNodes[t];for(var t=0;t<this._entryNodes.length;++t)if(this._entryNodes[t].id===e)return this._entryNodes[t];return null},silent:function(e){return e!==undefined&&(this._options.silent=e?!0:!1),this._options.silent},debugging:function(e){return e!==undefined&&(this._options.debugging=e?!0:!1),this._options.debugging},paused:function(e){return e!==undefined&&(this._isPaused=e?!0:!1),this._isPaused},stepping:function(e){return e!==undefined&&(this._isStepping=e?!0:!1),this._isStepping},createProperty:function(e,t,n,r){for(var i=0;i<this._properties.length;++i)if(this._properties[i].name===e)return!1;return n===undefined&&(n=0),this._properties.push({name:e,value:n,initialValue:n,type:t,options:r||{}}),!0},renameProperty:function(e,t){var n=null;for(var r=0;r<this._properties.length;++r){if(this._properties[r].name===t)return!1;this._properties[r].name===e&&(n=this._properties[r])}if(!n)return!1;n.name=t,this.__notifyNodes("onGlobalPropertyRenamed",[e,t])},removeProperty:function(e){for(var t=0;t<this._properties.length;++t)if(this._properties[t].name===e)return this.__notifyNodes("onGlobalPropertyRemoved",[e]),this._properties.splice(t,1),!0;return!1},property:function(e,t){var n=null;for(var r=0;r<this._properties.length;++r)if(this._properties[r].name===e){n=this._properties[r];break}if(!n)return;if(t!==undefined&&t!==n.value){var i=n.value;n.value=t,this.__notifyNodes("onGlobalPropertyChanged",[n.name,i,n.value])}return n.value},initialProperty:function(e,t){var n=null;for(var r=0;r<this._properties.length;++r)if(this._properties[r].name===e){n=this._properties[r];break}if(!n)return;if(t!==undefined&&t!==n.initialValue){var i=n.initialValue;n.initialValue=t,n.value==i&&(n.value=t,this.__notifyNodes("onGlobalInitialPropertyChanged",[n.name,i,n.value]))}return n.initialValue},listProperties:function(){var e=[];for(var t=0;t<this._properties.length;++t){var n=this._properties[t];e.push({name:n.name,value:n.value,initialValue:n.initialValue})}return e},triggerEvent:function(e,t){for(var n=0;n<this._entryNodes.length;++n)this._entryNodes[n].name===e&&this._entryNodes[n].onTriggered(t)},queueNodeEntry:function(e,t){if(e.enabled()){this._queuedChain.push({node:e,name:t});if(e.debugBreak()||this._isStepping)e._meta.flash=!0,e._meta.paused=!0,this._isPaused=!0}},queueNodeProperty:function(e,t,n){if(e.enabled()){this._queuedProperties.push({node:e,name:t,value:n});if(e.debugBreak()||this._isStepping)e._meta.flash=!0,e._meta.paused=!0,this._isPaused=!0}},__addNode:function(e){e instanceof wcNodeEntry?this._entryNodes.push(e):e instanceof wcNodeProcess?this._processNodes.push(e):e instanceof wcNodeStorage?this._storageNodes.push(e):e instanceof wcNodeComposite&&this._compositeNodes.push(e)},__removeNode:function(e){e instanceof wcNodeEntry?this._entryNodes.splice(this._entryNodes.indexOf(e),1):e instanceof wcNodeProcess?this._processNodes.splice(this._processNodes.indexOf(e),1):e instanceof wcNodeStorage?this._storageNodes.splice(this._storageNodes.indexOf(e),1):e instanceof wcNodeComposite&&this._compositeNodes.splice(this._compositeNodes.indexOf(e),1)},__notifyNodes:function(e,t){var n;for(var r=0;r<this._storageNodes.length;++r)n=this._storageNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._processNodes.length;++r)n=this._processNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._compositeNodes.length;++r)n=this._compositeNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._entryNodes.length;++r)n=this._entryNodes[r],typeof n[e]=="function"&&n[e].apply(n,t)},__notifyEditors:function(e,t){var n;for(var r=0;r<this._editors.length;++r)n=this._editors[r],typeof n[e]=="function"&&n[e].apply(n,t)}},wcPlayEditor.prototype={engine:function(e){if(e!==undefined&&e!==this._engine){if(this._engine){var t=this._engine._editors.indexOf(this);t>-1&&this._engine._editors.splice(t,1),this._engine._undoManager=this._undoManager,this._undoManager=null}this._engine=e,this._engine&&(this._engine._editors.push(this),this._undoManager=this._engine._undoManager,!this._undoManager&&window.wcUndoManager&&(this._undoManager=new wcUndoManager,this._engine._undoManager=this._undoManager))}return this._engine},center:function(){},onResized:function(){var e=this.$main.width(),t=this.$main.height();if(this._size.x!==e||this._size.y!==t){this._size.x=e,this._size.y=t;var n=e*this._paletteSize;this.$palette.css("width",n).attr("width",n).attr("height",t),this.$viewport.css("width",e-n).attr("width",e-n).attr("height",t)}},__mouse:function(e,t,n){if(e.originalEvent&&(e.originalEvent.touches||e.originalEvent.changedTouches)){var r=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0];return{x:r.clientX-(t?t.left:0)-(n?n.x:0),y:r.clientY-(t?t.top:0)-(n?n.y:0),gx:r.clientX,gy:r.clientY,which:1}}return{x:(e.clientX||e.pageX)-(t?t.left:0)-(n?n.x:0),y:(e.clientY||e.pageY)-(t?t.top:0)-(n?n.y:0),gx:e.clientX||e.pageX,gy:e.clientY||e.pageY,which:e.which||1}},__setCanvasFont:function(e,t){t.font=(e.weight?e.weight+" ":"")+(e.size+"px ")+e.family},__clampString:function(e,t){return e.length>t?e.substring(0,t)+"...":e},__blendColors:function(e,t,n){var r=n<0?n*-1:n,i=Math.round,s=parseInt;if(e.length>7){var o=e.split(","),u=(t?t:n<0?"rgb(0,0,0)":"rgb(255,255,255)").split(","),a=s(o[0].slice(4)),f=s(o[1]),l=s(o[2]);return"rgb("+(i((s(u[0].slice(4))-a)*r)+a)+","+(i((s(u[1])-f)*r)+f)+","+(i((s(u[2])-l)*r)+l)+")"}var o=s(e.slice(1),16),u=s((t?t:n<0?"#000000":"#FFFFFF").slice(1),16),c=o>>16,h=o>>8&255,p=o&255;return"#"+(16777216+(i(((u>>16)-c)*r)+c)*65536+(i(((u>>8&255)-h)*r)+h)*256+(i(((u&255)-p)*r)+p)).toString(16).slice(1)},__expandRect:function(e){var t={top:e[0].top,left:e[0].left,width:e[0].width,height:e[0].height};for(var n=1;n<e.length;++n)e[n].top<t.top&&(t.top=e[n].top),e[n].left<t.left&&(t.left=e[n].left),e[n].top+e[n].height>t.top+t.height&&(t.height=e[n].top+e[n].height-t.top),e[n].left+e[n].width>t.left+t.width&&(t.width=e[n].left+e[n].width-t.left);return t},__inRect:function(e,t,n){return n===undefined&&(n={x:0,y:0,z:1}),(e.y-n.y)/n.z>=t.top&&(e.x-n.x)/n.z>=t.left&&(e.y-n.y)/n.z<=t.top+t.height&&(e.x-n.x)/n.z<=t.left+t.width?!0:!1},__rectInRect:function(e,t){return!(t.left>e.left+e.width||t.left+t.width<e.left||t.top>e.top+e.height||t.top+t.height<e.top)},__drawRect:function(e,t,n){n.strokeStyle=t,n.strokeRect(e.left,e.top,e.width,e.height)},__drawRoundedRect:function(e,t,n,r,i){i.save(),i.strokeStyle=t,i.fillStyle=t,i.lineWidth=n>0?n:1,i.beginPath(),i.moveTo(e.left+r,e.top),i.arcTo(e.left+e.width,e.top,e.left+e.width,e.top+r,r),i.arcTo(e.left+e.width,e.top+e.height,e.left+e.width-r,e.top+e.height,r),i.arcTo(e.left,e.top+e.height,e.left,e.top+e.height-r,r),i.arcTo(e.left,e.top,e.left+r,e.top,r),i.closePath(),n==-1?i.fill():i.stroke(),i.restore()},__update:function(e){this._lastUpdate||(this._lastUpdate=e);var t=(e-this._lastUpdate)/1e3;this._lastUpdate=e;var n=this;$(".wcPlayEditorMenuOptionUndo").each(function(){$(this).toggleClass("disabled",!n._undoManager.canUndo()).find(".wcButton").toggleClass("disabled",!n._undoManager.canUndo()),$(this).attr("title","Undo "+n._undoManager.undoInfo())}),$(".wcPlayEditorMenuOptionRedo").each(function(){$(this).toggleClass("disabled",!n._undoManager.canRedo()).find(".wcButton").toggleClass("disabled",!n._undoManager.canRedo()),$(this).attr("title","Redo "+n._undoManager.redoInfo())}),$(".wcPlayEditorMenuOptionDebugging").children("i:first-child, span:first-child").toggleClass("fa-dot-circle-o",this._engine.debugging()).toggleClass("fa-circle-o",!this._engine.debugging()),$(".wcPlayEditorMenuOptionSilence").children(":first-child, span:first-child").toggleClass("fa-volume-off",this._engine.silent()).toggleClass("fa-volume-up",!this._engine.silent()),$(".wcPlayEditorMenuOptionPausePlay").children("i:first-child, span:first-child").toggleClass("fa-play",this._engine.paused()).toggleClass("fa-pause",!this._engine.paused()),$(".wcPlayEditorMenuOptionDelete").toggleClass("disabled",this._selectedNodes.length===0),$(".wcPlayEditorMenuOptionComposite").toggleClass("disabled",this._selectedNodes.length===0),this.onResized();if(this._engine){this.__drawPalette(t),this._viewportContext.clearRect(0,0,this.$viewport.width(),this.$viewport.height()),this._viewportContext.save(),this._viewportContext.translate(this._viewportCamera.x,this._viewportCamera.y),this._viewportContext.scale(this._viewportCamera.z,this._viewportCamera.z),this.__updateNodes(this._engine._entryNodes,t),this.__updateNodes(this._engine._processNodes,t),this.__updateNodes(this._engine._compositeNodes,t),this.__updateNodes(this._engine._storageNodes,t),this.__drawNodes(this._engine._entryNodes,this._viewportContext),this.__drawNodes(this._engine._processNodes,this._viewportContext),this.__drawNodes(this._engine._compositeNodes,this._viewportContext),this.__drawNodes(this._engine._storageNodes,this._viewportContext),this.__drawChains(this._engine._entryNodes,this._viewportContext),this.__drawChains(this._engine._processNodes,this._viewportContext),this.__drawChains(this._engine._compositeNodes,this._viewportContext),this.__drawChains(this._engine._storageNodes,this._viewportContext);if(this._highlightRect){var r=Math.min(10,this._highlightRect.width/2,this._highlightRect.height/2);this.__drawRoundedRect(this._highlightRect,"rgba(0, 255, 255, 0.25)",-1,r,this._viewportContext),this.__drawRoundedRect(this._highlightRect,"darkcyan",2,r,this._viewportContext)}this._viewportContext.restore()}window.requestAnimationFrame(this.__update.bind(this))},__updateNodes:function(e,t){for(var n=0;n<e.length;++n)this.__updateNode(e[n],t)},__updateNode:function(e,t){function r(e,r,i,s,o,u){e.flash?(e.flashDelta+=t*10,e.flashDelta>=1&&(e.flashDelta=1,!e.awake&&(!e.paused||!o&&!n._engine.paused())&&(e.flash=!1))):e.flashDelta>0&&(e.flashDelta-=t*5,e.flashDelta<=0&&(e.flashDelta=0,e.paused=o?e.paused:!1)),e.color=n.__blendColors(r,e.paused?s:i,e.flashDelta*u)}var n=this,i=e.color;this._highlightNode===e&&(i=this.__blendColors(e.color,"#00FFFF",.5)),r(e._meta,i,"#FFFFFF","#FFFFFF",!0,.5);var s="#000000",o="#117711",u="#FFFF00";for(var a=0;a<e.chain.entry.length;++a)r(e.chain.entry[a].meta,s,u,u,!1,.9);for(var a=0;a<e.chain.exit.length;++a)r(e.chain.exit[a].meta,s,u,u,!1,.9);for(var a=0;a<e.properties.length;++a)r(e.properties[a].inputMeta,o,u,u,!1,.9),r(e.properties[a].outputMeta,o,u,u,!1,.9)},__typeIndex:function(e){switch(e){case wcPlay.NODE_TYPE.ENTRY:return 0;case wcPlay.NODE_TYPE.PROCESS:return 1;case wcPlay.NODE_TYPE.STORAGE:return 2;case wcPlay.NODE_TYPE.COMPOSITE:return 3}},__setupMenu:function(){var e=$('      <ul class="wcPlayEditorMenu wcPlayNoHighlights">        <span class="wcPlayVersionTag wcPlayNoHighlights"></span>        <li><span>File</span>          <ul>            <li><span class="wcPlayEditorMenuOptionNew wcPlayMenuItem"><i class="wcPlayEditorMenuIcon wcButton fa fa-file-o fa-lg"/>New Script...<span>Ctrl+N</span></span></li>            <li><span class="wcPlayEditorMenuOptionOpen wcPlayMenuItem disabled"><i class="wcPlayEditorMenuIcon wcButton fa fa-folder-open-o fa-lg"/>Open Script...<span>Ctrl+O</span></span></li>            <li><span class="wcPlayEditorMenuOptionSave wcPlayMenuItem disabled"><i class="wcPlayEditorMenuIcon wcButton fa fa-save fa-lg"/>Save Script<span>Ctrl+S</span></span></li>          </ul>        </li>        <li><span>Edit</span>          <ul>            <li><span class="wcPlayEditorMenuOptionUndo wcPlayMenuItem disabled"><i class="wcPlayEditorMenuIcon wcButton fa fa-backward fa-lg"/>Undo<span>Ctrl+Z</span></span></li>            <li><span class="wcPlayEditorMenuOptionRedo wcPlayMenuItem disabled"><i class="wcPlayEditorMenuIcon wcButton fa fa-forward fa-lg"/>Redo<span>Ctrl+Y</span></span></li>            <li><hr class="wcPlayMenuSeparator"></li>            <li><span class="wcPlayEditorMenuOptionCut wcPlayMenuItem disabled"><i class="wcPlayEditorMenuIcon wcButton fa fa-cut fa-lg"/>Cut<span>Ctrl+X</span></span></li>            <li><span class="wcPlayEditorMenuOptionCopy wcPlayMenuItem disabled"><i class="wcPlayEditorMenuIcon wcButton fa fa-copy fa-lg"/>Copy<span>Ctrl+C</span></span></li>            <li><span class="wcPlayEditorMenuOptionPaste wcPlayMenuItem disabled"><i class="wcPlayEditorMenuIcon wcButton fa fa-paste fa-lg"/>Paste<span>Ctrl+P</span></span></li>            <li><span class="wcPlayEditorMenuOptionDelete wcPlayMenuItem"><i class="wcPlayEditorMenuIcon wcButton fa fa-trash-o fa-lg"/>Delete<span>Del</span></span></li>            <li><hr class="wcPlayMenuSeparator"></li>            <li><span class="wcPlayEditorMenuOptionComposite wcPlayMenuItem" title="Combine all selected nodes into a new \'Composite\' Node."><i class="wcPlayEditorMenuIcon wcButton fa fa-share-alt-square fa-lg"/>Create Composite<span></span></span></li>          </ul>        </li>        <li><span>Debugging</span>          <ul>            <li><span class="wcPlayEditorMenuOptionDebugging wcPlayMenuItem" title="Toggle debugging mode for the entire script."><i class="wcPlayEditorMenuIcon wcButton fa fa-dot-circle-o fa-lg"/>Toggle Debug Mode<span></span></span></li>            <li><span class="wcPlayEditorMenuOptionSilence wcPlayMenuItem" title="Toggle silent mode for the entire script (Nodes with debug log enabled will not log when this is active)."><i class="wcPlayEditorMenuIcon wcButton fa fa-volume-up fa-lg"/>Toggle Silence Mode<span></span></span></li>            <li><hr class="wcPlayMenuSeparator"></li>            <li><span class="wcPlayEditorMenuOptionRestart wcPlayMenuItem" title="Reset all property values to their initial state and restart the execution of the script."><i class="wcPlayEditorMenuIcon wcButton fa fa-refresh fa-lg"/>Restart Script<span></span></span></li>            <li><span class="wcPlayEditorMenuOptionPausePlay wcPlayMenuItem" title="Pause or Continue execution of the script."><i class="wcPlayEditorMenuIcon wcButton fa fa-pause fa-lg"/>Pause/Continue Script<span>Return</span></span></li>            <li><span class="wcPlayEditorMenuOptionStep wcPlayMenuItem" title="Steps execution of the script by a single update."><i class="wcPlayEditorMenuIcon wcButton fa fa-forward fa-lg"/>Step Script<span>Spacebar</span></span></li>          </ul>        </li>        <li><span>Help</span>          <ul>            <li><span class="wcPlayEditorMenuOptionDocs wcPlayMenuItem" title="Open the documentation for wcPlay in another window."><i class="wcPlayEditorMenuIcon wcButton fa fa-file-pdf-o fa-lg"/>Documentation...<span></span></span></li>            <li><span class="wcPlayEditorMenuOptionAbout wcPlayMenuItem disabled"><i class="wcPlayEditorMenuIcon wcButton fa fa-question fa-lg"/>About...<span></span></span></li>          </ul>        </li>      </ul>    '),t=$('      <div class="wcPlayEditorToolbar wcPlayNoHighlights">        <div class="wcPlayEditorMenuOptionNew"><span class="wcPlayEditorMenuIcon wcButton fa fa-file-o fa-lg" title="New Project"/></div>        <div class="wcPlayEditorMenuOptionOpen disabled"><span class="wcPlayEditorMenuIcon wcButton fa fa-folder-open-o fa-lg" title="Open Project"></div>        <div class="wcPlayEditorMenuOptionSave disabled"><span class="wcPlayEditorMenuIcon wcButton fa fa-save fa-lg" title="Save Project"></div>        <div class="ARPG_Separator"></div>        <div class="wcPlayEditorMenuOptionUndo"><span class="wcPlayEditorMenuIcon wcButton fa fa-backward fa-lg"/></div>        <div class="wcPlayEditorMenuOptionRedo"><span class="wcPlayEditorMenuIcon wcButton fa fa-forward fa-lg"/></div>        <div class="ARPG_Separator"></div>        <div class="wcPlayEditorMenuOptionCut disabled"><span class="wcPlayEditorMenuIcon wcButton fa fa-cut fa-lg" title="Cut"/></div>        <div class="wcPlayEditorMenuOptionCopy disabled"><span class="wcPlayEditorMenuIcon wcButton fa fa-copy fa-lg" title="Copy"/></div>        <div class="wcPlayEditorMenuOptionPaste disabled"><span class="wcPlayEditorMenuIcon wcButton fa fa-paste fa-lg" title="Paste"/></div>        <div class="wcPlayEditorMenuOptionDelete"><span class="wcPlayEditorMenuIcon wcButton fa fa-trash-o fa-lg" title="Delete"/></div>        <div class="ARPG_Separator"></div>        <div class="wcPlayEditorMenuOptionComposite"><span class="wcPlayEditorMenuIcon wcButton fa fa-share-alt-square fa-lg" title="Combine all selected nodes into a new \'Composite\' Node."/></div>        <div class="ARPG_Separator"></div>        <div class="wcPlayEditorMenuOptionDebugging"><span class="wcPlayEditorMenuIcon wcButton fa fa-dot-circle-o fa-lg" title="Toggle debugging mode for the entire script."/></div>        <div class="wcPlayEditorMenuOptionSilence"><span class="wcPlayEditorMenuIcon wcButton fa fa-volume-up fa-lg" title="Toggle silent mode for the entire script (Nodes with debug log enabled will not log when this is active)."/></div>        <div class="ARPG_Separator"></div>        <div class="wcPlayEditorMenuOptionRestart"><span class="wcPlayEditorMenuIcon wcButton fa fa-refresh fa-lg" title="Reset all property values to their initial state and restart the execution of the script."/></div>        <div class="wcPlayEditorMenuOptionPausePlay"><span class="wcPlayEditorMenuIcon wcButton fa fa-pause fa-lg" title="Pause or Continue execution of the script."/></div>        <div class="wcPlayEditorMenuOptionStep"><span class="wcPlayEditorMenuIcon wcButton fa fa-forward fa-lg" title="Steps execution of the script by a single update."/></div>        <div class="ARPG_Separator"></div>        <div class="wcPlayEditorMenuOptionDocs"><span class="wcPlayEditorMenuIcon wcButton fa fa-file-pdf-o fa-lg" title="Open the documentation for wcPlay in another window."/></div>        <div class="wcPlayEditorMenuOptionAbout disabled"><span class="wcPlayEditorMenuIcon wcButton fa fa-question fa-lg"/></div>      </div>    ');this.$top.append(e),this.$top.append(t)},__setupPalette:function(){this.$typeButton.push($('<button class="wcPlayEditorButton" title="Show Entry Nodes.">Entry</button>')),this.$typeButton.push($('<button class="wcPlayEditorButton wcToggled" title="Show Process Nodes.">Process</button>')),this.$typeButton.push($('<button class="wcPlayEditorButton" title="Show Storage Nodes.">Storage</button>')),this.$typeButton.push($('<button class="wcPlayEditorButton" title="Show Composite Nodes.">Composite</button>')),this.$palette.append(this.$typeButton[0]),this.$palette.append(this.$typeButton[1]),this.$palette.append(this.$typeButton[2]),this.$palette.append(this.$typeButton[3]),this.$typeArea.push($('<div class="wcPlayTypeArea wcPlayHidden">')),this.$typeArea.push($('<div class="wcPlayTypeArea">')),this.$typeArea.push($('<div class="wcPlayTypeArea wcPlayHidden">')),this.$typeArea.push($('<div class="wcPlayTypeArea wcPlayHidden">')),this.$paletteInner.append(this.$typeArea[0]),this.$paletteInner.append(this.$typeArea[1]),this.$paletteInner.append(this.$typeArea[2]),this.$paletteInner.append(this.$typeArea[3]);for(var e=0;e<wcPlay.NODE_LIBRARY.length;++e){var t=wcPlay.NODE_LIBRARY[e];this._nodeLibrary.hasOwnProperty(t.category)||(this._nodeLibrary[t.category]={});if(!this._nodeLibrary[t.category].hasOwnProperty(t.type)){var n={$category:$('<div class="wcPlayTypeCategory">'),$button:$('<button class="wcPlayCategoryButton wcToggled" title="Toggle visibility of this category.">'+t.category+"</button>"),$canvas:$('<canvas class="wcPlayTypeCategoryArea">'),context:null,nodes:[]};n.context=n.$canvas[0].getContext("2d"),n.$category.append(n.$button),n.$category.append(n.$canvas),this.$typeArea[this.__typeIndex(t.type)].append(n.$category),function(t){t.$button.click(function(){t.$button.hasClass("wcToggled")?(t.$button.removeClass("wcToggled"),t.$canvas.addClass("wcPlayHidden")):(t.$button.addClass("wcToggled"),t.$canvas.removeClass("wcPlayHidden"))})}(n),this._nodeLibrary[t.category][t.type]=n}var r=new window[t.name](null);this._nodeLibrary[t.category][t.type].nodes.push(r),this.__updateNode(r,0)}for(var i in this._nodeLibrary)for(var s in this._nodeLibrary[i]){var n=this._nodeLibrary[i][s];n.$canvas.attr("width",this.$paletteInner.width());var o=this._drawStyle.palette.spacing,u=this.$paletteInner.width()/2;for(var e=0;e<n.nodes.length;++e){var a=this.__drawNode(n.nodes[e],{x:u,y:o},n.context,!0);o+=a.rect.height+this._drawStyle.palette.spacing}n.$canvas.attr("height",o)}var f=this;this.$typeButton[0].click(function(){f.$typeButton[0].addClass("wcToggled"),f.$typeButton[1].removeClass("wcToggled"),f.$typeButton[2].removeClass("wcToggled"),f.$typeButton[3].removeClass("wcToggled"),f.$typeArea[0].removeClass("wcPlayHidden"),f.$typeArea[1].addClass("wcPlayHidden"),f.$typeArea[2].addClass("wcPlayHidden"),f.$typeArea[3].addClass("wcPlayHidden")}),this.$typeButton[1].click(function(){f.$typeButton[0].removeClass("wcToggled"),f.$typeButton[1].addClass("wcToggled"),f.$typeButton[2].removeClass("wcToggled"),f.$typeButton[3].removeClass("wcToggled"),f.$typeArea[0].addClass("wcPlayHidden"),f.$typeArea[1].removeClass("wcPlayHidden"),f.$typeArea[2].addClass("wcPlayHidden"),f.$typeArea[3].addClass("wcPlayHidden")}),this.$typeButton[2].click(function(){f.$typeButton[0].removeClass("wcToggled"),f.$typeButton[1].removeClass("wcToggled"),f.$typeButton[2].addClass("wcToggled"),f.$typeButton[3].removeClass("wcToggled"),f.$typeArea[0].addClass("wcPlayHidden"),f.$typeArea[1].addClass("wcPlayHidden"),f.$typeArea[2].removeClass("wcPlayHidden"),f.$typeArea[3].addClass("wcPlayHidden")}),this.$typeButton[3].click(function(){f.$typeButton[0].removeClass("wcToggled"),f.$typeButton[1].removeClass("wcToggled"),f.$typeButton[2].removeClass("wcToggled"),f.$typeButton[3].addClass("wcToggled"),f.$typeArea[0].addClass("wcPlayHidden"),f.$typeArea[1].addClass("wcPlayHidden"),f.$typeArea[2].addClass("wcPlayHidden"),f.$typeArea[3].removeClass("wcPlayHidden")})},__drawPalette:function(e){for(var t in this._nodeLibrary)for(var n in this._nodeLibrary[t]){if(!this.$typeButton[this.__typeIndex(n)].hasClass("wcToggled"))continue;var r=this._nodeLibrary[t][n];if(!r.$button.hasClass("wcToggled"))continue;var i=this._drawStyle.palette.spacing,s=this.$paletteInner.width()/2;r.$canvas.attr("width",this.$paletteInner.width()),r.context.clearRect(0,0,r.$canvas.width(),r.$canvas.height()),r.context.save(),this.__updateNodes(r.nodes,e);for(var o=0;o<r.nodes.length;++o){var u=this.__drawNode(r.nodes[o],{x:s,y:i},r.context,!0);i+=u.rect.height+this._drawStyle.palette.spacing}r.context.restore()}},__drawNodes:function(e,t,n){for(var r=0;r<e.length;++r)this.__drawNode(e[r],e[r].pos,t,n)},__drawNode:function(e,t,n,r){var i={node:e,rect:{top:t.y,left:t.x,width:0,height:0}},s=this.__measureEntryLinks(e,n,t),o=this.__measureCenter(e,n,{x:t.x,y:t.y+s.height},r),u=this.__measureExitLinks(e,n,{x:t.x,y:t.y+s.height+o.height}),a=this.__expandRect([s,o,u]);a.top=o.top,a.height=o.height,a.initialWidth=o.initialWidth,a.valueWidth=o.valueWidth,i.rect=this.__expandRect([s,o,u]),i.inner=this.__expandRect([o]),i.inner.left=i.rect.left,i.inner.width=i.rect.width,i.rect.top-=3,i.rect.left-=this._drawStyle.links.length+3,i.rect.width+=this._drawStyle.links.length*2+6,i.rect.height+=6,e.chain.entry.length?(i.inner.top-=this._drawStyle.links.padding+this._font.links.size,i.inner.height+=this._drawStyle.links.padding+this._font.links.size):(i.rect.top-=this._drawStyle.links.length,i.rect.height+=this._drawStyle.links.length),e.chain.exit.length?i.inner.height+=this._drawStyle.links.padding+this._font.links.size:i.rect.height+=this._drawStyle.links.length;var f=this.__drawCenter(e,n,a,r),l=this.__drawEntryLinks(e,n,t,s.width),c=this.__drawExitLinks(e,n,{x:t.x,y:t.y+s.height+o.height},u.width);return i.entryBounds=l,i.exitBounds=c,i.titleBounds=f.titleBounds,i.viewportBounds=f.viewportBounds,i.inputBounds=f.inputBounds,i.outputBounds=f.outputBounds,i.propertyBounds=f.propertyBounds,i.valueBounds=f.valueBounds,i.initialBounds=f.initialBounds,i.farRect={top:i.inner.top-i.inner.height/4,left:i.inner.left-i.inner.width/4,width:i.inner.width*1.5,height:i.inner.height*1.5},i.collapser={left:i.inner.left+4,top:i.inner.top+4+(e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0),width:this._drawStyle.node.margin-5,height:this._font.title.size-4},n.save(),n.fillStyle=this._highlightCollapser&&this._highlightNode===e?"cyan":"white",n.strokeStyle="black",n.lineWidth=1,n.fillRect(i.collapser.left,i.collapser.top,i.collapser.width,i.collapser.height),n.strokeRect(i.collapser.left,i.collapser.top,i.collapser.width,i.collapser.height),n.strokeStyle="black",n.lineWidth=2,n.beginPath(),n.moveTo(i.collapser.left+1,i.collapser.top+i.collapser.height/2),n.lineTo(i.collapser.left+i.collapser.width-1,i.collapser.top+i.collapser.height/2),e.collapsed()&&(n.moveTo(i.collapser.left+i.collapser.width/2,i.collapser.top+1),n.lineTo(i.collapser.left+i.collapser.width/2,i.collapser.top+i.collapser.height-1)),n.stroke(),n.restore(),i.breakpoint={left:i.inner.left+i.inner.width-this._drawStyle.node.margin+2,top:i.inner.top+4+(e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0),width:this._drawStyle.node.margin-5,height:this._font.title.size-4},n.save(),n.fillStyle=this._highlightBreakpoint&&this._highlightNode===e?"cyan":"white",n.fillRect(i.breakpoint.left,i.breakpoint.top,i.breakpoint.width,i.breakpoint.height),n.strokeStyle=e._break?"darkred":"black",n.fillStyle="darkred",n.lineWidth=2,n.beginPath(),n.arc(i.breakpoint.left+i.breakpoint.width/2,i.breakpoint.top+i.breakpoint.height/2,Math.min(i.breakpoint.width/2-2,i.breakpoint.height/2-2),0,2*Math.PI),e._break&&n.fill(),n.stroke(),n.strokeStyle="black",n.lineWidth=1,n.strokeRect(i.breakpoint.left,i.breakpoint.top,i.breakpoint.width,i.breakpoint.height),n.restore(),e._meta.flashDelta&&(e._meta.paused?this.__drawRoundedRect(i.inner,"#CC0000",5,10,n):this.__drawRoundedRect(i.inner,"yellow",2,10,n)),this._selectedNodes.indexOf(e)>-1&&(this.__drawRoundedRect(i.rect,"rgba(0, 255, 255, 0.25)",-1,10,n),this.__drawRoundedRect(i.rect,"darkcyan",2,10,n)),e._meta.bounds=i,i},__measureEntryLinks:function(e,t,n){var r={top:n.y,left:n.x,width:0,height:0};this.__setCanvasFont(this._font.links,t);var i=e.collapsed(),s=e.chain.entry;for(var o=0;o<s.length;++o)if(!i||s[o].links.length)r.width+=t.measureText(s[o].name).width+this._drawStyle.links.spacing;return r.left-=r.width/2+this._drawStyle.links.margin,r.width+=this._drawStyle.links.margin*2,e.chain.entry.length&&(r.height=this._font.links.size+this._drawStyle.links.padding+this._drawStyle.links.length),r},__measureExitLinks:function(e,t,n){var r={top:n.y,left:n.x,width:0,height:0};this.__setCanvasFont(this._font.links,t);var i=e.collapsed(),s=e.chain.exit;for(var o=0;o<s.length;++o)if(!i||s[o].links.length)r.width+=t.measureText(s[o].name).width+this._drawStyle.links.spacing;return r.left-=r.width/2+this._drawStyle.links.margin,r.width+=this._drawStyle.links.margin*2,e.chain.exit.length&&(r.height=this._font.links.size+this._drawStyle.links.padding+this._drawStyle.links.length),r},__measureCenter:function(e,t,n,r){var i={top:n.y,left:n.x,width:0,height:this._font.title.size+this._drawStyle.title.spacing+this._drawStyle.links.padding};this.__setCanvasFont(this._font.title,t),i.width=t.measureText(this._drawStyle.title.wrapL+e.type+(e.name?": ":"")+this._drawStyle.title.wrapR).width,e.name&&(this.__setCanvasFont(this._font.titleDesc,t),i.width+=t.measureText(e.name).width),e._viewportSize&&(i.width=Math.max(i.width,e._viewportSize.x),i.height+=e._viewportSize.y+this._drawStyle.property.spacing);var s=0,o=0,u=0,a=e.collapsed(),f=e.properties;for(var l=0;l<f.length;++l)if(!a&&!r||!f[l].options.collapsible||f[l].inputs.length||f[l].outputs.length)i.height+=this._font.property.size+this._drawStyle.property.spacing,this.__setCanvasFont(this._font.property,t),s=Math.max(t.measureText(f[l].name+": ").width,s),this.__setCanvasFont(this._font.value,t),o=Math.max(t.measureText(this._drawStyle.property.valueWrapL+this.__drawPropertyValue(e,f[l])+this._drawStyle.property.valueWrapR).width,this._drawStyle.property.minLength,o),this.__setCanvasFont(this._font.initialValue,t),u=Math.max(t.measureText(this._drawStyle.property.initialWrapL+this.__drawPropertyValue(e,f[l],!0)+this._drawStyle.property.initialWrapR).width,this._drawStyle.property.minLength,u);return i.width=Math.max(s+o+u,i.width)+this._drawStyle.node.margin*2,i.left-=i.width/2,i.initialWidth=u,i.valueWidth=o,i},__drawEntryLinks:function(e,t,n,r){var i=n.x-r/2+this._drawStyle.links.margin,s=n.y+this._drawStyle.links.length+this._font.links.size;this.__setCanvasFont(this._font.links,t);var o=[],u=e.collapsed(),a=e.chain.entry;for(var f=0;f<a.length;++f)if(!u||a[f].links.length){t.fillStyle="black";var l=t.measureText(a[f].name).width+this._drawStyle.links.spacing;t.fillText(a[f].name,i+this._drawStyle.links.spacing/2,s);var c={top:s-this._drawStyle.links.length-this._font.links.size,left:i+l/2-this._drawStyle.links.width/2,width:this._drawStyle.links.width,height:this._drawStyle.links.length};t.fillStyle=this._highlightEntryLink&&this._highlightEntryLink.name===a[f].name&&this._highlightNode===e?"cyan":a[f].meta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(c.left,c.top),t.lineTo(c.left+c.width/2,c.top+c.height/3),t.lineTo(c.left+c.width,c.top),t.lineTo(c.left+c.width,c.top+c.height),t.lineTo(c.left,c.top+c.height),t.closePath(),t.stroke(),t.fill(),c.left-=5,c.width+=10,o.push({rect:c,point:{x:c.left+c.width/2,y:c.top+c.height/3-2},name:a[f].name}),i+=l}return o},__drawExitLinks:function(e,t,n,r){var i=n.x-r/2+this._drawStyle.links.margin,s=n.y+this._font.links.size;this.__setCanvasFont(this._font.links,t);var o=[],u=e.collapsed(),a=e.chain.exit;for(var f=0;f<a.length;++f)if(!u||a[f].links.length){t.fillStyle="black";var l=t.measureText(a[f].name).width+this._drawStyle.links.spacing;t.fillText(a[f].name,i+this._drawStyle.links.spacing/2,s);var c={top:s+this._drawStyle.links.padding,left:i+l/2-this._drawStyle.links.width/2,width:this._drawStyle.links.width,height:this._drawStyle.links.length};t.fillStyle=this._highlightExitLink&&this._highlightExitLink.name===a[f].name&&this._highlightNode===e?"cyan":a[f].meta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(c.left,c.top),t.lineTo(c.left+c.width,c.top),t.lineTo(c.left+c.width,c.top+c.height/2),t.lineTo(c.left+c.width/2,c.top+c.height),t.lineTo(c.left,c.top+c.height/2),t.closePath(),t.stroke(),t.fill(),c.left-=5,c.width+=10,o.push({rect:c,point:{x:c.left+c.width/2,y:c.top+c.height+1},name:a[f].name}),i+=l}return o},__drawCenter:function(e,t,n,r){var i=e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0,s=e.chain.exit.length?this._font.links.size+this._drawStyle.links.padding:0,o={titleBounds:null,viewportBounds:null,propertyBounds:[],valueBounds:[],initialBounds:[],inputBounds:[],outputBounds:[]},u;t.save();var a=n.left+n.width/2,f=n.top+n.height/2,l=t.createRadialGradient(a,f,10,a,f,Math.max(n.width,n.height));l.addColorStop(0,e.enabled()?e._meta.color:"#555"),l.addColorStop(1,"white"),t.fillStyle=t.strokeStyle=l,t.lineJoin="round";var c=this._drawStyle.node.radius*2;t.lineWidth=c,t.fillRect(n.left+c/2,n.top-i+c/2,n.width-c,n.height+i+s-c),t.strokeRect(n.left+c/2,n.top-i+c/2,n.width-c,n.height+i+s-c),t.restore(),this.__drawRoundedRect({left:n.left,top:n.top-i,width:n.width,height:n.height+i+s},e._meta.color,3,this._drawStyle.node.radius,t),i=0,e.chain.entry.length&&(t.strokeStyle=e._meta.color,t.beginPath(),t.moveTo(n.left,n.top+i),t.lineTo(n.left+n.width,n.top+i),t.stroke()),o.titleBounds={top:n.top+i,left:n.left+this._drawStyle.node.margin,width:n.width-this._drawStyle.node.margin*2,height:this._font.title.size+this._drawStyle.title.spacing-1},this._highlightTitle&&this._highlightNode===e&&(t.save(),t.fillStyle="cyan",t.fillRect(o.titleBounds.left,o.titleBounds.top,o.titleBounds.width,o.titleBounds.height),t.restore()),this.__setCanvasFont(this._font.title,t);var h=t.measureText(this._drawStyle.title.wrapL+e.type+(e.name?": ":"")).width,p=t.measureText(this._drawStyle.title.wrapR).width,d=0;e.name&&(this.__setCanvasFont(this._font.titleDesc,t),d=t.measureText(e.name).width),t.save(),i+=this._font.title.size,t.fillStyle="black",t.strokeStyle="black",t.textAlign="left",this.__setCanvasFont(this._font.title,t),t.fillText(this._drawStyle.title.wrapL+e.type+(e.name?": ":""),n.left+(n.width-(h+p+d))/2,n.top+i),e.name&&(this.__setCanvasFont(this._font.titleDesc,t),t.fillText(e.name,n.left+h+(n.width-(h+p+d))/2,n.top+i)),t.textAlign="right",this.__setCanvasFont(this._font.title,t),t.fillText(this._drawStyle.title.wrapR,n.left+n.width-(n.width-(h+p+d))/2,n.top+i),t.restore(),i+=this._drawStyle.title.spacing,e._viewportSize&&(o.viewportBounds={top:n.top+i,left:n.left+(n.width/2-e._viewportSize.x/2),width:e._viewportSize.x,height:e._viewportSize.y},t.save(),t.translate(o.viewportBounds.left,o.viewportBounds.top),e.onViewportDraw(t),t.translate(-o.viewportBounds.left,-o.viewportBounds.top),t.restore(),i+=e._viewportSize.y+this._drawStyle.property.spacing),t.save();var v=e.collapsed(),m=e.properties;for(var g=0;g<m.length;++g)if(!v&&!r||!m[g].options.collapsible||m[g].inputs.length||m[g].outputs.length){i+=this._font.property.size;var y={rect:{top:n.top+i-this._font.property.size,left:n.left+this._drawStyle.node.margin,width:n.width-this._drawStyle.node.margin*2,height:this._font.property.size+this._drawStyle.property.spacing},name:m[g].name};o.propertyBounds.push(y);var b={rect:{top:n.top+i-this._font.property.size,left:n.left+n.width-this._drawStyle.node.margin-n.initialWidth,width:n.initialWidth,height:this._font.property.size+this._drawStyle.property.spacing},name:m[g].name};o.initialBounds.push(b);var w={rect:{top:n.top+i-this._font.property.size,left:n.left+n.width-this._drawStyle.node.margin-n.valueWidth-n.initialWidth,width:n.valueWidth,height:this._font.property.size+this._drawStyle.property.spacing},name:m[g].name};o.valueBounds.push(w),t.fillStyle="cyan",this._highlightNode===e&&this._highlightPropertyValue&&this._highlightPropertyValue.name===m[g].name&&t.fillRect(w.rect.left,w.rect.top,w.rect.width,w.rect.height),this._highlightNode===e&&this._highlightPropertyInitialValue&&this._highlightPropertyInitialValue.name===m[g].name&&t.fillRect(b.rect.left,b.rect.top,b.rect.width,b.rect.height),t.fillStyle="black",t.textAlign="left",this.__setCanvasFont(this._font.property,t),t.fillText(m[g].name+": ",n.left+this._drawStyle.node.margin,n.top+i),t.textAlign="right",this.__setCanvasFont(this._font.initialValue,t),t.fillStyle="#444444",t.fillText(this._drawStyle.property.initialWrapL+this.__drawPropertyValue(e,m[g],!0)+this._drawStyle.property.initialWrapR,n.left+n.width-this._drawStyle.node.margin,n.top+i),this.__setCanvasFont(this._font.value,t),t.fillStyle="black",t.fillText(this._drawStyle.property.valueWrapL+this.__drawPropertyValue(e,m[g])+this._drawStyle.property.valueWrapR,n.left+n.width-this._drawStyle.node.margin-n.initialWidth,n.top+i);if(!v||m[g].inputs.length)u={top:n.top+i-this._font.property.size/3-this._drawStyle.links.width/2,left:n.left-this._drawStyle.links.length,width:this._drawStyle.links.length,height:this._drawStyle.links.width},t.fillStyle=this._highlightInputLink&&this._highlightInputLink.name===m[g].name&&this._highlightNode===e?"cyan":m[g].inputMeta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(u.left,u.top),t.lineTo(u.left+u.width,u.top),t.lineTo(u.left+u.width,u.top+u.height),t.lineTo(u.left,u.top+u.height),t.lineTo(u.left+u.width/3,u.top+u.height/2),t.closePath(),t.stroke(),t.fill(),u.top-=5,u.height+=10,o.inputBounds.push({rect:u,point:{x:u.left+u.width/3-2,y:u.top+u.height/2},name:m[g].name});if(!v||m[g].outputs.length)u={top:n.top+i-this._font.property.size/3-this._drawStyle.links.width/2,left:n.left+n.width,width:this._drawStyle.links.length,height:this._drawStyle.links.width},t.fillStyle=this._highlightOutputLink&&this._highlightOutputLink.name===m[g].name&&this._highlightNode===e?"cyan":m[g].outputMeta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(u.left,u.top),t.lineTo(u.left+u.width/2,u.top),t.lineTo(u.left+u.width,u.top+u.height/2),t.lineTo(u.left+u.width/2,u.top+u.height),t.lineTo(u.left,u.top+u.height),t.closePath(),t.stroke(),t.fill(),u.top-=5,u.height+=10,o.outputBounds.push({rect:u,point:{x:u.left+u.width+1,y:u.top+u.height/2},name:m[g].name});i+=this._drawStyle.property.spacing}return t.restore(),e.chain.exit.length&&(t.strokeStyle=e._meta.color,t.beginPath(),t.moveTo(n.left,n.top+n.height),t.lineTo(n.left+n.width,n.top+n.height),t.stroke()),o},__drawChains:function(e,t){for(var n=0;n<e.length;++n)this.__drawNodeChains(e[n],t)},__drawNodeChains:function(e,t){for(var n=0;n<e.chain.exit.length;++n){var r=e.chain.exit[n];if(!r.links.length)continue;var i;for(var s=0;s<e._meta.bounds.exitBounds.length;++s)if(e._meta.bounds.exitBounds[s].name===r.name){i=e._meta.bounds.exitBounds[s].point;break}if(!i){console.log("ERROR: Attempted to draw chains for an exit link that has no meta data.");continue}for(var s=0;s<r.links.length;++s){var o=r.links[s].node,u=r.links[s].name,a;for(var f=0;f<o.chain.entry.length;++f)if(o.chain.entry[f].name===u){a=o.chain.entry[f];break}if(!a){console.log("ERROR: Attempted to chain an exit link to an entry link that was not found.");continue}var l;for(var f=0;f<o._meta.bounds.entryBounds.length;++f)if(o._meta.bounds.entryBounds[f].name===a.name){l=o._meta.bounds.entryBounds[f].point;break}if(!l){console.log("ERROR: Attempted to draw chains to an entry link that has no meta data.");continue}var c=r.meta.flashDelta>0&&a.meta.flashDelta>0,h=this._highlightNode===o&&this._highlightEntryLink&&this._highlightEntryLink.name===a.name||this._highlightNode===e&&this._highlightExitLink&&this._highlightExitLink.name===r.name;this.__drawFlowChain(i,l,e._meta.bounds.rect,o._meta.bounds.rect,t,c,h)}}for(var n=0;n<e.properties.length;++n){var p=e.properties[n];if(!p.outputs.length)continue;var d;for(var s=0;s<e._meta.bounds.outputBounds.length;++s)if(e._meta.bounds.outputBounds[s].name===p.name){d=e._meta.bounds.outputBounds[s].point;break}if(!d){console.log("ERROR: Attempted to draw chains for an output link that has no meta data.");continue}for(var s=0;s<p.outputs.length;++s){var o=p.outputs[s].node,u=p.outputs[s].name,v;for(var f=0;f<o.properties.length;++f)o.properties[f].name===u&&(v=o.properties[f]);if(!v){console.log("ERROR: Attempted to chain a property link to a property that was not found.");continue}var m;for(var f=0;f<o._meta.bounds.inputBounds.length;++f)if(o._meta.bounds.inputBounds[f].name===v.name){m=o._meta.bounds.inputBounds[f].point;break}if(!m){console.log("ERROR: Attempted to draw chains to a property input link that has no meta data.");continue}var c=p.outputMeta.flashDelta>0&&v.inputMeta.flashDelta>0,h=this._highlightNode===o&&this._highlightInputLink&&this._highlightInputLink.name===v.name||this._highlightNode===e&&this._highlightOutputLink&&this._highlightOutputLink.name===p.name;this.__drawPropertyChain(d,m,e._meta.bounds.rect,o._meta.bounds.rect,t,c,h)}}if(this._selectedNode===e&&this._selectedEntryLink){var g,y=null,h=!1;this._highlightNode&&this._highlightExitLink?(g=this._highlightExitLink.point,y=this._highlightExitLink.rect,h=!0):(g={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z},y={left:g.x,top:g.y,width:1,height:1});var b;for(var n=0;n<e._meta.bounds.entryBounds.length;++n)e._meta.bounds.entryBounds[n].name===this._selectedEntryLink.name&&(b=e._meta.bounds.entryBounds[n].point);this.__drawFlowChain(g,b,y,e._meta.bounds.rect,t,h)}if(this._selectedNode===e&&this._selectedExitLink){var g,y=null,h=!1;this._highlightNode&&this._highlightEntryLink?(g=this._highlightEntryLink.point,y=this._highlightEntryLink.rect,h=!0):(g={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z},y={left:g.x,top:g.y,width:1,height:1});var b;for(var n=0;n<e._meta.bounds.exitBounds.length;++n)e._meta.bounds.exitBounds[n].name===this._selectedExitLink.name&&(b=e._meta.bounds.exitBounds[n].point);this.__drawFlowChain(b,g,e._meta.bounds.rect,y,t,h)}if(this._selectedNode===e&&this._selectedInputLink){var g,y=null,h=!1;this._highlightNode&&this._highlightOutputLink?(g=this._highlightOutputLink.point,y=this._highlightOutputLink.rect,h=!0):(g={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z},y={left:g.x,top:g.y,width:1,height:1});var b;for(var n=0;n<e._meta.bounds.inputBounds.length;++n)e._meta.bounds.inputBounds[n].name===this._selectedInputLink.name&&(b=e._meta.bounds.inputBounds[n].point);this.__drawPropertyChain(g,b,y,e._meta.bounds.rect,t,h)}if(this._selectedNode===e&&this._selectedOutputLink){var g,y=null,h=!1;this._highlightNode&&this._highlightInputLink?(g=this._highlightInputLink.point,y=this._highlightInputLink.rect,h=!0):(g={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z},y={left:g.x,top:g.y,width:1,height:1});var b;for(var n=0;n<e._meta.bounds.outputBounds.length;++n)e._meta.bounds.outputBounds[n].name===this._selectedOutputLink.name&&(b=e._meta.bounds.outputBounds[n].point);this.__drawPropertyChain(b,g,e._meta.bounds.rect,y,t,h)}},__drawFlowChain:function(e,t,n,r,i,s,o){i.save(),i.strokeStyle=o?"cyan":s?"#CCCC00":"#000000",i.lineWidth=2,i.lineCap="round",i.lineJoin="round",i.beginPath(),i.moveTo(e.x,e.y);var u=15;if(e.y<t.y){var a=(t.x+e.x)/2,f=(t.y+e.y)/2,l=Math.min(u,Math.abs(t.x-e.x)/2,Math.abs(t.y-e.y)/2);i.arcTo(e.x,f,a,f,l),i.arcTo(t.x,f,t.x,t.y,l)}else if(n.left+n.width<r.left){var a=(r.left+n.left+n.width)/2-2,f=(t.y+e.y)/2,c=(a+e.x)/2,h=(t.x+a)/2,l=Math.min(u,Math.abs(t.y-e.y)/4,Math.abs(a-c),Math.abs(a-h));i.arcTo(e.x,e.y+l,c,e.y+l,l),i.arcTo(a,e.y+l,a,f,l),i.arcTo(a,t.y-l,h,t.y-l,l),i.arcTo(t.x,t.y-l,t.x,t.y,l)}else if(n.left>r.left+r.width){var a=(n.left+r.left+r.width)/2+2,f=(t.y+e.y)/2,c=(a+t.x)/2,h=(e.x+a)/2,l=Math.min(u,Math.abs(t.y-e.y)/4,Math.abs(a-c),Math.abs(a-h));i.arcTo(e.x,e.y+l,h,e.y+l,l),i.arcTo(a,e.y+l,a,f,l),i.arcTo(a,t.y-l,c,t.y-l,l),i.arcTo(t.x,t.y-l,t.x,t.y,l)}else if(e.y>t.y&&Math.abs(e.y-t.y)>this._drawStyle.links.length){var p=e.x,d=Math.min(n.top-u,r.top-u),v=Math.max(n.top+n.height+u,r.top+r.height+u),f=(e.y+t.y)/2;Math.abs(Math.min(n.left,r.left)-e.x)<=Math.abs(Math.max(n.left+n.width,r.left+r.width)-t.x)?(p=Math.min(n.left-u,r.left-u),v-=2):(p=Math.max(n.left+n.width+u,r.left+r.width+u),v+=2);var a=(e.x+p)/2,l=Math.min(u,Math.abs(p-e.x)/2,Math.abs(p-t.x)/2);i.arcTo(e.x,v,a,v,l),i.arcTo(p,v,p,f,l),i.arcTo(p,d,a,d,l),i.arcTo(t.x,d,t.x,t.y,l)}i.lineTo(t.x,t.y),i.stroke(),i.restore()},__drawPropertyChain:function(e,t,n,r,i,s,o){i.save(),i.strokeStyle=o?"cyan":s?"#AAFF33":"#33CC33",i.lineWidth=2,i.lineCap="round",i.lineJoin="round",i.beginPath(),i.moveTo(e.x,e.y);var u=15;if(e.x<t.x){var a=(t.x+e.x)/2,f=(t.y+e.y)/2,l=Math.min(u,Math.abs(t.x-e.x)/2,Math.abs(t.y-e.y)/2);i.arcTo(a,e.y,a,f,l),i.arcTo(a,t.y,t.x,t.y,l)}else if(n.top+n.height<r.top){var a=(t.x+e.x)/2,f=(r.top+n.top+n.height)/2-2,c=(f+e.y)/2,h=(t.y+f)/2,l=Math.min(u,Math.abs(t.x-e.x)/4,Math.abs(f-c),Math.abs(f-h));i.arcTo(e.x+l,e.y,e.x+l,c,l),i.arcTo(e.x+l,f,a,f,l),i.arcTo(t.x-l,f,t.x-l,h,l),i.arcTo(t.x-l,t.y,t.x,t.y,l)}else if(n.top>r.top+r.height){var a=(t.x+e.x)/2,f=(n.top+r.top+r.height)/2+2,c=(f+t.y)/2,h=(e.y+f)/2,l=Math.min(u,Math.abs(t.x-e.x)/4,Math.abs(f-c),Math.abs(f-h));i.arcTo(e.x+l,e.y,e.x+l,h,l),i.arcTo(e.x+l,f,a,f,l),i.arcTo(t.x-l,f,t.x-l,c,l),i.arcTo(t.x-l,t.y,t.x,t.y,l)}else if(e.x>t.x&&Math.abs(e.x-t.x)>this._drawStyle.links.length){var p=e.y,d=Math.max(n.left+n.width+u,r.left+r.width+u),v=Math.min(n.left-u,r.left-u),a=(e.x+t.x)/2;Math.abs(Math.min(n.top,r.top)-e.y)<=Math.abs(Math.max(n.top+n.height,r.top+r.height)-t.y)?(p=Math.min(n.top-u,r.top-u),d-=2):(p=Math.max(n.top+n.height+u,r.top+r.height+u),d+=2);var f=(e.y+p)/2,l=Math.min(u,Math.abs(p-e.y)/2,Math.abs(p-t.y)/2);i.arcTo(d,e.y,d,f,l),i.arcTo(d,p,a,p,l),i.arcTo(v,p,v,f,l),i.arcTo(v,t.y,t.x,t.y,l)}i.lineTo(t.x,t.y),i.stroke(),i.restore()},__drawPropertyValue:function(e,t,n){var r;n?r=e.initialProperty(t.name):r=e.property(t.name);if(typeof t.options.display=="function")r=t.options.display(r);else switch(t.type){case wcPlay.PROPERTY_TYPE.TOGGLE:return r?"yes":"no";case wcPlay.PROPERTY_TYPE.SELECT:if(r=="")return"<none>";var i=t.options.items;$.isFunction(i)&&(i=i.call(e));if($.isArray(i)){var s=!1;for(var o=0;o<i.length;++o)if(typeof i[o]=="object"){if(i[o].value==r){r=i[o].name,s=!0;break}}else if(typeof i[o]=="string"&&i[o]==r){s=!0;break}s||(r="Unknown")}}return this.__clampString(r.toString(),this._drawStyle.property.strLen)},__drawTitleEditor:function(e,t){var n=this,r=!1,i=$('<input type="text">');i.val(e.name),i.change(function(){r||(n._undoManager&&n._undoManager.addEvent('Title changed for Node "'+e.category+"."+e.type+'"',{id:e.id,oldValue:e.name,newValue:i.val(),editor:n},function(){var e=this.editor._engine.nodeById(this.id);e.name=this.oldValue},function(){var e=this.editor._engine.nodeById(this.id);e.name=this.newValue}),e.name=i.val())});var s={top:0,left:this.$palette.width()};this.$main.append(i),i.addClass("wcPlayEditorControl"),i.focus(),i.select(),i.blur(function(){$(this).remove()}),i.keyup(function(e){switch(e.keyCode){case 13:i.blur();break;case 27:r=!0,i.blur()}return!1}),i.css("top",s.top+t.top*this._viewportCamera.z+this._viewportCamera.y).css("left",s.left+t.left*this._viewportCamera.z+this._viewportCamera.x).css("width",200).css("height",Math.max(t.height*this._viewportCamera.z,15))},__drawPropertyEditor:function(e,t,n,r){function l(e,t,n,r){f._undoManager&&f._undoManager.addEvent('Property "'+t+'" changed for Node "'+e.category+"."+e.type+'"',{id:e.id,name:t,propFn:u,oldValue:n,newValue:r,editor:f},function(){var e=this.editor._engine.nodeById(this.id);e[this.propFn](this.name,this.oldValue)},function(){var e=this.editor._engine.nodeById(this.id);e[this.propFn](this.name,this.newValue)})}var i=null,s=!1,o=!0,u=r?"initialProperty":"property",a=t.type,f=this;switch(a){case wcPlay.PROPERTY_TYPE.TOGGLE:var c=e[u](t.name);l(e,t.name,c,!c),e[u](t.name,!c);break;case wcPlay.PROPERTY_TYPE.NUMBER:i=$('<input type="number"'+(t.options.min?' min="'+t.options.min+'"':"")+(t.options.max?' max="'+t.options.max+'"':"")+(t.options.step?' step="'+t.options.step+'"':"")+">"),i.val(parseFloat(e[u](t.name))),i.change(function(){if(!s){var n=$(this).attr("min")!==undefined?parseInt($(this).attr("min")):-Infinity,r=$(this).attr("max")!==undefined?parseInt($(this).attr("max")):Infinity;h=Math.min(r,Math.max(n,parseInt(i.val()))),l(e,t.name,e[u](t.name),h),e[u](t.name,h)}});break;case wcPlay.PROPERTY_TYPE.STRING:case wcPlay.PROPERTY_TYPE.DYNAMIC:t.options.multiline?(i=$("<textarea"+(t.options.maxlength?' maxlength="'+t.options.maxlength+'"':"")+">"),o=!1):i=$('<input type="text" maxlength="'+(t.options.maxlength||524288)+'">'),i.val(e[u](t.name).toString()),i.change(function(){s||(l(e,t.name,e[u](t.name),i.val()),e[u](t.name,i.val()))});break;case wcPlay.PROPERTY_TYPE.SELECT:var h=e[u](t.name);i=$("<select>");var p=t.options.items;$.isFunction(p)&&(p=p.call(e));if(!$.isArray(p)){console.log("ERROR: Tried to display a Select type property when no selection list was provided.");return}i.append($('<option value=""'+(""==h?" selected":"")+">&lt;none&gt;</option>"));for(var d=0;d<p.length;++d)typeof p[d]=="object"?i.append($('<option value="'+p[d].value+'"'+(p[d].value==h?" selected":"")+">"+p[d].name+"</option>")):i.append($('<option value="'+p[d]+'"'+(p[d]==h?" selected":"")+">"+p[d]+"</option>"));i.change(function(){s||(l(e,t.name,e[u](t.name),i.val()),e[u](t.name,i.val()),$(this).blur())})}if(i){var v={top:0,left:this.$palette.width()};this.$main.append(i),i.addClass("wcPlayEditorControl"),i.focus(),i.select(),i.blur(function(){$(this).remove()}),i.keyup(function(e){switch(e.keyCode){case 13:(o||e.ctrlKey)&&i.blur();break;case 27:s=!0,i.blur()}return!1}),i.css("top",v.top+n.rect.top*this._viewportCamera.z+this._viewportCamera.y).css("left",v.left+n.rect.left*this._viewportCamera.z+this._viewportCamera.x).css("width",200).css("height",Math.max(n.rect.height*this._viewportCamera.z,15))}},__setupControls:function(){var e=this;$("ul.wcPlayEditorMenu > li").on("mouseenter",this.__onMenuMouseEnter),$("ul.wcPlayEditorMenu > li > ul").on("click",this.__onMenuClicked),$("ul.wcPlayEditorMenu > li").on("mouseleave",this.__onMenuMouseLeave),$("ul.wcPlayEditorMenu > li > ul").on("mouseleave",this.__onSubMenuMouseLeave),this.__bindMenuHandlers(),this.$palette.on("mousemove",function(t){e.__onPaletteMouseMove(t,this)}),this.$palette.on("mousedown",function(t){e.__onPaletteMouseDown(t,this)}),this.$palette.on("mouseup",function(t){e.__onPaletteMouseUp(t,this)}),this.$viewport.on("mousemove",function(t){e.__onViewportMouseMove(t,this)}),this.$viewport.on("mousedown",function(t){e.__onViewportMouseDown(t,this)}),this.$viewport.on("click",function(t){e.__onViewportMouseClick(t,this)}),this.$viewport.on("dblclick",function(t){e.__onViewportMouseDoubleClick(t,this)}),this.$viewport.on("mouseup",function(t){e.__onViewportMouseUp(t,this)}),this.$viewport.on("mousewheel DOMMouseScroll",function(t){e.__onViewportMouseWheel(t,this)}),$("body").keyup(function(t){e.__onKey(t,this)})},__onKey:function(e,t){switch(e.keyCode){case 46:$(".wcPlayEditorMenuOptionDelete").first().click();break;case"Z".charCodeAt(0):e.ctrlKey&&!e.shiftKey&&$(".wcPlayEditorMenuOptionUndo").first().click();if(!e.shiftKey)break;case"Y".charCodeAt(0):e.ctrlKey&&$(".wcPlayEditorMenuOptionRedo").first().click();break;case 32:$(".wcPlayEditorMenuOptionStep").first().click();break;case 13:$(".wcPlayEditorMenuOptionPausePlay").first().click()}},__onMenuMouseEnter:function(e){var t=$(this);setTimeout(function(){t.is(":hover")&&t.addClass("wcPlayEditorMenuOpen").addClass("wcMenuItemHover")},100)},__onMenuClicked:function(){$("ul.wcPlayEditorMenu li ul").css("display","none"),setTimeout(function(){$("ul.wcPlayEditorMenu li ul").css("display","")},200)},__onMenuMouseLeave:function(e){$(this).find(e.toElement).length===0&&$(this).removeClass("wcPlayEditorMenuOpen").removeClass("wcMenuItemHover")},__onSubMenuMouseLeave:function(e){$parent=$(this).parent(),$parent.find(e.toElement).length===0&&$parent.removeClass("wcPlayEditorMenuOpen").removeClass("wcMenuItemHover")},__bindMenuHandlers:function(){var e=this,t=$("body");t.on("click",".wcPlayMenuItem.disabled",function(e){return e.stopPropagation(),e.preventDefault(),!1}),t.on("click",".wcPlayEditorMenuOptionNew",function(){e._engine&&e._engine.clear()}),t.on("click",".wcPlayEditorMenuOptionOpen",function(){}),t.on("click",".wcPlayEditorMenuOptionSave",function(){}),t.on("click",".wcPlayEditorMenuOptionUndo",function(){e._undoManager&&e._undoManager.undo()}),t.on("click",".wcPlayEditorMenuOptionRedo",function(){e._undoManager&&e._undoManager.redo()}),t.on("click",".wcPlayEditorMenuOptionDelete",function(){if(e._selectedNodes.length){e._undoManager&&e._undoManager.beginGroup("Removed Nodes");for(var t=0;t<e._selectedNodes.length;++t){var n=e._selectedNodes[t];e._undoManager&&e._undoManager.addEvent("",{id:n.id,className:n.className,pos:{x:n.pos.x,y:n.pos.y},collapsed:n.collapsed(),breakpoint:n._break,properties:n.listProperties(),entryChains:n.listEntryChains(),exitChains:n.listExitChains(),inputChains:n.listInputChains(),outputChains:n.listOutputChains(),editor:e},function(){var e=new window[this.className](this.editor._engine,this.pos);e.id=this.id,e.collapsed(this.collapsed),e.debugBreak(this.breakpoint);for(var t=0;t<this.properties.length;++t)e.initialProperty(this.properties[t].name,this.properties[t].initialValue),e.property(this.properties[t].name,this.properties[t].value);for(var t=0;t<this.entryChains.length;++t){var n=this.entryChains[t],r=this.editor._engine.nodeById(n.outNodeId);e.connectEntry(n.inName,r,n.outName)}for(var t=0;t<this.exitChains.length;++t){var n=this.exitChains[t],r=this.editor._engine.nodeById(n.inNodeId);e.connectExit(n.outName,r,n.inName)}for(var t=0;t<this.inputChains.length;++t){var n=this.inputChains[t],r=this.editor._engine.nodeById(n.outNodeId);e.connectInput(n.inName,r,n.outName)}for(var t=0;t<this.outputChains.length;++t){var n=this.outputChains[t],r=this.editor._engine.nodeById(n.outNodeId);e.connectOutput(n.inName,r,n.outName)}},function(){var e=this.editor._engine.nodeById(this.id);e.destroy()}),n.destroy(),n=null}e._selectedNode=null,e._selectedNodes=[],e._undoManager&&e._undoManager.endGroup()}}),t.on("click",".wcPlayEditorMenuOptionComposite",function(){e._selectedNodes.length}),t.on("click",".wcPlayEditorMenuOptionDebugging",function(){e._engine&&(e._engine.debugging(!e._engine.debugging()),e._engine.paused(!1))}),t.on("click",".wcPlayEditorMenuOptionSilence",function(){e._engine&&e._engine.silent(!e._engine.silent())}),t.on("click",".wcPlayEditorMenuOptionRestart",function(){e._engine&&e._engine.start()}),t.on("click",".wcPlayEditorMenuOptionPausePlay",function(){e._engine&&(e._engine.paused()||e._engine.stepping()?(e._engine.paused(!1),e._engine.stepping(!1)):e._engine.stepping(!0))}),t.on("click",".wcPlayEditorMenuOptionStep",function(){e._engine&&(e._engine.paused(!1),e._engine.stepping(!0))}),t.on("click",".wcPlayEditorMenuOptionDocs",function(){window.open("https://play.api.webcabin.org/","_blank")}),t.on("click",".wcPlayEditorMenuOptionAbout",function(){})},__onPaletteMouseMove:function(e,t){var n=this.__mouse(e);this._highlightTitle=!1,this._highlightCollapser=!1,this._highlightBreakpoint=!1,this._highlightEntryLink=!1,this._highlightExitLink=!1,this._highlightInputLink=!1,this._highlightOutputLink=!1,this._highlightPropertyValue=!1,this._highlightPropertyInitialValue=!1,this._highlightViewport=!1;if(this._draggingNodeData){var r={x:n.gx+this._draggingNodeData.offset.x,y:n.gy+this._draggingNodeData.offset.y};this._draggingNodeData.$canvas.css("left",r.x).css("top",r.y);return}var i=this.__findCategoryAreaAtPos(n);if(i){var s=i.$canvas.offset();n=this.__mouse(e,s);var o=this.__findNodeAtPos(n,undefined,i.nodes);o?(this._highlightNode=o,this.$palette.addClass("wcClickable"),this.$palette.attr("title","Create a new instance of this node by dragging this into your script.")):(this._highlightNode=null,this.$palette.removeClass("wcClickable"),this.$palette.attr("title",""))}},__onPaletteMouseDown:function(e,t){if(this._highlightNode){this.__onPaletteMouseUp(e,t);var n=this.__mouse(e),r=this._highlightNode._meta.bounds.rect,i=this.__findCategoryAreaAtPos(n);if(i){var s=i.$canvas.offset();this._draggingNodeData={node:this._highlightNode,$canvas:$('<canvas class="wcPlayHoverCanvas">'),offset:{x:0,y:0}},this.$main.append(this._draggingNodeData.$canvas),this.$palette.addClass("wcMoving"),this.$viewport.addClass("wcMoving"),this._draggingNodeData.$canvas.css("left",r.left+s.left).css("top",r.top+s.top),this._draggingNodeData.$canvas.attr("width",r.width).css("width",r.width),this._draggingNodeData.$canvas.attr("height",r.height).css("height",r.height),this._draggingNodeData.offset.x=r.left+s.left-n.x,this._draggingNodeData.offset.y=r.top+s.top-n.y;var o=0;this._highlightNode.chain.entry.length||(o+=this._drawStyle.links.length),this.__drawNode(this._highlightNode,{x:r.width/2,y:o+3},this._draggingNodeData.$canvas[0].getContext("2d"),!0)}}},__onPaletteMouseUp:function(e,t){this._draggingNodeData&&(this._draggingNodeData.$canvas.remove(),this._draggingNodeData.$canvas=null,this._draggingNodeData=null,this.$palette.removeClass("wcMoving"),this.$viewport.removeClass("wcMoving"))},__onViewportMouseMove:function(e,t){var n=this.__mouse(e,this.$viewport.offset());if(n.x!==this._mouse.x||n.y!==this._mouse.y)this._mouseMoved=!0;if(this._draggingNodeData){var r={x:n.gx+this._draggingNodeData.offset.x,y:n.gy+this._draggingNodeData.offset.y};this._draggingNodeData.$canvas.css("left",r.x).css("top",r.y),this._mouse=n;return}if(this._highlightRect&&this._engine){this._highlightRect.x=(n.x-this._viewportCamera.x)/this._viewportCamera.z-this._highlightRect.ox,this._highlightRect.y=(n.y-this._viewportCamera.y)/this._viewportCamera.z-this._highlightRect.oy,this._highlightRect.width=this._highlightRect.x,this._highlightRect.height=this._highlightRect.y,this._highlightRect.width<0&&(this._highlightRect.left=this._highlightRect.ox+this._highlightRect.width,this._highlightRect.width*=-1),this._highlightRect.height<0&&(this._highlightRect.top=this._highlightRect.oy+this._highlightRect.height,this._highlightRect.height*=-1),this._selectedNodes=[];var i=this;function s(e){for(var t=0;t<e.length;++t)i.__rectInRect(e[t]._meta.bounds.inner,i._highlightRect)&&i._selectedNodes.push(e[t])}s(this._engine._storageNodes),s(this._engine._compositeNodes),s(this._engine._processNodes),s(this._engine._entryNodes),this._mouse=n;return}if(this._viewportMoving){var o=n.x-this._mouse.x,u=n.y-this._mouse.y;this._viewportCamera.x+=o,this._viewportCamera.y+=u,this._mouse=n,!this._viewportMoved&&this._mouseMoved&&(this._viewportMoved=!0,this.$viewport.addClass("wcMoving"));return}if(this._viewportMovingNode){var o=n.x-this._mouse.x,u=n.y-this._mouse.y;for(var a=0;a<this._selectedNodes.length;++a)this._selectedNodes[a].pos.x+=o/this._viewportCamera.z,this._selectedNodes[a].pos.y+=u/this._viewportCamera.z;this._mouse=n;return}this._mouse=n,this._highlightTitle=!1,this._highlightCollapser=!1,this._highlightBreakpoint=!1,this._highlightEntryLink=!1,this._highlightExitLink=!1,this._highlightInputLink=!1,this._highlightOutputLink=!1,this._highlightPropertyValue=!1,this._highlightPropertyInitialValue=!1;var f=this._highlightViewport;this._highlightViewport=!1;var l=this.__findNodeAtPos(n,this._viewportCamera);if(l){this.__inRect(n,l._meta.bounds.inner,this._viewportCamera)?(this._highlightNode=l,this.$viewport.addClass("wcClickable"),this.$viewport.attr("title",(l._meta.description?l._meta.description+"\n":"")+"Click and drag to move this node. Double click to collapse/expand this node.")):this.$viewport.removeClass("wcClickable"),!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedInputLink&&!this._selectedOutputLink&&(this.__inRect(n,l._meta.bounds.collapser,this._viewportCamera)&&(this._highlightCollapser=!0,l.collapsed()?this.$viewport.attr("title","Expand this node."):this.$viewport.attr("title","Collapse this node.")),this.__inRect(n,l._meta.bounds.breakpoint,this._viewportCamera)&&(this._highlightBreakpoint=!0,this.$viewport.attr("title","Toggle debug breakpoint on this node.")));if(!this._selectedEntryLink&&!this._selectedInputLink&&!this._selectedOutputLink)for(var a=0;a<l._meta.bounds.entryBounds.length;++a)if(this.__inRect(n,l._meta.bounds.entryBounds[a].rect,this._viewportCamera)){this._highlightNode=l,this._highlightEntryLink=l._meta.bounds.entryBounds[a];var c;for(var h=0;h<l.chain.entry.length;++h)if(l.chain.entry[h].name==this._highlightEntryLink.name){c=l.chain.entry[h];break}this.$viewport.attr("title",(c.meta.description?c.meta.description+"\n":"")+"Click and drag to create a new flow chain from another node. Double click to manually fire this entry link.");break}if(!this._selectedExitLink&&!this._selectedInputLink&&!this._selectedOutputLink)for(var a=0;a<l._meta.bounds.exitBounds.length;++a)if(this.__inRect(n,l._meta.bounds.exitBounds[a].rect,this._viewportCamera)){this._highlightNode=l,this._highlightExitLink=l._meta.bounds.exitBounds[a];var c;for(var h=0;h<l.chain.exit.length;++h)if(l.chain.exit[h].name==this._highlightExitLink.name){c=l.chain.exit[h];break}this.$viewport.attr("title",(c.meta.description?c.meta.description+"\n":"")+"Click and drag to create a new flow chain to another node. Double click to manually fire this exit link.");break}if(!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedInputLink)for(var a=0;a<l._meta.bounds.inputBounds.length;++a)if(this.__inRect(n,l._meta.bounds.inputBounds[a].rect,this._viewportCamera)){this._highlightNode=l,this._highlightInputLink=l._meta.bounds.inputBounds[a],this.$viewport.attr("title","Click and drag to chain this property to the output of another.");break}if(!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedOutputLink)for(var a=0;a<l._meta.bounds.outputBounds.length;++a)if(this.__inRect(n,l._meta.bounds.outputBounds[a].rect,this._viewportCamera)){this._highlightNode=l,this._highlightOutputLink=l._meta.bounds.outputBounds[a],this.$viewport.attr("title","Click and drag to chain this property to the input of another. Double click to manually propagate this property through the chain.");break}if(!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedInputLink&&!this._selectedOutputLink){this.__inRect(this._mouse,l._meta.bounds.titleBounds,this._viewportCamera)&&(this._highlightNode=l,this._highlightTitle=!0);var p;for(var a=0;a<l._meta.bounds.propertyBounds.length;++a)if(this.__inRect(this._mouse,l._meta.bounds.propertyBounds[a].rect,this._viewportCamera)){p=l._meta.bounds.propertyBounds[a];break}if(p)for(var a=0;a<l.properties.length;++a)if(l.properties[a].name===p.name){this.$viewport.attr("title",l.properties[a].options.description?l.properties[a].options.description+"\n":"");break}var d;for(var a=0;a<l._meta.bounds.valueBounds.length;++a)if(this.__inRect(this._mouse,l._meta.bounds.valueBounds[a].rect,this._viewportCamera)){d=l._meta.bounds.valueBounds[a];break}if(d)for(var a=0;a<l.properties.length;++a)if(l.properties[a].name===d.name){this._highlightNode=l,this._highlightPropertyValue=d,this.$viewport.attr("title",(l.properties[a].options.description?l.properties[a].options.description+"\n":"")+"Click to change the current value of this property.");break}var v;for(var a=0;a<l._meta.bounds.initialBounds.length;++a)if(this.__inRect(this._mouse,l._meta.bounds.initialBounds[a].rect,this._viewportCamera)){v=l._meta.bounds.initialBounds[a];break}if(v)for(var a=0;a<l.properties.length;++a)if(l.properties[a].name===v.name){this._highlightNode=l,this._highlightPropertyInitialValue=v,this.$viewport.attr("title",(l.properties[a].options.description?l.properties[a].options.description+"\n":"")+"Click to change the initial value of this property.");break}if(l._meta.bounds.viewportBounds){var r={x:(n.x-this._viewportCamera.x)/this._viewportCamera.z-l._meta.bounds.viewportBounds.left,y:(n.y-this._viewportCamera.y)/this._viewportCamera.z-l._meta.bounds.viewportBounds.top};this.__inRect(this._mouse,l._meta.bounds.viewportBounds,this._viewportCamera)?(this._highlightNode=l,this._highlightViewport=!0,f||l.onViewportMouseEnter(e,r),l.onViewportMouseMove(e,r)):f&&l.onViewportMouseLeave(e,r)}}}else this._highlightNode=null,this.$viewport.attr("title",""),this.$viewport.removeClass("wcClickable");this._expandedNode&&this._expandedNode!==this._highlightNode&&(this._highlightNode||!this.__inRect(n,this._expandedNode._meta.bounds.farRect,this._viewportCamera))&&(this._expandedNodeWasCollapsed&&this._expandedNode.collapsed(!0),this._expandedNode=null),!this._expandedNode&&this._highlightNode&&(this._selectedEntryLink||this._selectedExitLink||this._selectedInputLink||this._selectedOutputLink)&&this.__inRect(n,l._meta.bounds.inner,this._viewportCamera)&&(this._expandedNode=this._highlightNode,this._expandedNodeWasCollapsed=this._expandedNode.collapsed(),this._expandedNode.collapsed(!1))},__onViewportMouseDown:function(e,t){this._mouse=this.__mouse(e,this.$viewport.offset()),this._mouseMoved=!1;if(e.ctrlKey||this._mouse.which===2){this._highlightRect={top:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z,left:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,oy:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z,ox:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,x:0,y:0,width:0,height:0};return}var n=!1,r=this.__findNodeAtPos(this._mouse,this._viewportCamera);if(r){if(!n)for(var i=0;i<r._meta.bounds.entryBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.entryBounds[i].rect,this._viewportCamera)){n=!0;if(e.altKey){var s=r.listEntryChains(r._meta.bounds.entryBounds[i].name);s.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Entry Links for "'+r.category+"."+r.type+"."+r._meta.bounds.entryBounds[i].name+'"',{id:r.id,name:r._meta.bounds.entryBounds[i].name,chains:s,editor:this},function(){var e=this.editor._engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.editor._engine.nodeById(this.chains[t].outNodeId),r=this.chains[t].outName;e.connectEntry(this.name,n,r)}},function(){var e=this.editor._engine.nodeById(this.id);e.disconnectEntry(this.name)}),r.disconnectEntry(r._meta.bounds.entryBounds[i].name);break}this._selectedNode=r,this._selectedNodes=[r],this._selectedEntryLink=r._meta.bounds.entryBounds[i];break}if(!n)for(var i=0;i<r._meta.bounds.exitBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.exitBounds[i].rect,this._viewportCamera)){n=!0;if(e.altKey){var s=r.listExitChains(r._meta.bounds.exitBounds[i].name);s.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Exit Links for "'+r.category+"."+r.type+"."+r._meta.bounds.exitBounds[i].name+'"',{id:r.id,name:r._meta.bounds.exitBounds[i].name,chains:s,editor:this},function(){var e=this.editor._engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.editor._engine.nodeById(this.chains[t].inNodeId),r=this.chains[t].inName;e.connectExit(this.name,n,r)}},function(){var e=this.editor._engine.nodeById(this.id);e.disconnectExit(this.name)}),r.disconnectExit(r._meta.bounds.exitBounds[i].name);break}if(e.shiftKey){r.triggerExit(r._meta.bounds.exitBounds[i].name);break}this._selectedNode=r,this._selectedNodes=[r],this._selectedExitLink=r._meta.bounds.exitBounds[i];break}if(!n)for(var i=0;i<r._meta.bounds.inputBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.inputBounds[i].rect,this._viewportCamera)){n=!0;if(e.altKey){var s=r.listInputChains(r._meta.bounds.inputBounds[i].name);s.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Property Input Links for "'+r.category+"."+r.type+"."+r._meta.bounds.inputBounds[i].name+'"',{id:r.id,name:r._meta.bounds.inputBounds[i].name,chains:s,editor:this},function(){var e=this.editor._engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.editor._engine.nodeById(this.chains[t].outNodeId),r=this.chains[t].outName;e.connectInput(this.name,n,r)}},function(){var e=this.editor._engine.nodeById(this.id);e.disconnectInput(this.name)}),r.disconnectInput(r._meta.bounds.inputBounds[i].name);break}this._selectedNode=r,this._selectedNodes=[r],this._selectedInputLink=r._meta.bounds.inputBounds[i];break}if(!n)for(var i=0;i<r._meta.bounds.outputBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.outputBounds[i].rect,this._viewportCamera)){n=!0;if(e.altKey){var s=r.listOutputChains(r._meta.bounds.outputBounds[i].name);s.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Property Output Links for "'+r.category+"."+r.type+"."+r._meta.bounds.outputBounds[i].name+'"',{id:r.id,name:r._meta.bounds.outputBounds[i].name,chains:s,editor:this},function(){var e=this.editor._engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.editor._engine.nodeById(this.chains[t].inNodeId),r=this.chains[t].inName;e.connectOutput(this.name,n,r)}},function(){var e=this.editor._engine.nodeById(this.id);e.disconnectOutput(this.name)}),r.disconnectOutput(r._meta.bounds.outputBounds[i].name);break}this._selectedNode=r,this._selectedNodes=[r],this._selectedOutputLink=r._meta.bounds.outputBounds[i];break}if(!n&&r._meta.bounds.viewportBounds){var o={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z-r._meta.bounds.viewportBounds.left,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z-r._meta.bounds.viewportBounds.top};this.__inRect(this._mouse,r._meta.bounds.viewportBounds,this._viewportCamera)&&(this._selectedNode=r,this._selectedNodes=[r],r.onViewportMouseDown(e,o)&&(n=!0))}if(!n&&this.__inRect(this._mouse,r._meta.bounds.inner,this._viewportCamera)){n=!0;if(!this._selectedNodes.length||this._selectedNodes.indexOf(r)===-1)this._selectedNode=r,this._selectedNodes=[r];this._viewportMovingNode=!0,this._selectedNodeOrigins=[];for(var i=0;i<this._selectedNodes.length;++i){var u=this._selectedNodes[i];this._selectedNodeOrigins.push({x:u.pos.x,y:u.pos.y})}}}n||(this._viewportMoving=!0,this._viewportMoved=!1)},__onViewportMouseUp:function(e,t){if(this._draggingNodeData){var n=this.__mouse(e,this.$viewport.offset(),this._viewportCamera),r=new window[this._draggingNodeData.node.className](this._engine,{x:(n.x+(this._draggingNodeData.$canvas.width()/2+this._draggingNodeData.offset.x))/this._viewportCamera.z,y:(n.y+this._draggingNodeData.offset.y)/this._viewportCamera.z});this._undoManager&&this._undoManager.addEvent('Created Node "'+r.category+"."+r.type+'"',{id:r.id,className:r.className,pos:{x:r.pos.x,y:r.pos.y},editor:this},function(){var e=this.editor._engine.nodeById(this.id);e.destroy()},function(){var e=new window[this.className](this.editor._engine,this.pos);e.id=this.id}),this._selectedNode=r,this._selectedNodes=[r],this._draggingNodeData.$canvas.remove(),this._draggingNodeData.$canvas=null,this._draggingNodeData=null,this.$palette.removeClass("wcMoving"),this.$viewport.removeClass("wcMoving")}if(this._highlightRect&&this._engine){this._highlightRect=null;return}if(this._selectedNodes.length&&this._selectedNodeOrigins.length){for(var i=0;i<this._selectedNodes.length;++i){var s=this._selectedNodes[i];(s.pos.x!==this._selectedNodeOrigins[i].x||s.pos.y!==this._selectedNodeOrigins[i].y)&&this._undoManager&&this._undoManager.addEvent('Moved Node "'+s.category+"."+s.type+'"',{id:s.id,start:{x:this._selectedNodeOrigins[i].x,y:this._selectedNodeOrigins[i].y},end:{x:s.pos.x,y:s.pos.y},editor:this},function(){var e=this.editor._engine.nodeById(this.id);e.pos.x=this.start.x,e.pos.y=this.start.y},function(){var e=this.editor._engine.nodeById(this.id);e.pos.x=this.end.x,e.pos.y=this.end.y})}this._selectedNodeOrigins=[]}this._selectedNode&&this._selectedEntryLink&&this._highlightNode&&this._highlightExitLink&&(this._selectedNode.connectEntry(this._selectedEntryLink.name,this._highlightNode,this._highlightExitLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectEntry(this._selectedEntryLink.name,this._highlightNode,this._highlightExitLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Entry Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedEntryLink.name+'" to Exit Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightExitLink.name+'"',{id:this._selectedNode.id,name:this._selectedEntryLink.name,targetId:this._highlightNode.id,targetName:this._highlightExitLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectEntry(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectEntry(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Entry Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedEntryLink.name+'" to Exit Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightExitLink.name+'"',{id:this._selectedNode.id,name:this._selectedEntryLink.name,targetId:this._highlightNode.id,targetName:this._highlightExitLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectEntry(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectEntry(this.name,t,this.targetName)})),this._selectedNode&&this._selectedExitLink&&this._highlightNode&&this._highlightEntryLink&&(this._selectedNode.connectExit(this._selectedExitLink.name,this._highlightNode,this._highlightEntryLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectExit(this._selectedExitLink.name,this._highlightNode,this._highlightEntryLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Exit Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedExitLink.name+'" to Entry Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightEntryLink.name+'"',{id:this._selectedNode.id,name:this._selectedExitLink.name,targetId:this._highlightNode.id,targetName:this._highlightEntryLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectExit(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectExit(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Exit Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedExitLink.name+'" to Entry Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightEntryLink.name+'"',{id:this._selectedNode.id,name:this._selectedExitLink.name,targetId:this._highlightNode.id,targetName:this._highlightEntryLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectExit(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectExit(this.name,t,this.targetName)})),this._selectedNode&&this._selectedInputLink&&this._highlightNode&&this._highlightOutputLink&&(this._selectedNode.connectInput(this._selectedInputLink.name,this._highlightNode,this._highlightOutputLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectInput(this._selectedInputLink.name,this._highlightNode,this._highlightOutputLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Property Input Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedInputLink.name+'" to Property Output Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightOutputLink.name+'"',{id:this._selectedNode.id,name:this._selectedInputLink.name,targetId:this._highlightNode.id,targetName:this._highlightOutputLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectInput(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectInput(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Property Input Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedInputLink.name+'" to Property Output Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightOutputLink.name+'"',{id:this._selectedNode.id,name:this._selectedInputLink.name,targetId:this._highlightNode.id,targetName:this._highlightOutputLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectInput(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectInput(this.name,t,this.targetName)})),this._selectedNode&&this._selectedOutputLink&&this._highlightNode&&this._highlightInputLink&&(this._selectedNode.connectOutput(this._selectedOutputLink.name,this._highlightNode,this._highlightInputLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectOutput(this._selectedOutputLink.name,this._highlightNode,this._highlightInputLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Property Output Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedOutputLink.name+'" to Property Input Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightInputLink.name+'"',{id:this._selectedNode.id,name:this._selectedOutputLink.name,targetId:this._highlightNode.id,targetName:this._highlightInputLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectOutput(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectOutput(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Property Output Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedOutputLink.name+'" to Property Input Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightInputLink.name+'"',{id:this._selectedNode.id,name:this._selectedOutputLink.name,targetId:this._highlightNode.id,targetName:this._highlightInputLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectOutput(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectOutput(this.name,t,this.targetName)}));if(this._selectedNode&&this._highlightViewport){var n=this.__mouse(e,this.$viewport.offset()),o={x:(n.x-this._viewportCamera.x)/this._viewportCamera.z-this._selectedNode._meta.bounds.viewportBounds.left,y:(n.y-this._viewportCamera.y)/this._viewportCamera.z-this._selectedNode._meta.bounds.viewportBounds.top};this._selectedNode.onViewportMouseUp(e,o)}this._expandedNode&&this._expandedNodeWasCollapsed&&this._expandedNode.collapsed(!0),this._expandedNode=null,this._selectedEntryLink=!1,this._selectedExitLink=!1,this._selectedInputLink=!1,this._selectedOutputLink=!1,this._viewportMovingNode=!1,this._viewportMoving&&(this._viewportMoving=!1,this._viewportMoved?(this._viewportMoved=!1,this.$viewport.removeClass("wcMoving")):(this._selectedNode=null,this._selectedNodes=[]))},__onViewportMouseClick:function(e,t){if(!this._mouseMoved){this._mouse=this.__mouse(e,this.$viewport.offset());var n=!1,r=this.__findNodeAtPos(this._mouse,this._viewportCamera);if(r){if(this.__inRect(this._mouse,r._meta.bounds.collapser,this._viewportCamera)){var i=!r.collapsed();r.collapsed(i),this._undoManager&&this._undoManager.addEvent((i?"Collapsed":"Expanded")+' Node "'+r.category+"."+r.type+'"',{id:r.id,state:i,editor:this},function(){var e=this.editor._engine.nodeById(this.id);e.collapsed(!this.state)},function(){var e=this.editor._engine.nodeById(this.id);e.collapsed(this.state)})}if(this.__inRect(this._mouse,r._meta.bounds.breakpoint,this._viewportCamera)){var i=!r._break;r.debugBreak(i),this._undoManager&&this._undoManager.addEvent((i?"Enabled":"Disabled")+' Breakpoint on Node "'+r.category+"."+r.type+'"',{id:r.id,state:i,editor:this},function(){var e=this.editor._engine.nodeById(this.id);e.debugBreak(!this.state)},function(){var e=this.editor._engine.nodeById(this.id);e.debugBreak(this.state)})}this.__inRect(this._mouse,r._meta.bounds.titleBounds,this._viewportCamera)&&this.__drawTitleEditor(r,r._meta.bounds.titleBounds);var s;for(var o=0;o<r._meta.bounds.valueBounds.length;++o)if(this.__inRect(this._mouse,r._meta.bounds.valueBounds[o].rect,this._viewportCamera)){s=r._meta.bounds.valueBounds[o];break}if(s)for(var o=0;o<r.properties.length;++o)if(r.properties[o].name===s.name){this.__drawPropertyEditor(r,r.properties[o],s);break}var u;for(var o=0;o<r._meta.bounds.initialBounds.length;++o)if(this.__inRect(this._mouse,r._meta.bounds.initialBounds[o].rect,this._viewportCamera)){u=r._meta.bounds.initialBounds[o];break}if(u)for(var o=0;o<r.properties.length;++o)if(r.properties[o].name===u.name){this.__drawPropertyEditor(r,r.properties[o],u,!0);break}if(r._meta.bounds.viewportBounds){var a={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z-r._meta.bounds.viewportBounds.left,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z-r._meta.bounds.viewportBounds.top};this.__inRect(this._mouse,r._meta.bounds.viewportBounds,this._viewportCamera)&&r.onViewportMouseClick(e,a)}}}},__onViewportMouseDoubleClick:function(e,t){this._mouse=this.__mouse(e,this.$viewport.offset());var n=!1,r=this.__findNodeAtPos(this._mouse,this._viewportCamera);if(r){this.__inRect(this._mouse,r._meta.bounds.collapser,this._viewportCamera)&&(n=!0),this.__inRect(this._mouse,r._meta.bounds.breakpoint,this._viewportCamera)&&(n=!0);for(var i=0;i<r._meta.bounds.valueBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.valueBounds[i].rect,this._viewportCamera)){n=!0;break}if(!n)for(var i=0;i<r._meta.bounds.entryBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.entryBounds[i].rect,this._viewportCamera)){n=!0,r.triggerEntry(r._meta.bounds.entryBounds[i].name);break}if(!n)for(var i=0;i<r._meta.bounds.exitBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.exitBounds[i].rect,this._viewportCamera)){n=!0,r.triggerExit(r._meta.bounds.exitBounds[i].name);break}if(!n)for(var i=0;i<r._meta.bounds.outputBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.outputBounds[i].rect,this._viewportCamera)){n=!0,r.property(r._meta.bounds.outputBounds[i].name,r.property(r._meta.bounds.outputBounds[i].name),!0);break}if(!n&&r._meta.bounds.viewportBounds){var s={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z-r._meta.bounds.viewportBounds.left,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z-r._meta.bounds.viewportBounds.top};this.__inRect(this._mouse,r._meta.bounds.viewportBounds,this._viewportCamera)&&(n=r.onViewportMouseDoubleClick(e,s))}!n&&this.__inRect(this._mouse,r._meta.bounds.inner,this._viewportCamera)&&(n=!0,r.collapsed(!r.collapsed()))}},__onViewportMouseWheel:function(e,t){var n=this._viewportCamera.z,r=this.__mouse(e,this.$viewport.offset());if(this._highlightNode&&this._highlightNode._meta.bounds.viewportBounds){var i={x:(r.x-this._viewportCamera.x)/this._viewportCamera.z-this._highlightNode._meta.bounds.viewportBounds.left,y:(r.y-this._viewportCamera.y)/this._viewportCamera.z-this._highlightNode._meta.bounds.viewportBounds.top};if(this.__inRect(r,this._highlightNode._meta.bounds.viewportBounds,this._viewportCamera)&&this._highlightNode.onViewportMouseWheel(e,i,e.originalEvent.wheelDelta>0||e.originalEvent.detail<0))return}e.originalEvent.wheelDelta>0||e.originalEvent.detail<0?this._viewportCamera.z=Math.min(this._viewportCamera.z*1.25,5):this._viewportCamera.z=Math.max(this._viewportCamera.z*.75,.1),this._viewportCamera.x=(this._viewportCamera.x-r.x)/(n/this._viewportCamera.z)+r.x,this._viewportCamera.y=(this._viewportCamera.y-r.y)/(n/this._viewportCamera.z)+r.y},__findNodeAtPos:function(e,t,n){if(this._engine){var r=this;function i(n){for(var i=n.length-1;i>=0;--i)if(n[i]._meta.bounds&&r.__inRect(e,n[i]._meta.bounds.rect,t))return n[i];return null}return n===undefined?i(this._engine._storageNodes)||i(this._engine._compositeNodes)||i(this._engine._processNodes)||i(this._engine._entryNodes):i(n)}return null},__findCategoryAreaAtPos:function(e){for(var t in this._nodeLibrary)for(var n in this._nodeLibrary[t]){if(!this.$typeButton[this.__typeIndex(n)].hasClass("wcToggled"))continue;var r=this._nodeLibrary[t][n];if(!r.$button.hasClass("wcToggled"))continue;var i=r.$canvas.offset();i.width=r.$canvas.width(),i.height=r.$canvas.height();if(this.__inRect(e,i))return r}}};var wcNodeNextID=0;Class.extend("wcNode","Node","",{init:function(e,t){this.id=++wcNodeNextID,this.name="",this.color="#FFFFFF",this._viewportSize=null,this.pos={x:t&&t.x||0,y:t&&t.y||0},this.chain={entry:[],exit:[]},this.properties=[],this._meta={flash:!1,flashDelta:0,color:null,paused:!1,awake:!1,threads:[],description:""},this._collapsed=!1,this._break=!1,this._parent=e,this.createProperty(wcNode.PROPERTY.ENABLED,wcPlay.PROPERTY_TYPE.TOGGLE,!0,{collapsible:!0,description:"Disabled nodes will be treated as if they were not there, all connections will be ignored."}),this.createProperty(wcNode.PROPERTY.DEBUG_LOG,wcPlay.PROPERTY_TYPE.TOGGLE,!1,{collapsible:!0,description:"Output various debugging information about this node."});var n=this.engine();n&&n.__addNode(this)},destroy:function(){for(var e=0;e<this.chain.entry.length;++e){var t=this.chain.entry[e];this.disconnectEntry(t.name)}for(var e=0;e<this.chain.exit.length;++e){var t=this.chain.exit[e];this.disconnectExit(t.name)}for(var e=0;e<this.properties.length;++e){var t=this.properties[e];this.disconnectInput(t.name),this.disconnectOutput(t.name)}this.reset();var n=this.engine();n&&n.__removeNode(this)},reset:function(){for(var e=0;e<this.properties.length;++e)this.properties[e].value=this.properties[e].initialValue;for(var e=0;e<this._meta.threads.length;++e)typeof this._meta.threads[e]=="number"?(clearTimeout(this._meta.threads[e]),clearInterval(this._meta.threads[e])):typeof this._meta.threads[e]=="function"&&this._meta.threads[e]();this._meta.threads=[],this._meta.awake=!1},engine:function(){var e=this._parent;while(e&&!(e instanceof wcPlay))e=e._parent;return e||null},enabled:function(e){return e!==undefined&&this.property(wcNode.PROPERTY.ENABLED,e?!0:!1),this.property(wcNode.PROPERTY.ENABLED)},debugLog:function(e){e!==undefined&&this.property(wcNode.PROPERTY.DEBUG_LOG,e?!0:!1);var t=this.engine();return!t||t.silent()?!1:this.property(wcNode.PROPERTY.DEBUG_LOG)},debugBreak:function(e){e!==undefined&&(this._break=e?!0:!1);var t=this.engine();return t&&t.debugging()&&this._break},collapsed:function(e){return e!==undefined&&(this._collapsed=e),this._collapsed},description:function(e){return e!==undefined&&(this._meta.description=e),this._meta.description},beginThread:function(e){return this._meta.threads.push(e),this._meta.awake=!0,e},finishThread:function(e){var t=this._meta.threads.indexOf(e);t>-1&&(this._meta.threads.splice(t,1),this._meta.threads.length||(this._meta.awake=!1))},pos:function(e){return e!==undefined&&(this.pos.x=e.x,this.pos.y=e.y),{x:this.pos.x,y:this.pos.y}},createEntry:function(e,t){for(var n=0;n<this.chain.entry.length;++n)if(this.chain.entry[n].name===e)return!1;return this.chain.entry.push({name:e,active:!1,links:[],meta:{flash:!1,flashDelta:0,color:"#000000",description:t}}),!0},createExit:function(e,t){for(var n=0;n<this.chain.exit.length;++n)if(this.chain.exit[n].name===e)return!1;return this.chain.exit.push({name:e,links:[],meta:{flash:!1,flashDelta:0,color:"#000000",description:t}}),!0},createProperty:function(e,t,n,r){for(var i=0;i<this.properties.length;++i)if(this.properties[i].name===e)return!1;return n===undefined&&(n=0),this.properties.push({name:e,value:n,initialValue:n,type:t,inputs:[],outputs:[],options:r||{},inputMeta:{flash:!1,flashDelta:0,color:"#000000"},outputMeta:{flash:!1,flashDelta:0,color:"#000000"}}),!0},removeEntry:function(e){for(var t=0;t<this.chain.entry.length;++t)if(this.chain.entry[t].name===e&&this.disconnectEntry(e)===wcNode.CONNECT_RESULT.SUCCESS)return this.chain.entry.splice(t,1),!0;return!1},removeExit:function(e){for(var t=0;t<this.chain.exit.length;++t)if(this.chain.exit[t].name===e&&this.disconnectExit(e)===wcNode.CONNECT_RESULT.SUCCESS)return this.chain.exit.splice(t,1),!0;return!1},removeProperty:function(e){for(var t=0;t<this.properties.length;++t)if(this.properties[t].name===e&&this.disconnectInput(e)===wcNode.CONNECT_RESULT.SUCCESS&&this.disconnectOutput(e)===wcNode.CONNECT_RESULT.SUCCESS)return this.properties.splice(t,1),!0;return!1},connectEntry:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.chain.entry.length;++s)if(this.chain.entry[s].name===e){r=this.chain.entry[s];break}for(var s=0;s<t.chain.exit.length;++s)if(t.chain.exit[s].name===n){i=t.chain.exit[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.links.length;++s)if(r.links[s].node===t&&r.links[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.links.length;++s)if(i.links[s].node===this&&i.links[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.links.push({name:i.name,node:t}),i.links.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.ENTRY,t,i.name,wcNode.LINK_TYPE.EXIT),t.onConnect(!0,i.name,wcNode.LINK_TYPE.EXIT,this,r.name,wcNode.LINK_TYPE.ENTRY),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},connectExit:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.chain.exit.length;++s)if(this.chain.exit[s].name===e){r=this.chain.exit[s];break}for(var s=0;s<t.chain.entry.length;++s)if(t.chain.entry[s].name===n){i=t.chain.entry[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.links.length;++s)if(r.links[s].node===t&&r.links[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.links.length;++s)if(i.links[s].node===this&&i.links[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.links.push({name:i.name,node:t}),i.links.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.EXIT,t,i.name,wcNode.LINK_TYPE.ENTRY),t.onConnect(!0,i.name,wcNode.LINK_TYPE.ENTRY,this,r.name,wcNode.LINK_TYPE.EXIT),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},connectInput:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.properties.length;++s)if(this.properties[s].name===e){r=this.properties[s];break}for(var s=0;s<t.properties.length;++s)if(t.properties[s].name===n){i=t.properties[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.inputs.length;++s)if(r.inputs[s].node===t&&r.inputs[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.outputs.length;++s)if(i.outputs[s].node===this&&i.outputs[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.inputs.push({name:i.name,node:t}),i.outputs.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.INPUT,t,i.name,wcNode.LINK_TYPE.OUTPUT),t.onConnect(!0,i.name,wcNode.LINK_TYPE.OUTPUT,this,r.name,wcNode.LINK_TYPE.INPUT),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},connectOutput:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.properties.length;++s)if(this.properties[s].name===e){r=this.properties[s];break}for(var s=0;s<t.properties.length;++s)if(t.properties[s].name===n){i=t.properties[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.outputs.length;++s)if(r.outputs[s].node===t&&r.outputs[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.inputs.length;++s)if(i.inputs[s].node===this&&i.inputs[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.outputs.push({name:i.name,node:t}),i.inputs.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.OUTPUT,t,i.name,wcNode.LINK_TYPE.INPUT),t.onConnect(!0,i.name,wcNode.LINK_TYPE.INPUT,this,r.name,wcNode.LINK_TYPE.OUTPUT),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},disconnectEntry:function(e,t,n){var r=null;for(var i=0;i<this.chain.entry.length;++i)if(this.chain.entry[i].name===e){r=this.chain.entry[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.links.length;++i){var s=r.links[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.links.splice(i,1),i--,s.node.disconnectExit(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},disconnectExit:function(e,t,n){var r=null;for(var i=0;i<this.chain.exit.length;++i)if(this.chain.exit[i].name===e){r=this.chain.exit[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.links.length;++i){var s=r.links[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.links.splice(i,1),i--,s.node.disconnectEntry(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},disconnectInput:function(e,t,n){var r=null;for(var i=0;i<this.properties.length;++i)if(this.properties[i].name===e){r=this.properties[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.inputs.length;++i){var s=r.inputs[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.inputs.splice(i,1),i--,s.node.disconnectOutput(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},disconnectOutput:function(e,t,n){var r=null;for(var i=0;i<this.properties.length;++i)if(this.properties[i].name===e){r=this.properties[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.outputs.length;++i){var s=r.outputs[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.outputs.splice(i,1),i--,s.node.disconnectInput(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},listEntryChains:function(e){var t=[];for(var n=0;n<this.chain.entry.length;++n)if(!e||this.chain.entry[n].name===e){var r=this.chain.entry[n];for(var i=0;i<r.links.length;++i)t.push({inName:r.name,inNodeId:this.id,outName:r.links[i].name,outNodeId:r.links[i].node.id})}return t},listExitChains:function(e){var t=[];for(var n=0;n<this.chain.exit.length;++n)if(!e||this.chain.exit[n].name===e){var r=this.chain.exit[n];for(var i=0;i<r.links.length;++i)t.push({inName:r.links[i].name,inNodeId:r.links[i].node.id,outName:r.name,outNodeId:this.id})}return t},listInputChains:function(e){var t=[];for(var n=0;n<this.properties.length;++n)if(!e||this.properties[n].name===e){var r=this.properties[n];for(var i=0;i<r.inputs.length;++i)t.push({inName:r.name,inNodeId:this.id,outName:r.inputs[i].name,outNodeId:r.inputs[i].node.id})}return t},listOutputChains:function(e){var t=[];for(var n=0;n<this.properties.length;++n)if(!e||this.properties[n].name===e){var r=this.properties[n];for(var i=0;i<r.outputs.length;++i)t.push({inName:r.outputs[i].name,inNodeId:r.outputs[i].node.id,outName:r.name,outNodeId:this.id})}return t},listProperties:function(){var e=[];for(var t=0;t<this.properties.length;++t){var n=this.properties[t];e.push({name:n.name,value:n.value,initialValue:n.initialValue})}return e},triggerEntry:function(e){for(var t=0;t<this.chain.entry.length;++t)if(this.chain.entry[t].name==e){var n=this.engine();this.chain.entry[t].meta.flash=!0;if(this.debugBreak()||n&&n.stepping())this.chain.entry[t].meta.paused=!0;return n&&n.queueNodeEntry(this,this.chain.entry[t].name),!0}return!1},triggerExit:function(e){if(!this.enabled())return!1;this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" - "+this.name:"")+'" Triggered Exit link "'+e+'"');for(var t=0;t<this.chain.exit.length;++t){var n=this.chain.exit[t];if(n.name==e){this.chain.exit[t].meta.flash=!0;var r=this.engine();for(var i=0;i<n.links.length;++i)if(n.links[i].node){n.links[i].node.triggerEntry(n.links[i].name);if(n.links[i].node.debugBreak()||r&&r.stepping())this.chain.exit[t].meta.paused=!0}return!0}}return!1},property:function(e,t,n){for(var r=0;r<this.properties.length;++r){var i=this.properties[r];if(i.name===e){if(t!==undefined){var s=i.value;switch(i.type){case wcPlay.PROPERTY_TYPE.TOGGLE:t=t?!0:!1;break;case wcPlay.PROPERTY_TYPE.NUMBER:var o=i.options.min!==undefined?i.options.min:-Infinity,u=i.options.max!==undefined?i.options.max:Infinity,f=Math.min(u,Math.max(o,parseInt(t)));isNaN(f)&&(t=Math.min(u,Math.max(o,0)));break;case wcPlay.PROPERTY_TYPE.STRING:var l=i.options.maxlength;l&&(t=t.toString().substring(0,l));break;case wcPlay.PROPERTY_TYPE.SELECT:var c=i.options.items;typeof c=="function"&&(c=c.call(this));var h=!1;if($.isArray(c))for(var r=0;r<c.length;++r)if(typeof c[r]=="object"){if(c[r].value==t){h=!0;break}}else if(c[r]==t){h=!0;break}h||(t="")}var p=this.engine();i.outputMeta.flash=!0;if(this.debugBreak()||p&&p.stepping())i.outputMeta.paused=!0;if(n||i.value!==t)t=this.onPropertyChanging(i.name,s,t)||t;if(n||i.value!==t){i.value=t,this.onPropertyChanged(i.name,s,t);if(n===undefined||n)for(a=0;a<i.outputs.length;++a)i.outputs[a].node&&i.outputs[a].node.triggerProperty(i.outputs[a].name,t)}}return this.onPropertyGet(i.name)||i.value}}},initialProperty:function(e,t){for(var n=0;n<this.properties.length;++n){var r=this.properties[n];if(r.name===e){if(t!==undefined){t=this.onInitialPropertyChanging(r.name,r.initialValue,t)||t,r.value==r.initialValue&&this.property(e,t);var i=r.initialValue;r.initialValue=t,this.onInitialPropertyChanged(r.name,i,t)}return this.onInitialPropertyGet(r.name)||r.initialValue}}},triggerProperty:function(e,t){var n=this.engine();n&&n.queueNodeProperty(this,e,t);for(var r=0;r<this.properties.length;++r){var i=this.properties[r];if(i.name===e){i.inputMeta.flash=!0;if(this.debugBreak()||n&&n.stepping())i.inputMeta.paused=!0}}},viewportSize:function(e,t){return e!==undefined&&t!==undefined&&(!e||!t?this._viewportSize=null:this._viewportSize={x:e,y:t}),{x:this._viewportSize.x,y:this._viewportSize.y}},onViewportDraw:function(e){},onViewportMouseEnter:function(e,t){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" - "+this.name:"")+'" mouse entered custom viewport!')},onViewportMouseLeave:function(e){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" - "+this.name:"")+'" mouse left custom viewport!')},onViewportMouseDown:function(e,t){},onViewportMouseUp:function(e,t){},onViewportMouseMove:function(e,t){},onViewportMouseWheel:function(e,t,n){},onViewportMouseClick:function(e,t){},onViewportMouseDoubleClick:function(e,t){},onConnect:function(e,t,n,r,i,s){e&&n===wcNode.LINK_TYPE.OUTPUT&&r.triggerProperty(i,this.property(t))},onStart:function(){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" - "+this.name:"")+'" started!')},onTriggered:function(e){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" - "+this.name:"")+'" Triggered Entry link "'+e+'"')},onPropertyChanging:function(e,t,n){},onPropertyChanged:function(e,t,n){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" - "+this.name:"")+'" Changed Property "'+e+'" from "'+t+'" to "'+n+'"')},onPropertyGet:function(e){},onInitialPropertyChanging:function(e,t,n){},onInitialPropertyChanged:function(e,t,n){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" - "+this.name:"")+'" Changed Property "'+e+'" from "'+t+'" to "'+n+'"')},onInitialPropertyGet:function(e){}}),wcNode.LINK_TYPE={ENTRY:"entry",EXIT:"exit",INPUT:"input",OUTPUT:"output"},wcNode.CONNECT_RESULT={NOT_FOUND:"not_found",ALREADY_CONNECTED:"already_connected",SUCCESS:"success"},wcNode.PROPERTY={ENABLED:"enabled",DEBUG_LOG:"debug log"},wcNode.extend("wcNodeEntry","Entry Node","",{init:function(e,t){this._super(e,t),this.color="#CCCC00",this.createExit("out")},classInit:function(e,t,n){n&&(this.className=e,this.type=t,this.category=n,wcPlay.registerNodeType(e,t,n,wcPlay.NODE_TYPE.ENTRY))},onTriggered:function(e){this.triggerCondition(e)&&this.triggerExit("out")},triggerCondition:function(e){return!0}}),wcNode.extend("wcNodeProcess","Node Process","",{init:function(e,t){this._super(e,t),this.color="#007ACC",this.createEntry("in"),this.createExit("out")},classInit:function(e,t,n){n&&(this.className=e,this.type=t,this.category=n,wcPlay.registerNodeType(e,t,n,wcPlay.NODE_TYPE.PROCESS))}}),wcNode.extend("wcNodeStorage","Storage","",{init:function(e,t){this._super(e,t),this.color="#009900"},classInit:function(e,t,n){n&&(this.className=e,this.type=t,this.category=n,wcPlay.registerNodeType(e,t,n,wcPlay.NODE_TYPE.STORAGE))},onStart:function(){this._super()}}),wcNode.extend("wcNodeComposite","Composite","",{init:function(e,t){this._super(e,t),this.color="#009999"},classInit:function(e,t,n){n&&(this.className=e,this.type=t,this.category=n,wcPlay.registerNodeType(e,t,n,wcPlay.NODE_TYPE.COMPOSITE))}}),wcNodeEntry.extend("wcNodeEntryStart","Start","Core",{init:function(e,t){this._super(e,t),this.description("Event that fires once on script execution.")},onStart:function(){this._super(),this.onTriggered()}}),wcNodeProcess.extend("wcNodeProcessDelay","Delay","Core",{init:function(e,t){this._super(e,t),this.description("Waits for a specified amount of time before continuing the flow chain."),this.createProperty("milliseconds",wcPlay.PROPERTY_TYPE.NUMBER,1e3,{description:"The time delay, in milliseconds, to wait before firing the 'out' Exit link."})},onTriggered:function(e){this._super(e);var t=this,n=this.property("milliseconds"),r=this.beginThread(setTimeout(function(){t.triggerExit("out"),t.finishThread(r)},n))}}),wcNodeProcess.extend("wcNodeProcessConsoleLog","Console Log","Debugging",{init:function(e,t){this._super(e,t),this.description("For debugging purposes, will print out a message into the console log the moment it is activated (only if silent mode is not on)."),this.createProperty("message",wcPlay.PROPERTY_TYPE.STRING,"Log message.",{description:"The message that will appear in the console log."})},onTriggered:function(e){this._super(e),this.triggerExit("out");var t=this.engine();if(!t||t.silent())return;var n=this.property("message");console.log(n)}}),wcNodeProcess.extend("wcNodeProcessAlert","Alert","Debugging",{init:function(e,t){this._super(e,t),this.description("For debugging purposes, will popup an alert box with a message the moment it is activated (only if silent mode is not on)."),this.createProperty("message",wcPlay.PROPERTY_TYPE.STRING,"Alert message.",{multiline:!0,description:"The message that will appear in the alert box."})},onTriggered:function(e){this._super(e),this.triggerExit("out");var t=this.engine();if(!t||t.silent())return;var n=this.property("message");alert(n)}}),wcNodeProcess.extend("wcNodeProcessOperation","Operation","Core",{init:function(e,t){this._super(e,t),this.description("Performs a simple math operation on two values."),this.removeEntry("in"),this.createEntry("add","valueA + valueB = result"),this.createEntry("sub","valueA - valueB = result"),this.createEntry("mul","valueA * valueB = result"),this.createEntry("div","valueA / valueB = result"),this.createProperty("valueA",wcPlay.PROPERTY_TYPE.NUMBER,0,{description:"Left hand value for the operation."}),this.createProperty("valueB",wcPlay.PROPERTY_TYPE.NUMBER,0,{description:"Right hand value for the operation."}),this.createProperty("result",wcPlay.PROPERTY_TYPE.NUMBER,0,{description:"The result of the operation."})},onTriggered:function(e){this._super(e);var t=parseFloat(this.property("valueA")),n=parseFloat(this.property("valueB")),r;switch(e){case"add":r=t+n;break;case"sub":r=t-n;break;case"mul":r=t*n;break;case"div":r=t/n}this.property("result",r),this.triggerExit("out")}}),wcNodeStorage.extend("wcNodeStorageGlobal","Global Property","Core",{init:function(e,t){this._super(e,t),this.description("References a global property on the script."),this.createProperty("property",wcPlay.PROPERTY_TYPE.SELECT,"",{items:this.propertyList,description:"The global script property to reference."}),this.createProperty("value",wcPlay.PROPERTY_TYPE.STRING,"",{description:"The current value of the global property chosen above."})},propertyList:function(){var e=[],t=this.engine();if(t){var n=t.listProperties();for(var r=0;r<n.length;++r)e.push(n[r].name)}return e},onPropertyChanged:function(e,t,n){this._super(e,t,n);if(e==="value"){var r=this.property("property");if(r){var i=this.engine();i&&i.property(r,n)}}else e==="property"&&(n?this.property("value",this.property("value")):this.property("value",""))},onPropertyGet:function(e){this._super(e);if(e==="value"){var t=this.property("property");if(t){var n=this.engine();return n&&n.property(t)||0}}},onInitialPropertyChanging:function(e,t,n){this._super(e,t,n);if(e==="value"){var r=this.property("property");if(r){var i=this.engine();i&&i.initialProperty(r,n)}}else if(e==="property"){var i=this.engine();i&&this.property("value",i.property(n))}},onInitialPropertyGet:function(e){this._super(e);if(e==="value"){var t=this.property("property");if(t){var n=this.engine();return n&&n.initialProperty(t)||0}}},onGlobalPropertyChanged:function(e,t,n){this.property("property")==e&&this.property("value",this.property("value"),!0)},onGlobalPropertyRemoved:function(e){this.property("property")==e&&this.property("property","")},onGlobalPropertyRenamed:function(e,t){this.property("property")==e&&this.property("property",t)}}),wcNodeStorage.extend("wcNodeStorageToggle","Toggle","Core",{init:function(e,t){this._super(e,t),this.description("Stores a boolean (toggleable) value."),this.createProperty("value",wcPlay.PROPERTY_TYPE.TOGGLE,!1)}}),wcNodeStorage.extend("wcNodeStorageNumber","Number","Core",{init:function(e,t){this._super(e,t),this.description("Stores a number value."),this.createProperty("value",wcPlay.PROPERTY_TYPE.NUMBER)}}),wcNodeStorage.extend("wcNodeStorageString","String","Core",{init:function(e,t){this._super(e,t),this.description("Stores a string value."),this.createProperty("value",wcPlay.PROPERTY_TYPE.STRING,"",{multiline:!0})}}),wcNodeProcess.extend("wcNodeProcessTutorialViewport","Example Viewport","Tutorial",{init:function(e,t){this._super(e,t),this.description("This node demonstrates an example of using the node's viewport for displaying graphics directly on your node. It can also receive mouse events for interactivity."),this.removeEntry("in"),this.removeExit("out"),this.viewportSize(100,100),this.hoverPos=null,this.mousePressed=!1,this.mouseClicked=!1,this.mouseDoubleClicked=!1,this.createProperty("lock viewport",wcPlay.PROPERTY_TYPE.TOGGLE,!0,{description:"If true, dragging in the viewport will not move the node."})},onViewportDraw:function(e){this._super(e),this.mouseClicked&&(e.fillStyle="green",e.fillRect(0,0,100,50)),this.mouseDoubleClicked&&(e.fillStyle="darkgreen",e.fillRect(0,50,100,50)),e.strokeStyle="red",e.strokeRect(0,0,100,100),e.beginPath(),e.moveTo(0,0),e.lineTo(100,100),e.stroke(),e.beginPath(),e.moveTo(100,0),e.lineTo(0,100),e.stroke(),this.hoverPos&&(e.fillStyle=this.mousePressed?"red":"blue",e.fillRect(this.hoverPos.x-5,this.hoverPos.y-5,10,10))},onViewportMouseEnter:function(e,t){this._super(e,t),this.hoverPos=t},onViewportMouseLeave:function(e){this._super(e),this.hoverPos=null,this.mousePressed=!1},onViewportMouseDown:function(e,t){return this._super(e,t),this.mousePressed=!0,this.property("lock viewport")},onViewportMouseUp:function(e,t){this._super(e,t),this.mousePressed=!1},onViewportMouseMove:function(e,t){this._super(e,t),this.hoverPos=t},onViewportMouseWheel:function(e,t,n){return this._super(e,t,n),this.property("lock viewport")},onViewportMouseClick:function(e,t){this._super(e,t),this.mouseClicked=!this.mouseClicked},onViewportMouseDoubleClick:function(e,t){return this._super(e,t),this.mouseDoubleClicked=!this.mouseDoubleClicked,!0}}),wcNodeProcess.extend("wcNodeProcessTutorialProperties","Example Properties","Tutorial",{init:function(e,t){this._super(e,t),this.description("This node demonstrates an example of the different property types and how their values can be limited."),this.removeEntry("in"),this.removeExit("out"),this.createProperty("toggle",wcPlay.PROPERTY_TYPE.TOGGLE,!0,{description:"Demonstration of the toggle property type."}),this.createProperty("number",wcPlay.PROPERTY_TYPE.NUMBER,3,{description:"Demonstration of the number property type with a clamped range of 1-5.",min:1,max:5}),this.createProperty("string",wcPlay.PROPERTY_TYPE.STRING,"Text",{description:"Demonstration of the string property with a max character length of 10.",maxlength:10}),this.createProperty("select",wcPlay.PROPERTY_TYPE.SELECT,3,{description:"Demonstration of the select property with a dynamic number of options based on the 'number' property.",items:this.selectItems})},selectItems:function(){var e=[],t=parseInt(this.property("number"));for(var n=0;n<t;++n)e.push({name:"Option "+(n+1),value:n+1});return e}}),wcNodeProcess.extend("wcNodeProcessTutorialDynamic","Example Dynamic","Tutorial",{init:function(e,t){this._super(e,t),this.description("This node demonstrates an example of using different flow links to determine how this node behaves."),this.removeEntry("in"),this.createEntry("change color","Change the color of this node!"),this._propCount=0,this.createProperty("count",wcPlay.PROPERTY_TYPE.NUMBER,0,{min:0,max:10,description:"Dynamically create a property for each count."})},onTriggered:function(e){this._super(e);switch(e){case"change color":this.color=="#007ACC"?this.color="#00CC7A":this.color="#007ACC"}this.triggerExit("out")},onPropertyChanged:function(e,t,n){this._super(e,t,n);if(e==="count"){var r=parseInt(n);if(r<this._propCount)while(this._propCount>r)this.removeProperty("Prop "+this._propCount),this._propCount--;else if(r>this._propCount)while(this._propCount<r)this._propCount++,this.createProperty("Prop "+this._propCount,wcPlay.PROPERTY_TYPE.STRING,"val "+this._propCount,{description:"Dynamically created property!"})}}})