/*!
 * Web Cabin Play - Node based visual scripting tool.
 *
 * Dependancies:
 *  JQuery 1.11.1
 *  font-awesome 4.2.0
 *
 * Author: Jeff Houde (lochemage@webcabin.org)
 * Web: https://play.webcabin.org/
 * API: https://play.api.webcabin.org/
 *
 * Licensed under
 *   MIT License http://www.opensource.org/licenses/mit-license
 *
 */
function wcPlay(e){this._entryNodes=[],this._processNodes=[],this._compositeNodes=[],this._storageNodes=[],this._properties=[],this._queuedChain=[],this._queuedProperties=[],this._updateID=0,this._isPaused=!1,this._isStepping=!1,this._editors=[],this._options={silent:!1,updateRate:25,debugging:!0};for(var t in e)this._options[t]=e[t]}function wcPlayEditor(e,t){this.$container=$(e),this.$viewport=null,this._viewportContext=null,this.$palette=null,this._paletteContext=null,this._paletteSize=.25,this._size={x:0,y:0},this._engine=null,this._nodeLibrary={},this._font={title:{size:15,family:"Arial",weight:"bold"},links:{size:10,family:"Arial"},property:{size:10,family:"Arial",weight:"italic"},value:{size:10,family:"Arial",weight:"bold"}},this._drawStyle={palette:{spacing:20},node:{radius:10,margin:10},title:{spacing:5},links:{length:12,width:8,spacing:10,padding:5,margin:10},property:{spacing:5,strLen:10}},this._lastUpdate=0,this._viewportCamera={x:0,y:0,z:1},this._paletteCamera={x:0,y:0,z:1},this._viewportMovingNode=!1,this._viewportMoving=!1,this._viewportMoved=!1,this._paletteMoving=!1,this._mouse=null,this._highlightNode=null,this._selectedNode=null,this._options={readOnly:!1};for(var n in t)this._options[n]=t[n];this.$palette=$('<canvas class="wcPlayPalette">'),this._paletteContext=this.$palette[0].getContext("2d"),this.$viewport=$('<canvas class="wcPlayViewport">'),this._viewportContext=this.$viewport[0].getContext("2d"),this.$container.append(this.$palette),this.$container.append(this.$viewport),this.onResized(),this.__setupControls(),window.requestAnimationFrame(this.__update.bind(this))}(function(){var e=!1,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(){function u(){e?this.classInit&&this.classInit.apply(this,arguments[0]):this.init&&this.init.apply(this,arguments)}var n=arguments[0],r=arguments[arguments.length-1],i=this.prototype;e=!0;var s=new this(arguments);e=!1;for(var o in r)s[o]=typeof r[o]=="function"&&typeof i[o]=="function"&&t.test(r[o])?function(e,t){return function(){var n=this._super;this._super=i[e];var r=t.apply(this,arguments);return this._super=n,r}}(o,r[o]):r[o];u.prototype=s,u.prototype.constructor=u,u.extend=arguments.callee,window[n]=u}})(),wcPlay.PROPERTY_TYPE={TOGGLE:"toggle",NUMBER:"number",STRING:"string",SELECT:"select",COLOR:"color"},wcPlay.NODE_TYPE={ENTRY:"entry",PROCESS:"process",COMPOSITE:"composite",STORAGE:"storage"},wcPlay.NODE_LIBRARY=[],wcPlay.registerNodeType=function(e,t,n,r){for(var i=0;i<wcPlay.NODE_LIBRARY.length;++i)if(wcPlay.NODE_LIBRARY[i].name===e)return!1;return wcPlay.NODE_LIBRARY.push({name:e,displayName:t,category:n,type:r}),!0},wcPlay.prototype={isSilent:function(){return this._options.silent},start:function(){var e=this;this._updateID=setInterval(function(){e.update()},this._options.updateRate),this.__notifyNodes("onStart",[])},update:function(){if(this._isPaused)return;var e=this._queuedProperties.length;while(e){e--;var t=this._queuedProperties.shift();t.node._meta.flash=!0,t.node._meta.paused=!1,t.node.property(t.name,t.value)}if(!this._queuedProperties.length){e=this._queuedChain.length;while(e){e--;var t=this._queuedChain.shift();t.node._meta.flash=!0,t.node._meta.paused=!1,t.node.onTriggered(t.name)}}this._isStepping&&(this._isPaused=!0)},debugging:function(e){return e!==undefined&&(this._options.debugging=e?!0:!1),this._options.debugging},paused:function(e){return e!==undefined&&(this._isPaused=e?!0:!1),this._isPaused},stepping:function(e){return e!==undefined&&(this._isStepping=e?!0:!1),this._isStepping},createProperty:function(e,t,n,r){for(var i=0;i<this._properties.length;++i)if(this._properties[i].name===e)return!1;return wcPlay.PROPERTY_TYPE.hasOwnProperty(t)||(t=wcPlay.PROPERTY_TYPE.STRING),this._properties.push({name:e,value:n,defaultValue:n,controlType:t,options:r||{}}),!0},renameProperty:function(e,t){var n=null;for(var r=0;r<this._properties.length;++r){if(this._properties[r].name===t)return!1;this._properties[r].name===e&&(n=this._properties[r])}if(!n)return!1;n.name=t,this.__notifyNodes("onGlobalPropertyRenamed",[e,t])},property:function(e,t){var n=null;for(var r=0;r<this._properties.length;++r)if(this._properties[r].name===e){n=this._properties[r];break}if(!n)return;if(t!==undefined&&t!==n.value){var i=n.value;n.value=t,this.__notifyNodes("onGlobalPropertyChanged",[n.name,i,n.value])}},triggerEvent:function(e,t){for(var n=0;n<this._entryNodes.length;++n)this._entryNodes[n].name===e&&this._entryNodes[n].onTriggered(t)},queueNodeEntry:function(e,t){if(e.enabled()){this._queuedChain.push({node:e,name:t});if(e.debugBreak()||this._isStepping)e._meta.flash=!0,e._meta.paused=!0,this._isPaused=!0}},queueNodeProperty:function(e,t,n){if(e.enabled()){this._queuedProperties.push({node:e,name:t,value:n});if(e.debugBreak()||this._isStepping)e._meta.flash=!0,e._meta.paused=!0,this._isPaused=!0}},__addNode:function(e){e instanceof wcNodeEntry?this._entryNodes.push(e):e instanceof wcNodeProcess?this._processNodes.push(e):e instanceof wcNodeStorage?this._storageNodes.push(e):e instanceof wcNodeComposite&&this._compositeNodes.push(e)},__removeNode:function(e){e instanceof wcNodeEntry?this._entryNodes.splice(this._entryNodes.indexOf(e),1):e instanceof wcNodeProcess?this._processNodes.splice(this._processNodes.indexOf(e),1):e instanceof wcNodeStorage?this._storageNodes.splice(this._storageNodes.indexOf(e),1):e instanceof wcNodeComposite&&this._compositeNodes.splice(this._compositeNodes.indexOf(e),1)},__notifyNodes:function(e,t){var n;for(var r=0;r<this._storageNodes.length;++r)n=this._storageNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._processNodes.length;++r)n=this._processNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._compositeNodes.length;++r)n=this._compositeNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._entryNodes.length;++r)n=this._entryNodes[r],typeof n[e]=="function"&&n[e].apply(n,t)},__notifyEditors:function(e,t){var n;for(var r=0;r<this._editors.length;++r)n=this._editors[r],typeof n[e]=="function"&&n[e].apply(n,t)}},wcPlayEditor.prototype={engine:function(e){if(e!==undefined){if(this._engine){var t=this._engine._editors.indexOf(this);t>-1&&this._engine._editors.splice(t,1)}this._engine=e,this._engine&&this._engine._editors.push(this)}return this._engine},center:function(){},onResized:function(){var e=this.$container.width(),t=this.$container.height();if(this._size.x!==e||this._size.y!==t){this._size.x=e,this._size.y=t;var n=e*this._paletteSize;this.$palette.css("width",n).attr("width",n).attr("height",t),this.$viewport.css("width",e-n).attr("width",e-n).attr("height",t)}},__mouse:function(e,t,n){if(e.originalEvent&&(e.originalEvent.touches||e.originalEvent.changedTouches)){var r=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0];return{x:r.clientX-(t?t.left:0)-(n?n.x:0),y:r.clientY-(t?t.top:0)-(n?n.y:0),which:1}}return{x:(e.clientX||e.pageX)-(t?t.left:0)-(n?n.x:0),y:(e.clientY||e.pageY)-(t?t.top:0)-(n?n.y:0),which:e.which||1}},__setCanvasFont:function(e,t){t.font=(e.weight?e.weight+" ":"")+(e.size+"px ")+e.family},__clampString:function(e,t){return e.length>t?e.substring(0,t)+"...":e},__blendColors:function(e,t,n){var r=n<0?n*-1:n,i=Math.round,s=parseInt;if(e.length>7){var o=e.split(","),u=(t?t:n<0?"rgb(0,0,0)":"rgb(255,255,255)").split(","),a=s(o[0].slice(4)),f=s(o[1]),l=s(o[2]);return"rgb("+(i((s(u[0].slice(4))-a)*r)+a)+","+(i((s(u[1])-f)*r)+f)+","+(i((s(u[2])-l)*r)+l)+")"}var o=s(e.slice(1),16),u=s((t?t:n<0?"#000000":"#FFFFFF").slice(1),16),c=o>>16,h=o>>8&255,p=o&255;return"#"+(16777216+(i(((u>>16)-c)*r)+c)*65536+(i(((u>>8&255)-h)*r)+h)*256+(i(((u&255)-p)*r)+p)).toString(16).slice(1)},__expandRect:function(e){var t={top:e[0].top,left:e[0].left,width:e[0].width,height:e[0].height};for(var n=1;n<e.length;++n)e[n].top<t.top&&(t.top=e[n].top),e[n].left<t.left&&(t.left=e[n].left),e[n].top+e[n].height>t.top+t.height&&(t.height=e[n].top+e[n].height-t.top),e[n].left+e[n].width>t.left+t.width&&(t.width=e[n].left+e[n].width-t.left);return t},__inRect:function(e,t,n){return n===undefined&&(n={x:0,y:0}),e.y-n.y>=t.top&&e.x-n.x>=t.left&&e.y-n.y<=t.top+t.height&&e.x-n.x<=t.left+t.width?!0:!1},__drawRect:function(e,t,n){n.strokeStyle=t,n.strokeRect(e.left,e.top,e.width,e.height)},__drawRoundedRect:function(e,t,n,r,i){i.save(),i.strokeStyle=t,i.lineWidth=n,i.beginPath(),i.moveTo(e.left+r,e.top),i.arcTo(e.left+e.width,e.top,e.left+e.width,e.top+r,r),i.arcTo(e.left+e.width,e.top+e.height,e.left+e.width-r,e.top+e.height,r),i.arcTo(e.left,e.top+e.height,e.left,e.top+e.height-r,r),i.arcTo(e.left,e.top,e.left+r,e.top,r),i.closePath(),i.stroke(),i.restore()},__update:function(e){this._lastUpdate||(this._lastUpdate=e);var t=(e-this._lastUpdate)/1e3;this._lastUpdate=e,this.onResized();if(this._engine){for(var n=0;n<wcPlay.NODE_LIBRARY.length;++n){var r=wcPlay.NODE_LIBRARY[n];this._nodeLibrary.hasOwnProperty(r.category)||(this._nodeLibrary[r.category]={});if(!this._nodeLibrary[r.category].hasOwnProperty(r.name)){var i=this._nodeLibrary[r.category][r.name]=new window[r.name](null);this.__updateNode(i,0)}}this._paletteContext.clearRect(0,0,this.$palette.width(),this.$palette.height());var s=this._drawStyle.palette.spacing,o=this.$palette.width()/2;for(var u in this._nodeLibrary)for(var i in this._nodeLibrary[u]){var a=this.__drawNode(this._nodeLibrary[u][i],{x:this._paletteCamera.x+o,y:this._paletteCamera.y+s},this._paletteContext);s+=a.rect.height+this._drawStyle.palette.spacing}this.__updateNodes(this._engine._entryNodes,t),this.__updateNodes(this._engine._processNodes,t),this.__updateNodes(this._engine._compositeNodes,t),this.__updateNodes(this._engine._storageNodes,t),this._viewportContext.clearRect(-this._viewportCamera.x,-this._viewportCamera.y,this.$viewport.width(),this.$viewport.height()),this.__drawNodes(this._engine._entryNodes,this._viewportContext),this.__drawNodes(this._engine._processNodes,this._viewportContext),this.__drawNodes(this._engine._compositeNodes,this._viewportContext),this.__drawNodes(this._engine._storageNodes,this._viewportContext),this.__drawChains(this._engine._entryNodes,this._viewportContext),this.__drawChains(this._engine._processNodes,this._viewportContext),this.__drawChains(this._engine._compositeNodes,this._viewportContext),this.__drawChains(this._engine._storageNodes,this._viewportContext)}window.requestAnimationFrame(this.__update.bind(this))},__updateNodes:function(e,t){for(var n=0;n<e.length;++n)this.__updateNode(e[n],t)},__updateNode:function(e,t){function r(e,r,i,s,o,u){e.flash?(e.flashDelta+=t*10,e.flashDelta>=1&&(e.flashDelta=1,!e.awake&&(!e.paused||!o&&!n._engine.paused())&&(e.flash=!1))):e.flashDelta>0&&(e.flashDelta-=t*5,e.flashDelta<=0&&(e.flashDelta=0,e.paused=o?e.paused:!1)),e.color=n.__blendColors(r,e.paused?s:i,e.flashDelta*u)}var n=this,i=e.color;this._highlightNode===e&&(i=this.__blendColors(e.color,"#00FFFF",.5)),r(e._meta,i,"#FFFFFF","#FFFFFF",!0,.5);var s="#000000",o="#FFFF00";for(var u=0;u<e.chain.entry.length;++u)r(e.chain.entry[u].meta,s,o,o,!1,.9);for(var u=0;u<e.chain.exit.length;++u)r(e.chain.exit[u].meta,s,o,o,!1,.9);for(var u=0;u<e.properties.length;++u)r(e.properties[u].inputMeta,s,o,o,!1,.9),r(e.properties[u].outputMeta,s,o,o,!1,.9)},__drawNodes:function(e,t,n){for(var r=0;r<e.length;++r)this.__drawNode(e[r],e[r].pos,t,n)},__drawNode:function(e,t,n,r){var i={node:e,rect:{top:t.y,left:t.x,width:0,height:0}},s=this.__measureEntryLinks(e,n,t),o=this.__measureCenter(e,n,{x:t.x,y:t.y+s.height}),u=this.__measureExitLinks(e,n,{x:t.x,y:t.y+s.height+o.height}),a=this.__expandRect([s,o,u]);a.top=o.top,a.height=o.height;var f=this.__drawCenter(e,n,a),l=this.__drawEntryLinks(e,n,t,s.width),c=this.__drawExitLinks(e,n,{x:t.x,y:t.y+s.height+o.height},u.width);return i.entryBounds=l,i.exitBounds=c,i.inputBounds=f.inputBounds,i.outputBounds=f.outputBounds,i.valueBounds=f.valueBounds,i.rect=this.__expandRect([s,o,u]),i.rect.left-=this._drawStyle.links.length,i.rect.width+=this._drawStyle.links.length*2,i.inner=this.__expandRect([o]),e.chain.entry.length?(i.inner.top-=this._drawStyle.links.padding+this._font.links.size,i.inner.height+=this._drawStyle.links.padding+this._font.links.size):(i.rect.top-=this._drawStyle.links.length,i.rect.height+=this._drawStyle.links.length),e.chain.exit.length?i.inner.height+=this._drawStyle.links.padding+this._font.links.size:i.rect.height+=this._drawStyle.links.length,e._meta.flashDelta&&(e._meta.paused?this.__drawRoundedRect(i.inner,"#CC0000",5,10,n):this.__drawRoundedRect(i.inner,e.color,5,10,n)),e===this._selectedNode&&this.__drawRoundedRect(i.rect,"cyan",2,10,n),e._meta.bounds=i,i},__measureEntryLinks:function(e,t,n){var r={top:n.y,left:n.x,width:0,height:0};this.__setCanvasFont(this._font.links,t);var i=e.collapsed(),s=e.chain.entry;for(var o=0;o<s.length;++o)if(!i||s[o].links.length)r.width+=t.measureText(s[o].name).width+this._drawStyle.links.spacing;return r.left-=r.width/2+this._drawStyle.links.margin,r.width+=this._drawStyle.links.margin*2,e.chain.entry.length&&(r.height=this._font.links.size+this._drawStyle.links.padding+this._drawStyle.links.length),r},__measureExitLinks:function(e,t,n){var r={top:n.y,left:n.x,width:0,height:0};this.__setCanvasFont(this._font.links,t);var i=e.collapsed(),s=e.chain.exit;for(var o=0;o<s.length;++o)if(!i||s[o].links.length)r.width+=t.measureText(s[o].name).width+this._drawStyle.links.spacing;return r.left-=r.width/2+this._drawStyle.links.margin,r.width+=this._drawStyle.links.margin*2,e.chain.exit.length&&(r.height=this._font.links.size+this._drawStyle.links.padding+this._drawStyle.links.length),r},__measureCenter:function(e,t,n){var r={top:n.y,left:n.x,width:0,height:this._font.title.size+this._drawStyle.title.spacing+this._drawStyle.links.padding};this.__setCanvasFont(this._font.title,t),r.width=t.measureText(e.name).width;var i=e.collapsed(),s=e.properties;for(var o=0;o<s.length;++o){r.height+=this._font.property.size+this._drawStyle.property.spacing,this.__setCanvasFont(this._font.property,t);var u=t.measureText(s[o].name+": ").width;this.__setCanvasFont(this._font.value,t),u+=t.measureText("["+this.__clampString(e.property(s[o].name).toString(),this._drawStyle.property.strLen)+"]").width,r.width=Math.max(u,r.width)}return r.left-=r.width/2+this._drawStyle.node.margin,r.width+=this._drawStyle.node.margin*2,r},__drawEntryLinks:function(e,t,n,r){var i=n.x-r/2+this._drawStyle.links.margin,s=n.y+this._drawStyle.links.length+this._font.links.size;this.__setCanvasFont(this._font.links,t);var o=[],u=e.collapsed(),a=e.chain.entry;for(var f=0;f<a.length;++f)if(!u||a[f].links.length){t.fillStyle="black";var l=t.measureText(a[f].name).width+this._drawStyle.links.spacing;t.fillText(a[f].name,i+this._drawStyle.links.spacing/2,s);var c={top:s-this._drawStyle.links.length-this._font.links.size,left:i+l/2-this._drawStyle.links.width/2,width:this._drawStyle.links.width,height:this._drawStyle.links.length};t.fillStyle=a[f].meta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(c.left,c.top),t.lineTo(c.left+c.width/2,c.top+c.height/3),t.lineTo(c.left+c.width,c.top),t.lineTo(c.left+c.width,c.top+c.height),t.lineTo(c.left,c.top+c.height),t.closePath(),t.stroke(),t.fill(),o.push({rect:c,name:a[f].name}),i+=l}return o},__drawExitLinks:function(e,t,n,r){var i=n.x-r/2+this._drawStyle.links.margin,s=n.y+this._font.links.size;this.__setCanvasFont(this._font.links,t);var o=[],u=e.collapsed(),a=e.chain.exit;for(var f=0;f<a.length;++f)if(!u||a[f].links.length){t.fillStyle="black";var l=t.measureText(a[f].name).width+this._drawStyle.links.spacing;t.fillText(a[f].name,i+this._drawStyle.links.spacing/2,s);var c={top:s+this._drawStyle.links.padding,left:i+l/2-this._drawStyle.links.width/2,width:this._drawStyle.links.width,height:this._drawStyle.links.length};t.fillStyle=a[f].meta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(c.left,c.top),t.lineTo(c.left+c.width,c.top),t.lineTo(c.left+c.width,c.top+c.height/2),t.lineTo(c.left+c.width/2,c.top+c.height),t.lineTo(c.left,c.top+c.height/2),t.closePath(),t.stroke(),t.fill(),o.push({rect:c,name:a[f].name}),i+=l}return o},__drawCenter:function(e,t,n){var r=e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0,i=e.chain.exit.length?this._font.links.size+this._drawStyle.links.padding:0;t.save();var s=n.left+n.width/2,o=n.top+n.height/2,u=t.createRadialGradient(s,o,10,s,o,Math.max(n.width,n.height));u.addColorStop(0,e._meta.color),u.addColorStop(1,"white"),t.fillStyle=t.strokeStyle=u,t.lineJoin="round";var a=this._drawStyle.node.radius*2;t.lineWidth=a,t.fillRect(n.left+a/2,n.top-r+a/2,n.width-a,n.height+r+i-a),t.strokeRect(n.left+a/2,n.top-r+a/2,n.width-a,n.height+r+i-a),t.restore(),this.__drawRoundedRect({left:n.left,top:n.top-r,width:n.width,height:n.height+r+i},e._meta.color,3,this._drawStyle.node.radius,t),r=0,e.chain.entry.length&&(t.strokeStyle=e._meta.color,t.beginPath(),t.moveTo(n.left,n.top+r),t.lineTo(n.left+n.width,n.top+r),t.stroke()),r+=this._font.title.size,t.fillStyle="black",t.strokeStyle="black",this.__setCanvasFont(this._font.title,t),t.fillText(e.name,n.left+this._drawStyle.node.margin,n.top+r),r+=this._drawStyle.title.spacing;var f={valueBounds:[],inputBounds:[],outputBounds:[]},l;t.save();var c=e.collapsed(),h=e.properties;for(var p=0;p<h.length;++p){r+=this._font.property.size,t.fillStyle="black",t.textAlign="left",this.__setCanvasFont(this._font.property,t),t.fillText(h[p].name+": ",n.left+this._drawStyle.node.margin,n.top+r),t.textAlign="right",this.__setCanvasFont(this._font.value,t),t.fillText("["+this.__clampString(e.property(h[p].name).toString(),this._drawStyle.property.strLen)+"]",n.left+n.width-this._drawStyle.node.margin,n.top+r);var d=t.measureText("["+this.__clampString(e.property(h[p].name).toString(),this._drawStyle.property.strLen)+"]").width;f.valueBounds.push({rect:{top:n.top+r-this._font.property.size,left:n.left+n.width-this._drawStyle.node.margin-d,width:d,height:this._font.property.size+this._drawStyle.property.spacing},name:h[p].name});if(!c||h[p].inputs.length)l={top:n.top+r-this._font.property.size/3-this._drawStyle.links.width/2,left:n.left-this._drawStyle.links.length,width:this._drawStyle.links.length,height:this._drawStyle.links.width},t.fillStyle=h[p].inputMeta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(l.left,l.top),t.lineTo(l.left+l.width,l.top),t.lineTo(l.left+l.width,l.top+l.height),t.lineTo(l.left,l.top+l.height),t.lineTo(l.left+l.width/3,l.top+l.height/2),t.closePath(),t.stroke(),t.fill(),f.inputBounds.push({rect:l,name:h[p].name});if(!c||h[p].outputs.length)l={top:n.top+r-this._font.property.size/3-this._drawStyle.links.width/2,left:n.left+n.width,width:this._drawStyle.links.length,height:this._drawStyle.links.width},t.fillStyle=h[p].outputMeta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(l.left,l.top),t.lineTo(l.left+l.width/2,l.top),t.lineTo(l.left+l.width,l.top+l.height/2),t.lineTo(l.left+l.width/2,l.top+l.height),t.lineTo(l.left,l.top+l.height),t.closePath(),t.stroke(),t.fill(),f.outputBounds.push({rect:l,name:h[p].name});r+=this._drawStyle.property.spacing}return t.restore(),e.chain.exit.length&&(t.strokeStyle=e._meta.color,t.beginPath(),t.moveTo(n.left,n.top+n.height),t.lineTo(n.left+n.width,n.top+n.height),t.stroke()),f},__drawChains:function(e,t){for(var n=0;n<e.length;++n)this.__drawNodeChains(e[n],t)},__drawNodeChains:function(e,t){for(var n=0;n<e.chain.exit.length;++n){var r=e.chain.exit[n];if(!r.links.length)continue;var i;for(var s=0;s<e._meta.bounds.exitBounds.length;++s)if(e._meta.bounds.exitBounds[s].name===r.name){i=e._meta.bounds.exitBounds[s].rect;break}if(!i){console.log("ERROR: Attempted to draw chains for an exit link that has no meta data.");continue}for(var s=0;s<r.links.length;++s){var o=r.links[s].node,u=r.links[s].name,a;for(var f=0;f<o.chain.entry.length;++f)if(o.chain.entry[f].name===u){a=o.chain.entry[f];break}if(!a){console.log("ERROR: Attempted to chain an exit link to an entry link that was not found.");continue}var l;for(var f=0;f<o._meta.bounds.entryBounds.length;++f)if(o._meta.bounds.entryBounds[f].name===a.name){l=o._meta.bounds.entryBounds[f].rect;break}if(!l){console.log("ERROR: Attempted to draw chains to an entry link that has no meta data.");continue}this.__drawChain({x:i.left+i.width/2,y:i.top+i.height},{x:l.left+l.width/2,y:l.top+l.height/3},e._meta.bounds.rect,o._meta.bounds.rect,t)}}for(var n=0;n<e.properties.length;++n){var c=e.properties[n];if(!c.outputs.length)continue;var h;for(var s=0;s<e._meta.bounds.outputBounds.length;++s)if(e._meta.bounds.outputBounds[s].name===c.name){h=e._meta.bounds.outputBounds[s].rect;break}if(!h){console.log("ERROR: Attempted to draw chains for an output link that has no meta data.");continue}for(var s=0;s<c.outputs.length;++s){var o=c.outputs[s].node,u=c.outputs[s].name,p;for(var f=0;f<o.properties.length;++f)o.properties[f].name===u&&(p=o.properties[f]);if(!p){console.log("ERROR: Attempted to chain a property link to a property that was not found.");continue}var d;for(var f=0;f<o._meta.bounds.inputBounds.length;++f)if(o._meta.bounds.inputBounds[f].name===p.name){d=o._meta.bounds.inputBounds[f].rect;break}if(!d){console.log("ERROR: Attempted to draw chains to a property input link that has no meta data.");continue}this.__drawPropertyChain({x:h.left+h.width,y:h.top+h.height/2},{x:d.left+d.width/3,y:d.top+d.height/2},e._meta.bounds.rect,o._meta.bounds.rect,t)}}},__drawChain:function(e,t,n,r,i){i.save(),i.strokeStyle="#000000",i.lineWidth=2,i.beginPath(),i.moveTo(e.x,e.y),i.lineTo(t.x,t.y),i.stroke(),i.restore()},__drawPropertyChain:function(e,t,n,r,i){i.save(),i.strokeStyle="#000000",i.lineWidth=2,i.beginPath(),i.moveTo(e.x,e.y),i.lineTo(t.x,t.y),i.stroke(),i.restore()},__setupControls:function(){var e=this;this.$viewport.on("mousemove",function(t){e.__onViewportMouseMove(t,this)}),this.$viewport.on("mousedown",function(t){e.__onViewportMouseDown(t,this)}),this.$viewport.on("mouseup",function(t){e.__onViewportMouseUp(t,this)})},__onViewportMouseMove:function(e,t){var n=this.__mouse(e,this.$viewport.offset());if(this._viewportMoving){var r=n.x-this._mouse.x,i=n.y-this._mouse.y;this._viewportCamera.x+=r,this._viewportCamera.y+=i,this._viewportContext.translate(r,i),this._mouse=n,this._viewportMoved||(this._viewportMoved=!0,this.$viewport.addClass("wcMoving"));return}if(this._viewportMovingNode){var r=n.x-this._mouse.x,i=n.y-this._mouse.y;this._selectedNode.pos.x+=r,this._selectedNode.pos.y+=i,this._mouse=n;return}var s=this.__findNodeAtPos(n,this._viewportCamera);this._highlightNode!==s&&(s?this.__inRect(n,s._meta.bounds.inner,this._viewportCamera)&&(this._highlightNode=s):this._highlightNode=null,this.$viewport.toggleClass("wcClickable",this._highlightNode!=null))},__onViewportMouseDown:function(e,t){this._mouse=this.__mouse(e,this.$viewport.offset());var n=this.__findNodeAtPos(this._mouse,this._viewportCamera);n?(this._selectedNode=n,this._viewportMovingNode=!0):(this._viewportMoving=!0,this._viewportMoved=!1)},__onViewportMouseUp:function(e,t){this._viewportMovingNode=!1,this._viewportMoving&&(this._viewportMoving=!1,this._viewportMoved?(this._viewportMoved=!1,this.$viewport.removeClass("wcMoving")):this._selectedNode=null)},__findNodeAtPos:function(e,t){if(this._engine){var n=this;function r(r){for(var i=r.length-1;i>=0;--i)if(r[i]._meta.bounds&&n.__inRect(e,r[i]._meta.bounds.rect,t))return r[i];return null}return r(this._engine._storageNodes)||r(this._engine._compositeNodes)||r(this._engine._processNodes)||r(this._engine._entryNodes)}return null}},Class.extend("wcNode","Node","",{init:function(e,t,n){this.name=n||this.name,this.color="#FFFFFF",this.pos={x:t&&t.x||0,y:t&&t.y||0},this.chain={entry:[],exit:[]},this.properties=[],this._meta={flash:!1,flashDelta:0,awake:!1,color:null,paused:!1},this._collapsed=!1,this._awake=!1,this._log=!1,this._break=!1,this._parent=e,this.createProperty(wcNode.PROPERTY.ENABLED,wcPlay.PROPERTY_TYPE.TOGGLE,!0);var r=this.engine();r&&r.__addNode(this)},classInit:function(e,t,n){n&&(this.className=e,this.name=t,this.category=n,wcPlay.registerNodeType(e,t,n,wcPlay.NODE_TYPE.STORAGE))},destroy:function(){for(var e=0;e<this.chain.entry.length;++e){var t=this.chain.entry[e];this.disconnectEntry(t.name)}for(var e=0;e<this.chain.exit.length;++e){var t=this.chain.exit[e];this.disconnectExit(t.name)}for(var e=0;e<this.properties.length;++e){var t=this.properties[e];this.disconnectInput(t.name),this.disconnectOutput(t.name)}var n=this.engine();n&&n.__removeNode(this)},engine:function(){var e=this._parent;while(e&&!(e instanceof wcPlay))e=e._parent;return e||null},enabled:function(e){return e!==undefined&&this.property(wcNode.PROPERTY.ENABLED,e?!0:!1),this.property(wcNode.PROPERTY.ENABLED)},debugLog:function(e){e!==undefined&&(this._log=e?!0:!1);var t=this.engine();return!t||t.isSilent()?!1:this._log},debugBreak:function(e){e!==undefined&&(this._break=e?!0:!1);var t=this.engine();return t.debugging()&&this._break},collapsed:function(e){return e!==undefined&&(this._collapsed=e),this._collapsed},wake:function(){this._meta.awake=!0},sleep:function(){this._meta.awake=!1},pos:function(e){return e!==undefined&&(this.pos.x=e.x,this.pos.y=e.y),{x:this.pos.x,y:this.pos.y}},createEntry:function(e){for(var t=0;t<this.chain.entry.length;++t)if(this.chain.entry[t].name===e)return!1;return this.chain.entry.push({name:e,active:!1,links:[],meta:{flash:!1,flashDelta:0,color:"#000000"}}),!0},createExit:function(e){for(var t=0;t<this.chain.exit.length;++t)if(this.chain.exit[t].name===e)return!1;return this.chain.exit.push({name:e,links:[],meta:{flash:!1,flashDelta:0,color:"#000000"}}),!0},createProperty:function(e,t,n,r){for(var i=0;i<this.properties.length;++i)if(this.properties[i].name===e)return!1;return wcPlay.PROPERTY_TYPE.hasOwnProperty(t)||(t=wcPlay.PROPERTY_TYPE.STRING),this.properties.push({name:e,value:n,defaultValue:n,controlType:t,inputs:[],outputs:[],options:r||{},inputMeta:{flash:!1,flashDelta:0,color:"#000000"},outputMeta:{flash:!1,flashDelta:0,color:"#000000"}}),!0},removeEntry:function(e){for(var t=0;t<this.chain.entry.length;++t)if(this.chain.entry[t].name===e&&this.disconnectEntry(e)===wcNode.CONNECT_RESULT.SUCCESS)return this.chain.entry.splice(t,1),!0;return!1},removeExit:function(e){for(var t=0;t<this.chain.exit.length;++t)if(this.chain.exit[t].name===e&&this.disconnectExit(e)===wcNode.CONNECT_RESULT.SUCCESS)return this.chain.exit.splice(t,1),!0;return!1},removeProperty:function(e){for(var t=0;t<this.properties.length;++t)if(this.properties[t].name===e&&this.disconnectInput(e)===this.disconnectOutput(e)===wcNode.CONNECT_RESULT.SUCCESS)return this.properties.splice(t,1),!0;return!1},connectEntry:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.chain.entry.length;++s)if(this.chain.entry[s].name===e){r=this.chain.entry[s];break}for(var s=0;s<t.chain.exit.length;++s)if(t.chain.exit[s].name===n){i=t.chain.exit[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.links.length;++s)if(r.links[s].node===t&&r.links[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.links.length;++s)if(i.links[s].node===this&&i.links[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.links.push({name:i.name,node:t}),i.links.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.ENTRY,t,i.name,wcNode.LINK_TYPE.EXIT),t.onConnect(!0,i.name,wcNode.LINK_TYPE.EXIT,this,r.name,wcNode.LINK_TYPE.ENTRY),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},connectExit:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.chain.exit.length;++s)if(this.chain.exit[s].name===e){r=this.chain.exit[s];break}for(var s=0;s<t.chain.entry.length;++s)if(t.chain.entry[s].name===n){i=t.chain.entry[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.links.length;++s)if(r.links[s].node===t&&r.links[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.links.length;++s)if(i.links[s].node===this&&i.links[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.links.push({name:i.name,node:t}),i.links.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.EXIT,t,i.name,wcNode.LINK_TYPE.ENTRY),t.onConnect(!0,i.name,wcNode.LINK_TYPE.ENTRY,this,r.name,wcNode.LINK_TYPE.EXIT),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},connectInput:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.properties.length;++s)if(this.properties[s].name===e){r=this.properties[s];break}for(var s=0;s<t.properties.length;++s)if(t.properties[s].name===n){i=t.properties[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.inputs.length;++s)if(r.inputs[s].node===t&&r.inputs[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.outputs.length;++s)if(i.outputs[s].node===this&&i.outputs[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.inputs.push({name:i.name,node:t}),i.outputs.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.INPUT,t,i.name,wcNode.LINK_TYPE.OUTPUT),t.onConnect(!0,i.name,wcNode.LINK_TYPE.OUTPUT,this,r.name,wcNode.LINK_TYPE.INPUT),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},connectOutput:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.properties.length;++s)if(this.properties[s].name===e){r=this.properties[s];break}for(var s=0;s<t.properties.length;++s)if(t.properties[s].name===n){i=t.properties[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.outputs.length;++s)if(r.outputs[s].node===t&&r.outputs[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.inputs.length;++s)if(i.inputs[s].node===this&&i.inputs[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.outputs.push({name:i.name,node:t}),i.inputs.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.OUTPUT,t,i.name,wcNode.LINK_TYPE.INPUT),t.onConnect(!0,i.name,wcNode.LINK_TYPE.INPUT,this,r.name,wcNode.LINK_TYPE.OUTPUT),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},disconnectEntry:function(e,t,n){var r=null;for(var i=0;i<this.chain.entry.length;++i)if(this.chain.entry[i].name===e){r=this.chain.entry[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.links.length;++i){var s=r.links[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.links.splice(i,1),i--,s.node.disconnectExit(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},disconnectExit:function(e,t,n){var r=null;for(var i=0;i<this.chain.exit.length;++i)if(this.chain.exit[i].name===e){r=this.chain.exit[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.links.length;++i){var s=r.links[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.links.splice(i,1),i--,s.node.disconnectEntry(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},disconnectInput:function(e,t,n){var r=null;for(var i=0;i<this.properties.length;++i)if(this.properties[i].name===e){r=this.properties[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.inputs.length;++i){var s=r.inputs[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.inputs.splice(i,1),i--,s.node.disconnectOutput(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},disconnectOutput:function(e,t,n){var r=null;for(var i=0;i<this.properties.length;++i)if(this.properties[i].name===e){r=this.properties[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.outputs.length;++i){var s=r.outputs[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.outputs.splice(i,1),i--,s.node.disconnectInput(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},triggerEntry:function(e){for(var t=0;t<this.chain.entry.length;++t)if(this.chain.entry[t].name==e){var n=this.engine();this.chain.entry[t].meta.flash=!0;if(this.debugBreak()||n&&n.stepping())this.chain.entry[t].meta.paused=!0;return n&&n.queueNodeEntry(this,this.chain.entry[t].name),!0}return!1},triggerExit:function(e){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.name+'" Triggered Exit link "'+e+'"');for(var t=0;t<this.chain.exit.length;++t){var n=this.chain.exit[t];if(n.name==e){this.chain.exit[t].meta.flash=!0;var r=this.engine();for(var i=0;i<n.links.length;++i)if(n.links[i].node){n.links[i].node.triggerEntry(n.links[i].name);if(n.links[i].node.debugBreak()||r&&r.stepping())this.chain.exit[t].meta.paused=!0}return!0}}return!1},property:function(e,t,n){for(var r=0;r<this.properties.length;++r){var i=this.properties[r];if(i.name===e){if(t!==undefined){var s=i.value,o=this.engine();i.outputMeta.flash=!0;if(this.debugBreak()||o&&o.stepping())i.outputMeta.paused=!0;if(n||i.value!==t)t=this.onPropertyChanging(i.name,s,t)||t;if(n||i.value!==t){i.value=t,this.onPropertyChanged(i.name,s,t);for(a=0;a<i.outputs.length;++a)i.outputs[a].node&&i.outputs[a].node.triggerProperty(i.outputs[a].name,t)}}return i.value}}},triggerProperty:function(e,t){var n=this.engine();n&&n.queueNodeProperty(this,e,t);for(var r=0;r<this.properties.length;++r){var i=this.properties[r];if(i.name===e){i.inputMeta.flash=!0;if(this.debugBreak()||n&&n.stepping())i.inputMeta.paused=!0}}},defaultValue:function(e,t){for(var n=0;n<this.properties.length;++n){var r=this.properties[n];r.name===e&&(r.defaultValue=t)}},onConnect:function(e,t,n,r,i,s){},onStart:function(){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.name+'" started!')},onTriggered:function(e){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.name+'" Triggered Entry link "'+e+'"')},onPropertyChanging:function(e,t,n){},onPropertyChanged:function(e,t,n){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.name+'" Changed Property "'+e+'" from "'+t+'" to "'+n+'"')},onPropertyGet:function(e){},onPropertyGot:function(e){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.name+'" Got Property "'+e+'"')}}),wcNode.LINK_TYPE={ENTRY:"entry",EXIT:"exit",INPUT:"input",OUTPUT:"output"},wcNode.CONNECT_RESULT={NOT_FOUND:"not_found",ALREADY_CONNECTED:"already_connected",SUCCESS:"success"},wcNode.PROPERTY={ENABLED:"enabled"},wcNode.extend("wcNodeEntry","Entry Node","",{init:function(e,t,n){this._super(e,t,n),this.color="#CCCC00",this.createExit("out")},classInit:function(e,t,n){n&&(this.className=e,this.name=t,this.category=n,wcPlay.registerNodeType(e,t,n,wcPlay.NODE_TYPE.ENTRY))},onTriggered:function(e){this.triggerCondition(e)&&this.triggerExit("out")},triggerCondition:function(e){return!0}}),wcNode.extend("wcNodeProcess","Node Process","",{init:function(e,t,n){this._super(e,t,n),this.color="#007ACC",this.createEntry("in"),this.createExit("out")},classInit:function(e,t,n){n&&(this.className=e,this.name=t,this.category=n,wcPlay.registerNodeType(e,t,n,wcPlay.NODE_TYPE.PROCESS))}}),wcNode.extend("wcNodeStorage","Storage","Core",{init:function(e,t,n){this._super(e,t,n),this.color="#009900",this.createProperty("value",wcPlay.PROPERTY_TYPE.STRING,"")},onStart:function(){this._super(),this.property("value",this.property("value"),!0)}}),wcNodeEntry.extend("wcNodeEntryStart","Start","Core",{init:function(e,t,n){this._super(e,t,n)},onStart:function(){this._super(),this.onTriggered()}}),wcNodeProcess.extend("wcNodeProcessDelay","Delay","Core",{init:function(e,t,n){this._super(e,t,n),this.createExit("finished"),this.createProperty("milliseconds",wcPlay.PROPERTY_TYPE.NUMBER,1e3)},onTriggered:function(e){this._super(e),this.triggerExit("out"),this.wake();var t=this,n=this.property("milliseconds");setTimeout(function(){t.triggerExit("finished"),t.sleep()},n)}}),wcNodeProcess.extend("wcNodeProcessLog","Log","Core",{init:function(e,t,n){this._super(e,t,n),this.createProperty("message",wcPlay.PROPERTY_TYPE.STRING,"Log message.")},onTriggered:function(e){this._super(e);var t=this.property("message");console.log("LOG: "+t),this.triggerExit("out")}}),wcNodeProcess.extend("wcNodeProcessOperation","Operation","Core",{init:function(e,t,n){this._super(e,t,n),this.removeEntry("in"),this.createEntry("add"),this.createEntry("sub"),this.createEntry("mul"),this.createEntry("div"),this.createProperty("valueA",wcPlay.PROPERTY_TYPE.NUMBER,0),this.createProperty("valueB",wcPlay.PROPERTY_TYPE.NUMBER,0),this.createProperty("result",wcPlay.PROPERTY_TYPE.NUMBER,0)},onTriggered:function(e){this._super(e);var t=parseFloat(this.property("valueA")),n=parseFloat(this.property("valueB")),r;switch(e){case"add":r=t+n;break;case"sub":r=t-n;break;case"mul":r=t*n;break;case"div":r=t/n}this.property("result",r),this.triggerExit("out")}})