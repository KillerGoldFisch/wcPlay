/*!
 * Web Cabin Play - Node based visual scripting tool.
 *
 * Dependancies:
 *  JQuery 1.11.1
 *  font-awesome 4.2.0
 *
 * Author: Jeff Houde (lochemage@webcabin.org)
 * Web: https://play.webcabin.org/
 * API: https://play.api.webcabin.org/
 *
 * Licensed under
 *   MIT License http://www.opensource.org/licenses/mit-license
 *
 */
function wcPlay(e){this._entryNodes=[],this._processNodes=[],this._compositeNodes=[],this._storageNodes=[],this._properties=[],this._queuedChain=[],this._queuedProperties=[],this._updateID=0,this._isPaused=!1,this._isStepping=!1,this._editors=[],this._options={silent:!1,updateRate:25,updateLimit:100,debugging:!0};for(var t in e)this._options[t]=e[t]}function wcPlayEditor(e,t){this.$container=$(e),this.$viewport=null,this._viewportContext=null,this.$palette=null,this._paletteSize=.25,this.$typeButton=[],this.$typeArea=[],this._size={x:0,y:0},this._engine=null,this._nodeLibrary={},this._font={title:{size:15,family:"Arial",weight:"bold"},links:{size:10,family:"Arial"},property:{size:10,family:"Arial",weight:"italic"},value:{size:10,family:"Arial",weight:"bold"}},this._drawStyle={palette:{spacing:20},node:{radius:10,margin:15},title:{spacing:5},links:{length:12,width:8,spacing:10,padding:5,margin:10},property:{spacing:5,strLen:10}},this._lastUpdate=0,this._viewportCamera={x:0,y:0,z:1},this._viewportMovingNode=!1,this._viewportMoving=!1,this._viewportMoved=!1,this._paletteMoving=!1,this._mouse={x:0,y:0},this._highlightNode=null,this._selectedNode=null,this._expandedNode=null,this._expandedNodeWasCollapsed=!1,this._highlightCollapser=!1,this._highlightBreakpoint=!1,this._highlightEntryLink=!1,this._highlightExitLink=!1,this._highlightInputLink=!1,this._highlightOutputLink=!1,this._highlightPropertyValue=!1,this._selectedEntryLink=!1,this._selectedExitLink=!1,this._selectedInputLink=!1,this._selectedOutputLink=!1,this._selectedNodeOrigin=null,this._draggingNodeData=null,this._undoManager=null,window.wcUndoManager&&(this._undoManager=new wcUndoManager),this._options={readOnly:!1};for(var n in t)this._options[n]=t[n];this.$palette=$('<div class="wcPlayPalette">'),this.$paletteInner=$('<div class="wcPlayPaletteInner">'),this.$viewport=$('<canvas class="wcPlayViewport">'),this._viewportContext=this.$viewport[0].getContext("2d"),this.$palette.append(this.$paletteInner),this.$container.append(this.$palette),this.$container.append(this.$viewport),this.onResized(),this.__setupPalette(),this.__setupControls(),window.requestAnimationFrame(this.__update.bind(this))}(function(){var e=!1,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(){function u(){e?this.classInit&&this.classInit.apply(this,arguments[0]):this.init&&this.init.apply(this,arguments)}var n=arguments[0],r=arguments[arguments.length-1],i=this.prototype;e=!0;var s=new this(arguments);e=!1;for(var o in r)s[o]=typeof r[o]=="function"&&typeof i[o]=="function"&&t.test(r[o])?function(e,t){return function(){var n=this._super;this._super=i[e];var r=t.apply(this,arguments);return this._super=n,r}}(o,r[o]):r[o];u.prototype=s,u.prototype.constructor=u,u.extend=arguments.callee,window[n]=u}})(),wcPlay.PROPERTY_TYPE={DYNAMIC:"dynamic",TOGGLE:"toggle",NUMBER:"number",STRING:"string",SELECT:"select"},wcPlay.NODE_TYPE={ENTRY:"entry",PROCESS:"process",COMPOSITE:"composite",STORAGE:"storage"},wcPlay.NODE_LIBRARY=[],wcPlay.registerNodeType=function(e,t,n,r){for(var i=0;i<wcPlay.NODE_LIBRARY.length;++i)if(wcPlay.NODE_LIBRARY[i].name===e)return!1;return wcPlay.NODE_LIBRARY.push({name:e,displayName:t,category:n,type:r}),!0},wcPlay.prototype={isSilent:function(){return this._options.silent},start:function(){var e=this;this._updateID=setInterval(function(){e.update()},this._options.updateRate),this.__notifyNodes("onStart",[])},nodeById:function(e){for(var t=0;t<this._storageNodes.length;++t)if(this._storageNodes[t].id===e)return this._storageNodes[t];for(var t=0;t<this._processNodes.length;++t)if(this._processNodes[t].id===e)return this._processNodes[t];for(var t=0;t<this._compositeNodes.length;++t)if(this._compositeNodes[t].id===e)return this._compositeNodes[t];for(var t=0;t<this._entryNodes.length;++t)if(this._entryNodes[t].id===e)return this._entryNodes[t];return null},update:function(){if(this._isPaused)return;var e=Math.min(this._queuedProperties.length,this._options.updateLimit);while(e){e--;var t=this._queuedProperties.shift();t.node._meta.flash=!0,t.node._meta.paused=!1,t.node.property(t.name,t.value)}if(!this._queuedProperties.length){e=Math.min(this._queuedChain.length,this._options.updateLimit-e);while(e){e--;var t=this._queuedChain.shift();t.node._meta.flash=!0,t.node._meta.paused=!1,t.node.onTriggered(t.name)}}this._isStepping&&(this._isPaused=!0)},debugging:function(e){return e!==undefined&&(this._options.debugging=e?!0:!1),this._options.debugging},paused:function(e){return e!==undefined&&(this._isPaused=e?!0:!1),this._isPaused},stepping:function(e){return e!==undefined&&(this._isStepping=e?!0:!1),this._isStepping},createProperty:function(e,t,n,r){for(var i=0;i<this._properties.length;++i)if(this._properties[i].name===e)return!1;return wcPlay.PROPERTY_TYPE.hasOwnProperty(t)||(t=wcPlay.PROPERTY_TYPE.STRING),this._properties.push({name:e,value:n,defaultValue:n,type:t,options:r||{}}),!0},renameProperty:function(e,t){var n=null;for(var r=0;r<this._properties.length;++r){if(this._properties[r].name===t)return!1;this._properties[r].name===e&&(n=this._properties[r])}if(!n)return!1;n.name=t,this.__notifyNodes("onSharedPropertyRenamed",[e,t])},property:function(e,t){var n=null;for(var r=0;r<this._properties.length;++r)if(this._properties[r].name===e){n=this._properties[r];break}if(!n)return;if(t!==undefined&&t!==n.value){var i=n.value;n.value=t,this.__notifyNodes("onSharedPropertyChanged",[n.name,i,n.value])}},triggerEvent:function(e,t){for(var n=0;n<this._entryNodes.length;++n)this._entryNodes[n].name===e&&this._entryNodes[n].onTriggered(t)},queueNodeEntry:function(e,t){if(e.enabled()){this._queuedChain.push({node:e,name:t});if(e.debugBreak()||this._isStepping)e._meta.flash=!0,e._meta.paused=!0,this._isPaused=!0}},queueNodeProperty:function(e,t,n){if(e.enabled()){this._queuedProperties.push({node:e,name:t,value:n});if(e.debugBreak()||this._isStepping)e._meta.flash=!0,e._meta.paused=!0,this._isPaused=!0}},__addNode:function(e){e instanceof wcNodeEntry?this._entryNodes.push(e):e instanceof wcNodeProcess?this._processNodes.push(e):e instanceof wcNodeStorage?this._storageNodes.push(e):e instanceof wcNodeComposite&&this._compositeNodes.push(e)},__removeNode:function(e){e instanceof wcNodeEntry?this._entryNodes.splice(this._entryNodes.indexOf(e),1):e instanceof wcNodeProcess?this._processNodes.splice(this._processNodes.indexOf(e),1):e instanceof wcNodeStorage?this._storageNodes.splice(this._storageNodes.indexOf(e),1):e instanceof wcNodeComposite&&this._compositeNodes.splice(this._compositeNodes.indexOf(e),1)},__notifyNodes:function(e,t){var n;for(var r=0;r<this._storageNodes.length;++r)n=this._storageNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._processNodes.length;++r)n=this._processNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._compositeNodes.length;++r)n=this._compositeNodes[r],typeof n[e]=="function"&&n[e].apply(n,t);for(var r=0;r<this._entryNodes.length;++r)n=this._entryNodes[r],typeof n[e]=="function"&&n[e].apply(n,t)},__notifyEditors:function(e,t){var n;for(var r=0;r<this._editors.length;++r)n=this._editors[r],typeof n[e]=="function"&&n[e].apply(n,t)}},wcPlayEditor.prototype={engine:function(e){if(e!==undefined){if(this._engine){var t=this._engine._editors.indexOf(this);t>-1&&this._engine._editors.splice(t,1)}this._engine=e,this._engine&&this._engine._editors.push(this)}return this._engine},center:function(){},onResized:function(){var e=this.$container.width(),t=this.$container.height();if(this._size.x!==e||this._size.y!==t){this._size.x=e,this._size.y=t;var n=e*this._paletteSize;this.$palette.css("width",n).attr("width",n).attr("height",t),this.$viewport.css("width",e-n).attr("width",e-n).attr("height",t)}},__mouse:function(e,t,n){if(e.originalEvent&&(e.originalEvent.touches||e.originalEvent.changedTouches)){var r=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0];return{x:r.clientX-(t?t.left:0)-(n?n.x:0),y:r.clientY-(t?t.top:0)-(n?n.y:0),gx:r.clientX,gy:r.clientY,which:1}}return{x:(e.clientX||e.pageX)-(t?t.left:0)-(n?n.x:0),y:(e.clientY||e.pageY)-(t?t.top:0)-(n?n.y:0),gx:e.clientX||e.pageX,gy:e.clientY||e.pageY,which:e.which||1}},__setCanvasFont:function(e,t){t.font=(e.weight?e.weight+" ":"")+(e.size+"px ")+e.family},__clampString:function(e,t){return e.length>t?e.substring(0,t)+"...":e},__blendColors:function(e,t,n){var r=n<0?n*-1:n,i=Math.round,s=parseInt;if(e.length>7){var o=e.split(","),u=(t?t:n<0?"rgb(0,0,0)":"rgb(255,255,255)").split(","),a=s(o[0].slice(4)),f=s(o[1]),l=s(o[2]);return"rgb("+(i((s(u[0].slice(4))-a)*r)+a)+","+(i((s(u[1])-f)*r)+f)+","+(i((s(u[2])-l)*r)+l)+")"}var o=s(e.slice(1),16),u=s((t?t:n<0?"#000000":"#FFFFFF").slice(1),16),c=o>>16,h=o>>8&255,p=o&255;return"#"+(16777216+(i(((u>>16)-c)*r)+c)*65536+(i(((u>>8&255)-h)*r)+h)*256+(i(((u&255)-p)*r)+p)).toString(16).slice(1)},__expandRect:function(e){var t={top:e[0].top,left:e[0].left,width:e[0].width,height:e[0].height};for(var n=1;n<e.length;++n)e[n].top<t.top&&(t.top=e[n].top),e[n].left<t.left&&(t.left=e[n].left),e[n].top+e[n].height>t.top+t.height&&(t.height=e[n].top+e[n].height-t.top),e[n].left+e[n].width>t.left+t.width&&(t.width=e[n].left+e[n].width-t.left);return t},__inRect:function(e,t,n){return n===undefined&&(n={x:0,y:0,z:1}),(e.y-n.y)/n.z>=t.top&&(e.x-n.x)/n.z>=t.left&&(e.y-n.y)/n.z<=t.top+t.height&&(e.x-n.x)/n.z<=t.left+t.width?!0:!1},__drawRect:function(e,t,n){n.strokeStyle=t,n.strokeRect(e.left,e.top,e.width,e.height)},__drawRoundedRect:function(e,t,n,r,i){i.save(),i.strokeStyle=t,i.lineWidth=n,i.beginPath(),i.moveTo(e.left+r,e.top),i.arcTo(e.left+e.width,e.top,e.left+e.width,e.top+r,r),i.arcTo(e.left+e.width,e.top+e.height,e.left+e.width-r,e.top+e.height,r),i.arcTo(e.left,e.top+e.height,e.left,e.top+e.height-r,r),i.arcTo(e.left,e.top,e.left+r,e.top,r),i.closePath(),i.stroke(),i.restore()},__update:function(e){this._lastUpdate||(this._lastUpdate=e);var t=(e-this._lastUpdate)/1e3;this._lastUpdate=e,this.onResized(),this._engine&&(this.__drawPalette(t),this._viewportContext.clearRect(0,0,this.$viewport.width(),this.$viewport.height()),this._viewportContext.save(),this._viewportContext.translate(this._viewportCamera.x,this._viewportCamera.y),this._viewportContext.scale(this._viewportCamera.z,this._viewportCamera.z),this.__updateNodes(this._engine._entryNodes,t),this.__updateNodes(this._engine._processNodes,t),this.__updateNodes(this._engine._compositeNodes,t),this.__updateNodes(this._engine._storageNodes,t),this.__drawNodes(this._engine._entryNodes,this._viewportContext),this.__drawNodes(this._engine._processNodes,this._viewportContext),this.__drawNodes(this._engine._compositeNodes,this._viewportContext),this.__drawNodes(this._engine._storageNodes,this._viewportContext),this.__drawChains(this._engine._entryNodes,this._viewportContext),this.__drawChains(this._engine._processNodes,this._viewportContext),this.__drawChains(this._engine._compositeNodes,this._viewportContext),this.__drawChains(this._engine._storageNodes,this._viewportContext),this._viewportContext.restore()),window.requestAnimationFrame(this.__update.bind(this))},__updateNodes:function(e,t){for(var n=0;n<e.length;++n)this.__updateNode(e[n],t)},__updateNode:function(e,t){function r(e,r,i,s,o,u){e.flash?(e.flashDelta+=t*10,e.flashDelta>=1&&(e.flashDelta=1,!e.awake&&(!e.paused||!o&&!n._engine.paused())&&(e.flash=!1))):e.flashDelta>0&&(e.flashDelta-=t*5,e.flashDelta<=0&&(e.flashDelta=0,e.paused=o?e.paused:!1)),e.color=n.__blendColors(r,e.paused?s:i,e.flashDelta*u)}var n=this,i=e.color;this._highlightNode===e&&(i=this.__blendColors(e.color,"#00FFFF",.5)),r(e._meta,i,"#FFFFFF","#FFFFFF",!0,.5);var s="#000000",o="#117711",u="#FFFF00";for(var a=0;a<e.chain.entry.length;++a)r(e.chain.entry[a].meta,s,u,u,!1,.9);for(var a=0;a<e.chain.exit.length;++a)r(e.chain.exit[a].meta,s,u,u,!1,.9);for(var a=0;a<e.properties.length;++a)r(e.properties[a].inputMeta,o,u,u,!1,.9),r(e.properties[a].outputMeta,o,u,u,!1,.9)},__typeIndex:function(e){switch(e){case wcPlay.NODE_TYPE.ENTRY:return 0;case wcPlay.NODE_TYPE.PROCESS:return 1;case wcPlay.NODE_TYPE.STORAGE:return 2}},__setupPalette:function(){this.$typeButton.push($('<button class="wcToggled">Entry</button>')),this.$typeButton.push($("<button>Process</button>")),this.$typeButton.push($("<button>Storage</button>")),this.$palette.append(this.$typeButton[0]),this.$palette.append(this.$typeButton[1]),this.$palette.append(this.$typeButton[2]),this.$typeArea.push($('<div class="wcPlayTypeArea">')),this.$typeArea.push($('<div class="wcPlayTypeArea wcPlayHidden">')),this.$typeArea.push($('<div class="wcPlayTypeArea wcPlayHidden">')),this.$paletteInner.append(this.$typeArea[0]),this.$paletteInner.append(this.$typeArea[1]),this.$paletteInner.append(this.$typeArea[2]);for(var e=0;e<wcPlay.NODE_LIBRARY.length;++e){var t=wcPlay.NODE_LIBRARY[e];this._nodeLibrary.hasOwnProperty(t.category)||(this._nodeLibrary[t.category]={});if(!this._nodeLibrary[t.category].hasOwnProperty(t.type)){var n={$category:$('<div class="wcPlayTypeCategory">'),$button:$('<button class="wcPlayCategoryButton">'+t.category+"</button>"),$canvas:$('<canvas class="wcPlayTypeCategoryArea">'),context:null,nodes:[]};n.context=n.$canvas[0].getContext("2d"),n.$category.append(n.$button),n.$category.append(n.$canvas),this.$typeArea[this.__typeIndex(t.type)].append(n.$category),function(t){t.$button.click(function(){t.$button.hasClass("wcToggled")?(t.$button.removeClass("wcToggled"),t.$canvas.removeClass("wcPlayHidden")):(t.$button.addClass("wcToggled"),t.$canvas.addClass("wcPlayHidden"))})}(n),this._nodeLibrary[t.category][t.type]=n}var r=new window[t.name](null);this._nodeLibrary[t.category][t.type].nodes.push(r),this.__updateNode(r,0)}for(var i in this._nodeLibrary)for(var s in this._nodeLibrary[i]){var n=this._nodeLibrary[i][s];n.$canvas.attr("width",this.$paletteInner.width());var o=this._drawStyle.palette.spacing,u=this.$paletteInner.width()/2;for(var e=0;e<n.nodes.length;++e){var a=this.__drawNode(n.nodes[e],{x:u,y:o},n.context,!0);o+=a.rect.height+this._drawStyle.palette.spacing}n.$canvas.attr("height",o)}var f=this;this.$typeButton[0].click(function(){f.$typeButton[0].addClass("wcToggled"),f.$typeButton[1].removeClass("wcToggled"),f.$typeButton[2].removeClass("wcToggled"),f.$typeArea[0].removeClass("wcPlayHidden"),f.$typeArea[1].addClass("wcPlayHidden"),f.$typeArea[2].addClass("wcPlayHidden")}),this.$typeButton[1].click(function(){f.$typeButton[0].removeClass("wcToggled"),f.$typeButton[1].addClass("wcToggled"),f.$typeButton[2].removeClass("wcToggled"),f.$typeArea[0].addClass("wcPlayHidden"),f.$typeArea[1].removeClass("wcPlayHidden"),f.$typeArea[2].addClass("wcPlayHidden")}),this.$typeButton[2].click(function(){f.$typeButton[0].removeClass("wcToggled"),f.$typeButton[1].removeClass("wcToggled"),f.$typeButton[2].addClass("wcToggled"),f.$typeArea[0].addClass("wcPlayHidden"),f.$typeArea[1].addClass("wcPlayHidden"),f.$typeArea[2].removeClass("wcPlayHidden")})},__drawPalette:function(e){for(var t in this._nodeLibrary)for(var n in this._nodeLibrary[t]){if(!this.$typeButton[this.__typeIndex(n)].hasClass("wcToggled"))continue;var r=this._nodeLibrary[t][n];if(r.$button.hasClass("wcToggled"))continue;var i=this._drawStyle.palette.spacing,s=this.$paletteInner.width()/2;r.$canvas.attr("width",this.$paletteInner.width()),r.context.clearRect(0,0,r.$canvas.width(),r.$canvas.height()),r.context.save(),this.__updateNodes(r.nodes,e);for(var o=0;o<r.nodes.length;++o){var u=this.__drawNode(r.nodes[o],{x:s,y:i},r.context,!0);i+=u.rect.height+this._drawStyle.palette.spacing}r.context.restore()}},__drawNodes:function(e,t,n){for(var r=0;r<e.length;++r)this.__drawNode(e[r],e[r].pos,t,n)},__drawNode:function(e,t,n,r){var i={node:e,rect:{top:t.y,left:t.x,width:0,height:0}},s=this.__measureEntryLinks(e,n,t),o=this.__measureCenter(e,n,{x:t.x,y:t.y+s.height},r),u=this.__measureExitLinks(e,n,{x:t.x,y:t.y+s.height+o.height}),a=this.__expandRect([s,o,u]);a.top=o.top,a.height=o.height;var f=this.__drawCenter(e,n,a,r),l=this.__drawEntryLinks(e,n,t,s.width),c=this.__drawExitLinks(e,n,{x:t.x,y:t.y+s.height+o.height},u.width);i.entryBounds=l,i.exitBounds=c,i.inputBounds=f.inputBounds,i.outputBounds=f.outputBounds,i.valueBounds=f.valueBounds,i.inner=this.__expandRect([o]),i.rect=this.__expandRect([s,o,u]),i.inner.left=i.rect.left,i.inner.width=i.rect.width,i.rect.left-=this._drawStyle.links.length,i.rect.width+=this._drawStyle.links.length*2,e.chain.entry.length?(i.inner.top-=this._drawStyle.links.padding+this._font.links.size,i.inner.height+=this._drawStyle.links.padding+this._font.links.size):(i.rect.top-=this._drawStyle.links.length,i.rect.height+=this._drawStyle.links.length),e.chain.exit.length?i.inner.height+=this._drawStyle.links.padding+this._font.links.size:i.rect.height+=this._drawStyle.links.length,i.farRect={top:i.inner.top-i.inner.height/4,left:i.inner.left-i.inner.width/4,width:i.inner.width*1.5,height:i.inner.height*1.5},i.collapser={left:i.inner.left+4,top:i.inner.top+4+(e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0),width:this._drawStyle.node.margin-5,height:this._font.title.size-4},n.save(),n.fillStyle=this._highlightCollapser&&this._highlightNode===e?"darkgray":"white",n.strokeStyle="black",n.lineWidth=1,n.fillRect(i.collapser.left,i.collapser.top,i.collapser.width,i.collapser.height),n.strokeRect(i.collapser.left,i.collapser.top,i.collapser.width,i.collapser.height),n.strokeStyle="black",n.lineWidth=2,n.beginPath(),n.moveTo(i.collapser.left+1,i.collapser.top+i.collapser.height/2),n.lineTo(i.collapser.left+i.collapser.width-1,i.collapser.top+i.collapser.height/2),e.collapsed()&&(n.moveTo(i.collapser.left+i.collapser.width/2,i.collapser.top+1),n.lineTo(i.collapser.left+i.collapser.width/2,i.collapser.top+i.collapser.height-1)),n.stroke(),n.restore(),i.breakpoint={left:i.inner.left+i.inner.width-this._drawStyle.node.margin+2,top:i.inner.top+4+(e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0),width:this._drawStyle.node.margin-5,height:this._font.title.size-4},n.save();var h=n.createRadialGradient(i.breakpoint.left+i.breakpoint.width/2,i.breakpoint.top+i.breakpoint.height/2,0,i.breakpoint.left+i.breakpoint.width/2,i.breakpoint.top+i.breakpoint.height/2,Math.min(i.breakpoint.width*.5,i.breakpoint.height*.5));return h.addColorStop(0,e._break?"darkred":"gray"),h.addColorStop(1,this._highlightBreakpoint&&this._highlightNode===e?"darkgray":"white"),n.fillStyle=h,n.fillRect(i.breakpoint.left,i.breakpoint.top,i.breakpoint.width,i.breakpoint.height),n.strokeStyle="black",n.lineWidth=1,n.strokeRect(i.breakpoint.left,i.breakpoint.top,i.breakpoint.width,i.breakpoint.height),n.restore(),e._meta.flashDelta&&(e._meta.paused?this.__drawRoundedRect(i.inner,"#CC0000",5,10,n):this.__drawRoundedRect(i.inner,"yellow",2,10,n)),e===this._selectedNode&&this.__drawRoundedRect(i.rect,"cyan",2,10,n),e._meta.bounds=i,i},__measureEntryLinks:function(e,t,n){var r={top:n.y,left:n.x,width:0,height:0};this.__setCanvasFont(this._font.links,t);var i=e.collapsed(),s=e.chain.entry;for(var o=0;o<s.length;++o)if(!i||s[o].links.length)r.width+=t.measureText(s[o].name).width+this._drawStyle.links.spacing;return r.left-=r.width/2+this._drawStyle.links.margin,r.width+=this._drawStyle.links.margin*2,e.chain.entry.length&&(r.height=this._font.links.size+this._drawStyle.links.padding+this._drawStyle.links.length),r},__measureExitLinks:function(e,t,n){var r={top:n.y,left:n.x,width:0,height:0};this.__setCanvasFont(this._font.links,t);var i=e.collapsed(),s=e.chain.exit;for(var o=0;o<s.length;++o)if(!i||s[o].links.length)r.width+=t.measureText(s[o].name).width+this._drawStyle.links.spacing;return r.left-=r.width/2+this._drawStyle.links.margin,r.width+=this._drawStyle.links.margin*2,e.chain.exit.length&&(r.height=this._font.links.size+this._drawStyle.links.padding+this._drawStyle.links.length),r},__measureCenter:function(e,t,n,r){var i={top:n.y,left:n.x,width:0,height:this._font.title.size+this._drawStyle.title.spacing+this._drawStyle.links.padding};this.__setCanvasFont(this._font.title,t),i.width=t.measureText(e.type+(e.name?": "+e.name:"")).width,e._viewportSize&&(i.width=Math.max(i.width,e._viewportSize.x),i.height+=e._viewportSize.y+this._drawStyle.property.spacing);var s=e.collapsed(),o=e.properties;for(var u=0;u<o.length;++u)if(!s&&!r||!o[u].options.collapsible||o[u].inputs.length||o[u].outputs.length){i.height+=this._font.property.size+this._drawStyle.property.spacing,this.__setCanvasFont(this._font.property,t);var a=t.measureText(o[u].name+": ").width;this.__setCanvasFont(this._font.value,t),a+=t.measureText("["+this.__clampString(e.property(o[u].name).toString(),this._drawStyle.property.strLen)+"]").width,i.width=Math.max(a,i.width)}return i.left-=i.width/2+this._drawStyle.node.margin,i.width+=this._drawStyle.node.margin*2,i},__drawEntryLinks:function(e,t,n,r){var i=n.x-r/2+this._drawStyle.links.margin,s=n.y+this._drawStyle.links.length+this._font.links.size;this.__setCanvasFont(this._font.links,t);var o=[],u=e.collapsed(),a=e.chain.entry;for(var f=0;f<a.length;++f)if(!u||a[f].links.length){t.fillStyle="black";var l=t.measureText(a[f].name).width+this._drawStyle.links.spacing;t.fillText(a[f].name,i+this._drawStyle.links.spacing/2,s);var c={top:s-this._drawStyle.links.length-this._font.links.size,left:i+l/2-this._drawStyle.links.width/2,width:this._drawStyle.links.width,height:this._drawStyle.links.length};t.fillStyle=this._highlightEntryLink&&this._highlightEntryLink.name===a[f].name&&this._highlightNode===e?"cyan":a[f].meta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(c.left,c.top),t.lineTo(c.left+c.width/2,c.top+c.height/3),t.lineTo(c.left+c.width,c.top),t.lineTo(c.left+c.width,c.top+c.height),t.lineTo(c.left,c.top+c.height),t.closePath(),t.stroke(),t.fill(),c.left-=5,c.width+=10,o.push({rect:c,point:{x:c.left+c.width/2,y:c.top+c.height/3},name:a[f].name}),i+=l}return o},__drawExitLinks:function(e,t,n,r){var i=n.x-r/2+this._drawStyle.links.margin,s=n.y+this._font.links.size;this.__setCanvasFont(this._font.links,t);var o=[],u=e.collapsed(),a=e.chain.exit;for(var f=0;f<a.length;++f)if(!u||a[f].links.length){t.fillStyle="black";var l=t.measureText(a[f].name).width+this._drawStyle.links.spacing;t.fillText(a[f].name,i+this._drawStyle.links.spacing/2,s);var c={top:s+this._drawStyle.links.padding,left:i+l/2-this._drawStyle.links.width/2,width:this._drawStyle.links.width,height:this._drawStyle.links.length};t.fillStyle=this._highlightExitLink&&this._highlightExitLink.name===a[f].name&&this._highlightNode===e?"cyan":a[f].meta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(c.left,c.top),t.lineTo(c.left+c.width,c.top),t.lineTo(c.left+c.width,c.top+c.height/2),t.lineTo(c.left+c.width/2,c.top+c.height),t.lineTo(c.left,c.top+c.height/2),t.closePath(),t.stroke(),t.fill(),c.left-=5,c.width+=10,o.push({rect:c,point:{x:c.left+c.width/2,y:c.top+c.height},name:a[f].name}),i+=l}return o},__drawCenter:function(e,t,n,r){var i=e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0,s=e.chain.exit.length?this._font.links.size+this._drawStyle.links.padding:0;t.save();var o=n.left+n.width/2,u=n.top+n.height/2,a=t.createRadialGradient(o,u,10,o,u,Math.max(n.width,n.height));a.addColorStop(0,e._meta.color),a.addColorStop(1,"white"),t.fillStyle=t.strokeStyle=a,t.lineJoin="round";var f=this._drawStyle.node.radius*2;t.lineWidth=f,t.fillRect(n.left+f/2,n.top-i+f/2,n.width-f,n.height+i+s-f),t.strokeRect(n.left+f/2,n.top-i+f/2,n.width-f,n.height+i+s-f),t.restore(),this.__drawRoundedRect({left:n.left,top:n.top-i,width:n.width,height:n.height+i+s},e._meta.color,3,this._drawStyle.node.radius,t),i=0,e.chain.entry.length&&(t.strokeStyle=e._meta.color,t.beginPath(),t.moveTo(n.left,n.top+i),t.lineTo(n.left+n.width,n.top+i),t.stroke()),t.save(),i+=this._font.title.size,t.fillStyle="black",t.strokeStyle="black",t.textAlign="center",this.__setCanvasFont(this._font.title,t),t.fillText(e.type+(e.name?": "+e.name:""),n.left+n.width/2,n.top+i),t.restore(),i+=this._drawStyle.title.spacing;if(e._viewportSize){var l={x:-this._viewportCamera.x+n.left+(n.width/2-e._viewportSize.x/2),y:-this._viewportCamera.y+n.top+i};t.save(),t.translate(l.x,l.y),e.onViewport(t),t.translate(-l.x,-l.y),t.restore(),i+=e._viewportSize.y+this._drawStyle.property.spacing}var c={valueBounds:[],inputBounds:[],outputBounds:[]},h;t.save();var p=e.collapsed(),d=e.properties;for(var v=0;v<d.length;++v)if(!p&&!r||!d[v].options.collapsible||d[v].inputs.length||d[v].outputs.length){i+=this._font.property.size,t.fillStyle="black",t.textAlign="left",this.__setCanvasFont(this._font.property,t),t.fillText(d[v].name+": ",n.left+this._drawStyle.node.margin,n.top+i),t.textAlign="right",this.__setCanvasFont(this._font.value,t);var m=t.measureText("["+this.__clampString(e.property(d[v].name).toString(),this._drawStyle.property.strLen)+"]").width,g={rect:{top:n.top+i-this._font.property.size,left:n.left+n.width-this._drawStyle.node.margin-m,width:m,height:this._font.property.size+this._drawStyle.property.spacing},name:d[v].name};c.valueBounds.push(g),this._highlightNode===e&&this._highlightPropertyValue&&this._highlightPropertyValue.name===d[v].name&&(t.fillStyle="darkgray",t.fillRect(g.rect.left,g.rect.top,g.rect.width,g.rect.height)),t.fillStyle="black",t.fillText("["+this.__clampString(e.property(d[v].name).toString(),this._drawStyle.property.strLen)+"]",n.left+n.width-this._drawStyle.node.margin,n.top+i);if(!p||d[v].inputs.length)h={top:n.top+i-this._font.property.size/3-this._drawStyle.links.width/2,left:n.left-this._drawStyle.links.length,width:this._drawStyle.links.length,height:this._drawStyle.links.width},t.fillStyle=this._highlightInputLink&&this._highlightInputLink.name===d[v].name&&this._highlightNode===e?"cyan":d[v].inputMeta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(h.left,h.top),t.lineTo(h.left+h.width,h.top),t.lineTo(h.left+h.width,h.top+h.height),t.lineTo(h.left,h.top+h.height),t.lineTo(h.left+h.width/3,h.top+h.height/2),t.closePath(),t.stroke(),t.fill(),h.top-=5,h.height+=10,c.inputBounds.push({rect:h,point:{x:h.left+h.width/3,y:h.top+h.height/2},name:d[v].name});if(!p||d[v].outputs.length)h={top:n.top+i-this._font.property.size/3-this._drawStyle.links.width/2,left:n.left+n.width,width:this._drawStyle.links.length,height:this._drawStyle.links.width},t.fillStyle=this._highlightOutputLink&&this._highlightOutputLink.name===d[v].name&&this._highlightNode===e?"cyan":d[v].outputMeta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(h.left,h.top),t.lineTo(h.left+h.width/2,h.top),t.lineTo(h.left+h.width,h.top+h.height/2),t.lineTo(h.left+h.width/2,h.top+h.height),t.lineTo(h.left,h.top+h.height),t.closePath(),t.stroke(),t.fill(),h.top-=5,h.height+=10,c.outputBounds.push({rect:h,point:{x:h.left+h.width,y:h.top+h.height/2},name:d[v].name});i+=this._drawStyle.property.spacing}return t.restore(),e.chain.exit.length&&(t.strokeStyle=e._meta.color,t.beginPath(),t.moveTo(n.left,n.top+n.height),t.lineTo(n.left+n.width,n.top+n.height),t.stroke()),c},__drawChains:function(e,t){for(var n=0;n<e.length;++n)this.__drawNodeChains(e[n],t)},__drawNodeChains:function(e,t){for(var n=0;n<e.chain.exit.length;++n){var r=e.chain.exit[n];if(!r.links.length)continue;var i;for(var s=0;s<e._meta.bounds.exitBounds.length;++s)if(e._meta.bounds.exitBounds[s].name===r.name){i=e._meta.bounds.exitBounds[s].point;break}if(!i){console.log("ERROR: Attempted to draw chains for an exit link that has no meta data.");continue}for(var s=0;s<r.links.length;++s){var o=r.links[s].node,u=r.links[s].name,a;for(var f=0;f<o.chain.entry.length;++f)if(o.chain.entry[f].name===u){a=o.chain.entry[f];break}if(!a){console.log("ERROR: Attempted to chain an exit link to an entry link that was not found.");continue}var l;for(var f=0;f<o._meta.bounds.entryBounds.length;++f)if(o._meta.bounds.entryBounds[f].name===a.name){l=o._meta.bounds.entryBounds[f].point;break}if(!l){console.log("ERROR: Attempted to draw chains to an entry link that has no meta data.");continue}var c=r.meta.flashDelta>0&&a.meta.flashDelta>0;this.__drawFlowChain(i,l,e._meta.bounds.rect,o._meta.bounds.rect,t,c)}}for(var n=0;n<e.properties.length;++n){var h=e.properties[n];if(!h.outputs.length)continue;var p;for(var s=0;s<e._meta.bounds.outputBounds.length;++s)if(e._meta.bounds.outputBounds[s].name===h.name){p=e._meta.bounds.outputBounds[s].point;break}if(!p){console.log("ERROR: Attempted to draw chains for an output link that has no meta data.");continue}for(var s=0;s<h.outputs.length;++s){var o=h.outputs[s].node,u=h.outputs[s].name,d;for(var f=0;f<o.properties.length;++f)o.properties[f].name===u&&(d=o.properties[f]);if(!d){console.log("ERROR: Attempted to chain a property link to a property that was not found.");continue}var v;for(var f=0;f<o._meta.bounds.inputBounds.length;++f)if(o._meta.bounds.inputBounds[f].name===d.name){v=o._meta.bounds.inputBounds[f].point;break}if(!v){console.log("ERROR: Attempted to draw chains to a property input link that has no meta data.");continue}var c=h.outputMeta.flashDelta>0&&d.inputMeta.flashDelta>0;this.__drawPropertyChain(p,v,e._meta.bounds.rect,o._meta.bounds.rect,t,c)}}if(this._selectedNode===e&&this._selectedEntryLink){var m,g=null,y=!1;this._highlightNode&&this._highlightExitLink?(m=this._highlightExitLink.point,g=this._highlightExitLink.rect,y=!0):m={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z};var b;for(var n=0;n<e._meta.bounds.entryBounds.length;++n)e._meta.bounds.entryBounds[n].name===this._selectedEntryLink.name&&(b=e._meta.bounds.entryBounds[n].point);this.__drawFlowChain(b,m,e._meta.bounds.rect,g,t,y)}if(this._selectedNode===e&&this._selectedExitLink){var m,g=null,y=!1;this._highlightNode&&this._highlightEntryLink?(m=this._highlightEntryLink.point,g=this._highlightEntryLink.rect,y=!0):m={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z};var b;for(var n=0;n<e._meta.bounds.exitBounds.length;++n)e._meta.bounds.exitBounds[n].name===this._selectedExitLink.name&&(b=e._meta.bounds.exitBounds[n].point);this.__drawFlowChain(b,m,e._meta.bounds.rect,g,t,y)}if(this._selectedNode===e&&this._selectedInputLink){var m,g=null,y=!1;this._highlightNode&&this._highlightOutputLink?(m=this._highlightOutputLink.point,g=this._highlightOutputLink.rect,y=!0):m={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z};var b;for(var n=0;n<e._meta.bounds.inputBounds.length;++n)e._meta.bounds.inputBounds[n].name===this._selectedInputLink.name&&(b=e._meta.bounds.inputBounds[n].point);this.__drawPropertyChain(b,m,e._meta.bounds.rect,g,t,y)}if(this._selectedNode===e&&this._selectedOutputLink){var m,g=null,y=!1;this._highlightNode&&this._highlightInputLink?(m=this._highlightInputLink.point,g=this._highlightInputLink.rect,y=!0):m={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z};var b;for(var n=0;n<e._meta.bounds.outputBounds.length;++n)e._meta.bounds.outputBounds[n].name===this._selectedOutputLink.name&&(b=e._meta.bounds.outputBounds[n].point);this.__drawPropertyChain(b,m,e._meta.bounds.rect,g,t,y)}},__drawFlowChain:function(e,t,n,r,i,s){i.save(),i.strokeStyle=s?"#CCCC00":"#000000",i.lineWidth=2,i.beginPath(),i.moveTo(e.x,e.y),i.lineTo(t.x,t.y),i.stroke(),i.restore()},__drawPropertyChain:function(e,t,n,r,i,s){i.save(),i.strokeStyle=s?"#55FF00":"#33CC33",i.lineWidth=2,i.beginPath(),i.moveTo(e.x,e.y),i.lineTo(t.x,t.y),i.stroke(),i.restore()},__drawPropertyEditor:function(e,t,n){function f(e,t,n,r){a._undoManager&&a._undoManager.addEvent('Property "'+t+'" changed for Node "'+e.category+"."+e.type+'"',{id:e.id,name:t,oldValue:n,newValue:r,editor:a},function(){var e=this.editor._engine.nodeById(this.id);e.property(this.name,this.oldValue)},function(){var e=this.editor._engine.nodeById(this.id);e.property(this.name,this.newValue)})}var r=null,i=!1,s=!0,o=t.type;if(o===wcPlay.PROPERTY_TYPE.DYNAMIC){var u=e.property(t.name);typeof u=="string"?o=wcPlay.PROPERTY_TYPE.STRING:typeof u=="bool"?o=wcPlay.PROPERTY_TYPE.TOGGLE:typeof u=="number"&&(o=wcPlay.PROPERTY_TYPE.NUMBER)}var a=this;switch(o){case wcPlay.PROPERTY_TYPE.TOGGLE:var l=e.property(t.name);f(e,t.name,l,!l),e.property(t.name,!l);break;case wcPlay.PROPERTY_TYPE.NUMBER:r=$('<input type="number"'+(t.options.min?' min="'+t.options.min+'"':"")+(t.options.max?' max="'+t.options.max+'"':"")+(t.options.step?' step="'+t.options.step+'"':"")+">"),r.val(parseFloat(e.property(t.name))),r.change(function(){i||(f(e,t.name,e.property(t.name),r.val()),e.property(t.name,r.val()))});break;case wcPlay.PROPERTY_TYPE.STRING:t.options.multiline?(r=$("<textarea"+(t.options.maxlength?' maxlength="'+t.options.maxlength+'"':"")+">"),s=!1):r=$('<input type="text" maxlength="'+(t.options.maxlength||524288)+'">'),r.val(e.property(t.name).toString()),r.change(function(){i||(f(e,t.name,e.property(t.name),r.val()),e.property(t.name,r.val()))});break;case wcPlay.PROPERTY_TYPE.SELECT:}if(r){var c={top:0,left:this.$palette.width()};this.$container.append(r),r.addClass("wcPlayEditorControl"),r.focus(),r.select(),r.blur(function(){$(this).remove()}),r.keyup(function(e){switch(e.keyCode){case 13:(s||e.shiftKey)&&r.blur();break;case 27:i=!0,r.blur()}return!1}),r.css("top",c.top+n.rect.top*this._viewportCamera.z+this._viewportCamera.y).css("left",c.left+n.rect.left*this._viewportCamera.z+this._viewportCamera.x).css("width",200).css("height",Math.max(n.rect.height*this._viewportCamera.z*.9,15))}},__setupControls:function(){var e=this;this.$palette.on("mousemove",function(t){e.__onPaletteMouseMove(t,this)}),this.$palette.on("mousedown",function(t){e.__onPaletteMouseDown(t,this)}),this.$palette.on("mouseup",function(t){e.__onPaletteMouseUp(t,this)}),this.$viewport.on("mousemove",function(t){e.__onViewportMouseMove(t,this)}),this.$viewport.on("mousedown",function(t){e.__onViewportMouseDown(t,this)}),this.$viewport.on("click",function(t){e.__onViewportMouseClick(t,this)}),this.$viewport.on("dblclick",function(t){e.__onViewportMouseDoubleClick(t,this)}),this.$viewport.on("mouseup",function(t){e.__onViewportMouseUp(t,this)}),this.$viewport.on("mousewheel DOMMouseScroll",function(t){e.__onViewportMouseWheel(t,this)}),$("body").keyup(function(t){e.__onKey(t,this)})},__onKey:function(e,t){switch(e.keyCode){case 46:this._selectedNode&&(this._undoManager&&this._undoManager.addEvent('Removed Node "'+this._selectedNode.category+"."+this._selectedNode.type+'"',{id:this._selectedNode.id,className:this._selectedNode.className,pos:{x:this._selectedNode.pos.x,y:this._selectedNode.pos.y},collapsed:this._selectedNode.collapsed(),breakpoint:this._selectedNode._break,properties:this._selectedNode.listProperties(),entryChains:this._selectedNode.listEntryChains(),exitChains:this._selectedNode.listExitChains(),inputChains:this._selectedNode.listInputChains(),outputChains:this._selectedNode.listOutputChains(),editor:this},function(){var e=new window[this.className](this.editor._engine,this.pos);e.id=this.id,e.collapsed(this.collapsed),e.debugBreak(this.breakpoint);for(var t=0;t<this.properties.length;++t)e.initialProperty(this.properties[t].name,this.properties[t].initialValue),e.property(this.properties[t].name,this.properties[t].value);for(var t=0;t<this.entryChains.length;++t){var n=this.entryChains[t],r=this.editor._engine.nodeById(n.outNodeId);e.connectEntry(n.inName,r,n.outName)}for(var t=0;t<this.exitChains.length;++t){var n=this.exitChains[t],r=this.editor._engine.nodeById(n.inNodeId);e.connectExit(n.outName,r,n.inName)}for(var t=0;t<this.inputChains.length;++t){var n=this.inputChains[t],r=this.editor._engine.nodeById(n.outNodeId);e.connectInput(n.inName,r,n.outName)}for(var t=0;t<this.outputChains.length;++t){var n=this.outputChains[t],r=this.editor._engine.nodeById(n.outNodeId);e.connectOutput(n.inName,r,n.outName)}},function(){var e=this.editor._engine.nodeById(this.id);e.destroy()}),this._selectedNode.destroy(),this._selectedNode=null);case"Z".charCodeAt(0):e.ctrlKey&&!e.shiftKey&&this._undoManager&&this._undoManager.undo();if(!e.shiftKey)break;case"Y".charCodeAt(0):e.ctrlKey&&this._undoManager&&this._undoManager.redo()}},__onPaletteMouseMove:function(e,t){var n=this.__mouse(e);this._highlightCollapser=!1,this._highlightBreakpoint=!1,this._highlightEntryLink=!1,this._highlightExitLink=!1,this._highlightInputLink=!1,this._highlightOutputLink=!1,this._highlightPropertyValue=!1;if(this._draggingNodeData){var r={x:n.gx+this._draggingNodeData.offset.x,y:n.gy+this._draggingNodeData.offset.y};this._draggingNodeData.$canvas.css("left",r.x).css("top",r.y);return}var i=this.__findCategoryAreaAtPos(n);if(i){var s=i.$canvas.offset();n=this.__mouse(e,s);var o=this.__findNodeAtPos(n,undefined,i.nodes);o?(this._highlightNode=o,this.$palette.addClass("wcClickable")):(this._highlightNode=null,this.$palette.removeClass("wcClickable"))}},__onPaletteMouseDown:function(e,t){if(this._highlightNode){this.__onPaletteMouseUp(e,t);var n=this.__mouse(e),r=this._highlightNode._meta.bounds.rect,i=this.__findCategoryAreaAtPos(n);if(i){var s=i.$canvas.offset();this._draggingNodeData={node:this._highlightNode,$canvas:$('<canvas class="wcPlayHoverCanvas">'),offset:{x:0,y:0}},this.$container.append(this._draggingNodeData.$canvas),this.$palette.addClass("wcMoving"),this.$viewport.addClass("wcMoving"),this._draggingNodeData.$canvas.css("left",r.left+s.left).css("top",r.top+s.top),this._draggingNodeData.$canvas.attr("width",r.width).css("width",r.width),this._draggingNodeData.$canvas.attr("height",r.height).css("height",r.height),this._draggingNodeData.offset.x=r.left+s.left-n.x,this._draggingNodeData.offset.y=r.top+s.top-n.y;var o=0;this._highlightNode.chain.entry.length||(o+=this._drawStyle.links.length),this.__drawNode(this._highlightNode,{x:r.width/2,y:o},this._draggingNodeData.$canvas[0].getContext("2d"),!0)}}},__onPaletteMouseUp:function(e,t){this._draggingNodeData&&(this._draggingNodeData.$canvas.remove(),this._draggingNodeData.$canvas=null,this._draggingNodeData=null,this.$palette.removeClass("wcMoving"),this.$viewport.removeClass("wcMoving"))},__onViewportMouseMove:function(e,t){var n=this.__mouse(e,this.$viewport.offset());if(n.x!==this._mouse.x||n.y!==this._mouse.y)this._mouseMoved=!0;if(this._draggingNodeData){var r={x:n.gx+this._draggingNodeData.offset.x,y:n.gy+this._draggingNodeData.offset.y};this._draggingNodeData.$canvas.css("left",r.x).css("top",r.y);return}if(this._viewportMoving){var i=n.x-this._mouse.x,s=n.y-this._mouse.y;this._viewportCamera.x+=i,this._viewportCamera.y+=s,this._mouse=n,this._viewportMoved||(this._viewportMoved=!0,this.$viewport.addClass("wcMoving"));return}if(this._viewportMovingNode){var i=n.x-this._mouse.x,s=n.y-this._mouse.y;this._selectedNode.pos.x+=i/this._viewportCamera.z,this._selectedNode.pos.y+=s/this._viewportCamera.z,this._mouse=n;return}this._mouse=n,this._highlightCollapser=!1,this._highlightBreakpoint=!1,this._highlightEntryLink=!1,this._highlightExitLink=!1,this._highlightInputLink=!1,this._highlightOutputLink=!1,this._highlightPropertyValue=!1;var o=this.__findNodeAtPos(n,this._viewportCamera);if(o){!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedInputLink&&!this._selectedOutputLink&&(this.__inRect(n,o._meta.bounds.collapser,this._viewportCamera)&&(this._highlightCollapser=!0),this.__inRect(n,o._meta.bounds.breakpoint,this._viewportCamera)&&(this._highlightBreakpoint=!0));if(!this._selectedEntryLink&&!this._selectedInputLink&&!this._selectedOutputLink)for(var u=0;u<o._meta.bounds.entryBounds.length;++u)if(this.__inRect(n,o._meta.bounds.entryBounds[u].rect,this._viewportCamera)){this._highlightNode=o,this._highlightEntryLink=o._meta.bounds.entryBounds[u];break}if(!this._selectedExitLink&&!this._selectedInputLink&&!this._selectedOutputLink)for(var u=0;u<o._meta.bounds.exitBounds.length;++u)if(this.__inRect(n,o._meta.bounds.exitBounds[u].rect,this._viewportCamera)){this._highlightNode=o,this._highlightExitLink=o._meta.bounds.exitBounds[u];break}if(!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedInputLink)for(var u=0;u<o._meta.bounds.inputBounds.length;++u)if(this.__inRect(n,o._meta.bounds.inputBounds[u].rect,this._viewportCamera)){this._highlightNode=o,this._highlightInputLink=o._meta.bounds.inputBounds[u];break}if(!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedOutputLink)for(var u=0;u<o._meta.bounds.outputBounds.length;++u)if(this.__inRect(n,o._meta.bounds.outputBounds[u].rect,this._viewportCamera)){this._highlightNode=o,this._highlightOutputLink=o._meta.bounds.outputBounds[u];break}if(!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedInputLink&&!this._selectedOutputLink){var a;for(var u=0;u<o._meta.bounds.valueBounds.length;++u)if(this.__inRect(this._mouse,o._meta.bounds.valueBounds[u].rect,this._viewportCamera)){a=o._meta.bounds.valueBounds[u];break}if(a)for(var u=0;u<o.properties.length;++u)if(o.properties[u].name===a.name){this._highlightNode=o,this._highlightPropertyValue=a;break}}this.__inRect(n,o._meta.bounds.inner,this._viewportCamera)?(this._highlightNode=o,this.$viewport.addClass("wcClickable")):this.$viewport.removeClass("wcClickable")}else this._highlightNode=null,this.$viewport.removeClass("wcClickable");this._expandedNode&&this._expandedNode!==this._highlightNode&&(this._highlightNode||!this.__inRect(n,this._expandedNode._meta.bounds.farRect,this._viewportCamera))&&(this._expandedNodeWasCollapsed&&this._expandedNode.collapsed(!0),this._expandedNode=null),!this._expandedNode&&this._highlightNode&&(this._selectedEntryLink||this._selectedExitLink||this._selectedInputLink||this._selectedOutputLink)&&this.__inRect(n,o._meta.bounds.inner,this._viewportCamera)&&(this._expandedNode=this._highlightNode,this._expandedNodeWasCollapsed=this._expandedNode.collapsed(),this._expandedNode.collapsed(!1))},__onViewportMouseDown:function(e,t){this._mouse=this.__mouse(e,this.$viewport.offset()),this._mouseMoved=!1;var n=!1,r=this.__findNodeAtPos(this._mouse,this._viewportCamera);if(r){if(!n)for(var i=0;i<r._meta.bounds.entryBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.entryBounds[i].rect,this._viewportCamera)){n=!0;if(e.altKey){var s=r.listEntryChains(r._meta.bounds.entryBounds[i].name);s.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Entry Links for "'+r.category+"."+r.type+"."+r._meta.bounds.entryBounds[i].name+'"',{id:r.id,name:r._meta.bounds.entryBounds[i].name,chains:s,editor:this},function(){var e=this.editor._engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.editor._engine.nodeById(this.chains[t].outNodeId),r=this.chains[t].outName;e.connectEntry(this.name,n,r)}},function(){var e=this.editor._engine.nodeById(this.id);e.disconnectEntry(this.name)}),r.disconnectEntry(r._meta.bounds.entryBounds[i].name);break}this._selectedNode=r,this._selectedEntryLink=r._meta.bounds.entryBounds[i];break}if(!n)for(var i=0;i<r._meta.bounds.exitBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.exitBounds[i].rect,this._viewportCamera)){n=!0;if(e.altKey){var s=r.listExitChains(r._meta.bounds.exitBounds[i].name);s.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Exit Links for "'+r.category+"."+r.type+"."+r._meta.bounds.exitBounds[i].name+'"',{id:r.id,name:r._meta.bounds.exitBounds[i].name,chains:s,editor:this},function(){var e=this.editor._engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.editor._engine.nodeById(this.chains[t].inNodeId),r=this.chains[t].inName;e.connectExit(this.name,n,r)}},function(){var e=this.editor._engine.nodeById(this.id);e.disconnectExit(this.name)}),r.disconnectExit(r._meta.bounds.exitBounds[i].name);break}if(e.shiftKey){r.triggerExit(r._meta.bounds.exitBounds[i].name);break}this._selectedNode=r,this._selectedExitLink=r._meta.bounds.exitBounds[i];break}if(!n)for(var i=0;i<r._meta.bounds.inputBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.inputBounds[i].rect,this._viewportCamera)){n=!0;if(e.altKey){var s=r.listInputChains(r._meta.bounds.inputBounds[i].name);s.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Property Input Links for "'+r.category+"."+r.type+"."+r._meta.bounds.inputBounds[i].name+'"',{id:r.id,name:r._meta.bounds.inputBounds[i].name,chains:s,editor:this},function(){var e=this.editor._engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.editor._engine.nodeById(this.chains[t].outNodeId),r=this.chains[t].outName;e.connectInput(this.name,n,r)}},function(){var e=this.editor._engine.nodeById(this.id);e.disconnectInput(this.name)}),r.disconnectInput(r._meta.bounds.inputBounds[i].name);break}this._selectedNode=r,this._selectedInputLink=r._meta.bounds.inputBounds[i];break}if(!n)for(var i=0;i<r._meta.bounds.outputBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.outputBounds[i].rect,this._viewportCamera)){n=!0;if(e.altKey){var s=r.listOutputChains(r._meta.bounds.outputBounds[i].name);s.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Property Output Links for "'+r.category+"."+r.type+"."+r._meta.bounds.outputBounds[i].name+'"',{id:r.id,name:r._meta.bounds.outputBounds[i].name,chains:s,editor:this},function(){var e=this.editor._engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.editor._engine.nodeById(this.chains[t].inNodeId),r=this.chains[t].inName;e.connectOutput(this.name,n,r)}},function(){var e=this.editor._engine.nodeById(this.id);e.disconnectOutput(this.name)}),r.disconnectOutput(r._meta.bounds.outputBounds[i].name);break}this._selectedNode=r,this._selectedOutputLink=r._meta.bounds.outputBounds[i];break}!n&&this.__inRect(this._mouse,r._meta.bounds.inner,this._viewportCamera)&&(n=!0,this._selectedNode=r,this._viewportMovingNode=!0,this._selectedNodeOrigin={x:r.pos.x,y:r.pos.y})}n||(this._viewportMoving=!0,this._viewportMoved=!1)},__onViewportMouseClick:function(e,t){if(!this._mouseMoved){this._mouse=this.__mouse(e,this.$viewport.offset());var n=!1,r=this.__findNodeAtPos(this._mouse,this._viewportCamera);if(r){if(this.__inRect(this._mouse,r._meta.bounds.collapser,this._viewportCamera)){var i=!r.collapsed();r.collapsed(i),this._undoManager&&this._undoManager.addEvent((i?"Collapsed":"Expanded")+' Node "'+r.category+"."+r.type+'"',{id:r.id,state:i,editor:this},function(){var e=this.editor._engine.nodeById(this.id);e.collapsed(!this.state)},function(){var e=this.editor._engine.nodeById(this.id);e.collapsed(this.state)})}if(this.__inRect(this._mouse,r._meta.bounds.breakpoint,this._viewportCamera)){var i=!r._break;r.debugBreak(i),this._undoManager&&this._undoManager.addEvent((i?"Enabled":"Disabled")+' Breakpoint on Node "'+r.category+"."+r.type+'"',{id:r.id,state:i,editor:this},function(){var e=this.editor._engine.nodeById(this.id);e.debugBreak(!this.state)},function(){var e=this.editor._engine.nodeById(this.id);e.debugBreak(this.state)})}var s;for(var o=0;o<r._meta.bounds.valueBounds.length;++o)if(this.__inRect(this._mouse,r._meta.bounds.valueBounds[o].rect,this._viewportCamera)){s=r._meta.bounds.valueBounds[o];break}if(s)for(var o=0;o<r.properties.length;++o)if(r.properties[o].name===s.name){this.__drawPropertyEditor(r,r.properties[o],s);break}}}},__onViewportMouseDoubleClick:function(e,t){this._mouse=this.__mouse(e,this.$viewport.offset());var n=!1,r=this.__findNodeAtPos(this._mouse,this._viewportCamera);if(r){this.__inRect(this._mouse,r._meta.bounds.collapser,this._viewportCamera)&&(n=!0),this.__inRect(this._mouse,r._meta.bounds.breakpoint,this._viewportCamera)&&(n=!0);for(var i=0;i<r._meta.bounds.valueBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.valueBounds[i].rect,this._viewportCamera)){n=!0;break}if(!n)for(var i=0;i<r._meta.bounds.exitBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.exitBounds[i].rect,this._viewportCamera)){n=!0,r.triggerExit(r._meta.bounds.exitBounds[i].name);break}if(!n)for(var i=0;i<r._meta.bounds.outputBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.outputBounds[i].rect,this._viewportCamera)){n=!0,r.property(r._meta.bounds.outputBounds[i].name,r.property(r._meta.bounds.outputBounds[i].name),!0);break}!n&&this.__inRect(this._mouse,r._meta.bounds.inner,this._viewportCamera)&&(n=!0,r.collapsed(!r.collapsed()))}},__onViewportMouseUp:function(e,t){if(this._draggingNodeData){var n=this.__mouse(e,this.$viewport.offset(),this._viewportCamera),r=new window[this._draggingNodeData.node.className](this._engine,{x:(n.x+(this._draggingNodeData.$canvas.width()/2+this._draggingNodeData.offset.x))/this._viewportCamera.z,y:(n.y+this._draggingNodeData.offset.y)/this._viewportCamera.z});this._undoManager&&this._undoManager.addEvent('Created Node "'+r.category+"."+r.type+'"',{id:r.id,className:r.className,pos:{x:r.pos.x,y:r.pos.y},editor:this},function(){var e=this.editor._engine.nodeById(this.id);e.destroy()},function(){var e=new window[this.className](this.editor._engine,this.pos);e.id=this.id}),this._draggingNodeData.$canvas.remove(),this._draggingNodeData.$canvas=null,this._draggingNodeData=null,this.$palette.removeClass("wcMoving"),this.$viewport.removeClass("wcMoving")}this._selectedNode&&this._selectedNodeOrigin&&((this._selectedNode.pos.x!==this._selectedNodeOrigin.x||this._selectedNode.pos.y!==this._selectedNodeOrigin.y)&&this._undoManager&&this._undoManager.addEvent('Moved Node "'+this._selectedNode.category+"."+this._selectedNode.type+'"',{id:this._selectedNode.id,start:{x:this._selectedNodeOrigin.x,y:this._selectedNodeOrigin.y},end:{x:this._selectedNode.pos.x,y:this._selectedNode.pos.y},editor:this},function(){var e=this.editor._engine.nodeById(this.id);e.pos.x=this.start.x,e.pos.y=this.start.y},function(){var e=this.editor._engine.nodeById(this.id);e.pos.x=this.end.x,e.pos.y=this.end.y}),this._selectedNodeOrigin=null),this._selectedNode&&this._selectedEntryLink&&this._highlightNode&&this._highlightExitLink&&(this._selectedNode.connectEntry(this._selectedEntryLink.name,this._highlightNode,this._highlightExitLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectEntry(this._selectedEntryLink.name,this._highlightNode,this._highlightExitLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Entry Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedEntryLink.name+'" to Exit Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightExitLink.name+'"',{id:this._selectedNode.id,name:this._selectedEntryLink.name,targetId:this._highlightNode.id,targetName:this._highlightExitLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectEntry(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectEntry(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Entry Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedEntryLink.name+'" to Exit Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightExitLink.name+'"',{id:this._selectedNode.id,name:this._selectedEntryLink.name,targetId:this._highlightNode.id,targetName:this._highlightExitLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectEntry(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectEntry(this.name,t,this.targetName)})),this._selectedNode&&this._selectedExitLink&&this._highlightNode&&this._highlightEntryLink&&(this._selectedNode.connectExit(this._selectedExitLink.name,this._highlightNode,this._highlightEntryLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectExit(this._selectedExitLink.name,this._highlightNode,this._highlightEntryLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Exit Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedExitLink.name+'" to Entry Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightEntryLink.name+'"',{id:this._selectedNode.id,name:this._selectedExitLink.name,targetId:this._highlightNode.id,targetName:this._highlightEntryLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectExit(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectExit(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Exit Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedExitLink.name+'" to Entry Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightEntryLink.name+'"',{id:this._selectedNode.id,name:this._selectedExitLink.name,targetId:this._highlightNode.id,targetName:this._highlightEntryLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectExit(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectExit(this.name,t,this.targetName)})),this._selectedNode&&this._selectedInputLink&&this._highlightNode&&this._highlightOutputLink&&(this._selectedNode.connectInput(this._selectedInputLink.name,this._highlightNode,this._highlightOutputLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectInput(this._selectedInputLink.name,this._highlightNode,this._highlightOutputLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Property Input Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedInputLink.name+'" to Property Output Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightOutputLink.name+'"',{id:this._selectedNode.id,name:this._selectedInputLink.name,targetId:this._highlightNode.id,targetName:this._highlightOutputLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectInput(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectInput(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Property Input Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedInputLink.name+'" to Property Output Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightOutputLink.name+'"',{id:this._selectedNode.id,name:this._selectedInputLink.name,targetId:this._highlightNode.id,targetName:this._highlightOutputLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectInput(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectInput(this.name,t,this.targetName)})),this._selectedNode&&this._selectedOutputLink&&this._highlightNode&&this._highlightInputLink&&(this._selectedNode.connectOutput(this._selectedOutputLink.name,this._highlightNode,this._highlightInputLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectOutput(this._selectedOutputLink.name,this._highlightNode,this._highlightInputLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Property Output Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedOutputLink.name+'" to Property Input Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightInputLink.name+'"',{id:this._selectedNode.id,name:this._selectedOutputLink.name,targetId:this._highlightNode.id,targetName:this._highlightInputLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectOutput(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectOutput(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Property Output Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedOutputLink.name+'" to Property Input Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightInputLink.name+'"',{id:this._selectedNode.id,name:this._selectedOutputLink.name,targetId:this._highlightNode.id,targetName:this._highlightInputLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectOutput(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectOutput(this.name,t,this.targetName)})),this._expandedNode&&this._expandedNodeWasCollapsed&&this._expandedNode.collapsed(!0),this._expandedNode=null,this._selectedEntryLink=!1,this._selectedExitLink=!1,this._selectedInputLink=!1,this._selectedOutputLink=!1,this._viewportMovingNode=!1,this._viewportMoving&&(this._viewportMoving=!1,this._viewportMoved?(this._viewportMoved=!1,this.$viewport.removeClass("wcMoving")):this._selectedNode=null)},__onViewportMouseWheel:function(e,t){var n=this._viewportCamera.z,r=this.__mouse(e,this.$viewport.offset());e.originalEvent.wheelDelta>0||e.originalEvent.detail<0?this._viewportCamera.z=Math.min(this._viewportCamera.z*1.25,5):this._viewportCamera.z=Math.max(this._viewportCamera.z*.75,.1),this._viewportCamera.x=(this._viewportCamera.x-r.x)/(n/this._viewportCamera.z)+r.x,this._viewportCamera.y=(this._viewportCamera.y-r.y)/(n/this._viewportCamera.z)+r.y},__findNodeAtPos:function(e,t,n){if(this._engine){var r=this;function i(n){for(var i=n.length-1;i>=0;--i)if(n[i]._meta.bounds&&r.__inRect(e,n[i]._meta.bounds.rect,t))return n[i];return null}return n===undefined?i(this._engine._storageNodes)||i(this._engine._compositeNodes)||i(this._engine._processNodes)||i(this._engine._entryNodes):i(n)}return null},__findCategoryAreaAtPos:function(e){for(var t in this._nodeLibrary)for(var n in this._nodeLibrary[t]){if(!this.$typeButton[this.__typeIndex(n)].hasClass("wcToggled"))continue;var r=this._nodeLibrary[t][n];if(r.$button.hasClass("wcToggled"))continue;var i=r.$canvas.offset();i.width=r.$canvas.width(),i.height=r.$canvas.height();if(this.__inRect(e,i))return r}}};var wcNodeNextID=0;Class.extend("wcNode","Node","",{init:function(e,t,n){this.id=++wcNodeNextID,this.type=n||this.name,this.name="",this.color="#FFFFFF",this._viewportSize=null,this.pos={x:t&&t.x||0,y:t&&t.y||0},this.chain={entry:[],exit:[]},this.properties=[],this._meta={flash:!1,flashDelta:0,color:null,paused:!1,awake:!1,threads:[]},this._threadIndex=0,this._collapsed=!1,this._break=!1,this._parent=e,this.createProperty(wcNode.PROPERTY.ENABLED,wcPlay.PROPERTY_TYPE.TOGGLE,!0,{collapsible:!0}),this.createProperty(wcNode.PROPERTY.DEBUG_LOG,wcPlay.PROPERTY_TYPE.TOGGLE,!1,{collapsible:!0});var r=this.engine();r&&r.__addNode(this)},destroy:function(){for(var e=0;e<this.chain.entry.length;++e){var t=this.chain.entry[e];this.disconnectEntry(t.name)}for(var e=0;e<this.chain.exit.length;++e){var t=this.chain.exit[e];this.disconnectExit(t.name)}for(var e=0;e<this.properties.length;++e){var t=this.properties[e];this.disconnectInput(t.name),this.disconnectOutput(t.name)}var n=this.engine();n&&n.__removeNode(this)},engine:function(){var e=this._parent;while(e&&!(e instanceof wcPlay))e=e._parent;return e||null},enabled:function(e){return e!==undefined&&this.property(wcNode.PROPERTY.ENABLED,e?!0:!1),this.property(wcNode.PROPERTY.ENABLED)},debugLog:function(e){e!==undefined&&this.property(wcNode.PROPERTY.DEBUG_LOG,e?!0:!1);var t=this.engine();return!t||t.isSilent()?!1:this.property(wcNode.PROPERTY.DEBUG_LOG)},debugBreak:function(e){e!==undefined&&(this._break=e?!0:!1);var t=this.engine();return t&&t.debugging()&&this._break},collapsed:function(e){return e!==undefined&&(this._collapsed=e),this._collapsed},beginThread:function(){return this._threadIndex++,this._meta.threads.push(this._threadIndex),this._meta.awake=!0,this._threadIndex},finishThread:function(e){var t=this._meta.threads.indexOf(e);t>-1&&(this._meta.threads.splice(t,1),this._meta.threads.length||(this._meta.awake=!1))},pos:function(e){return e!==undefined&&(this.pos.x=e.x,this.pos.y=e.y),{x:this.pos.x,y:this.pos.y}},createEntry:function(e){for(var t=0;t<this.chain.entry.length;++t)if(this.chain.entry[t].name===e)return!1;return this.chain.entry.push({name:e,active:!1,links:[],meta:{flash:!1,flashDelta:0,color:"#000000"}}),!0},createExit:function(e){for(var t=0;t<this.chain.exit.length;++t)if(this.chain.exit[t].name===e)return!1;return this.chain.exit.push({name:e,links:[],meta:{flash:!1,flashDelta:0,color:"#000000"}}),!0},createProperty:function(e,t,n,r){for(var i=0;i<this.properties.length;++i)if(this.properties[i].name===e)return!1;return n===undefined&&(n=0),this.properties.push({name:e,value:n,initialValue:n,type:t,inputs:[],outputs:[],options:r||{},inputMeta:{flash:!1,flashDelta:0,color:"#000000"},outputMeta:{flash:!1,flashDelta:0,color:"#000000"}}),!0},removeEntry:function(e){for(var t=0;t<this.chain.entry.length;++t)if(this.chain.entry[t].name===e&&this.disconnectEntry(e)===wcNode.CONNECT_RESULT.SUCCESS)return this.chain.entry.splice(t,1),!0;return!1},removeExit:function(e){for(var t=0;t<this.chain.exit.length;++t)if(this.chain.exit[t].name===e&&this.disconnectExit(e)===wcNode.CONNECT_RESULT.SUCCESS)return this.chain.exit.splice(t,1),!0;return!1},removeProperty:function(e){for(var t=0;t<this.properties.length;++t)if(this.properties[t].name===e&&this.disconnectInput(e)===this.disconnectOutput(e)===wcNode.CONNECT_RESULT.SUCCESS)return this.properties.splice(t,1),!0;return!1},connectEntry:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.chain.entry.length;++s)if(this.chain.entry[s].name===e){r=this.chain.entry[s];break}for(var s=0;s<t.chain.exit.length;++s)if(t.chain.exit[s].name===n){i=t.chain.exit[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.links.length;++s)if(r.links[s].node===t&&r.links[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.links.length;++s)if(i.links[s].node===this&&i.links[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.links.push({name:i.name,node:t}),i.links.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.ENTRY,t,i.name,wcNode.LINK_TYPE.EXIT),t.onConnect(!0,i.name,wcNode.LINK_TYPE.EXIT,this,r.name,wcNode.LINK_TYPE.ENTRY),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},connectExit:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.chain.exit.length;++s)if(this.chain.exit[s].name===e){r=this.chain.exit[s];break}for(var s=0;s<t.chain.entry.length;++s)if(t.chain.entry[s].name===n){i=t.chain.entry[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.links.length;++s)if(r.links[s].node===t&&r.links[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.links.length;++s)if(i.links[s].node===this&&i.links[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.links.push({name:i.name,node:t}),i.links.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.EXIT,t,i.name,wcNode.LINK_TYPE.ENTRY),t.onConnect(!0,i.name,wcNode.LINK_TYPE.ENTRY,this,r.name,wcNode.LINK_TYPE.EXIT),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},connectInput:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.properties.length;++s)if(this.properties[s].name===e){r=this.properties[s];break}for(var s=0;s<t.properties.length;++s)if(t.properties[s].name===n){i=t.properties[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.inputs.length;++s)if(r.inputs[s].node===t&&r.inputs[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.outputs.length;++s)if(i.outputs[s].node===this&&i.outputs[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.inputs.push({name:i.name,node:t}),i.outputs.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.INPUT,t,i.name,wcNode.LINK_TYPE.OUTPUT),t.onConnect(!0,i.name,wcNode.LINK_TYPE.OUTPUT,this,r.name,wcNode.LINK_TYPE.INPUT),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},connectOutput:function(e,t,n){if(t instanceof wcNode){var r=null,i=null;for(var s=0;s<this.properties.length;++s)if(this.properties[s].name===e){r=this.properties[s];break}for(var s=0;s<t.properties.length;++s)if(t.properties[s].name===n){i=t.properties[s];break}if(!r||!i)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var s=0;s<r.outputs.length;++s)if(r.outputs[s].node===t&&r.outputs[s].name===i.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;for(var s=0;s<i.inputs.length;++s)if(i.inputs[s].node===this&&i.inputs[s].name===r.name)return wcNode.CONNECT_RESULT.ALREADY_CONNECTED;return r.outputs.push({name:i.name,node:t}),i.inputs.push({name:r.name,node:this}),this.onConnect(!0,r.name,wcNode.LINK_TYPE.OUTPUT,t,i.name,wcNode.LINK_TYPE.INPUT),t.onConnect(!0,i.name,wcNode.LINK_TYPE.INPUT,this,r.name,wcNode.LINK_TYPE.OUTPUT),wcNode.CONNECT_RESULT.SUCCESS}return wcNode.CONNECT_RESULT.NOT_FOUND},disconnectEntry:function(e,t,n){var r=null;for(var i=0;i<this.chain.entry.length;++i)if(this.chain.entry[i].name===e){r=this.chain.entry[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.links.length;++i){var s=r.links[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.links.splice(i,1),i--,s.node.disconnectExit(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},disconnectExit:function(e,t,n){var r=null;for(var i=0;i<this.chain.exit.length;++i)if(this.chain.exit[i].name===e){r=this.chain.exit[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.links.length;++i){var s=r.links[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.links.splice(i,1),i--,s.node.disconnectEntry(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},disconnectInput:function(e,t,n){var r=null;for(var i=0;i<this.properties.length;++i)if(this.properties[i].name===e){r=this.properties[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.inputs.length;++i){var s=r.inputs[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.inputs.splice(i,1),i--,s.node.disconnectOutput(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},disconnectOutput:function(e,t,n){var r=null;for(var i=0;i<this.properties.length;++i)if(this.properties[i].name===e){r=this.properties[i];break}if(!r)return wcNode.CONNECT_RESULT.NOT_FOUND;for(var i=0;i<r.outputs.length;++i){var s=r.outputs[i];(!t||t===s.node)&&(!n||n===s.name)&&(r.outputs.splice(i,1),i--,s.node.disconnectInput(s.name,this,e))}return wcNode.CONNECT_RESULT.SUCCESS},listEntryChains:function(e){var t=[];for(var n=0;n<this.chain.entry.length;++n)if(!e||this.chain.entry[n].name===e){var r=this.chain.entry[n];for(var i=0;i<r.links.length;++i)t.push({inName:r.name,inNodeId:this.id,outName:r.links[i].name,outNodeId:r.links[i].node.id})}return t},listExitChains:function(e){var t=[];for(var n=0;n<this.chain.exit.length;++n)if(!e||this.chain.exit[n].name===e){var r=this.chain.exit[n];for(var i=0;i<r.links.length;++i)t.push({inName:r.links[i].name,inNodeId:r.links[i].node.id,outName:r.name,outNodeId:this.id})}return t},listInputChains:function(e){var t=[];for(var n=0;n<this.properties.length;++n)if(!e||this.properties[n].name===e){var r=this.properties[n];for(var i=0;i<r.inputs.length;++i)t.push({inName:r.name,inNodeId:this.id,outName:r.inputs[i].name,outNodeId:r.inputs[i].node.id})}return t},listOutputChains:function(e){var t=[];for(var n=0;n<this.properties.length;++n)if(!e||this.properties[n].name===e){var r=this.properties[n];for(var i=0;i<r.outputs.length;++i)t.push({inName:r.outputs[i].name,inNodeId:r.outputs[i].node.id,outName:r.name,outNodeId:this.id})}return t},listProperties:function(){var e=[];for(var t=0;t<this.properties.length;++t){var n=this.properties[t];e.push({name:n.name,value:n.value,initialValue:n.initialValue})}return e},triggerEntry:function(e){for(var t=0;t<this.chain.entry.length;++t)if(this.chain.entry[t].name==e){var n=this.engine();this.chain.entry[t].meta.flash=!0;if(this.debugBreak()||n&&n.stepping())this.chain.entry[t].meta.paused=!0;return n&&n.queueNodeEntry(this,this.chain.entry[t].name),!0}return!1},triggerExit:function(e){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" - "+this.name:"")+'" Triggered Exit link "'+e+'"');for(var t=0;t<this.chain.exit.length;++t){var n=this.chain.exit[t];if(n.name==e){this.chain.exit[t].meta.flash=!0;var r=this.engine();for(var i=0;i<n.links.length;++i)if(n.links[i].node){n.links[i].node.triggerEntry(n.links[i].name);if(n.links[i].node.debugBreak()||r&&r.stepping())this.chain.exit[t].meta.paused=!0}return!0}}return!1},property:function(e,t,n){for(var r=0;r<this.properties.length;++r){var i=this.properties[r];if(i.name===e){if(t!==undefined){var s=i.value,o=this.engine();i.outputMeta.flash=!0;if(this.debugBreak()||o&&o.stepping())i.outputMeta.paused=!0;if(n||i.value!==t)t=this.onPropertyChanging(i.name,s,t)||t;if(n||i.value!==t){i.value=t,this.onPropertyChanged(i.name,s,t);if(n===undefined||n)for(a=0;a<i.outputs.length;++a)i.outputs[a].node&&i.outputs[a].node.triggerProperty(i.outputs[a].name,t)}}return i.value}}},initialProperty:function(e,t){for(var n=0;n<this.properties.length;++n){var r=this.properties[n];r.name===e&&(r.initialValue=t)}},triggerProperty:function(e,t){var n=this.engine();n&&n.queueNodeProperty(this,e,t);for(var r=0;r<this.properties.length;++r){var i=this.properties[r];if(i.name===e){i.inputMeta.flash=!0;if(this.debugBreak()||n&&n.stepping())i.inputMeta.paused=!0}}},viewportSize:function(e,t){return e!==undefined&&t!==undefined&&(!e||!t?this._viewportSize=null:this._viewportSize={x:e,y:t}),{x:this._viewportSize.x,y:this._viewportSize.y}},onViewport:function(e){},onConnect:function(e,t,n,r,i,s){e&&n===wcNode.LINK_TYPE.OUTPUT&&r.triggerProperty(i,this.property(t))},onStart:function(){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" - "+this.name:"")+'" started!')},onTriggered:function(e){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" - "+this.name:"")+'" Triggered Entry link "'+e+'"')},onPropertyChanging:function(e,t,n){},onPropertyChanged:function(e,t,n){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" - "+this.name:"")+'" Changed Property "'+e+'" from "'+t+'" to "'+n+'"')},onPropertyGet:function(e){},onPropertyGot:function(e){this.debugLog()&&console.log('DEBUG: Node "'+this.category+"."+this.type+(this.name?" - "+this.name:"")+'" Got Property "'+e+'"')}}),wcNode.LINK_TYPE={ENTRY:"entry",EXIT:"exit",INPUT:"input",OUTPUT:"output"},wcNode.CONNECT_RESULT={NOT_FOUND:"not_found",ALREADY_CONNECTED:"already_connected",SUCCESS:"success"},wcNode.PROPERTY={ENABLED:"enabled",DEBUG_LOG:"debug log"},wcNode.extend("wcNodeEntry","Entry Node","",{init:function(e,t,n){this._super(e,t,n),this.color="#CCCC00",this.createExit("out")},classInit:function(e,t,n){n&&(this.className=e,this.name=t,this.category=n,wcPlay.registerNodeType(e,t,n,wcPlay.NODE_TYPE.ENTRY))},onTriggered:function(e){this.triggerCondition(e)&&this.triggerExit("out")},triggerCondition:function(e){return!0}}),wcNode.extend("wcNodeProcess","Node Process","",{init:function(e,t,n){this._super(e,t,n),this.color="#007ACC",this.createEntry("in"),this.createExit("out")},classInit:function(e,t,n){n&&(this.className=e,this.name=t,this.category=n,wcPlay.registerNodeType(e,t,n,wcPlay.NODE_TYPE.PROCESS))}}),wcNode.extend("wcNodeStorage","Storage","",{init:function(e,t,n){this._super(e,t,n),this.color="#009900"},classInit:function(e,t,n){n&&(this.className=e,this.name=t,this.category=n,wcPlay.registerNodeType(e,t,n,wcPlay.NODE_TYPE.STORAGE))},onStart:function(){this._super(),this.property("value",this.property("value"),!0)}}),wcNodeEntry.extend("wcNodeEntryStart","Start","Core",{init:function(e,t,n){this._super(e,t,n)},onStart:function(){this._super(),this.onTriggered()}}),wcNodeProcess.extend("wcNodeProcessDelay","Delay","Core",{init:function(e,t,n){this._super(e,t,n),this.createExit("finished"),this.createProperty("milliseconds",wcPlay.PROPERTY_TYPE.NUMBER,1e3)},onTriggered:function(e){this._super(e),this.triggerExit("out");var t=this,n=this.property("milliseconds"),r=this.beginThread();setTimeout(function(){t.triggerExit("finished"),t.finishThread(r)},n)}}),wcNodeProcess.extend("wcNodeProcessConsoleLog","Console Log","Debugging",{init:function(e,t,n){this._super(e,t,n),this.createProperty("message",wcPlay.PROPERTY_TYPE.STRING,"Log message.",{multiline:!0})},onTriggered:function(e){this._super(e),this.triggerExit("out");var t=this.engine();if(!t||t.isSilent())return;var n=this.property("message");console.log(n)}}),wcNodeProcess.extend("wcNodeProcessAlert","Alert","Debugging",{init:function(e,t,n){this._super(e,t,n),this.createProperty("message",wcPlay.PROPERTY_TYPE.STRING,"Alert message.",{multiline:!0})},onTriggered:function(e){this._super(e),this.triggerExit("out");var t=this.engine();if(!t||t.isSilent())return;var n=this.property("message");alert(n)}}),wcNodeProcess.extend("wcNodeProcessOperation","Operation","Core",{init:function(e,t,n){this._super(e,t,n),this.removeEntry("in"),this.createEntry("add"),this.createEntry("sub"),this.createEntry("mul"),this.createEntry("div"),this.createProperty("valueA",wcPlay.PROPERTY_TYPE.NUMBER,0),this.createProperty("valueB",wcPlay.PROPERTY_TYPE.NUMBER,0),this.createProperty("result",wcPlay.PROPERTY_TYPE.NUMBER,0)},onTriggered:function(e){this._super(e);var t=parseFloat(this.property("valueA")),n=parseFloat(this.property("valueB")),r;switch(e){case"add":r=t+n;break;case"sub":r=t-n;break;case"mul":r=t*n;break;case"div":r=t/n}this.property("result",r),this.triggerExit("out")}}),wcNodeStorage.extend("wcNodeStorageToggle","Toggle","Core",{init:function(e,t,n){this._super(e,t,n),this.createProperty("value",wcPlay.PROPERTY_TYPE.TOGGLE,!1)}}),wcNodeStorage.extend("wcNodeStorageNumber","Number","Core",{init:function(e,t,n){this._super(e,t,n),this.createProperty("value",wcPlay.PROPERTY_TYPE.NUMBER)}}),wcNodeStorage.extend("wcNodeStorageString","String","Core",{init:function(e,t,n){this._super(e,t,n),this.createProperty("value",wcPlay.PROPERTY_TYPE.STRING,"",{multiline:!0})}})