/*!
 * Web Cabin Play - Node based visual scripting tool.
 *
 * Dependancies:
 *  JQuery 1.11.1
 *  font-awesome 4.2.0
 *  wcMenu
 * Optional Dependencies:
 *  FileSaver.js
 *  wcUndoManager
 *
 * Author: Jeff Houde (lochemage@webcabin.org)
 * Web: https://play.webcabin.org/
 * API: https://play.api.webcabin.org/
 *
 * Licensed under
 *   MIT License http://www.opensource.org/licenses/mit-license
 *
 */
"use strict";function wcPlayEditor(e,t){this.$container=$(e),this.$typeButton=[],this.$typeArea=[],this._paletteSize=300,this._chainStyle=1,this._chainStyleMax=1,this._menu=null,this._size={x:0,y:0},this._engine=null,this._parent=null,this._nodeLibrary={},this._font={breadcrumbs:{size:10,family:"Arial",weight:"bold"},title:{size:13,family:"Arial",weight:"bold"},titleDesc:{size:10,family:"Arial",weight:"italic"},details:{size:9,family:"Arial",weight:"bold"},links:{size:9,family:"Arial"},property:{size:9,family:"Arial",weight:"italic"},value:{size:9,family:"Arial",weight:"bold"},initialValue:{size:9,family:"Arial",weight:"bold italic"}},this._drawStyle={palette:{spacing:10},node:{radius:7,margin:14},title:{spacing:5,wrapL:"  ",wrapR:"  ",placeholder:"  ",nameWrapL:" (",nameWrapR:") ",details:" [?] "},links:{length:10,width:7,spacing:7,padding:5,margin:7},property:{spacing:5,strLen:20,minLength:30,valueWrapL:" [",valueWrapR:"] ",initialWrapL:" ",initialWrapR:" ",highlightColor:"rgba(255, 255, 255, 0.5)",normalColor:"rgba(255, 255, 255, 0.5)",highlightBorder:-1,normalBorder:1}},this._lastUpdate=0,this._viewportCamera={x:0,y:0,z:1},this._viewportBounds={left:0,top:0,width:0,height:0},this._viewportMovingNode=!1,this._viewportMoving=!1,this._viewportMoved=!1,this._paletteMoving=!1,this._autoScrollDirection={x:0,y:0},this._autoScrollInterval=0,this._autoScrollNodes=!1,this._mouse={x:0,y:0},this._mouseInViewport=!1,this._highlightRect=null,this._highlightNode=null,this._selectedNode=null,this._selectedNodes=[],this._expandedHighlightNode=null,this._expandedSelectedNode=null,this._highlightTitle=!1,this._highlightDetails=!1,this._highlightDebugLog=!1,this._highlightBreakpoint=!1,this._highlightEntryLink=!1,this._highlightExitLink=!1,this._highlightInputLink=!1,this._highlightOutputLink=!1,this._highlightPropertyValue=!1,this._highlightPropertyInitialValue=!1,this._highlightViewport=!1,this._selectedEntryLink=!1,this._selectedExitLink=!1,this._selectedInputLink=!1,this._selectedOutputLink=!1,this._selectedNodeOrigins=[],this._draggingNodeData=null,this._highlightCrumb=-1,this._crumbBounds=[],this._undoManager=null,this._options={readOnly:!1,playable:!0,category:{items:[],isBlacklist:!0}};for(var n in t)this._options[n]=t[n];this.$top=$('<div class="wcPlayEditorTop" tabindex="1">'),this.$main=$('<div class="wcPlayEditorMain" tabindex="1">'),this.$palette=$('<div class="wcPlayPalette wcPlayNoHighlights" tabindex="1">'),this.$paletteScroller=$('<div class="wcPlayPaletteScroller" tabindex="1">'),this.$paletteInner=$('<div class="wcPlayPaletteInner" tabindex="1">'),this.$viewport=$('<canvas class="wcPlayViewport" tabindex="1">'),this._viewportContext=this.$viewport[0].getContext("2d"),this.$palette.append(this.$paletteScroller),this.$paletteScroller.append(this.$paletteInner),this.$main.append(this.$palette),this.$main.append(this.$viewport),this.$container.append(this.$top),this.$container.append(this.$main),this.$search=$('<div class="wcPlayEditorSearch wcPlayHidden"><span>Search</span><input type="text"/><i class="fa fa-chevron-up wcPlayEditorSearchPrev"/><i class="fa fa-chevron-down wcPlayEditorSearchNext"/></div>'),this.$hiddenFileLoader=$('<input type="file" id="wcPlayEditorHiddenFileLoader"/>'),this.$hiddenFileImporter=$('<input type="file" id="wcPlayEditorHiddenFileImporter"/>'),this.$container.append(this.$search),this.onResized(),this.__setupMenu(),this.__setupControls(),this.$top.focus(),window.requestAnimationFrame(this.__update.bind(this))}window.wcPlayEditorClipboard={bounds:{top:0,left:0,width:0,height:0},nodes:[]},wcPlayEditor.prototype={engine:function(e){if(e!==undefined&&e!==this._engine){if(this._engine){var t=this._engine._editors.indexOf(this);t>-1&&this._engine._editors.splice(t,1),this._engine._undoManager=this._undoManager,this._undoManager=null}this._engine=e,this._parent=e,this.__setupPalette(),this.center(),this._engine&&(this._engine._editors.push(this),this._undoManager=this._engine._undoManager,!this._undoManager&&window.wcUndoManager&&(this._undoManager=new wcUndoManager,this._engine._undoManager=this._undoManager))}return this._engine},menu:function(){return this._menu},center:function(){this._parent&&this.focus(this._parent._entryNodes.concat(this._parent._processNodes,this._parent._storageNodes,this._parent._compositeNodes))},focus:function(e){if(e.length){this.__updateNodes(e,0,this._viewportContext),this.__drawNodes(e,this._viewportContext);var t=[],n=[];for(var r=0;r<e.length;++r)t.push(e[r]._meta.bounds.farRect),n.push(e[r].pos);var i=this.__expandRect(t,n);i.width<1e3&&(i.left-=(1e3-i.width)/2,i.width=1e3),this.focusRect(i)}},focusRect:function(e){var t=this.$viewport.width()/(e.width+100),n=this.$viewport.height()/(e.height+100);this._viewportCamera.z=Math.min(t,n),t>n?e.left-=(this.$viewport.width()/n-(e.width+100))/2:e.top-=(this.$viewport.height()/t-(e.height+100))/2,this._viewportCamera.x=-(e.left-50)*this._viewportCamera.z,this._viewportCamera.y=-(e.top-50)*this._viewportCamera.z},onResized:function(){var e=this.$main.width(),t=this.$main.height();if(this._size.x!==e||this._size.y!==t||this._size.z!==this._paletteSize)this._size.x=e,this._size.y=t,this._size.z=this._paletteSize,this.$palette.css("width",this._size.z).attr("width",this._size.z).attr("height",t),this.$viewport.css("width",e-this._size.z).attr("width",e-this._size.z).attr("height",t);this._viewportBounds.top=-this._viewportCamera.y/this._viewportCamera.z,this._viewportBounds.left=-this._viewportCamera.x/this._viewportCamera.z,this._viewportBounds.width=this._size.x/this._viewportCamera.z,this._viewportBounds.height=this._size.y/this._viewportCamera.z},__mouse:function(e,t,n){if(e.originalEvent&&(e.originalEvent.touches||e.originalEvent.changedTouches)){var r=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0];return{x:r.clientX-(t?t.left:0)-(n?n.x:0),y:r.clientY-(t?t.top:0)-(n?n.y:0),gx:r.clientX,gy:r.clientY,which:1}}return{x:(e.clientX||e.pageX)-(t?t.left:0)-(n?n.x:0),y:(e.clientY||e.pageY)-(t?t.top:0)-(n?n.y:0),gx:e.clientX||e.pageX,gy:e.clientY||e.pageY,which:e.which||1}},__setCanvasFont:function(e,t){t.font=(e.weight?e.weight+" ":"")+(e.size+"px ")+e.family},__clampString:function(e,t){return e.length>t?e.substr(0,t)+"...":e},__blendColors:function(e,t,n){var r=n<0?n*-1:n,i=Math.round,s=parseInt;if(e.length>7){var o=e.split(","),u=(t?t:n<0?"rgb(0,0,0)":"rgb(255,255,255)").split(","),a=s(o[0].slice(4)),f=s(o[1]),l=s(o[2]);return"rgb("+(i((s(u[0].slice(4))-a)*r)+a)+","+(i((s(u[1])-f)*r)+f)+","+(i((s(u[2])-l)*r)+l)+")"}var o=s(e.slice(1),16),u=s((t?t:n<0?"#000000":"#FFFFFF").slice(1),16),c=o>>16,h=o>>8&255,p=o&255;return"#"+(16777216+(i(((u>>16)-c)*r)+c)*65536+(i(((u>>8&255)-h)*r)+h)*256+(i(((u&255)-p)*r)+p)).toString(16).slice(1)},__expandRect:function(e,t){var n={top:e[0].top+(t?t[0].y:0),left:e[0].left+(t?t[0].x:0),width:e[0].width,height:e[0].height};for(var r=1;r<e.length;++r){var i=0,s=0;t&&(i=t[r].x,s=t[r].y),e[r].top+s<n.top&&(n.top=e[r].top+s),e[r].left+i<n.left&&(n.left=e[r].left+i)}for(var r=0;r<e.length;++r){var i=0,s=0;t&&(i=t[r].x,s=t[r].y),e[r].top+s+e[r].height>n.top+n.height&&(n.height=e[r].top+s+e[r].height-n.top),e[r].left+i+e[r].width>n.left+n.width&&(n.width=e[r].left+i+e[r].width-n.left)}return n},__inRect:function(e,t,n,r){return n===undefined&&(n={x:0,y:0}),r===undefined&&(r={x:0,y:0,z:1}),(e.y-r.y)/r.z>=n.y+t.top&&(e.x-r.x)/r.z>=n.x+t.left&&(e.y-r.y)/r.z<=n.y+t.top+t.height&&(e.x-r.x)/r.z<=n.x+t.left+t.width?!0:!1},__rectOnRect:function(e,t,n){return n===undefined&&(n={x:0,y:0}),!(t.left>n.x+e.left+e.width||t.left+t.width<n.x+e.left||t.top>n.y+e.top+e.height||t.top+t.height<n.y+e.top)},__drawRoundedRect:function(e,t,n,r,i,s){s||(s={x:0,y:0}),i.save(),i.strokeStyle=t,i.fillStyle=t,i.lineWidth=n>0?n:1,i.beginPath(),i.moveTo(s.x+e.left+r,s.y+e.top),i.arcTo(s.x+e.left+e.width,s.y+e.top,s.x+e.left+e.width,s.y+e.top+r,r),i.arcTo(s.x+e.left+e.width,s.y+e.top+e.height,s.x+e.left+e.width-r,s.y+e.top+e.height,r),i.arcTo(s.x+e.left,s.y+e.top+e.height,s.x+e.left,s.y+e.top+e.height-r,r),i.arcTo(s.x+e.left,s.y+e.top,s.x+e.left+r,s.y+e.top,r),i.closePath(),n==-1?i.fill():i.stroke(),i.restore()},__update:function(e){this._lastUpdate||(this._lastUpdate=e);var t=(e-this._lastUpdate)/1e3;this._lastUpdate=e,this.onResized(),this._menu.update();if(this._parent){this.__drawPalette(t),this._viewportContext.clearRect(0,0,this.$viewport.width(),this.$viewport.height()),this._viewportContext.save(),this._viewportContext.translate(this._viewportCamera.x,this._viewportCamera.y),this._viewportContext.scale(this._viewportCamera.z,this._viewportCamera.z),this.__updateNodes(this._parent._entryNodes,t,this._viewportContext),this.__updateNodes(this._parent._processNodes,t,this._viewportContext),this.__updateNodes(this._parent._storageNodes,t,this._viewportContext),this.__updateNodes(this._parent._compositeNodes,t,this._viewportContext),this.__drawNodes(this._parent._entryNodes,this._viewportContext),this.__drawNodes(this._parent._processNodes,this._viewportContext),this.__drawNodes(this._parent._compositeNodes,this._viewportContext),this.__drawNodes(this._parent._storageNodes,this._viewportContext),this.__drawChains(this._parent._entryNodes,this._viewportContext),this.__drawChains(this._parent._processNodes,this._viewportContext),this.__drawChains(this._parent._compositeNodes,this._viewportContext),this.__drawChains(this._parent._storageNodes,this._viewportContext);if(this._highlightRect){var n=Math.min(10,this._highlightRect.width/2,this._highlightRect.height/2);this.__drawRoundedRect(this._highlightRect,"rgba(0, 255, 255, 0.25)",-1,n,this._viewportContext),this.__drawRoundedRect(this._highlightRect,"darkcyan",2,n,this._viewportContext)}this._viewportContext.restore();var r=[],i=[],s=this._parent;while(!(s instanceof wcPlay))r.unshift(s),i.unshift(s.type+(s.name?" ("+s.name+")":"")),s=s._parent;r.unshift(this._engine),i.unshift("Root"),this._viewportContext.fillStyle="black",this.__setCanvasFont(this._font.breadcrumbs,this._viewportContext),this._crumbBounds=[];var o=2;for(var u=0;u<i.length;++u){var a=this._viewportContext.measureText(i[u]).width,f=this._viewportContext.measureText(" / ").width,l={rect:{top:0,left:o,width:a+6,height:this._font.breadcrumbs.size+this._drawStyle.property.spacing},parent:r[u]};this._crumbBounds.push(l),o+=a+f,this._highlightCrumb===u&&(this.__drawRoundedRect(l.rect,"rgba(0, 255, 255, 0.25)",-1,3,this._viewportContext),this.__drawRoundedRect(l.rect,"darkcyan",2,3,this._viewportContext))}this._viewportContext.fillText(i.join(" / "),5,this._font.breadcrumbs.size)}window.requestAnimationFrame(this.__update.bind(this))},__updateNodes:function(e,t,n){for(var r=0;r<e.length;++r)this.__updateNode(e[r],t,n)},__updateNode:function(e,t,n){function i(e,n,i,s,o,u){e.flash?(e.flashDelta+=t*10,e.flashDelta>=1&&(e.flashDelta=1,!e.awake&&(!e.broken||!o&&!r._engine.paused())&&(e.flash=!1))):e.flashDelta>0&&(e.flashDelta-=t*5,e.flashDelta<=0&&(e.flashDelta=0,e.broken=o?e.broken:e.broken-1)),e.color=r.__blendColors(n,e.broken?s:i,e.flashDelta*u)}e.onDraw();var r=this,s=e.color;this._highlightNode===e&&(s=this.__blendColors(e.color,"#FFFFFF",.25)),i(e._meta,s,"#FFFFFF","#FFFFFF",!0,.5);var o="#000000",u="#117711",a="#FFFF00";for(var f=0;f<e.properties.length;++f)i(e.properties[f].inputMeta,u,a,a,!1,.9),i(e.properties[f].outputMeta,u,a,a,!1,.9);if(this._engine._queuedProperties.length===0){for(var f=0;f<e.chain.entry.length;++f)i(e.chain.entry[f].meta,o,a,a,!1,.9);for(var f=0;f<e.chain.exit.length;++f)i(e.chain.exit[f].meta,o,a,a,!1,.9)}if(e._meta.dirty){e._meta.dirty=!1,e._meta.bounds={node:e};var l=this.__measureEntryLinkOuter(e,n),c=this.__measureOuter(e,n,l.height),h=this.__measureExitLinkOuter(e,n,l.height+c.height),p=this.__expandRect([l,c,h]);p.top=c.top,p.height=c.height,p.propWidth=c.propWidth,p.valueWidth=c.valueWidth,p.initialWidth=c.initialWidth,e._meta.bounds.entryOuter=l,e._meta.bounds.exitOuter=h,e._meta.bounds.centerOuter=c,e._meta.bounds.rect=this.__expandRect([l,c,h]),e._meta.bounds.inner=this.__expandRect([c]),e._meta.bounds.inner.left=e._meta.bounds.rect.left,e._meta.bounds.inner.width=e._meta.bounds.rect.width,e._meta.bounds.rect.top-=3,e._meta.bounds.rect.left-=this._drawStyle.links.length+3,e._meta.bounds.rect.width+=this._drawStyle.links.length*2+6,e._meta.bounds.rect.height+=6,e.chain.entry.length?(e._meta.bounds.inner.top-=this._drawStyle.links.padding+this._font.links.size,e._meta.bounds.inner.height+=this._drawStyle.links.padding+this._font.links.size):(e._meta.bounds.rect.top-=this._drawStyle.links.length,e._meta.bounds.rect.height+=this._drawStyle.links.length),e.chain.exit.length?e._meta.bounds.inner.height+=this._drawStyle.links.padding+this._font.links.size:e._meta.bounds.rect.height+=this._drawStyle.links.length;var d=e._meta.bounds.inner.width-this._drawStyle.node.margin*2-p.propWidth;if(d>p.valueWidth+p.initialWidth){var v=(d-(p.valueWidth+p.initialWidth))/2;p.valueWidth+=v,p.initialWidth+=v}this.__measureCenter(e,n,p),this.__measureEntryLinks(e,n,l.width),this.__measureExitLinks(e,n,l.height+c.height,h.width),e._meta.bounds.farRect={top:e._meta.bounds.inner.top-30,left:e._meta.bounds.inner.left-30,width:e._meta.bounds.inner.width+60,height:e._meta.bounds.inner.height+60},e._meta.bounds.debugLog={left:e._meta.bounds.inner.left+4,top:e._meta.bounds.inner.top+4+(e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0),width:this._drawStyle.node.margin-5,height:this._font.title.size-4},e._meta.bounds.breakpoint={left:e._meta.bounds.inner.left+e._meta.bounds.inner.width-this._drawStyle.node.margin+2,top:e._meta.bounds.inner.top+4+(e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0),width:this._drawStyle.node.margin-5,height:this._font.title.size-4}}},__typeIndex:function(e){switch(e){case wcPlay.NODE.ENTRY:return 0;case wcPlay.NODE.PROCESS:return 1;case wcPlay.NODE.STORAGE:return 2;case wcPlay.NODE.COMPOSITE:return 3}},__setupMenu:function(){function e(e){wcPlayEditorClipboard.nodes=[];var t=[],n=[];for(var r=0;r<e._selectedNodes.length;++r){var i=e._selectedNodes[r],s=i.export();t.push(i._meta.bounds.farRect),n.push(i.pos),wcPlayEditorClipboard.nodes.push(s)}wcPlayEditorClipboard.bounds=e.__expandRect(t,n)}function u(){i&&(r=i.nodesBySearch(s),r.length>0&&(t._parent=r[o]._parent,t.focus([r[o]]),t._selectedNodes=r))}function a(){r.length&&(o-=1,o<0&&(o=r.length-1),t._parent=r[o]._parent,t.focus([r[o]]),t._selectedNodes=r)}function f(){r.length&&(o+=1,o>=r.length&&(o=0),t._parent=r[o]._parent,t.focus([r[o]]),t._selectedNodes=r)}this._menu=new wcMenu(this.$top,{outer:this.$main,manualUpdate:!0,data:this,version:"v1.0.0"}),this._menu.addOption("File","New Script...",{hotkeys:"Alt+N",icon:"fa fa-file-o fa-lg",description:"Start a new script...",toolbarIndex:-1,condition:function(e){return!e._options.readOnly},onActivated:function(e){e._engine&&(e._engine.clear(),e._undoManager&&e._undoManager.clear(),e._parent=e._engine)}}),this._menu.addOption("File","Open Script...",{hotkeys:"Ctrl+O",icon:"fa fa-folder-open-o fa-lg",description:"Open a script file...",toolbarIndex:-1,condition:function(e){return!e._options.readOnly},onActivated:function(e){if(e._engine&&document.createEvent){var t=document.createEvent("MouseEvents");t.initEvent("click",!0,!1),e.$container.prepend(e.$hiddenFileLoader),e.$hiddenFileLoader[0].dispatchEvent(t)}}}),this._menu.addOption("File","Save Script",{hotkeys:"Ctrl+S",icon:"fa fa-save fa-lg",description:"Save this script...",toolbarIndex:-1,condition:function(e){return!e._options.readOnly},onActivated:function(e){if(e._engine){if(!saveAs){console.log("ERROR: Attempted to save the script when external dependency 'FileSaver' was not included.");return}var t=e._engine.save(),n;try{n=new Blob([t],{type:"text/plain"})}catch(r){var i=new BlobBuilder;i.append(t),n=i.getBlob("text/plain")}saveAs(n,"script.wcplay")}}}),this._menu.addOption("File","Import...",{icon:"fa fa-plus-square-o fa-lg",description:"Import a script file as a Composite Node.",toolbarIndex:-1,condition:function(e){return!e._options.readOnly},onActivated:function(e){if(e._engine&&document.createEvent){var t=document.createEvent("MouseEvents");t.initEvent("click",!0,!1),e.$container.prepend(e.$hiddenFileImporter),e.$hiddenFileImporter[0].dispatchEvent(t)}}}),this._menu.addOption("Edit","Undo",{hotkeys:"Ctrl+Z",icon:"fa fa-undo fa-lg",toolbarIndex:-1,description:function(e){return"Undo "+(e._undoManager&&e._undoManager.undoInfo()||"Event")},condition:function(e){return e._undoManager&&e._undoManager.canUndo()},onActivated:function(e){e._undoManager&&e._undoManager.undo()}}),this._menu.addOption("Edit","Redo",{hotkeys:"Ctrl+Y,Ctrl+Shift+Z",icon:"fa fa-undo fa-flip-horizontal fa-lg",toolbarIndex:-1,description:function(e){return"Redo "+(e._undoManager&&e._undoManager.redoInfo()||"Event")},condition:function(e){return e._undoManager&&e._undoManager.canRedo()},onActivated:function(e){e._undoManager&&e._undoManager.redo()}}),this._menu.addOption("Edit","Cut",{hotkeys:"Ctrl+X",icon:"fa fa-cut fa-lg",toolbarIndex:-1,description:"Cut selected node(s) out of your script and into the clipboard.",condition:function(e){return e._selectedNodes.length>0},onActivated:function(t){e(t,t._engine),t._undoManager&&t._undoManager.beginGroup("Cut Nodes to clipboard");for(var n=0;n<t._selectedNodes.length;++n)t.__onDestroyNode(t._selectedNodes[n]),t._selectedNodes[n].destroy();t._selectedNodes=[],t._undoManager&&t._undoManager.endGroup()}}),this._menu.addOption("Edit","Copy",{hotkeys:"Ctrl+C",icon:"fa fa-copy fa-lg",toolbarIndex:-1,description:"Copy selected node(s) to your clipboard.",condition:function(e){return e._selectedNodes.length>0},onActivated:e}),this._menu.addOption("Edit","Paste",{hotkeys:"Ctrl+V",icon:"fa fa-paste fa-lg",toolbarIndex:-1,description:"Paste node(s) in clipboard into your script.",condition:function(e){return wcPlayEditorClipboard.nodes.length>0},onActivated:function(e){var t={x:e._mouse.x,y:e._mouse.y};e._mouseInViewport||(t.x=e.$viewport.width()/2,t.y=e.$viewport.height()/2),e._selectedNode=null,e._selectedNodes=[];var n=[],r=[];e._undoManager&&e._undoManager.beginGroup("Paste Nodes from clipboard");var i=wcPlayEditorClipboard.bounds;for(var s=0;s<wcPlayEditorClipboard.nodes.length;++s){var o=wcPlayEditorClipboard.nodes[s],u=new window[o.className](e._parent,o.pos);n[o.id]=u.id,r.push(u)}for(var s=0;s<wcPlayEditorClipboard.nodes.length;++s){var o=wcPlayEditorClipboard.nodes[s],u=r[s];e._selectedNodes.push(u),e._selectedNode||(e._selectedNode=u),u.import(o,n),u.pos.x=(t.x-e._viewportCamera.x)/e._viewportCamera.z-i.width/2+(o.pos.x-i.left),u.pos.y=(t.y-e._viewportCamera.y)/e._viewportCamera.z-i.height/2+(o.pos.y-i.top),e.__onCreateNode(u)}e._undoManager&&e._undoManager.endGroup()}}),this._menu.addOption("Edit","Delete",{hotkeys:"Delete",icon:"fa fa-trash fa-lg",toolbarIndex:-1,description:"Delete selected node(s).",condition:function(e){return e._selectedNodes.length>0},onActivated:function(e){if(e._selectedNodes.length){e._undoManager&&e._undoManager.beginGroup("Removed Nodes");for(var t=0;t<e._selectedNodes.length;++t)e.__onDestroyNode(e._selectedNodes[t]),e._selectedNodes[t].destroy();e._selectedNode=null,e._selectedNodes=[],e._undoManager&&e._undoManager.endGroup()}}}),this._menu.addOption("Edit","Create Composite",{hotkeys:"C",icon:"fa fa-suitcase fa-lg",toolbarIndex:-1,description:"Combine all selected nodes into a new 'Composite' Node.",condition:function(e){return e._selectedNodes.length>0},onActivated:function(e){if(e._selectedNodes.length&&e._parent){e._undoManager&&e._undoManager.beginGroup("Combined Nodes into Composite");for(var t=0;t<e._selectedNodes.length;++t)e.__onDestroyNode(e._selectedNodes[t]),e._selectedNodes[t].id=++window.wcNodeNextID;var n=new wcNodeCompositeScript(e._parent,{x:0,y:0},e._selectedNodes),r=[],i=[];for(var t=0;t<e._selectedNodes.length;++t){var s=e._selectedNodes[t];r.push(s._meta.bounds.farRect),i.push(s.pos)}var o=e.__expandRect(r,i),u=[];for(var t=0;t<e._selectedNodes.length;++t){var s=e._selectedNodes[t];e._parent.__removeNode(s);var a=s.listEntryChains(undefined,e._selectedNodes),f=s.listExitChains(undefined,e._selectedNodes),l=s.listInputChains(undefined,e._selectedNodes),c=s.listOutputChains(undefined,e._selectedNodes),h=[];for(var p=0;p<a.length;++p){var d=e._engine.nodeById(a[p].outNodeId),v=a[p].outName,s=e._engine.nodeById(a[p].inNodeId),m=a[p].inName,g=null;for(var y=0;y<h.length;++y)if(h[y].name===m){g=h[y].node;break}g||(g=new wcNodeCompositeEntry(n,{x:s.pos.x,y:o.top-100},m),g.collapsed(!0),h.push({name:m,node:g})),g.connectExit("out",s,m),n.connectEntry(g.name,d,v),d.disconnectExit(v,s,m)}h=[];for(var p=0;p<f.length;++p){var d=e._engine.nodeById(f[p].inNodeId),v=f[p].inName,s=e._engine.nodeById(f[p].outNodeId),m=f[p].outName,g=null;for(var y=0;y<h.length;++y)if(h[y].name===m){g=h[y].node;break}g||(g=new wcNodeCompositeExit(n,{x:s.pos.x,y:o.top+o.height+50},m),g.collapsed(!0),h.push({name:m,node:g})),g.connectEntry("in",s,m),n.connectExit(g.name,d,v),d.disconnectEntry(v,s,m)}h=[];for(var p=0;p<l.length;++p){var d=e._engine.nodeById(l[p].outNodeId),v=l[p].outName,s=e._engine.nodeById(l[p].inNodeId),m=l[p].inName,g=null;for(var y=0;y<h.length;++y)if(h[y].name===m){g=h[y].node;break}g||(g=new wcNodeCompositeProperty(n,{x:o.left-200,y:s.pos.y},m),g.collapsed(!0),h.push({name:m,node:g})),g.connectOutput("value",s,m),n.connectInput(g.name,d,v),d.disconnectOutput(v,s,m)}h=[];for(var p=0;p<c.length;++p){var d=e._engine.nodeById(c[p].inNodeId),v=c[p].inName,s=e._engine.nodeById(c[p].outNodeId),m=c[p].outName,g=null;for(var y=0;y<h.length;++y)if(h[y].name===m){g=h[y].node;break}g||(g=new wcNodeCompositeProperty(n,{x:o.left+o.width+200,y:s.pos.y},m),g.collapsed(!0),h.push({name:m,node:g})),g.connectInput("value",s,m),n.connectOutput(g.name,d,v),d.disconnectInput(v,s,m)}}e._selectedNode=null,e._selectedNodes=[],n.pos.x=o.left+o.width/2,n.pos.y=o.top+o.height/2,e.__onCreateNode(n),e._undoManager&&e._undoManager.endGroup(),e.__setupPalette()}}}),this._menu.addOption("Debugging","Toggle Debug Mode",{icon:function(e){return e._engine&&e._engine.debugging()?"fa fa-dot-circle-o fa-lg":"fa fa-circle-o fa-lg"},toolbarIndex:-1,description:"Toggle debugging mode for the entire script.",onActivated:function(e){e._engine&&(e._engine.debugging(!e._engine.debugging()),e._engine.paused(!1))}}),this._menu.addOption("Debugging","Toggle Silence Mode",{icon:function(e){return e._engine&&e._engine.silent()?"fa fa-volume-off fa-lg":"fa fa-volume-up fa-lg"},toolbarIndex:-1,description:"Toggle silent mode for the entire script.",onActivated:function(e){e._engine&&e._engine.silent(!e._engine.silent())}}),this._menu.addOption("Debugging","Start Script",{hotkeys:"Shift+Enter",icon:function(e){return e._engine&&e._engine.isRunning()?"fa fa-stop fa-lg":"fa fa-play fa-lg"},toolbarIndex:-1,display:function(e){return e._engine&&e._engine.isRunning()?"Stop Script":"Start Script"},description:"Starts or Stops execution of the script.",condition:function(e){return!e._options.readOnly&&e._options.playable},onActivated:function(e){e._engine&&(e._engine.isRunning()?e._engine.stop():e._engine.start())}}),this._menu.addOption("Debugging","Pause Script",{hotkeys:"Return",icon:"fa fa-pause fa-lg",toggle:function(e){return e._engine&&e._engine.paused()},display:function(e){return e._engine&&e._engine.paused()?"Resume Script":"Pause Script"},toolbarIndex:-1,description:"Pause or Continue the script.",condition:function(e){return!e._options.readOnly&&e._engine&&e._engine.isRunning()},onActivated:function(e){e._engine&&(e._engine.paused()||e._engine.stepping()?(e._engine.paused(!1),e._engine.stepping(!1)):e._engine.stepping(!0))}}),this._menu.addOption("Debugging","Step Script",{hotkeys:"Spacebar",icon:"fa fa-fast-forward fa-lg",toolbarIndex:-1,description:"Perform a single script update.",condition:function(e){return!e._options.readOnly&&e._engine&&e._engine.isRunning()},onActivated:function(e){e._engine&&(e._engine.paused(!1),e._engine.stepping(!0))}}),this._menu.addOption("View","Fit in View",{hotkeys:"F",icon:"fa fa-crosshairs fa-lg",categoryIndex:2,toolbarIndex:-1,description:"Center view on selected node(s).",onActivated:function(e){e._selectedNodes.length?e.focus(e._selectedNodes):e.center()}}),this._menu.addOption("View","Exit Composite",{hotkeys:"O",icon:"fa fa-level-up fa-lg",toolbarIndex:-1,description:"Step out of this Composite Node.",condition:function(e){return e._parent instanceof wcNodeCompositeScript},onActivated:function(e){var t=e._parent;e._parent=e._parent._parent,e._selectedNode=t,e._selectedNodes=[t],e.focus(e._selectedNodes)}}),this._menu.addOption("View","Enter Composite",{hotkeys:"I",icon:"fa fa-level-down fa-lg",toolbarIndex:-1,description:"Step in to this Composite Node.",condition:function(e){return e._selectedNodes.length===1&&e._selectedNodes[0]instanceof wcNodeCompositeScript},onActivated:function(e){e._parent=e._selectedNodes[0],e._selectedNode=null,e._selectedNodes=[],e.center()}}),this._menu.addOption("View","Chain Style",{hotkeys:"V",icon:"fa fa-sitemap fa-lg",toolbarIndex:-1,description:"Toggle the visual style of the chains.",onActivated:function(e){e._chainStyle+=1,e._chainStyle>e._chainStyleMax&&(e._chainStyle=0)}});var t=this,n=this.$search.children("input"),r=[],i=null,s="",o=0;this.$search.children(".wcPlayEditorSearchPrev").click(a),this.$search.children(".wcPlayEditorSearchNext").click(f),this.$search.keydown(function(e){if(e.keyCode===27)t.$search.hasClass("wcPlayHidden")||t.$search.addClass("wcPlayHidden");else{if(e.keyCode===13||e.keyCode===40||e.keyCode===9)return f(),e.stopPropagation(),e.preventDefault(),!0;if(e.keyCode===38)return a(),e.stopPropagation(),e.preventDefault(),!0}}),this.$search.keyup(function(e){var r=n.val().toLowerCase();s!==r&&(o=0,i=t._parent,s=r,u())}),this._menu.addOption("View","Search...",{hotkeys:"Ctrl+F",icon:"fa fa-search fa-lg",toolbarIndex:-1,description:"Toggle the visual style of the chains.",onActivated:function(e){e.$search.removeClass("wcPlayHidden"),n.focus(),n.select(),r.length&&u()}}),this._menu.addOption("Help","Documentation...",{icon:"fa fa-file-pdf-o fa-lg",description:"Open the documentation for wcPlay in another window.",onActivated:function(e){window.open("http://play.api.webcabin.org/","_blank")}}),this._menu.addSpacer("File","Save Script"),this._menu.addSpacer("Edit","Redo"),this._menu.addSpacer("Edit","Delete"),this._menu.addSpacer("View","Enter Composite"),this._menu.addSpacer("View","Chain Style"),this._menu.addSpacer("Debugging","Toggle Silence Mode"),this._menu.addToolbarSpacer("File","Save Script"),this._menu.addToolbarSpacer("Edit","Redo"),this._menu.addToolbarSpacer("Edit","Delete"),this._menu.addToolbarSpacer("Edit","Create Composite"),this._menu.addToolbarSpacer("View","Enter Composite"),this._menu.addToolbarSpacer("View","Chain Style"),this._menu.addToolbarSpacer("Debugging","Toggle Silence Mode"),this._menu.addToolbarSpacer("Debugging","Step Script")},__setupPalette:function(){function i(e){this._nodeLibrary.hasOwnProperty(e.category)||(this._nodeLibrary[e.category]={});if(!this._nodeLibrary[e.category].hasOwnProperty(e.nodeType)){var t={$category:$('<div class="wcPlayTypeCategory">'),$button:$('<button class="wcPlayCategoryButton" title="Toggle visibility of this category.">'+e.category+"</button>"),$canvas:$('<canvas class="wcPlayTypeCategoryArea">'),context:null,nodes:[]};t.context=t.$canvas[0].getContext("2d"),t.$category.append(t.$button),t.$category.append(t.$canvas),this.$typeArea[this.__typeIndex(e.nodeType)].append(t.$category),function(t){t.$button.click(function(){t.$button.hasClass("wcToggled")?(t.$button.removeClass("wcToggled"),t.$canvas.removeClass("wcPlayHidden")):(t.$button.addClass("wcToggled"),t.$canvas.addClass("wcPlayHidden"))})}(t),this._nodeLibrary[e.category][e.nodeType]=t}}if(!this._engine)return;this._paletteSize=this._options.readOnly?0:300,this.onResized(),this.$typeButton.length==0&&(this.$typeButton.push($('<button class="wcPlayEditorButton" title="Show Entry Nodes.">Entry</button>')),this.$typeButton.push($('<button class="wcPlayEditorButton wcToggled" title="Show Process Nodes.">Process</button>')),this.$typeButton.push($('<button class="wcPlayEditorButton" title="Show Storage Nodes.">Storage</button>')),this.$typeButton.push($('<button class="wcPlayEditorButton" title="Show Composite Nodes.">Composite</button>')),this.$palette.append(this.$typeButton[0]),this.$palette.append(this.$typeButton[1]),this.$palette.append(this.$typeButton[2]),this.$palette.append(this.$typeButton[3]),this.$typeArea.push($('<div class="wcPlayTypeArea wcPlayHidden">')),this.$typeArea.push($('<div class="wcPlayTypeArea">')),this.$typeArea.push($('<div class="wcPlayTypeArea wcPlayHidden">')),this.$typeArea.push($('<div class="wcPlayTypeArea wcPlayHidden">')),this.$paletteInner.append(this.$typeArea[0]),this.$paletteInner.append(this.$typeArea[1]),this.$paletteInner.append(this.$typeArea[2]),this.$paletteInner.append(this.$typeArea[3]));if(this._nodeLibrary){for(var e in this._nodeLibrary)for(var t in this._nodeLibrary[e]){var n=this._nodeLibrary[e][t];n.$button.remove(),n.$canvas.remove(),n.$category.remove();for(var r=0;r<n.nodes.length;++r)n.nodes[r].destroy()}this._nodeLibrary={}}for(var r=0;r<wcPlay.NODE_LIBRARY.length;++r){var s=wcPlay.NODE_LIBRARY[r];if(s.nodeType!==wcPlay.NODE.COMPOSITE){var o=this._options.category.items.indexOf(s.category);if(!this._options.category.isBlacklist&&o===-1||this._options.category.isBlacklist&&o>-1)continue}else if(s.className==="wcNodeCompositeScript")continue;i.call(this,s);var u=new window[s.className](null);u.collapsed(!1),this._nodeLibrary[s.category][s.nodeType].nodes.push(u)}var a=this._engine.importedComposites();for(var r=0;r<a.length;++r){var u=a[r];i.call(this,u),this._nodeLibrary[u.category][u.nodeType].nodes.push(u)}for(var e in this._nodeLibrary)for(var t in this._nodeLibrary[e]){var n=this._nodeLibrary[e][t];n.$canvas.attr("width",this.$paletteInner.width());var f=this._drawStyle.palette.spacing,l=this.$paletteInner.width()/2;for(var r=0;r<n.nodes.length;++r)this.__updateNode(n.nodes[r],0,n.context),n.nodes[r].pos.x=l,n.nodes[r].pos.y=f,this.__drawNode(n.nodes[r],n.context,!0),f+=n.nodes[r]._meta.bounds.rect.height+this._drawStyle.palette.spacing;n.$canvas.attr("height",f)}var c=this;this.$typeButton[0].click(function(){c.$typeButton[0].addClass("wcToggled"),c.$typeButton[1].removeClass("wcToggled"),c.$typeButton[2].removeClass("wcToggled"),c.$typeButton[3].removeClass("wcToggled"),c.$typeArea[0].removeClass("wcPlayHidden"),c.$typeArea[1].addClass("wcPlayHidden"),c.$typeArea[2].addClass("wcPlayHidden"),c.$typeArea[3].addClass("wcPlayHidden")}),this.$typeButton[1].click(function(){c.$typeButton[0].removeClass("wcToggled"),c.$typeButton[1].addClass("wcToggled"),c.$typeButton[2].removeClass("wcToggled"),c.$typeButton[3].removeClass("wcToggled"),c.$typeArea[0].addClass("wcPlayHidden"),c.$typeArea[1].removeClass("wcPlayHidden"),c.$typeArea[2].addClass("wcPlayHidden"),c.$typeArea[3].addClass("wcPlayHidden")}),this.$typeButton[2].click(function(){c.$typeButton[0].removeClass("wcToggled"),c.$typeButton[1].removeClass("wcToggled"),c.$typeButton[2].addClass("wcToggled"),c.$typeButton[3].removeClass("wcToggled"),c.$typeArea[0].addClass("wcPlayHidden"),c.$typeArea[1].addClass("wcPlayHidden"),c.$typeArea[2].removeClass("wcPlayHidden"),c.$typeArea[3].addClass("wcPlayHidden")}),this.$typeButton[3].click(function(){c.$typeButton[0].removeClass("wcToggled"),c.$typeButton[1].removeClass("wcToggled"),c.$typeButton[2].removeClass("wcToggled"),c.$typeButton[3].addClass("wcToggled"),c.$typeArea[0].addClass("wcPlayHidden"),c.$typeArea[1].addClass("wcPlayHidden"),c.$typeArea[2].addClass("wcPlayHidden"),c.$typeArea[3].removeClass("wcPlayHidden")})},__drawPalette:function(e){for(var t in this._nodeLibrary)for(var n in this._nodeLibrary[t]){if(!this.$typeButton[this.__typeIndex(n)].hasClass("wcToggled"))continue;var r=this._nodeLibrary[t][n];if(r.$button.hasClass("wcToggled"))continue;var i=this._drawStyle.palette.spacing,s=this.$paletteInner.width()/2;r.$canvas.attr("width",this.$paletteInner.width()),r.context.clearRect(0,0,r.$canvas.width(),r.$canvas.height()),r.context.save();for(var o=0;o<r.nodes.length;++o)this.__updateNode(r.nodes[o],0,r.context),r.nodes[o].pos.x=s,r.nodes[o].pos.y=i,this.__drawNode(r.nodes[o],r.context,!0),i+=r.nodes[o]._meta.bounds.rect.height+this._drawStyle.palette.spacing;r.context.restore()}},__drawNodes:function(e,t,n){for(var r=0;r<e.length;++r)this.__drawNode(e[r],t,n)},__drawNode:function(e,t,n){if(!n&&!this.__rectOnRect(e._meta.bounds.farRect,this._viewportBounds,e.pos)){e._meta.visible=!1;return}e._meta.visible=!0,this._selectedNodes.indexOf(e)>-1&&(this.__drawRoundedRect(e._meta.bounds.rect,"rgba(0, 255, 255, 0.25)",-1,10,t,e.pos),this.__drawRoundedRect(e._meta.bounds.rect,"darkcyan",2,10,t,e.pos)),this.__drawCenter(e,t,n),this.__drawEntryLinks(e,t,e._meta.bounds.entryOuter.width),this.__drawExitLinks(e,t,e._meta.bounds.entryOuter.height+e._meta.bounds.centerOuter.height,e._meta.bounds.exitOuter.width),t.save(),t.fillStyle=this._highlightDebugLog&&this._highlightNode===e?"black":"white",t.strokeStyle="black",t.lineWidth=1,t.fillRect(e.pos.x+e._meta.bounds.debugLog.left,e.pos.y+e._meta.bounds.debugLog.top,e._meta.bounds.debugLog.width,e._meta.bounds.debugLog.height),t.strokeRect(e.pos.x+e._meta.bounds.debugLog.left,e.pos.y+e._meta.bounds.debugLog.top,e._meta.bounds.debugLog.width,e._meta.bounds.debugLog.height),t.strokeStyle=e._log?"red":this._highlightDebugLog&&this._highlightNode===e?"white":"black",t.lineWidth=2,t.beginPath(),t.moveTo(e.pos.x+e._meta.bounds.debugLog.left+1,e.pos.y+e._meta.bounds.debugLog.top+1),t.lineTo(e.pos.x+e._meta.bounds.debugLog.left+e._meta.bounds.debugLog.width/2,e.pos.y+e._meta.bounds.debugLog.top+e._meta.bounds.debugLog.height/2),t.lineTo(e.pos.x+e._meta.bounds.debugLog.left+1,e.pos.y+e._meta.bounds.debugLog.top+e._meta.bounds.debugLog.height-1),t.moveTo(e.pos.x+e._meta.bounds.debugLog.left+e._meta.bounds.debugLog.width/2,e.pos.y+e._meta.bounds.debugLog.top+e._meta.bounds.debugLog.height-2),t.lineTo(e.pos.x+e._meta.bounds.debugLog.left+e._meta.bounds.debugLog.width,e.pos.y+e._meta.bounds.debugLog.top+e._meta.bounds.debugLog.height-2),t.stroke(),t.restore(),t.save(),t.fillStyle=this._highlightBreakpoint&&this._highlightNode===e?"black":"white",t.fillRect(e.pos.x+e._meta.bounds.breakpoint.left,e.pos.y+e._meta.bounds.breakpoint.top,e._meta.bounds.breakpoint.width,e._meta.bounds.breakpoint.height),t.strokeStyle=e._break?"red":this._highlightBreakpoint&&this._highlightNode===e?"white":"black",t.fillStyle="red",t.lineWidth=2,t.beginPath(),t.arc(e.pos.x+e._meta.bounds.breakpoint.left+e._meta.bounds.breakpoint.width/2,e.pos.y+e._meta.bounds.breakpoint.top+e._meta.bounds.breakpoint.height/2,Math.min(e._meta.bounds.breakpoint.width/2-2,e._meta.bounds.breakpoint.height/2-2),0,2*Math.PI),e._break&&t.fill(),t.stroke(),t.strokeStyle="black",t.lineWidth=1,t.strokeRect(e.pos.x+e._meta.bounds.breakpoint.left,e.pos.y+e._meta.bounds.breakpoint.top,e._meta.bounds.breakpoint.width,e._meta.bounds.breakpoint.height),t.restore(),e.isBroken()?this.__drawRoundedRect(e._meta.bounds.inner,"#CC0000",5,this._drawStyle.node.radius,t,e.pos):e._meta.flashDelta&&this.__drawRoundedRect(e._meta.bounds.inner,"yellow",2,this._drawStyle.node.radius,t,e.pos)},__measureEntryLinkOuter:function(e,t){var n={top:0,left:0,width:0,height:0};this.__setCanvasFont(this._font.links,t);var r=e.chain.entry;for(var i=0;i<r.length;++i)n.width+=t.measureText(r[i].name).width+this._drawStyle.links.spacing;return n.left-=n.width/2+this._drawStyle.links.margin,n.width+=this._drawStyle.links.margin*2,e.chain.entry.length&&(n.height=this._font.links.size+this._drawStyle.links.padding+this._drawStyle.links.length),n},__measureExitLinkOuter:function(e,t,n){var r={top:n,left:0,width:0,height:0};this.__setCanvasFont(this._font.links,t);var i=e.chain.exit;for(var s=0;s<i.length;++s)r.width+=t.measureText(i[s].name).width+this._drawStyle.links.spacing;return r.left-=r.width/2+this._drawStyle.links.margin,r.width+=this._drawStyle.links.margin*2,e.chain.exit.length&&(r.height=this._font.links.size+this._drawStyle.links.padding+this._drawStyle.links.length),r},__measureOuter:function(e,t,n){var r={top:n,left:0,width:0,height:this._font.title.size+this._drawStyle.title.spacing+this._drawStyle.links.padding};this.__setCanvasFont(this._font.title,t),r.width=t.measureText(this._drawStyle.title.wrapL+e.type+": "+this._drawStyle.title.wrapR).width,this.__setCanvasFont(this._font.titleDesc,t),r.width+=t.measureText(this._drawStyle.title.nameWrapL+(e.name||this._drawStyle.title.placeholder)+this._drawStyle.title.nameWrapR).width;if(e.description()||e.details())this.__setCanvasFont(this._font.details,t),r.width+=t.measureText(this._drawStyle.title.details).width;e._viewportSize&&(r.width=Math.max(r.width,e._viewportSize.x),r.height+=e._viewportSize.y+this._drawStyle.property.spacing);var i=0,s=0,o=0,u=e.collapsed(),a=e.properties;for(var f=0;f<a.length;++f)r.height+=this._font.property.size+this._drawStyle.property.spacing,this.__setCanvasFont(this._font.property,t),i=Math.max(t.measureText(a[f].name+": ").width,i),this.__setCanvasFont(this._font.value,t),s=Math.max(t.measureText(this._drawStyle.property.valueWrapL+this.__drawPropertyValue(e,a[f])+this._drawStyle.property.valueWrapR).width,this._drawStyle.property.minLength,s),this.__setCanvasFont(this._font.initialValue,t),o=Math.max(t.measureText(this._drawStyle.property.initialWrapL+this.__drawPropertyValue(e,a[f],!0)+this._drawStyle.property.initialWrapR).width,this._drawStyle.property.minLength,o);return r.width=Math.max(i+s+o,r.width)+this._drawStyle.node.margin*2,r.left-=r.width/2,r.propWidth=i,r.valueWidth=s,r.initialWidth=o,r},__measureCenter:function(e,t,n){var r=e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0,i=e.chain.exit.length?this._font.links.size+this._drawStyle.links.padding:0;e._meta.bounds.center=n,e._meta.bounds.inputBounds=[],e._meta.bounds.outputBounds=[],e._meta.bounds.propertyBounds=[],e._meta.bounds.valueBounds=[],e._meta.bounds.initialBounds=[],t.save(),this.__setCanvasFont(this._font.title,t);var s=t.measureText(this._drawStyle.title.wrapL+e.type+": ").width,o=t.measureText(this._drawStyle.title.wrapR).width;this.__setCanvasFont(this._font.titleDesc,t);var u=t.measureText(this._drawStyle.title.nameWrapL+(e.name||this._drawStyle.title.placeholder)+this._drawStyle.title.nameWrapR).width,a=0;if(e.description()||e.details())this.__setCanvasFont(this._font.details,t),a=t.measureText(this._drawStyle.title.details).width;e._meta.bounds.titleBounds={top:n.top,left:n.left+s+(n.width-(s+o+u+a))/2,width:u,height:this._font.title.size+this._drawStyle.title.spacing-1,typeWidth:s,wrapRWidth:o,textWidth:u},e._meta.bounds.detailsBounds={top:n.top,left:n.left+n.width-this._drawStyle.node.margin-a,width:a,height:this._font.details.size+this._drawStyle.title.spacing-1},r=this._font.title.size,r+=this._drawStyle.title.spacing,e._viewportSize&&(e._meta.bounds.viewportBounds={top:n.top+r,left:n.left+(n.width/2-e._viewportSize.x/2),width:e._viewportSize.x,height:e._viewportSize.y},r+=e._viewportSize.y+this._drawStyle.property.spacing);var f,l=e.collapsed(),c=e.properties;for(var h=0;h<c.length;++h){r+=this._font.property.size;if(!l||!c[h].options.collapsible||c[h].inputs.length||c[h].outputs.length){var p={rect:{top:n.top+r-this._font.property.size,left:n.left+this._drawStyle.node.margin,width:n.width-this._drawStyle.node.margin*2,height:this._font.property.size+this._drawStyle.property.spacing},name:c[h].name};e._meta.bounds.propertyBounds.push(p);var d={rect:{top:n.top+r-this._font.property.size,left:n.left+n.width-this._drawStyle.node.margin-n.initialWidth,width:n.initialWidth,height:this._font.property.size+this._drawStyle.property.spacing},name:c[h].name};e._meta.bounds.initialBounds.push(d);var v={rect:{top:n.top+r-this._font.property.size,left:n.left+n.width-this._drawStyle.node.margin-n.valueWidth-n.initialWidth,width:this._engine.isRunning()?n.valueWidth:0,height:this._font.property.size+this._drawStyle.property.spacing},name:c[h].name};e._meta.bounds.valueBounds.push(v);if(!l||c[h].inputs.length)f={top:n.top+r-this._font.property.size/3-this._drawStyle.links.width/2,left:n.left-this._drawStyle.links.length,width:this._drawStyle.links.length,height:this._drawStyle.links.width},f.top-=5,f.height+=10,e._meta.bounds.inputBounds.push({rect:f,point:{x:f.left+f.width/3-2,y:f.top+f.height/2},name:c[h].name});if(!l||c[h].outputs.length)f={top:n.top+r-this._font.property.size/3-this._drawStyle.links.width/2,left:n.left+n.width,width:this._drawStyle.links.length,height:this._drawStyle.links.width},f.top-=5,f.height+=10,e._meta.bounds.outputBounds.push({rect:f,point:{x:f.left+f.width+1,y:f.top+f.height/2},name:c[h].name});r+=this._drawStyle.property.spacing}}t.restore()},__measureEntryLinks:function(e,t,n){e._meta.bounds.entryBounds=[];var r=-n/2+this._drawStyle.links.margin,i=this._drawStyle.links.length+this._font.links.size;t.save(),this.__setCanvasFont(this._font.links,t);var s=e.collapsed(),o=e.chain.entry;for(var u=0;u<o.length;++u){var a=t.measureText(o[u].name).width+this._drawStyle.links.spacing,f={top:i-this._drawStyle.links.length-this._font.links.size,left:r+a/2-this._drawStyle.links.width/2,width:this._drawStyle.links.width,height:this._drawStyle.links.length};f.left-=5,f.width+=10,e._meta.bounds.entryBounds.push({rect:f,point:{x:f.left+f.width/2,y:f.top+f.height/3-2},name:o[u].name}),r+=a}t.restore()},__measureExitLinks:function(e,t,n,r){e._meta.bounds.exitBounds=[];var i=-r/2+this._drawStyle.links.margin,s=n+this._font.links.size;t.save(),this.__setCanvasFont(this._font.links,t);var o=e.collapsed(),u=e.chain.exit;for(var a=0;a<u.length;++a){var f=t.measureText(u[a].name).width+this._drawStyle.links.spacing,l={top:s+this._drawStyle.links.padding,left:i+f/2-this._drawStyle.links.width/2,width:this._drawStyle.links.width,height:this._drawStyle.links.length};l.left-=5,l.width+=10,e._meta.bounds.exitBounds.push({rect:l,point:{x:l.left+l.width/2,y:l.top+l.height+1},name:u[a].name}),i+=f}t.restore()},__drawCenter:function(e,t,n){var r=e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0,i=e.chain.exit.length?this._font.links.size+this._drawStyle.links.padding:0;t.save();var s=e.pos.x+e._meta.bounds.center.left+e._meta.bounds.center.width/2,o=e.pos.y+e._meta.bounds.center.top+e._meta.bounds.center.height/2,u=t.createRadialGradient(s,o,10,s,o,Math.max(e._meta.bounds.center.width,e._meta.bounds.center.height));u.addColorStop(0,e.enabled()?e._meta.color:"#555"),u.addColorStop(1,"white"),t.fillStyle=t.strokeStyle=u,t.lineJoin="round";var a=this._drawStyle.node.radius*2;t.lineWidth=a,t.fillRect(e.pos.x+e._meta.bounds.center.left+a/2,e.pos.y+e._meta.bounds.center.top-r+a/2,e._meta.bounds.center.width-a,e._meta.bounds.center.height+r+i-a),t.strokeRect(e.pos.x+e._meta.bounds.center.left+a/2,e.pos.y+e._meta.bounds.center.top-r+a/2,e._meta.bounds.center.width-a,e._meta.bounds.center.height+r+i-a),t.restore(),this.__drawRoundedRect({left:e._meta.bounds.center.left,top:e._meta.bounds.center.top-r,width:e._meta.bounds.center.width,height:e._meta.bounds.center.height+r+i},e._meta.color,3,this._drawStyle.node.radius,t,e.pos),r=0,e.chain.entry.length&&(t.strokeStyle=e._meta.color,t.beginPath(),t.moveTo(e.pos.x+e._meta.bounds.center.left,e.pos.y+e._meta.bounds.center.top+r),t.lineTo(e.pos.x+e._meta.bounds.center.left+e._meta.bounds.center.width,e.pos.y+e._meta.bounds.center.top+r),t.stroke()),this._options.readOnly||(this._highlightTitle&&this._highlightNode===e?this.__drawRoundedRect(e._meta.bounds.titleBounds,this._drawStyle.property.highlightColor,this._drawStyle.property.highlightBorder,this._font.title.size/2,t,e.pos):!n&&this._highlightNode===e&&this.__drawRoundedRect(e._meta.bounds.titleBounds,this._drawStyle.property.normalColor,this._drawStyle.property.normalBorder,this._font.title.size/2,t,e.pos)),!this._options.readOnly&&e._meta.bounds.detailsBounds.width>0&&(this._highlightDetails&&this._highlightNode===e?this.__drawRoundedRect(e._meta.bounds.detailsBounds,this._drawStyle.property.highlightColor,this._drawStyle.property.highlightBorder,this._font.title.size/2,t,e.pos):!n&&this._highlightNode===e&&this.__drawRoundedRect(e._meta.bounds.detailsBounds,this._drawStyle.property.normalColor,this._drawStyle.property.normalBorder,this._font.title.size/2,t,e.pos)),t.save(),r+=this._font.title.size,t.fillStyle="black",t.strokeStyle="black",t.textAlign="left",this.__setCanvasFont(this._font.title,t),t.fillText(this._drawStyle.title.wrapL+e.type+": ",e.pos.x+e._meta.bounds.titleBounds.left-e._meta.bounds.titleBounds.typeWidth,e.pos.y+e._meta.bounds.titleBounds.top+r),this.__setCanvasFont(this._font.titleDesc,t),t.fillText(this._drawStyle.title.nameWrapL+(e.name||this._drawStyle.title.placeholder)+this._drawStyle.title.nameWrapR,e.pos.x+e._meta.bounds.titleBounds.left,e.pos.y+e._meta.bounds.titleBounds.top+r),t.textAlign="right",this.__setCanvasFont(this._font.title,t),t.fillText(this._drawStyle.title.wrapR,e.pos.x+e._meta.bounds.titleBounds.left,e.pos.y+e._meta.bounds.titleBounds.top+r);if(e.description()||e.details())this.__setCanvasFont(this._font.details,t),t.fillText(this._drawStyle.title.details,e.pos.x+e._meta.bounds.detailsBounds.left+e._meta.bounds.detailsBounds.width,e.pos.y+e._meta.bounds.detailsBounds.top+this._font.details.size);t.restore(),r+=this._drawStyle.title.spacing,e._meta.bounds.viewportBounds&&(t.save(),t.translate(e.pos.x+e._meta.bounds.viewportBounds.left,e.pos.y+e._meta.bounds.viewportBounds.top),e.onViewportDraw(t,this._options.readOnly),t.translate(-e.pos.x-e._meta.bounds.viewportBounds.left,-e.pos.y-e._meta.bounds.viewportBounds.top),t.restore(),r+=e._viewportSize.y+this._drawStyle.property.spacing),t.save();var f=e.collapsed(),l=e.properties;for(var c=0;c<l.length;++c){r+=this._font.property.size;var h=null;for(var p=0;p<e._meta.bounds.propertyBounds.length;++p)if(e._meta.bounds.propertyBounds[p].name===l[c].name){h=e._meta.bounds.propertyBounds[p];break}var d=null;for(var p=0;p<e._meta.bounds.initialBounds.length;++p)if(e._meta.bounds.initialBounds[p].name===l[c].name){d=e._meta.bounds.initialBounds[p];break}var v=null;for(var p=0;p<e._meta.bounds.valueBounds.length;++p)if(e._meta.bounds.valueBounds[p].name===l[c].name){v=e._meta.bounds.valueBounds[p];break}this._options.readOnly||(this._engine&&this._engine.isRunning()&&(this._highlightNode===e&&this._highlightPropertyValue&&this._highlightPropertyValue.name===l[c].name?this.__drawRoundedRect(v.rect,this._drawStyle.property.highlightColor,this._drawStyle.property.highlightBorder,this._font.property.size/2,t,e.pos):!n&&this._highlightNode===e&&this.__drawRoundedRect(v.rect,this._drawStyle.property.normalColor,this._drawStyle.property.normalBorder,this._font.property.size/2,t,e.pos)),this._highlightNode===e&&this._highlightPropertyInitialValue&&this._highlightPropertyInitialValue.name===l[c].name?this.__drawRoundedRect(d.rect,this._drawStyle.property.highlightColor,this._drawStyle.property.highlightBorder,this._font.property.size/2,t,e.pos):!n&&this._highlightNode===e&&this.__drawRoundedRect(d.rect,this._drawStyle.property.normalColor,this._drawStyle.property.normalBorder,this._font.property.size/2,t,e.pos)),t.fillStyle="black",t.textAlign="left",this.__setCanvasFont(this._font.property,t),t.fillText(l[c].name+": ",e.pos.x+e._meta.bounds.center.left+this._drawStyle.node.margin,e.pos.y+e._meta.bounds.center.top+r),t.textAlign="right",this.__setCanvasFont(this._font.initialValue,t),t.fillStyle="black",t.fillText(this._drawStyle.property.initialWrapL+this.__drawPropertyValue(e,l[c],!0)+this._drawStyle.property.initialWrapR,e.pos.x+e._meta.bounds.center.left+e._meta.bounds.center.width-this._drawStyle.node.margin,e.pos.y+e._meta.bounds.center.top+r),this._engine&&this._engine.isRunning()&&(this.__setCanvasFont(this._font.value,t),t.fillStyle="#444444",t.fillText(this._drawStyle.property.valueWrapL+this.__drawPropertyValue(e,l[c])+this._drawStyle.property.valueWrapR,e.pos.x+e._meta.bounds.center.left+e._meta.bounds.center.width-this._drawStyle.node.margin-e._meta.bounds.center.initialWidth,e.pos.y+e._meta.bounds.center.top+r));if(!f||l[c].inputs.length){var m=null;for(var p=0;p<e._meta.bounds.inputBounds.length;++p)if(e._meta.bounds.inputBounds[p].name===l[c].name){m=e._meta.bounds.inputBounds[p].rect;break}t.fillStyle=this._highlightInputLink&&this._highlightInputLink.name===l[c].name&&this._highlightNode===e?"cyan":l[c].inputMeta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(e.pos.x+m.left,e.pos.y+m.top+5),t.lineTo(e.pos.x+m.left+m.width,e.pos.y+m.top+5),t.lineTo(e.pos.x+m.left+m.width,e.pos.y+m.top+m.height-5),t.lineTo(e.pos.x+m.left,e.pos.y+m.top+m.height-5),t.lineTo(e.pos.x+m.left+m.width/3,e.pos.y+m.top+m.height/2),t.closePath(),t.stroke(),t.fill()}if(!f||l[c].outputs.length){var m=null;for(var p=0;p<e._meta.bounds.outputBounds.length;++p)if(e._meta.bounds.outputBounds[p].name===l[c].name){m=e._meta.bounds.outputBounds[p].rect;break}t.fillStyle=this._highlightOutputLink&&this._highlightOutputLink.name===l[c].name&&this._highlightNode===e?"cyan":l[c].outputMeta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(e.pos.x+m.left,e.pos.y+m.top+5),t.lineTo(e.pos.x+m.left+m.width/2,e.pos.y+m.top+5),t.lineTo(e.pos.x+m.left+m.width,e.pos.y+m.top+m.height/2),t.lineTo(e.pos.x+m.left+m.width/2,e.pos.y+m.top+m.height-5),t.lineTo(e.pos.x+m.left,e.pos.y+m.top+m.height-5),t.closePath(),t.stroke(),t.fill()}r+=this._drawStyle.property.spacing}e.chain.exit.length&&(t.strokeStyle=e._meta.color,t.beginPath(),t.moveTo(e.pos.x+e._meta.bounds.center.left,e.pos.y+e._meta.bounds.center.top+e._meta.bounds.center.height),t.lineTo(e.pos.x+e._meta.bounds.center.left+e._meta.bounds.center.width,e.pos.y+e._meta.bounds.center.top+e._meta.bounds.center.height),t.stroke()),t.restore()},__drawEntryLinks:function(e,t,n){var r=e.pos.x-n/2+this._drawStyle.links.margin,i=e.pos.y+this._drawStyle.links.length+this._font.links.size;t.save(),this.__setCanvasFont(this._font.links,t);var s=e.collapsed(),o=e.chain.entry;for(var u=0;u<o.length;++u){t.fillStyle="black";var a=t.measureText(o[u].name).width+this._drawStyle.links.spacing;t.fillText(o[u].name,r+this._drawStyle.links.spacing/2,i);if(!s||o[u].links.length){var f=null;for(var l=0;l<e._meta.bounds.entryBounds.length;++l)if(e._meta.bounds.entryBounds[l].name===o[u].name){f=e._meta.bounds.entryBounds[l].rect;break}t.fillStyle=this._highlightEntryLink&&this._highlightEntryLink.name===o[u].name&&this._highlightNode===e?"cyan":o[u].meta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(e.pos.x+f.left+5,e.pos.y+f.top),t.lineTo(e.pos.x+f.left+f.width/2,e.pos.y+f.top+f.height/3),t.lineTo(e.pos.x+f.left+f.width-5,e.pos.y+f.top),t.lineTo(e.pos.x+f.left+f.width-5,e.pos.y+f.top+f.height),t.lineTo(e.pos.x+f.left+5,e.pos.y+f.top+f.height),t.closePath(),t.stroke(),t.fill()}r+=a}t.restore()},__drawExitLinks:function(e,t,n,r){var i=e.pos.x-r/2+this._drawStyle.links.margin,s=e.pos.y+n+this._font.links.size;t.save(),this.__setCanvasFont(this._font.links,t);var o=e.collapsed(),u=e.chain.exit;for(var a=0;a<u.length;++a){t.fillStyle="black";var f=t.measureText(u[a].name).width+this._drawStyle.links.spacing;t.fillText(u[a].name,i+this._drawStyle.links.spacing/2,s);if(!o||u[a].links.length){var l=null;for(var c=0;c<e._meta.bounds.exitBounds.length;++c)if(e._meta.bounds.exitBounds[c].name===u[a].name){l=e._meta.bounds.exitBounds[c].rect;break}t.fillStyle=this._highlightExitLink&&this._highlightExitLink.name===u[a].name&&this._highlightNode===e?"cyan":u[a].meta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(e.pos.x+l.left+5,e.pos.y+l.top),t.lineTo(e.pos.x+l.left+l.width-5,e.pos.y+l.top),t.lineTo(e.pos.x+l.left+l.width-5,e.pos.y+l.top+l.height/2),t.lineTo(e.pos.x+l.left+l.width/2,e.pos.y+l.top+l.height),t.lineTo(e.pos.x+l.left+5,e.pos.y+l.top+l.height/2),t.closePath(),t.stroke(),t.fill()}i+=f}t.restore()},__drawChains:function(e,t){for(var n=0;n<e.length;++n)this.__drawNodeChains(e[n],t)},__drawNodeChains:function(e,t){for(var n=0;n<e.chain.exit.length;++n){var r=e.chain.exit[n];if(!r.links.length)continue;var i;for(var s=0;s<e._meta.bounds.exitBounds.length;++s)if(e._meta.bounds.exitBounds[s].name===r.name){i=e._meta.bounds.exitBounds[s].point;break}if(!i){console.log("ERROR: Attempted to draw chains for an exit link that has no meta data.");continue}for(var s=0;s<r.links.length;++s){var o=r.links[s].node,u=r.links[s].name,a;if(!e._meta.visible&&!o._meta.visible)continue;for(var f=0;f<o.chain.entry.length;++f)if(o.chain.entry[f].name===u){a=o.chain.entry[f];break}if(!a){console.log("ERROR: Attempted to chain an exit link to an entry link that was not found.");continue}var l;for(var f=0;f<o._meta.bounds.entryBounds.length;++f)if(o._meta.bounds.entryBounds[f].name===a.name){l=o._meta.bounds.entryBounds[f].point;break}if(!l){console.log("ERROR: Attempted to draw chains to an entry link that has no meta data.");continue}var c=r.meta.flashDelta>0&&a.meta.flashDelta>0,h=this._highlightNode===o&&this._highlightEntryLink&&this._highlightEntryLink.name===a.name||this._highlightNode===e&&this._highlightExitLink&&this._highlightExitLink.name===r.name;this.__drawChain(e.pos,o.pos,i,l,e._meta.bounds.rect,o._meta.bounds.rect,t,c,h)}}for(var n=0;n<e.properties.length;++n){var p=e.properties[n];if(!p.outputs.length)continue;var d;for(var s=0;s<e._meta.bounds.outputBounds.length;++s)if(e._meta.bounds.outputBounds[s].name===p.name){d=e._meta.bounds.outputBounds[s].point;break}if(!d){console.log("ERROR: Attempted to draw chains for an output link that has no meta data.");continue}for(var s=0;s<p.outputs.length;++s){var o=p.outputs[s].node,u=p.outputs[s].name,v;if(!e._meta.visible&&!o._meta.visible)continue;for(var f=0;f<o.properties.length;++f)o.properties[f].name===u&&(v=o.properties[f]);if(!v){console.log("ERROR: Attempted to chain a property link to a property that was not found.");continue}var m;for(var f=0;f<o._meta.bounds.inputBounds.length;++f)if(o._meta.bounds.inputBounds[f].name===v.name){m=o._meta.bounds.inputBounds[f].point;break}if(!m){console.log("ERROR: Attempted to draw chains to a property input link that has no meta data.");continue}var c=p.outputMeta.flashDelta>0||v.inputMeta.flashDelta>0,h=this._highlightNode===o&&this._highlightInputLink&&this._highlightInputLink.name===v.name||this._highlightNode===e&&this._highlightOutputLink&&this._highlightOutputLink.name===p.name;this.__drawChain(e.pos,o.pos,d,m,e._meta.bounds.rect,o._meta.bounds.rect,t,c,h,!0)}}if(this._selectedNode===e&&this._selectedEntryLink){var g,y=null,b=null,h=!1;this._highlightNode&&this._highlightExitLink?(g=this._highlightExitLink.point,y=this._highlightExitLink.rect,b=this._highlightNode.pos,h=!0):(g={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z},y={left:g.x,top:g.y,width:1,height:1},b={x:0,y:0});var w;for(var n=0;n<e._meta.bounds.entryBounds.length;++n)e._meta.bounds.entryBounds[n].name===this._selectedEntryLink.name&&(w=e._meta.bounds.entryBounds[n].point);this.__drawChain(b,e.pos,g,w,y,e._meta.bounds.rect,t,h)}if(this._selectedNode===e&&this._selectedExitLink){var g,y=null,b=null,h=!1;this._highlightNode&&this._highlightEntryLink?(g=this._highlightEntryLink.point,y=this._highlightEntryLink.rect,b=this._highlightNode.pos,h=!0):(g={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z},y={left:g.x,top:g.y,width:1,height:1},b={x:0,y:0});var w;for(var n=0;n<e._meta.bounds.exitBounds.length;++n)e._meta.bounds.exitBounds[n].name===this._selectedExitLink.name&&(w=e._meta.bounds.exitBounds[n].point);this.__drawChain(e.pos,b,w,g,e._meta.bounds.rect,y,t,h)}if(this._selectedNode===e&&this._selectedInputLink){var g,y=null,b=null,h=!1;this._highlightNode&&this._highlightOutputLink?(g=this._highlightOutputLink.point,y=this._highlightOutputLink.rect,b=this._highlightNode.pos,h=!0):(g={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z},y={left:g.x,top:g.y,width:1,height:1},b={x:0,y:0});var w;for(var n=0;n<e._meta.bounds.inputBounds.length;++n)e._meta.bounds.inputBounds[n].name===this._selectedInputLink.name&&(w=e._meta.bounds.inputBounds[n].point);this.__drawChain(b,e.pos,g,w,y,e._meta.bounds.rect,t,h,!1,!0)}if(this._selectedNode===e&&this._selectedOutputLink){var g,y=null,b=null,h=!1;this._highlightNode&&this._highlightInputLink?(g=this._highlightInputLink.point,y=this._highlightInputLink.rect,b=this._highlightNode.pos,h=!0):(g={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z},y={left:g.x,top:g.y,width:1,height:1},b={x:0,y:0});var w;for(var n=0;n<e._meta.bounds.outputBounds.length;++n)e._meta.bounds.outputBounds[n].name===this._selectedOutputLink.name&&(w=e._meta.bounds.outputBounds[n].point);this.__drawChain(e.pos,b,w,g,e._meta.bounds.rect,y,t,h,!1,!0)}},__drawChain:function(e,t,n,r,i,s,o,u,a,f){function l(e,t){f?o.lineTo(t,e):o.lineTo(e,t)}function c(e,t,n,r,i){f?o.arcTo(t,e,r,n,i):o.arcTo(e,t,n,r,i)}function h(e,t,n,r,i,s){f?o.bezierCurveTo(t,e,r,n,s,i):o.bezierCurveTo(e,t,n,r,i,s)}o.save(),o.lineWidth=2,o.lineCap="round",o.lineJoin="round",o.beginPath(),o.moveTo(e.x+n.x,e.y+n.y);var p,d,v,m;f?(p={x:e.y+n.y,y:e.x+n.x},d={x:t.y+r.y,y:t.x+r.x},v={top:i.left+e.x,left:i.top+e.y,width:i.height,height:i.width},m={top:s.left+t.x,left:s.top+t.y,width:s.height,height:s.width},o.strokeStyle=a?"cyan":u?"#CCCC00":"#33CC33"):(p={x:e.x+n.x,y:e.y+n.y},d={x:t.x+r.x,y:t.y+r.y},v={top:i.top+e.y,left:i.left+e.x,width:i.width,height:i.height},m={top:s.top+t.y,left:s.left+t.x,width:s.width,height:s.height},o.strokeStyle=a?"cyan":u?"#CCCC00":"#000000");switch(this._chainStyle){case 0:var g=15;if(p.y<d.y){var y=(d.x+p.x)/2,b=(d.y+p.y)/2,w=Math.min(g,Math.abs(d.x-p.x)/2,Math.abs(d.y-p.y)/2);c(p.x,b,y,b,w),c(d.x,b,d.x,d.y,w)}else if(v.left+v.width<m.left){var y=(m.left+v.left+v.width)/2-2,b=(d.y+p.y)/2,E=(y+p.x)/2,S=(d.x+y)/2,w=Math.min(g,Math.abs(d.y-p.y)/4,Math.abs(y-E),Math.abs(y-S));c(p.x,p.y+w,E,p.y+w,w),c(y,p.y+w,y,b,w),c(y,d.y-w,S,d.y-w,w),c(d.x,d.y-w,d.x,d.y,w)}else if(v.left>m.left+m.width){var y=(v.left+m.left+m.width)/2+2,b=(d.y+p.y)/2,E=(y+d.x)/2,S=(p.x+y)/2,w=Math.min(g,Math.abs(d.y-p.y)/4,Math.abs(y-E),Math.abs(y-S));c(p.x,p.y+w,S,p.y+w,w),c(y,p.y+w,y,b,w),c(y,d.y-w,E,d.y-w,w),c(d.x,d.y-w,d.x,d.y,w)}else if(p.y>d.y&&Math.abs(p.y-d.y)>this._drawStyle.links.length){var x=p.x,T=Math.min(v.top-g,m.top-g),N=Math.max(v.top+v.height+g,m.top+m.height+g),b=(p.y+d.y)/2;Math.abs(Math.min(v.left,m.left)-p.x)<=Math.abs(Math.max(v.left+v.width,m.left+m.width)-d.x)?(x=Math.min(v.left-g,m.left-g),N-=2):(x=Math.max(v.left+v.width+g,m.left+m.width+g),N+=2);var y=(p.x+x)/2,w=Math.min(g,Math.abs(x-p.x)/2,Math.abs(x-d.x)/2);c(p.x,N,y,N,w),c(x,N,x,b,w),c(x,T,y,T,w),c(d.x,T,d.x,d.y,w)}break;case 1:if(p.y<d.y){var b=(p.y+d.y)/2,y=(p.x+d.x)/2;h(p.x,b,d.x,b,d.x,d.y)}else if(v.left+v.width<m.left||v.left>m.left+m.width){var w=Math.abs(p.y-d.y)/2,T=m.top-w,N=v.top+v.height+w;h(p.x,N,d.x,T,d.x,d.y)}else if(p.y>d.y&&Math.abs(p.y-d.y)>this._drawStyle.links.length){var C=p.x;Math.abs(Math.min(v.left,m.left)-p.x)<=Math.abs(Math.max(v.left+v.width,m.left+m.width)-d.x)?C=Math.min(v.left,m.left)-15:C=Math.max(v.left+v.width,m.left+m.width)+15;var T=m.top-30,N=Math.max(v.top+v.height+30,m.top+m.height+30),b=(p.y+d.y)/2;h(p.x,N,C,N,C,b),h(C,T,d.x,T,d.x,d.y)}}o.lineTo(t.x+r.x,t.y+r.y),o.stroke(),o.restore()},__drawPropertyValue:function(e,t,n){var r;n?r=e.initialProperty(t.name):r=e.property(t.name);if(typeof t.options.display=="function")r=t.options.display(r);else switch(t.type){case wcPlay.PROPERTY.TOGGLE:return r?"yes":"no";case wcPlay.PROPERTY.SELECT:if(r=="")return"<none>";var i=t.options.items;$.isFunction(i)&&(i=i.call(e));if($.isArray(i)){var s=!1;for(var o=0;o<i.length;++o)if(typeof i[o]=="object"){if(i[o].value==r){r=i[o].name,s=!0;break}}else if(typeof i[o]=="string"&&i[o]==r){s=!0;break}s||(r="Unknown")}}return this.__clampString(r.toString(),this._drawStyle.property.strLen)},__drawDetailsPopup:function(e){var t=e.type+" Node",n=e.description();n&&(n+="\n\n"),n+=e.details();var r=$('<div class="wcPlayDetailsPopupBlocker">'),i=$('<div class="wcPlayDetailsPopup">'),s=$("<h3>"+t+"</h3>"),o=$('<pre class="wcPlayDetailsPopupText">'+n+"</pre>");i.append(s),i.append(o),r.append(i),$("body").append(r),r.click(function(){$(this).remove()})},__drawTitleEditor:function(e,t){if(this._options.readOnly)return;var n=this,r=!1,i=$('<input type="text">');i.val(e.name),i.change(function(){if(!r){n._undoManager&&n._undoManager.addEvent('Title changed for Node "'+e.category+"."+e.type+'"',{id:e.id,oldValue:e.name,newValue:i.val(),engine:n._engine},function(){var e=this.engine.nodeById(this.id),t=e.name,n=e.onNameChanging(t,this.oldValue);n===undefined&&(n=this.oldValue),e.name=n,e.onNameChanged(t,n)},function(){var e=this.engine.nodeById(this.id),t=e.name,n=e.onNameChanging(t,this.newValue);n===undefined&&(n=this.newValue),e.name=n,e.onNameChanged(t,n)});var t=e.name,s=e.onNameChanging(t,i.val());s===undefined&&(s=i.val()),e.name=s,e.onNameChanged(t,s)}});var s={top:0,left:this.$palette.width()};this.$main.append(i),i.addClass("wcPlayEditorControl"),i.focus(),i.select(),i.blur(function(){$(this).remove()}),i.keydown(function(e){e.stopPropagation()}),i.keyup(function(e){switch(e.keyCode){case 13:i.blur();break;case 27:r=!0,i.blur()}return!1}),i.css("top",s.top+(e.pos.y+t.top)*this._viewportCamera.z+this._viewportCamera.y).css("left",s.left+(e.pos.x+t.left)*this._viewportCamera.z+this._viewportCamera.x).css("width",Math.max(t.width*this._viewportCamera.z,200)).css("height",Math.max(t.height*this._viewportCamera.z,15))},__drawPropertyEditor:function(e,t,n,r){function l(e,t,n,r){f._undoManager&&f._undoManager.addEvent('Property "'+t+'" changed for Node "'+e.category+"."+e.type+'"',{id:e.id,name:t,propFn:u,oldValue:n,newValue:r,engine:f._engine},function(){var e=this.engine.nodeById(this.id);e[this.propFn](this.name,this.oldValue,!0,!0)},function(){var e=this.engine.nodeById(this.id);e[this.propFn](this.name,this.newValue,!0,!0)})}if(this._options.readOnly)return;var i=null,s=!1,o=!0,u=r?"initialProperty":"property",a=t.type,f=this;switch(a){case wcPlay.PROPERTY.TOGGLE:var c=e[u](t.name);l(e,t.name,c,!c),e[u](t.name,!c,!0,!0);break;case wcPlay.PROPERTY.NUMBER:i=$('<input type="number"'+(t.options.min?' min="'+t.options.min+'"':"")+(t.options.max?' max="'+t.options.max+'"':"")+(t.options.step?' step="'+t.options.step+'"':"")+">"),i.val(parseFloat(e[u](t.name))),i.change(function(){if(!s){var n=$(this).attr("min")!==undefined?parseInt($(this).attr("min")):-Infinity,r=$(this).attr("max")!==undefined?parseInt($(this).attr("max")):Infinity;h=Math.min(r,Math.max(n,parseInt(i.val()))),l(e,t.name,e[u](t.name),h),e[u](t.name,h,!0,!0)}});break;case wcPlay.PROPERTY.STRING:case wcPlay.PROPERTY.DYNAMIC:t.options.multiline?(i=$("<textarea"+(t.options.maxlength?' maxlength="'+t.options.maxlength+'"':"")+">"),o=!1):i=$('<input type="text" maxlength="'+(t.options.maxlength||524288)+'">'),i.val(e[u](t.name).toString()),i.change(function(){s||(l(e,t.name,e[u](t.name),i.val()),e[u](t.name,i.val(),!0,!0))});break;case wcPlay.PROPERTY.SELECT:var h=e[u](t.name);i=$("<select>");var p=t.options.items;$.isFunction(p)&&(p=p.call(e));if(!$.isArray(p)){console.log("ERROR: Tried to display a Select type property when no selection list was provided.");return}i.append($('<option value=""'+(""==h?" selected":"")+">&lt;none&gt;</option>"));for(var d=0;d<p.length;++d)typeof p[d]=="object"?i.append($('<option value="'+p[d].value+'"'+(p[d].value==h?" selected":"")+">"+p[d].name+"</option>")):i.append($('<option value="'+p[d]+'"'+(p[d]==h?" selected":"")+">"+p[d]+"</option>"));i.change(function(){s||(l(e,t.name,e[u](t.name),i.val()),e[u](t.name,i.val(),!0,!0),$(this).blur())})}if(i){var v={top:0,left:this.$palette.width()};this.$main.append(i),i.addClass("wcPlayEditorControl"),i.focus(),i.select(),i.blur(function(){$(this).remove()}),i.keydown(function(e){e.stopPropagation()}),i.keyup(function(e){switch(e.keyCode){case 13:(o||e.ctrlKey)&&i.blur();break;case 27:s=!0,i.blur()}return!1}),i.css("top",v.top+(e.pos.y+n.rect.top)*this._viewportCamera.z+this._viewportCamera.y).css("left",v.left+(e.pos.x+n.rect.left)*this._viewportCamera.z+this._viewportCamera.x).css("width",Math.max(n.rect.width*this._viewportCamera.z,200)).css("height",Math.max(n.rect.height*this._viewportCamera.z,15))}},__onCreateNode:function(e){this._undoManager&&this._undoManager.addEvent('Created Node "'+e.category+"."+e.type+'"',{id:e.id,className:e.className,data:e.export(),engine:this._engine,parent:this._parent},function(){var e=this.engine.nodeById(this.id);for(var t=0;t<this.engine._editors.length;++t){var n=this.engine._editors[t]._parent;while(!(n instanceof wcPlay)){if(n==e){this.engine._editors[t]._parent=e._parent,this.engine._editors[t].center();break}n=n._parent}}e.destroy()},function(){var e=new window[this.className](this.parent,this.data.pos);e.id=this.id,e.import(this.data)})},__onDestroyNode:function(e){this._undoManager&&this._undoManager.addEvent("",{data:e.export(),parent:this._parent,engine:this._engine},function(){var e=new window[this.data.className](this.parent,this.data.pos);e.import(this.data)},function(){var e=this.engine.nodeById(this.data.id);for(var t=0;t<this.engine._editors.length;++t){var n=this.engine._editors[t]._parent;while(!(n instanceof wcPlay)){if(n==e){this.engine._editors[t]._parent=e._parent,this.engine._editors[t].center();break}n=n._parent}}e.destroy()})},__handleAutoScroll:function(e,t){var n=!1,r=this.$viewport.width(),i=this.$viewport.height(),s=Math.min(50,r/2,i/2);this._autoScrollNodes=t,e&&(this._mouse.x>=r-s?(n=!0,this._autoScrollDirection.x=this._mouse.x-r+s,this._autoScrollDirection.y=0):this._mouse.x<=s&&(n=!0,this._autoScrollDirection.x=this._mouse.x-s,this._autoScrollDirection.y=0),this._mouse.y>=i-s?(n=!0,this._autoScrollDirection.x=0,this._autoScrollDirection.y=this._mouse.y-i+s):this._mouse.y<=s&&(n=!0,this._autoScrollDirection.x=0,this._autoScrollDirection.y=this._mouse.y-s));if(n&&!this._autoScrollInterval){var o=this;this._autoScrollInterval=setInterval(function(){var e=o._autoScrollDirection.x,t=o._autoScrollDirection.y;o._viewportCamera.x-=e,o._viewportCamera.y-=t;if(o._autoScrollNodes)for(var n=0;n<o._selectedNodes.length;++n){var r=o._selectedNodes[n],i={x:r.pos.x,y:r.pos.y},s={x:r.pos.x+e/o._viewportCamera.z,y:r.pos.y+t/o._viewportCamera.z},s=r.onMoving(i,s)||s;if(i.x!==s.x||i.y!==s.y)r.pos.x=s.x,r.pos.y=s.y,r.onMoved(i,s)}},10)}else this._autoScrollInterval&&!n&&(clearInterval(this._autoScrollInterval),this._autoScrollInterval=0)},__setupControls:function(){var e=this;this.__bindMenuHandlers(),this.$palette.on("mousemove",function(t){e.__onPaletteMouseMove(t,this)}),this.$palette.on("mousedown",function(t){e.__onPaletteMouseDown(t,this)}),this.$palette.on("mouseup",function(t){e.__onPaletteMouseUp(t,this)}),this.$viewport.on("mousemove",function(t){e.__onViewportMouseMove(t,this)}),this.$viewport.on("mousedown",function(t){e.__onViewportMouseDown(t,this)}),this.$viewport.on("mouseup",function(t){e.__onViewportMouseUp(t,this)}),this.$viewport.on("mouseenter",function(t){e.__onViewportMouseEnter(t,this)}),this.$viewport.on("mouseleave",function(t){e.__onViewportMouseLeave(t,this)}),this.$viewport.on("click",function(t){e.__onViewportMouseClick(t,this)}),this.$viewport.on("dblclick",function(t){e.__onViewportMouseDoubleClick(t,this)}),this.$viewport.on("mousewheel DOMMouseScroll",function(t){e.__onViewportMouseWheel(t,this)})},__bindMenuHandlers:function(){function t(t,n){var r=new FileReader;r.onload=function(r){e._engine&&(n?e._engine.import(r.target.result,t.name)&&(e.__setupPalette(),e.$typeButton[3].click()):e._engine.load(r.target.result)?(e._parent=e._engine,e._selectedNode=null,e._selectedNodes=[],e._undoManager&&e._undoManager.clear(),e.center()):alert('Failed to open file "'+t.name+'"\nPlease check to ensure it is actually a wcPlay script file.'))},r.readAsText(t)}var e=this;$("body").on("change","#wcPlayEditorHiddenFileLoader",function(e){if($(this).hasClass("disabled"))return;e.target.files.length&&(t(e.target.files[0]),$(this).val(""),$(this).remove())}),$("body").on("change","#wcPlayEditorHiddenFileImporter",function(e){if($(this).hasClass("disabled"))return;e.target.files.length&&(t(e.target.files[0],!0),$(this).val(""),$(this).remove())}),this.$container.on("dragover",function(e){e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy"}),this.$container.on("drop",function(e){e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.files.length&&t(e.originalEvent.dataTransfer.files[0],e.ctrlKey)})},__onPaletteMouseMove:function(e,t){var n=this.__mouse(e);this._highlightTitle=!1,this._highlightDetails=!1,this._highlightDebugLog=!1,this._highlightBreakpoint=!1,this._highlightEntryLink=!1,this._highlightExitLink=!1,this._highlightInputLink=!1,this._highlightOutputLink=!1,this._highlightPropertyValue=!1,this._highlightPropertyInitialValue=!1,this._highlightViewport=!1;if(this._draggingNodeData){var r={x:n.gx+this._draggingNodeData.offset.x,y:n.gy+this._draggingNodeData.offset.y};this._draggingNodeData.$canvas.css("left",r.x).css("top",r.y);return}var i=this.__findCategoryAreaAtPos(n);if(i){var s=i.$canvas.offset();n=this.__mouse(e,s);var o=this.__findNodeAtPos(n,undefined,i.nodes);o?(this._highlightNode=o,this.$palette.addClass("wcClickable"),this.$palette.attr("title","Create a new instance of this node by dragging this into your script.")):(this._highlightNode=null,this.$palette.removeClass("wcClickable"),this.$palette.attr("title",""))}},__onPaletteMouseDown:function(e,t){if(this._highlightNode){this.__onPaletteMouseUp(e,t);var n=this.__mouse(e),r=this._highlightNode._meta.bounds.rect,i=this.__findCategoryAreaAtPos(n);if(i){var s=i.$canvas.offset();this._draggingNodeData={node:this._highlightNode,$canvas:$('<canvas class="wcPlayHoverCanvas">'),offset:{x:0,y:0}},this.$main.append(this._draggingNodeData.$canvas),this.$palette.addClass("wcMoving"),this.$viewport.addClass("wcMoving"),this._draggingNodeData.$canvas.css("left",this._highlightNode.pos.x+r.left+s.left).css("top",this._highlightNode.pos.y+r.top+s.top),this._draggingNodeData.$canvas.attr("width",r.width).css("width",r.width),this._draggingNodeData.$canvas.attr("height",r.height).css("height",r.height),this._draggingNodeData.offset.x=this._highlightNode.pos.x+r.left+s.left-n.x,this._draggingNodeData.offset.y=this._highlightNode.pos.y+r.top+s.top-n.y;var o=0;this._highlightNode.chain.entry.length||(o+=this._drawStyle.links.length),this._highlightNode.pos.x=r.width/2,this._highlightNode.pos.y=o+3,this.__drawNode(this._highlightNode,this._draggingNodeData.$canvas[0].getContext("2d"),!0)}}},__onPaletteMouseUp:function(e,t){this._draggingNodeData&&(this._draggingNodeData.$canvas.remove(),this._draggingNodeData.$canvas=null,this._draggingNodeData=null,this.$palette.removeClass("wcMoving"),this.$viewport.removeClass("wcMoving"))},__onViewportMouseMove:function(e,t){var n=this.__mouse(e,this.$viewport.offset());if(n.x!==this._mouse.x||n.y!==this._mouse.y)this._mouseMoved=!0;if(this._draggingNodeData){var r={x:n.gx+this._draggingNodeData.offset.x,y:n.gy+this._draggingNodeData.offset.y};this._draggingNodeData.$canvas.css("left",r.x).css("top",r.y),this._mouse=n,this.__handleAutoScroll(!0);return}if(this._highlightRect&&this._parent){this._highlightRect.x=(n.x-this._viewportCamera.x)/this._viewportCamera.z-this._highlightRect.ox,this._highlightRect.y=(n.y-this._viewportCamera.y)/this._viewportCamera.z-this._highlightRect.oy,this._highlightRect.width=this._highlightRect.x,this._highlightRect.height=this._highlightRect.y,this._highlightRect.width<0&&(this._highlightRect.left=this._highlightRect.ox+this._highlightRect.width,this._highlightRect.width*=-1),this._highlightRect.height<0&&(this._highlightRect.top=this._highlightRect.oy+this._highlightRect.height,this._highlightRect.height*=-1),this._selectedNodes=[];var i=this;function s(e){for(var t=0;t<e.length;++t)i.__rectOnRect(e[t]._meta.bounds.inner,i._highlightRect,e[t].pos)&&i._selectedNodes.push(e[t])}s(this._parent._storageNodes),s(this._parent._compositeNodes),s(this._parent._processNodes),s(this._parent._entryNodes),this._mouse=n,this.__handleAutoScroll(!0);return}if(this._viewportMoving){var o=n.x-this._mouse.x,u=n.y-this._mouse.y;this._viewportCamera.x+=o,this._viewportCamera.y+=u,this._mouse=n,!this._viewportMoved&&this._mouseMoved&&(this._viewportMoved=!0,this.$viewport.addClass("wcMoving")),this.__handleAutoScroll(!1);return}if(this._viewportMovingNode){var o=n.x-this._mouse.x,u=n.y-this._mouse.y;for(var a=0;a<this._selectedNodes.length;++a){var f=this._selectedNodes[a],l={x:f.pos.x,y:f.pos.y},c={x:f.pos.x+o/this._viewportCamera.z,y:f.pos.y+u/this._viewportCamera.z},c=f.onMoving(l,c)||c;if(l.x!==c.x||l.y!==c.y)f.pos.x=c.x,f.pos.y=c.y,f.onMoved(l,c)}this._mouse=n,this.__handleAutoScroll(!0,!0);return}this._mouse=n,this._highlightNode=null,this._highlightCrumb=-1,this._highlightTitle=!1,this._highlightDetails=!1,this._highlightDebugLog=!1,this._highlightBreakpoint=!1,this._highlightEntryLink=!1,this._highlightExitLink=!1,this._highlightInputLink=!1,this._highlightOutputLink=!1,this._highlightPropertyValue=!1,this._highlightPropertyInitialValue=!1,this.__handleAutoScroll(this._selectedEntryLink||this._selectedExitLink||this._selectedInputLink||this._selectedOutputLink);var h=this._highlightViewport;this._highlightViewport=!1,this.$viewport.removeClass("wcClickable wcMoving wcGrab"),this.$viewport.attr("title","");for(var a=0;a<this._crumbBounds.length;++a)if(this.__inRect(n,this._crumbBounds[a].rect)){this._highlightCrumb=a,this.$viewport.addClass("wcClickable"),this.$viewport.attr("title","Click to go to this level in the hierarchy.");break}var f=null;this._highlightCrumb===-1&&(f=this.__findNodeAtPos(n,this._viewportCamera));if(f){!this._options.readOnly&&this.__inRect(n,f._meta.bounds.farRect,f.pos,this._viewportCamera)&&(this._highlightNode=f,this.$viewport.attr("title",f._meta.description?f._meta.description+"\n":""),this.$viewport.addClass("wcMoving")),!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedInputLink&&!this._selectedOutputLink&&(this.__inRect(n,f._meta.bounds.debugLog,f.pos,this._viewportCamera)&&(this._highlightDebugLog=!0,this._highlightNode=f,this.$viewport.addClass("wcClickable"),f._log?this.$viewport.attr("title","Disable debug logging for this node."):this.$viewport.attr("title","Enable debug logging for this node.")),this.__inRect(n,f._meta.bounds.breakpoint,f.pos,this._viewportCamera)&&(this._highlightBreakpoint=!0,this._highlightNode=f,this.$viewport.addClass("wcClickable"),this.$viewport.attr("title","Toggle debug breakpoint on this node.")));if(!this._options.readOnly&&!this._selectedEntryLink&&!this._selectedInputLink&&!this._selectedOutputLink)for(var a=0;a<f._meta.bounds.entryBounds.length;++a)if(this.__inRect(n,f._meta.bounds.entryBounds[a].rect,f.pos,this._viewportCamera)){this._highlightNode=f,this._highlightEntryLink=f._meta.bounds.entryBounds[a];var p;for(var d=0;d<f.chain.entry.length;++d)if(f.chain.entry[d].name==this._highlightEntryLink.name){p=f.chain.entry[d];break}this.$viewport.attr("title",(p.meta.description?p.meta.description+"\n":"")+"Click and drag to create a new flow chain from another node. Double click to manually fire this entry link."),this.$viewport.addClass("wcGrab");break}if(!this._options.readOnly&&!this._selectedExitLink&&!this._selectedInputLink&&!this._selectedOutputLink)for(var a=0;a<f._meta.bounds.exitBounds.length;++a)if(this.__inRect(n,f._meta.bounds.exitBounds[a].rect,f.pos,this._viewportCamera)){this._highlightNode=f,this._highlightExitLink=f._meta.bounds.exitBounds[a];var p;for(var d=0;d<f.chain.exit.length;++d)if(f.chain.exit[d].name==this._highlightExitLink.name){p=f.chain.exit[d];break}this.$viewport.attr("title",(p.meta.description?p.meta.description+"\n":"")+"Click and drag to create a new flow chain to another node. Double click to manually fire this exit link."),this.$viewport.addClass("wcGrab");break}if(!this._options.readOnly&&!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedInputLink)for(var a=0;a<f._meta.bounds.inputBounds.length;++a)if(this.__inRect(n,f._meta.bounds.inputBounds[a].rect,f.pos,this._viewportCamera)){this._highlightNode=f,this._highlightInputLink=f._meta.bounds.inputBounds[a],this.$viewport.attr("title","Click and drag to chain this property to the output of another."),this.$viewport.addClass("wcGrab");break}if(!this._options.readOnly&&!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedOutputLink)for(var a=0;a<f._meta.bounds.outputBounds.length;++a)if(this.__inRect(n,f._meta.bounds.outputBounds[a].rect,f.pos,this._viewportCamera)){this._highlightNode=f,this._highlightOutputLink=f._meta.bounds.outputBounds[a],this.$viewport.attr("title","Click and drag to chain this property to the input of another. Double click to manually propagate this property through the chain."),this.$viewport.addClass("wcGrab");break}if(!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedInputLink&&!this._selectedOutputLink){if(!this._options.readOnly){this.__inRect(this._mouse,f._meta.bounds.titleBounds,f.pos,this._viewportCamera)&&(this._highlightNode=f,this._highlightTitle=!0,this.$viewport.attr("title","Click to add or modify an additional label for this title."),this.$viewport.addClass("wcClickable")),this.__inRect(this._mouse,f._meta.bounds.detailsBounds,f.pos,this._viewportCamera)&&(this._highlightNode=f,this._highlightDetails=!0,this.$viewport.attr("title","Click to see futher details for this node."),this.$viewport.addClass("wcClickable"));var v;for(var a=0;a<f._meta.bounds.propertyBounds.length;++a)if(this.__inRect(this._mouse,f._meta.bounds.propertyBounds[a].rect,f.pos,this._viewportCamera)){v=f._meta.bounds.propertyBounds[a];break}if(v)for(var a=0;a<f.properties.length;++a)if(f.properties[a].name===v.name){this.$viewport.attr("title",f.properties[a].options.description?f.properties[a].options.description+"\n":""),this.$viewport.addClass("wcClickable");break}var m;for(var a=0;a<f._meta.bounds.valueBounds.length;++a)if(this.__inRect(this._mouse,f._meta.bounds.valueBounds[a].rect,f.pos,this._viewportCamera)){m=f._meta.bounds.valueBounds[a];break}if(m)for(var a=0;a<f.properties.length;++a)if(f.properties[a].name===m.name){this._highlightNode=f,this._highlightPropertyValue=m,this.$viewport.attr("title",(f.properties[a].options.description?f.properties[a].options.description+"\n":"")+'Click to change the current value of this property.\nValue = "'+f.properties[a].value+'"\n'),this.$viewport.addClass("wcClickable");break}var g;for(var a=0;a<f._meta.bounds.initialBounds.length;++a)if(this.__inRect(this._mouse,f._meta.bounds.initialBounds[a].rect,f.pos,this._viewportCamera)){g=f._meta.bounds.initialBounds[a];break}if(g)for(var a=0;a<f.properties.length;++a)if(f.properties[a].name===g.name){this._highlightNode=f,this._highlightPropertyInitialValue=g,this.$viewport.attr("title",(f.properties[a].options.description?f.properties[a].options.description+"\n":"")+'Click to change the initial value of this property.\nValue = "'+f.properties[a].initialValue+'"\n'),this.$viewport.addClass("wcClickable");break}}if(f._meta.bounds.viewportBounds){var r={x:(n.x-this._viewportCamera.x)/this._viewportCamera.z-(f.pos.x+f._meta.bounds.viewportBounds.left),y:(n.y-this._viewportCamera.y)/this._viewportCamera.z-(f.pos.y+f._meta.bounds.viewportBounds.top)};this.__inRect(this._mouse,f._meta.bounds.viewportBounds,f.pos,this._viewportCamera)?(this._highlightNode=f,this._highlightViewport=!0,this.$viewport.addClass("wcClickable"),h||f.onViewportMouseEnter(e,r,this._options.readOnly),f.onViewportMouseMove(e,r,this._options.readOnly)):h&&f.onViewportMouseLeave(e,r,this._options.readOnly)}}}this._expandedHighlightNode&&this._expandedHighlightNode!==this._highlightNode&&(this._highlightNode||!this.__inRect(n,this._expandedHighlightNode._meta.bounds.farRect,this._expandedHighlightNode.pos,this._viewportCamera))&&(this._expandedSelectedNode!==this._expandedHighlightNode&&this._expandedHighlightNode.collapsed(!0),this._expandedHighlightNode=null);if(!this._expandedHighlightNode&&this._highlightNode&&this.__inRect(n,f._meta.bounds.farRect,f.pos,this._viewportCamera)){this._expandedHighlightNode=this._highlightNode;var i=this;i._expandedHighlightNode.collapsed(!1)}},__onViewportMouseDown:function(e,t){this._mouse=this.__mouse(e,this.$viewport.offset());if(this._mouse.which===3)return;this._mouseMoved=!1;if(e.ctrlKey||this._mouse.which===2){this._highlightRect={top:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z,left:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,oy:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z,ox:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,x:0,y:0,width:0,height:0};return}var n=!1,r=this.__findNodeAtPos(this._mouse,this._viewportCamera);if(r){if(!n&&!this._options.readOnly)for(var i=0;i<r._meta.bounds.entryBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.entryBounds[i].rect,r.pos,this._viewportCamera)){n=!0;if(e.altKey){var s=r.listEntryChains(r._meta.bounds.entryBounds[i].name);s.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Entry Links for "'+r.category+"."+r.type+"."+r._meta.bounds.entryBounds[i].name+'"',{id:r.id,name:r._meta.bounds.entryBounds[i].name,chains:s,engine:this._engine},function(){var e=this.engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.engine.nodeById(this.chains[t].outNodeId),r=this.chains[t].outName;e.connectEntry(this.name,n,r)}},function(){var e=this.engine.nodeById(this.id);e.disconnectEntry(this.name)}),r.disconnectEntry(r._meta.bounds.entryBounds[i].name);break}this._selectedNode=r,this._selectedNodes=[r],this._selectedEntryLink=r._meta.bounds.entryBounds[i],this.$viewport.addClass("wcGrabbing"),this._expandedSelectedNode=this._expandedHighlightNode;break}if(!n&&!this._options.readOnly)for(var i=0;i<r._meta.bounds.exitBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.exitBounds[i].rect,r.pos,this._viewportCamera)){n=!0;if(e.altKey){var s=r.listExitChains(r._meta.bounds.exitBounds[i].name);s.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Exit Links for "'+r.category+"."+r.type+"."+r._meta.bounds.exitBounds[i].name+'"',{id:r.id,name:r._meta.bounds.exitBounds[i].name,chains:s,engine:this._engine},function(){var e=this.engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.engine.nodeById(this.chains[t].inNodeId),r=this.chains[t].inName;e.connectExit(this.name,n,r)}},function(){var e=this.engine.nodeById(this.id);e.disconnectExit(this.name)}),r.disconnectExit(r._meta.bounds.exitBounds[i].name);break}if(e.shiftKey){r.activateExit(r._meta.bounds.exitBounds[i].name);break}this._selectedNode=r,this._selectedNodes=[r],this._selectedExitLink=r._meta.bounds.exitBounds[i],this.$viewport.addClass("wcGrabbing"),this._expandedSelectedNode=this._expandedHighlightNode;break}if(!n&&!this._options.readOnly)for(var i=0;i<r._meta.bounds.inputBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.inputBounds[i].rect,r.pos,this._viewportCamera)){n=!0;if(e.altKey){var s=r.listInputChains(r._meta.bounds.inputBounds[i].name);s.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Property Input Links for "'+r.category+"."+r.type+"."+r._meta.bounds.inputBounds[i].name+'"',{id:r.id,name:r._meta.bounds.inputBounds[i].name,chains:s,engine:this._engine},function(){var e=this.engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.engine.nodeById(this.chains[t].outNodeId),r=this.chains[t].outName;e.connectInput(this.name,n,r)}},function(){var e=this.engine.nodeById(this.id);e.disconnectInput(this.name)}),r.disconnectInput(r._meta.bounds.inputBounds[i].name);break}this._selectedNode=r,this._selectedNodes=[r],this._selectedInputLink=r._meta.bounds.inputBounds[i],this.$viewport.addClass("wcGrabbing"),this._expandedSelectedNode=this._expandedHighlightNode;break}if(!n&&!this._options.readOnly)for(var i=0;i<r._meta.bounds.outputBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.outputBounds[i].rect,r.pos,this._viewportCamera)){n=!0;if(e.altKey){var s=r.listOutputChains(r._meta.bounds.outputBounds[i].name);s.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Property Output Links for "'+r.category+"."+r.type+"."+r._meta.bounds.outputBounds[i].name+'"',{id:r.id,name:r._meta.bounds.outputBounds[i].name,chains:s,engine:this._engine},function(){var e=this.engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.engine.nodeById(this.chains[t].inNodeId),r=this.chains[t].inName;e.connectOutput(this.name,n,r)}},function(){var e=this.engine.nodeById(this.id);e.disconnectOutput(this.name)}),r.disconnectOutput(r._meta.bounds.outputBounds[i].name);break}this._selectedNode=r,this._selectedNodes=[r],this._selectedOutputLink=r._meta.bounds.outputBounds[i],this.$viewport.addClass("wcGrabbing"),this._expandedSelectedNode=this._expandedHighlightNode;break}if(!n&&r._meta.bounds.viewportBounds){var o={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z-r._meta.bounds.viewportBounds.left,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z-r._meta.bounds.viewportBounds.top};this.__inRect(this._mouse,r._meta.bounds.viewportBounds,r.pos,this._viewportCamera)&&(this._selectedNode=r,this._selectedNodes=[r],r.onViewportMouseDown(e,o,this._options.readOnly)&&(n=!0))}if(!n&&this.__inRect(this._mouse,r._meta.bounds.farRect,r.pos,this._viewportCamera)){n=!0;if(!this._selectedNodes.length||this._selectedNodes.indexOf(r)===-1)this._selectedNode=r,this._selectedNodes=[r];this._viewportMovingNode=!this._options.readOnly,this._selectedNodeOrigins=[];for(var i=0;i<this._selectedNodes.length;++i){var u=this._selectedNodes[i];this._selectedNodeOrigins.push({x:u.pos.x,y:u.pos.y})}}}n||(this._viewportMoving=!0,this._viewportMoved=!1)},__onViewportMouseUp:function(e,t){this.$viewport.removeClass("wcGrabbing");if(this._draggingNodeData){var n=this.__mouse(e,this.$viewport.offset(),this._viewportCamera),r=new window[this._draggingNodeData.node.className](this._parent,{x:0,y:0}),i=this._draggingNodeData.node.export();i.id=r.id,i.pos.x=n.x/this._viewportCamera.z+(this._draggingNodeData.$canvas.width()/2+this._draggingNodeData.offset.x),i.pos.y=n.y/this._viewportCamera.z+(this._draggingNodeData.offset.y+5),r.chain.entry.length||(i.y+=this._drawStyle.links.length),r.import(i,[]),this.__onCreateNode(r),this._selectedNode=r,this._selectedNodes=[r],this._expandedHighlightNode=r,r.collapsed(!1),this.__updateNode(r,0,this._viewportContext),this.__drawNode(r,this._viewportContext),this._draggingNodeData.$canvas.remove(),this._draggingNodeData.$canvas=null,this._draggingNodeData=null,this.$palette.removeClass("wcMoving"),this.$viewport.removeClass("wcMoving")}if(this._highlightRect&&this._parent){this._highlightRect=null;return}if(this._selectedNodes.length&&this._selectedNodeOrigins.length){this._undoManager&&this._undoManager.beginGroup("Node(s) moved.");for(var s=0;s<this._selectedNodes.length;++s){var o=this._selectedNodes[s];if(o.pos.x!==this._selectedNodeOrigins[s].x||o.pos.y!==this._selectedNodeOrigins[s].y)o.onMoved({x:this._selectedNodeOrigins[s].x,y:this._selectedNodeOrigins[s].y},{x:o.pos.x,y:o.pos.y}),this._undoManager&&this._undoManager.addEvent('Moved Node "'+o.category+"."+o.type+'"',{id:o.id,start:{x:this._selectedNodeOrigins[s].x,y:this._selectedNodeOrigins[s].y},end:{x:o.pos.x,y:o.pos.y},engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=e.onMoving({x:this.end.x,y:this.end.y},{x:this.start.x,y:this.start.y})||this.start;e.pos.x=this.start.x,e.pos.y=this.start.y,e.onMoved({x:this.end.x,y:this.end.y},{x:t.x,y:t.y})},function(){var e=this.engine.nodeById(this.id),t=e.onMoving({x:this.start.x,y:this.start.y},{x:this.end.x,y:this.end.y})||this.end;e.pos.x=this.end.x,e.pos.y=this.end.y,e.onMoved({x:this.start.x,y:this.start.y},{x:t.x,y:t.y})})}this._undoManager&&this._undoManager.endGroup(),this._selectedNodeOrigins=[]}this._selectedNode&&this._selectedEntryLink&&this._highlightNode&&this._highlightExitLink&&(this._selectedNode.connectEntry(this._selectedEntryLink.name,this._highlightNode,this._highlightExitLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectEntry(this._selectedEntryLink.name,this._highlightNode,this._highlightExitLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Entry Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedEntryLink.name+'" to Exit Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightExitLink.name+'"',{id:this._selectedNode.id,name:this._selectedEntryLink.name,targetId:this._highlightNode.id,targetName:this._highlightExitLink.name,engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.connectEntry(this.name,t,this.targetName)},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.disconnectEntry(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Entry Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedEntryLink.name+'" to Exit Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightExitLink.name+'"',{id:this._selectedNode.id,name:this._selectedEntryLink.name,targetId:this._highlightNode.id,targetName:this._highlightExitLink.name,engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.disconnectEntry(this.name,t,this.targetName)},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.connectEntry(this.name,t,this.targetName)})),this._selectedNode&&this._selectedExitLink&&this._highlightNode&&this._highlightEntryLink&&(this._selectedNode.connectExit(this._selectedExitLink.name,this._highlightNode,this._highlightEntryLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectExit(this._selectedExitLink.name,this._highlightNode,this._highlightEntryLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Exit Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedExitLink.name+'" to Entry Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightEntryLink.name+'"',{id:this._selectedNode.id,name:this._selectedExitLink.name,targetId:this._highlightNode.id,targetName:this._highlightEntryLink.name,engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.connectExit(this.name,t,this.targetName)},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.disconnectExit(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Exit Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedExitLink.name+'" to Entry Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightEntryLink.name+'"',{id:this._selectedNode.id,name:this._selectedExitLink.name,targetId:this._highlightNode.id,targetName:this._highlightEntryLink.name,engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.disconnectExit(this.name,t,this.targetName)},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.connectExit(this.name,t,this.targetName)})),this._selectedNode&&this._selectedInputLink&&this._highlightNode&&this._highlightOutputLink&&(this._selectedNode.connectInput(this._selectedInputLink.name,this._highlightNode,this._highlightOutputLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectInput(this._selectedInputLink.name,this._highlightNode,this._highlightOutputLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Property Input Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedInputLink.name+'" to Property Output Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightOutputLink.name+'"',{id:this._selectedNode.id,name:this._selectedInputLink.name,targetId:this._highlightNode.id,targetName:this._highlightOutputLink.name,engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.connectInput(this.name,t,this.targetName)},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.disconnectInput(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Property Input Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedInputLink.name+'" to Property Output Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightOutputLink.name+'"',{id:this._selectedNode.id,name:this._selectedInputLink.name,targetId:this._highlightNode.id,targetName:this._highlightOutputLink.name,engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.disconnectInput(this.name,t,this.targetName)},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.connectInput(this.name,t,this.targetName)})),this._selectedNode&&this._selectedOutputLink&&this._highlightNode&&this._highlightInputLink&&(this._selectedNode.connectOutput(this._selectedOutputLink.name,this._highlightNode,this._highlightInputLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectOutput(this._selectedOutputLink.name,this._highlightNode,this._highlightInputLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Property Output Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedOutputLink.name+'" to Property Input Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightInputLink.name+'"',{id:this._selectedNode.id,name:this._selectedOutputLink.name,targetId:this._highlightNode.id,targetName:this._highlightInputLink.name,engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.connectOutput(this.name,t,this.targetName)},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.disconnectOutput(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Property Output Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedOutputLink.name+'" to Property Input Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightInputLink.name+'"',{id:this._selectedNode.id,name:this._selectedOutputLink.name,targetId:this._highlightNode.id,targetName:this._highlightInputLink.name,engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.disconnectOutput(this.name,t,this.targetName)},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.connectOutput(this.name,t,this.targetName)}));if(this._selectedNode&&this._highlightViewport){var n=this.__mouse(e,this.$viewport.offset()),u={x:(n.x-this._viewportCamera.x)/this._viewportCamera.z-this._selectedNode._meta.bounds.viewportBounds.left,y:(n.y-this._viewportCamera.y)/this._viewportCamera.z-this._selectedNode._meta.bounds.viewportBounds.top};this._selectedNode.onViewportMouseUp(e,u,this._options.readOnly)}this._expandedSelectedNode&&this._expandedSelectedNode!==this._expandedHighlightNode&&this._expandedSelectedNode.collapsed(!0),this._expandedSelectedNode=null,this._selectedEntryLink=!1,this._selectedExitLink=!1,this._selectedInputLink=!1,this._selectedOutputLink=!1,this._viewportMovingNode=!1,this._viewportMoving&&(this._viewportMoving=!1,this._viewportMoved?(this._viewportMoved=!1,this.$viewport.removeClass("wcMoving")):(this._selectedNode=null,this._selectedNodes=[]))},__onViewportMouseEnter:function(e,t){this._mouseInViewport=!0},__onViewportMouseLeave:function(e,t){this._mouseInViewport=!1},__onViewportMouseClick:function(e,t){if(!this._mouseMoved){if(this._highlightCrumb>-1){if(this._crumbBounds[this._highlightCrumb].parent!==this._parent){var n=this._crumbBounds[this._highlightCrumb+1].parent;this._parent=this._crumbBounds[this._highlightCrumb].parent,this._selectedNode=n,this._selectedNodes=[n],this.focus(this._selectedNodes)}return}this._mouse=this.__mouse(e,this.$viewport.offset());var r=!1,i=this.__findNodeAtPos(this._mouse,this._viewportCamera);if(i){if(this.__inRect(this._mouse,i._meta.bounds.debugLog,i.pos,this._viewportCamera)){var s=!i._log;i.debugLog(s),this._undoManager&&this._undoManager.addEvent((s?"Enabled":"Disabled")+' Debug Logging for Node "'+i.category+"."+i.type+'"',{id:i.id,state:s,engine:this._engine},function(){var e=this.engine.nodeById(this.id);e.debugLog(!this.state)},function(){var e=this.engine.nodeById(this.id);e.debugLog(this.state)})}if(this.__inRect(this._mouse,i._meta.bounds.breakpoint,i.pos,this._viewportCamera)){var s=!i._break;i.debugBreak(s),this._undoManager&&this._undoManager.addEvent((s?"Enabled":"Disabled")+' Breakpoint on Node "'+i.category+"."+i.type+'"',{id:i.id,state:s,engine:this._engine},function(){var e=this.engine.nodeById(this.id);e.debugBreak(!this.state)},function(){var e=this.engine.nodeById(this.id);e.debugBreak(this.state)})}this.__inRect(this._mouse,i._meta.bounds.titleBounds,i.pos,this._viewportCamera)&&this.__drawTitleEditor(i,i._meta.bounds.titleBounds),this.__inRect(this._mouse,i._meta.bounds.detailsBounds,i.pos,this._viewportCamera)&&this.__drawDetailsPopup(i);var o;for(var u=0;u<i._meta.bounds.valueBounds.length;++u)if(this.__inRect(this._mouse,i._meta.bounds.valueBounds[u].rect,i.pos,this._viewportCamera)){o=i._meta.bounds.valueBounds[u];break}if(o)for(var u=0;u<i.properties.length;++u)if(i.properties[u].name===o.name){this.__drawPropertyEditor(i,i.properties[u],o);break}var a;for(var u=0;u<i._meta.bounds.initialBounds.length;++u)if(this.__inRect(this._mouse,i._meta.bounds.initialBounds[u].rect,i.pos,this._viewportCamera)){a=i._meta.bounds.initialBounds[u];break}if(a)for(var u=0;u<i.properties.length;++u)if(i.properties[u].name===a.name){this.__drawPropertyEditor(i,i.properties[u],a,!0);break}if(i._meta.bounds.viewportBounds){var f={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z-i._meta.bounds.viewportBounds.left,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z-i._meta.bounds.viewportBounds.top};this.__inRect(this._mouse,i._meta.bounds.viewportBounds,i.pos,this._viewportCamera)&&i.onViewportMouseClick(e,f,this._options.readOnly)}}}},__onViewportMouseDoubleClick:function(e,t){this._mouse=this.__mouse(e,this.$viewport.offset());var n=!1,r=this.__findNodeAtPos(this._mouse,this._viewportCamera);if(r){this.__inRect(this._mouse,r._meta.bounds.debugLog,r.pos,this._viewportCamera)&&(n=!0),this.__inRect(this._mouse,r._meta.bounds.breakpoint,r.pos,this._viewportCamera)&&(n=!0);for(var i=0;i<r._meta.bounds.valueBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.valueBounds[i].rect,r.pos,this._viewportCamera)){n=!0;break}if(!this._options.readOnly&&!n)for(var i=0;i<r._meta.bounds.entryBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.entryBounds[i].rect,r.pos,this._viewportCamera)){n=!0,r.activateEntry(r._meta.bounds.entryBounds[i].name);break}if(!this._options.readOnly&&!n)for(var i=0;i<r._meta.bounds.exitBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.exitBounds[i].rect,r.pos,this._viewportCamera)){n=!0,r.activateExit(r._meta.bounds.exitBounds[i].name);break}if(!this._options.readOnly&&!n)for(var i=0;i<r._meta.bounds.outputBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.outputBounds[i].rect,r.pos,this._viewportCamera)){n=!0,r.property(r._meta.bounds.outputBounds[i].name,r.property(r._meta.bounds.outputBounds[i].name),!0);break}if(!n&&r._meta.bounds.viewportBounds){var s={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z-r._meta.bounds.viewportBounds.left,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z-r._meta.bounds.viewportBounds.top};this.__inRect(this._mouse,r._meta.bounds.viewportBounds,r.pos,this._viewportCamera)&&(n=r.onViewportMouseDoubleClick(e,s,this._options.readOnly))}if(!n&&this.__inRect(this._mouse,r._meta.bounds.inner,r.pos,this._viewportCamera)){n=!0;if(r instanceof wcNodeCompositeScript)this._parent=r,this._selectedNode=null,this._selectedNodes=[],this.center();else if(r instanceof wcNodeComposite&&this._parent instanceof wcNodeCompositeScript){var o=this._parent;this._parent=this._parent._parent,this._selectedNode=o,this._selectedNodes=[o],this.focus(this._selectedNodes)}else r instanceof wcNodeEntry&&r.onActivated()}}},__onViewportMouseWheel:function(e,t){var n=this._viewportCamera.z;if(this._highlightNode&&this._highlightNode._meta.bounds.viewportBounds){var r={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z-this._highlightNode._meta.bounds.viewportBounds.left,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z-this._highlightNode._meta.bounds.viewportBounds.top};if(this.__inRect(this._mouse,this._highlightNode._meta.bounds.viewportBounds,this._highlightNode.pos,this._viewportCamera)&&this._highlightNode.onViewportMouseWheel(e,r,e.originalEvent.wheelDelta>0||e.originalEvent.detail<0,this._options.readOnly))return}e.originalEvent.wheelDelta>0||e.originalEvent.detail<0?this._viewportCamera.z=Math.min(this._viewportCamera.z*1.25,5):this._viewportCamera.z=Math.max(this._viewportCamera.z*.75,.1),this._viewportCamera.x=(this._viewportCamera.x-this._mouse.x)/(n/this._viewportCamera.z)+this._mouse.x,this._viewportCamera.y=(this._viewportCamera.y-this._mouse.y)/(n/this._viewportCamera.z)+this._mouse.y},__findNodeAtPos:function(e,t,n){if(this._parent){var r=this;function i(n){for(var i=n.length-1;i>=0;--i)if(n[i]._meta.bounds&&r.__inRect(e,n[i]._meta.bounds.farRect,n[i].pos,t))return n[i];return null}return n===undefined?i(this._parent._storageNodes)||i(this._parent._compositeNodes)||i(this._parent._processNodes)||i(this._parent._entryNodes):i(n)}return null},__findCategoryAreaAtPos:function(e){for(var t in this._nodeLibrary)for(var n in this._nodeLibrary[t]){if(!this.$typeButton[this.__typeIndex(n)].hasClass("wcToggled"))continue;var r=this._nodeLibrary[t][n];if(r.$button.hasClass("wcToggled"))continue;var i=r.$canvas.offset();i.width=r.$canvas.width(),i.height=r.$canvas.height();if(this.__inRect(e,i))return r}}}