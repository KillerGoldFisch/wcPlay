/*!
 * Web Cabin Play - Node based visual scripting tool.
 *
 * Dependancies:
 *  JQuery 1.11.1
 *  font-awesome 4.2.0
 *  wcMenu
 * Optional Dependencies:
 *  FileSaver.js
 *  wcUndoManager
 *
 * Author: Jeff Houde (lochemage@webcabin.org)
 * Web: http://play.webcabin.org/
 * API: http://play.api.webcabin.org/
 *
 * Licensed under
 *   MIT License http://www.opensource.org/licenses/mit-license
 *
 */
function wcPlayEditor(e,t){this.$container=$(e),this.$typeButton=[],this.$typeArea=[],this._paletteSize=0,this._chainStyle=1,this._chainStyleMax=1,this._showingSelector=!1,this._menu=null,this._size={x:0,y:0},this._engine=null,this._parent=null,this._nodeLibrary=[],this._eventHandlers={onBeforeSave:null,onSaved:null,onBeforeLoad:null,onLoaded:null,onBeforeImport:null,onImported:null},this._font={breadcrumbs:{size:10,family:"Arial",weight:"bold"},title:{size:13,family:"Arial",weight:"bold"},titleDesc:{size:10,family:"Arial",weight:"italic"},details:{size:9,family:"Arial",weight:"bold"},links:{size:9,family:"Arial"},property:{size:9,family:"Arial",weight:"italic"},value:{size:9,family:"Arial",weight:"bold"},initialValue:{size:9,family:"Arial",weight:"bold italic"},propertyHeader:{size:8,family:"Arial",weight:"bold italic"}},this._drawStyle={palette:{spacing:10,scale:.7,width:0},palettePopup:{padding:5,searchOffset:44,width:300,height:400},node:{radius:7,margin:14},title:{spacing:5,wrapL:"  ",wrapR:"  ",placeholder:"  ",nameWrapL:" (",nameWrapR:") ",details:" [?] "},links:{length:10,width:7,spacing:7,padding:5,margin:7},property:{spacing:5,strLen:20,longStrLen:43,minLength:30,valueWrapL:" [",valueWrapR:"] ",initialWrapL:" ",initialWrapR:" ",highlightColor:"rgba(255, 255, 255, 0.5)",normalColor:"rgba(255, 255, 255, 0.5)",headerColor:"rgba(255, 255, 255, 0.2)",highlightBorder:-1,normalBorder:1,headerBorder:-1,headerSpace:5}},this._lastUpdate=0,this._viewportCamera={x:0,y:0,z:1},this._viewportBounds={left:0,top:0,width:0,height:0},this._viewportMovingNode=!1,this._viewportMoving=!1,this._viewportMoved=!1,this._paletteMoving=!1,this._autoScrollDirection={x:0,y:0},this._autoScrollInterval=0,this._autoScrollNodes=!1,this._mouse={x:0,y:0},this._mouseInViewport=!1,this._highlightRect=null,this._highlightNode=null,this._selectedNode=null,this._selectedNodes=[],this._highlightTitle=!1,this._highlightDetails=!1,this._highlightDebugLog=!1,this._highlightBreakpoint=!1,this._highlightEntryLink=!1,this._highlightExitLink=!1,this._highlightInputLink=!1,this._highlightOutputLink=!1,this._highlightPropertyValue=!1,this._highlightPropertyInitialValue=!1,this._highlightViewport=!1,this._selectedEntryLink=!1,this._selectedExitLink=!1,this._selectedInputLink=!1,this._selectedOutputLink=!1,this._selectedNodeOrigins=[],this._highlightCrumb=-1,this._crumbBounds=[],this._undoManager=null,this._options={readOnly:!1,playable:!0,category:{items:[],isBlacklist:!0}};for(var n in t)this._options[n]=t[n];this.$top=$('<div class="wcPlayEditorTop" tabindex="1">'),this.$main=$('<div class="wcPlayEditorMain" tabindex="1" oncontextmenu="return false;">'),this.$palette=$('<div class="wcPlayPalette wcPlayNoHighlights" tabindex="1">'),this.$paletteScroller=$('<div class="wcPlayPaletteScroller" tabindex="1">'),this.$paletteInner=$('<div class="wcPlayPaletteInner" tabindex="1">'),this.$viewport=$('<canvas class="wcPlayViewport" tabindex="1">'),this._viewportContext=this.$viewport[0].getContext("2d"),this.$palette.append(this.$paletteScroller),this.$paletteScroller.append(this.$paletteInner),this.$main.append(this.$viewport),this.$container.append(this.$top),this.$container.append(this.$main),this.$search=$('<div class="wcPlayEditorSearch wcPlayHidden"><span>Search</span><input type="text"/><i class="fa fa-chevron-up wcPlayEditorSearchPrev"/><i class="fa fa-chevron-down wcPlayEditorSearchNext"/></div>'),this.$hiddenFileLoader=$('<input type="file" id="wcPlayEditorHiddenFileLoader"/>'),this.$hiddenFileImporter=$('<input type="file" id="wcPlayEditorHiddenFileImporter"/>'),this.$container.append(this.$search),this.onResized(),this.__setupMenu(),this.__setupControls(),this.$top.focus(),window.requestAnimationFrame(this.__update.bind(this))}!function(e){"use strict";function t(){console.log.apply(console,arguments)}function n(e,t){var n,r,i,s;for(this.list=e,this.options=t=t||{},n=0,s=["sort","shouldSort","verbose","tokenize"],r=s.length;r>n;n++)i=s[n],this.options[i]=i in t?t[i]:o[i];for(n=0,s=["searchFn","sortFn","keys","getFn","include","tokenSeparator"],r=s.length;r>n;n++)i=s[n],this.options[i]=t[i]||o[i]}function r(e,t,n){var s,o,u,a,f,l;if(t){if(u=t.indexOf("."),-1!==u?(s=t.slice(0,u),o=t.slice(u+1)):s=t,a=e[s],null!==a&&void 0!==a)if(o||"string"!=typeof a&&"number"!=typeof a)if(i(a))for(f=0,l=a.length;l>f;f++)r(a[f],o,n);else o&&r(a,o,n);else n.push(a)}else n.push(e);return n}function i(e){return"[object Array]"===Object.prototype.toString.call(e)}function s(e,t){t=t||{},this.options=t,this.options.location=t.location||s.defaultOptions.location,this.options.distance="distance"in t?t.distance:s.defaultOptions.distance,this.options.threshold="threshold"in t?t.threshold:s.defaultOptions.threshold,this.options.maxPatternLength=t.maxPatternLength||s.defaultOptions.maxPatternLength,this.pattern=t.caseSensitive?e:e.toLowerCase(),this.patternLen=e.length,this.patternLen<=this.options.maxPatternLength&&(this.matchmask=1<<this.patternLen-1,this.patternAlphabet=this._calculatePatternAlphabet())}var o={id:null,caseSensitive:!1,include:[],shouldSort:!0,searchFn:s,sortFn:function(e,t){return e.score-t.score},getFn:r,keys:[],verbose:!1,tokenize:!1,tokenSeparator:/ +/g};n.VERSION="2.4.1",n.prototype.set=function(e){return this.list=e,e},n.prototype.search=function(e){this.options.verbose&&t("\nSearch term:",e,"\n"),this.pattern=e,this.results=[],this.resultMap={},this._keyMap=null,this._prepareSearchers(),this._startSearch(),this._computeScore(),this._sort();var n=this._format();return n},n.prototype._prepareSearchers=function(){var e=this.options,t=this.pattern,n=e.searchFn,r=t.split(e.tokenSeparator),i=0,s=r.length;if(this.options.tokenize)for(this.tokenSearchers=[];s>i;i++)this.tokenSearchers.push(new n(r[i],e));this.fullSeacher=new n(t,e)},n.prototype._startSearch=function(){var e,t,n,r,i=this.options,s=i.getFn,o=this.list,u=o.length,a=this.options.keys,f=a.length,l=null;if("string"==typeof o[0])for(n=0;u>n;n++)this._analyze("",o[n],n,n);else for(this._keyMap={},n=0;u>n;n++)for(l=o[n],r=0;f>r;r++){if(e=a[r],"string"!=typeof e){if(t=1-e.weight||1,this._keyMap[e.name]={weight:t},e.weight<=0||e.weight>1)throw new Error("Key weight has to be > 0 and <= 1");e=e.name}else this._keyMap[e]={weight:1};this._analyze(e,s(l,e,[]),l,n)}},n.prototype._analyze=function(e,n,r,s){var o,u,a,f,l,c,h,p,d,v,m,g,y,b=this.options,w=!1;if(void 0!==n&&null!==n)if(u=[],"string"==typeof n){if(o=n.split(b.tokenSeparator),b.verbose&&t("---------\nKey:",e),this.options.tokenize){for(g=0;g<this.tokenSearchers.length;g++){for(p=this.tokenSearchers[g],b.verbose&&t("Pattern:",p.pattern),d=[],y=0;y<o.length;y++){v=o[y],m=p.search(v);var E={};m.isMatch?(E[v]=m.score,w=!0,u.push(m.score)):(E[v]=1,u.push(1)),d.push(E)}b.verbose&&t("Token scores:",d)}for(f=u[0],c=u.length,g=1;c>g;g++)f+=u[g];f/=c,b.verbose&&t("Token score average:",f)}h=this.fullSeacher.search(n),b.verbose&&t("Full text score:",h.score),l=h.score,void 0!==f&&(l=(l+f)/2),b.verbose&&t("Score average:",l),(w||h.isMatch)&&(a=this.resultMap[s],a?a.output.push({key:e,score:l,matchedIndices:h.matchedIndices}):(this.resultMap[s]={item:r,output:[{key:e,score:l,matchedIndices:h.matchedIndices}]},this.results.push(this.resultMap[s])))}else if(i(n))for(g=0;g<n.length;g++)this._analyze(e,n[g],r,s)},n.prototype._computeScore=function(){var e,n,r,i,s,o,u,a,f,l=this._keyMap,c=this.results;for(this.options.verbose&&t("\n\nComputing score:\n"),e=0;e<c.length;e++){for(r=0,i=c[e].output,s=i.length,a=1,n=0;s>n;n++)o=i[n].score,u=l?l[i[n].key].weight:1,f=o*u,1!==u?a=Math.min(a,f):(r+=f,i[n].nScore=f);1===a?c[e].score=r/s:c[e].score=a,this.options.verbose&&t(c[e])}},n.prototype._sort=function(){var e=this.options;e.shouldSort&&(e.verbose&&t("\n\nSorting...."),this.results.sort(e.sortFn))},n.prototype._format=function(){var e,n,r,i,s,o=this.options,u=o.getFn,a=[],f=this.results,l=o.include;for(o.verbose&&t("\n\nOutput:\n\n",f),i=o.id?function(e){f[e].item=u(f[e].item,o.id,[])[0]}:function(){},s=function(e){var t,n,r,i,s,o=f[e];if(l.length>0){if(t={item:o.item},-1!==l.indexOf("matches"))for(r=o.output,t.matches=[],n=0;n<r.length;n++)i=r[n],s={indices:i.matchedIndices},i.key&&(s.key=i.key),t.matches.push(s);-1!==l.indexOf("score")&&(t.score=f[e].score)}else t=o.item;return t},n=0,r=f.length;r>n;n++)i(n),e=s(n),a.push(e);return a},s.defaultOptions={location:0,distance:100,threshold:.6,maxPatternLength:32},s.prototype._calculatePatternAlphabet=function(){var e={},t=0;for(t=0;t<this.patternLen;t++)e[this.pattern.charAt(t)]=0;for(t=0;t<this.patternLen;t++)e[this.pattern.charAt(t)]|=1<<this.pattern.length-t-1;return e},s.prototype._bitapScore=function(e,t){var n=e/this.patternLen,r=Math.abs(this.options.location-t);return this.options.distance?n+r/this.options.distance:r?1:n},s.prototype.search=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x=this.options;if(e=x.caseSensitive?e:e.toLowerCase(),this.pattern===e)return{isMatch:!0,score:0,matchedIndices:[[0,e.length-1]]};if(this.patternLen>x.maxPatternLength){if(g=e.match(new RegExp(this.pattern.replace(x.tokenSeparator,"|"))),y=!!g)for(w=[],t=0,E=g.length;E>t;t++)S=g[t],w.push([e.indexOf(S),S.length-1]);return{isMatch:y,score:y?.5:1,matchedIndices:w}}for(i=x.location,r=e.length,s=x.threshold,o=e.indexOf(this.pattern,i),b=[],t=0;r>t;t++)b[t]=0;for(-1!=o&&(s=Math.min(this._bitapScore(0,o),s),o=e.lastIndexOf(this.pattern,i+this.patternLen),-1!=o&&(s=Math.min(this._bitapScore(0,o),s))),o=-1,v=1,m=[],f=this.patternLen+r,t=0;t<this.patternLen;t++){for(u=0,a=f;a>u;)this._bitapScore(t,i+a)<=s?u=a:f=a,a=Math.floor((f-u)/2+u);for(f=a,l=Math.max(1,i-a+1),c=Math.min(i+a,r)+this.patternLen,h=Array(c+2),h[c+1]=(1<<t)-1,n=c;n>=l;n--)if(d=this.patternAlphabet[e.charAt(n-1)],d&&(b[n-1]=1),0===t?h[n]=(h[n+1]<<1|1)&d:h[n]=(h[n+1]<<1|1)&d|((p[n+1]|p[n])<<1|1)|p[n+1],h[n]&this.matchmask&&(v=this._bitapScore(t,n-1),s>=v)){if(s=v,o=n-1,m.push(o),!(o>i))break;l=Math.max(1,2*i-o)}if(this._bitapScore(t+1,i)>s)break;p=h}return w=this._getMatchedIndices(b),{isMatch:o>=0,score:0===v?.001:v,matchedIndices:w}},s.prototype._getMatchedIndices=function(e){for(var t,n=[],r=-1,i=-1,s=0,o=e.length;o>s;s++)t=e[s],t&&-1===r?r=s:t||-1===r||(i=s-1,n.push([r,i]),r=-1);return e[s-1]&&n.push([r,s-1]),n},"object"==typeof exports?module.exports=n:"function"==typeof define&&define.amd?define(function(){return n}):e.Fuse=n}(this),window.wcPlayEditorClipboard={bounds:{top:0,left:0,width:0,height:0},nodes:[]},wcPlayEditor.prototype={isModified:function(){return this._engine&&this._engine._undoManager?this._engine._undoManager.isModified():!1},clearModified:function(){this._engine&&this._engine._undoManager&&this._engine._undoManager.clearModified()},engine:function(e){if(e!==undefined&&e!==this._engine){if(this._engine){var t=this._engine._editors.indexOf(this);t>-1&&this._engine._editors.splice(t,1),this._engine._undoManager=this._undoManager,this._undoManager=null}this._engine=e,this._parent=e,this.__setupPalette(),this.center(),this._engine&&(this._engine._editors.push(this),this._undoManager=this._engine._undoManager,!this._undoManager&&window.wcUndoManager&&(this._undoManager=new wcUndoManager,this._engine._undoManager=this._undoManager))}return this._engine},menu:function(){return this._menu},center:function(){this._parent&&this.focus(this._parent._entryNodes.concat(this._parent._processNodes,this._parent._storageNodes,this._parent._compositeNodes))},focus:function(e){if(e.length){this.__updateNodes(e,0,this._viewportContext),this.__drawNodes(e,this._viewportContext);var t=[],n=[];for(var r=0;r<e.length;++r)t.push(e[r]._meta.bounds.farRect),n.push(e[r].pos);var i=this.__expandRect(t,n);i.width<1e3&&(i.left-=(1e3-i.width)/2,i.width=1e3),this.focusRect(i)}},focusRect:function(e){var t=this.$viewport.width()?this.$viewport.width()/(e.width+100):1,n=this.$viewport.height()?this.$viewport.height()/(e.height+100):1;this._viewportCamera.z=Math.min(t,n),t>n?e.left-=(this.$viewport.width()/n-(e.width+100))/2:e.top-=(this.$viewport.height()/t-(e.height+100))/2,this._viewportCamera.x=-(e.left-50)*this._viewportCamera.z,this._viewportCamera.y=-(e.top-50)*this._viewportCamera.z},triggerEvent:function(e,t){this._eventHandlers.hasOwnProperty(e)&&this._eventHandlers[e]&&this._eventHandlers[e].apply(this,t)},onBeforeSave:function(e){return typeof e!="function"?(console.log("Failed to bind event handler for onBeforeSave, argument must be a function!"),!1):(this._eventHandlers.onBeforeSave=e,!0)},onSaved:function(e){return typeof e!="function"?(console.log("Failed to bind event handler for onSaved, argument must be a function!"),!1):(this._eventHandlers.onSaved=e,!0)},onBeforeLoad:function(e){return typeof e!="function"?(console.log("Failed to bind event handler for onBeforeLoad, argument must be a function!"),!1):(this._eventHandlers.onBeforeLoad=e,!0)},onLoaded:function(e){return typeof e!="function"?(console.log("Failed to bind event handler for onLoaded, argument must be a function!"),!1):(this._eventHandlers.onLoaded=e,!0)},onBeforeImport:function(e){return typeof e!="function"?(console.log("Failed to bind event handler for onBeforeImport, argument must be a function!"),!1):(this._eventHandlers.onBeforeImport=e,!0)},onImported:function(e){return typeof e!="function"?(console.log("Failed to bind event handler for onImported, argument must be a function!"),!1):(this._eventHandlers.onImported=e,!0)},onBeginUndoGroup:function(e){this._undoManager&&this._undoManager.beginGroup(e)},onEndUndoGroup:function(){this._undoManager&&this._undoManager.endGroup()},onResized:function(){var e=this.$main.width(),t=this.$main.height();if(this._size.x!==e||this._size.y!==t||this._size.z!==this._paletteSize)this._size.x=e,this._size.y=t,this._size.z=this._paletteSize,this.$palette.css("width",this._size.z).attr("width",this._size.z).attr("height",t),this.$viewport.css("width",e-this._size.z).attr("width",e-this._size.z).attr("height",t);this._viewportBounds.top=-this._viewportCamera.y/this._viewportCamera.z,this._viewportBounds.left=-this._viewportCamera.x/this._viewportCamera.z,this._viewportBounds.width=this._size.x/this._viewportCamera.z,this._viewportBounds.height=this._size.y/this._viewportCamera.z},onDisconnectEntryChains:function(e,t){var n=e.listEntryChains(t);n.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Entry Links for "'+e.category+"."+e.type+"."+t+'"',{id:e.id,name:t,chains:n,engine:this._engine},function(){var e=this.engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.engine.nodeById(this.chains[t].outNodeId),r=this.chains[t].outName;e.connectEntry(this.name,n,r)}},function(){var e=this.engine.nodeById(this.id);e.disconnectEntry(this.name)}),e.disconnectEntry(t)},onDisconnectExitChains:function(e,t){var n=e.listExitChains(t);n.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Exit Links for "'+e.category+"."+e.type+"."+t+'"',{id:e.id,name:t,chains:n,engine:this._engine},function(){var e=this.engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.engine.nodeById(this.chains[t].inNodeId),r=this.chains[t].inName;e.connectExit(this.name,n,r)}},function(){var e=this.engine.nodeById(this.id);e.disconnectExit(this.name)}),e.disconnectExit(t)},onDisconnectInputChains:function(e,t){var n=e.listInputChains(t);n.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Property Input Links for "'+e.category+"."+e.type+"."+t+'"',{id:e.id,name:t,chains:n,engine:this._engine},function(){var e=this.engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.engine.nodeById(this.chains[t].outNodeId),r=this.chains[t].outName;e.connectInput(this.name,n,r)}},function(){var e=this.engine.nodeById(this.id);e.disconnectInput(this.name)}),e.disconnectInput(t)},onDisconnectOutputChains:function(e,t){var n=e.listOutputChains(t);n.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Property Output Links for "'+e.category+"."+e.type+"."+t+'"',{id:e.id,name:t,chains:n,engine:this._engine},function(){var e=this.engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.engine.nodeById(this.chains[t].inNodeId),r=this.chains[t].inName;e.connectOutput(this.name,n,r)}},function(){var e=this.engine.nodeById(this.id);e.disconnectOutput(this.name)}),e.disconnectOutput(t)},__mouse:function(e,t,n){if(e.originalEvent&&(e.originalEvent.touches||e.originalEvent.changedTouches)){var r=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0];return{x:r.clientX-(t?t.left:0)-(n?n.x:0),y:r.clientY-(t?t.top:0)-(n?n.y:0),gx:r.clientX,gy:r.clientY,which:1}}return{x:(e.clientX||e.pageX)-(t?t.left:0)-(n?n.x:0),y:(e.clientY||e.pageY)-(t?t.top:0)-(n?n.y:0),gx:e.clientX||e.pageX,gy:e.clientY||e.pageY,which:e.which||1}},__setCanvasFont:function(e,t){t.font=(e.weight?e.weight+" ":"")+(e.size+"px ")+e.family},__clampString:function(e,t){return e.length>t?e.substr(0,t)+"...":e},__blendColors:function(e,t,n){var r=n<0?n*-1:n,i=Math.round,s=parseInt;if(e.length>7){var o=e.split(","),u=(t?t:n<0?"rgb(0,0,0)":"rgb(255,255,255)").split(","),a=s(o[0].slice(4)),f=s(o[1]),l=s(o[2]);return"rgb("+(i((s(u[0].slice(4))-a)*r)+a)+","+(i((s(u[1])-f)*r)+f)+","+(i((s(u[2])-l)*r)+l)+")"}var o=s(e.slice(1),16),u=s((t?t:n<0?"#000000":"#FFFFFF").slice(1),16),c=o>>16,h=o>>8&255,p=o&255;return"#"+(16777216+(i(((u>>16)-c)*r)+c)*65536+(i(((u>>8&255)-h)*r)+h)*256+(i(((u&255)-p)*r)+p)).toString(16).slice(1)},__expandRect:function(e,t){var n={top:e[0].top+(t?t[0].y:0),left:e[0].left+(t?t[0].x:0),width:e[0].width,height:e[0].height};for(var r=1;r<e.length;++r){var i=0,s=0;t&&(i=t[r].x,s=t[r].y),e[r].top+s<n.top&&(n.top=e[r].top+s),e[r].left+i<n.left&&(n.left=e[r].left+i)}for(var r=0;r<e.length;++r){var i=0,s=0;t&&(i=t[r].x,s=t[r].y),e[r].top+s+e[r].height>n.top+n.height&&(n.height=e[r].top+s+e[r].height-n.top),e[r].left+i+e[r].width>n.left+n.width&&(n.width=e[r].left+i+e[r].width-n.left)}return n},__inRect:function(e,t,n,r){return n===undefined&&(n={x:0,y:0}),r===undefined&&(r={x:0,y:0,z:1}),(e.y-r.y)/r.z>=n.y+t.top&&(e.x-r.x)/r.z>=n.x+t.left&&(e.y-r.y)/r.z<=n.y+t.top+t.height&&(e.x-r.x)/r.z<=n.x+t.left+t.width?!0:!1},__rectOnRect:function(e,t,n){return n===undefined&&(n={x:0,y:0}),!(t.left>n.x+e.left+e.width||t.left+t.width<n.x+e.left||t.top>n.y+e.top+e.height||t.top+t.height<n.y+e.top)},__drawRoundedRect:function(e,t,n,r,i,s){s||(s={x:0,y:0}),i.save(),i.strokeStyle=t,i.fillStyle=t,i.lineWidth=n>0?n:1,i.beginPath(),i.moveTo(s.x+e.left+r,s.y+e.top),i.arcTo(s.x+e.left+e.width,s.y+e.top,s.x+e.left+e.width,s.y+e.top+r,r),i.arcTo(s.x+e.left+e.width,s.y+e.top+e.height,s.x+e.left+e.width-r,s.y+e.top+e.height,r),i.arcTo(s.x+e.left,s.y+e.top+e.height,s.x+e.left,s.y+e.top+e.height-r,r),i.arcTo(s.x+e.left,s.y+e.top,s.x+e.left+r,s.y+e.top,r),i.closePath(),n==-1?i.fill():i.stroke(),i.restore()},__update:function(e){this._lastUpdate||(this._lastUpdate=e);var t=(e-this._lastUpdate)/1e3;this._lastUpdate=e,this.onResized(),this._menu.update();if(this._parent){this._viewportContext.clearRect(0,0,this.$viewport.width(),this.$viewport.height()),this._viewportContext.save(),this._viewportContext.translate(this._viewportCamera.x,this._viewportCamera.y),this._viewportContext.scale(this._viewportCamera.z,this._viewportCamera.z),this.__updateNodes(this._parent._entryNodes,t,this._viewportContext),this.__updateNodes(this._parent._processNodes,t,this._viewportContext),this.__updateNodes(this._parent._storageNodes,t,this._viewportContext),this.__updateNodes(this._parent._compositeNodes,t,this._viewportContext),this.__drawNodes(this._parent._entryNodes,this._viewportContext),this.__drawNodes(this._parent._processNodes,this._viewportContext),this.__drawNodes(this._parent._compositeNodes,this._viewportContext),this.__drawNodes(this._parent._storageNodes,this._viewportContext),this.__drawChains(this._parent._entryNodes,this._viewportContext),this.__drawChains(this._parent._processNodes,this._viewportContext),this.__drawChains(this._parent._compositeNodes,this._viewportContext),this.__drawChains(this._parent._storageNodes,this._viewportContext);if(this._highlightRect){var n=Math.min(10,this._highlightRect.width/2,this._highlightRect.height/2);this.__drawRoundedRect(this._highlightRect,"rgba(0, 255, 255, 0.25)",-1,n,this._viewportContext),this.__drawRoundedRect(this._highlightRect,"darkcyan",2,n,this._viewportContext)}this._viewportContext.restore();var r=[],i=[],s=this._parent;while(!s||!s.instanceOf("wcPlay"))r.unshift(s),i.unshift(s.type+(s.name?" ("+s.name+")":"")),s=s._parent;r.unshift(this._engine),i.unshift("Root"),this._viewportContext.fillStyle="black",this.__setCanvasFont(this._font.breadcrumbs,this._viewportContext),this._crumbBounds=[];var o=2;for(var u=0;u<i.length;++u){var a=this._viewportContext.measureText(i[u]).width,f=this._viewportContext.measureText(" / ").width,l={rect:{top:0,left:o,width:a+6,height:this._font.breadcrumbs.size+this._drawStyle.property.spacing},parent:r[u]};this._crumbBounds.push(l),o+=a+f,this._highlightCrumb===u&&(this.__drawRoundedRect(l.rect,"rgba(0, 255, 255, 0.25)",-1,3,this._viewportContext),this.__drawRoundedRect(l.rect,"darkcyan",2,3,this._viewportContext))}this._viewportContext.fillText(i.join(" / "),5,this._font.breadcrumbs.size)}window.requestAnimationFrame(this.__update.bind(this))},__updateNodes:function(e,t,n){for(var r=0;r<e.length;++r)this.__updateNode(e[r],t,n)},__updateNode:function(e,t,n){function i(e,n,i,s,o){return o=o||{},e.flash||o.forceActive?(e.flashDelta+=t*10,e.flashDelta>=1&&(e.flashDelta=1,!e.awake&&(!e.broken||!o.keepBroken&&!r._engine.paused())&&(e.flash=!1))):e.flashDelta>0&&(e.flashDelta-=t*5,e.flashDelta<=0&&(e.flashDelta=0,e.broken=o.keepBroken?e.broken:e.broken-1)),e.color=r.__blendColors(n,e.broken?s:i,e.flashDelta*(o.colorMul||1)),e.flash}e.onDraw();var r=this,s="#000000",o="#FFFFFF",u="#117711",a="#FFFF00",f=!1;if(this._engine._queuedProperties.length===0){for(var l=0;l<e.chain.entry.length;++l)i(e.chain.entry[l].meta,s,a,a,{colorMul:.9});for(var l=0;l<e.chain.exit.length;++l)i(e.chain.exit[l].meta,s,a,a,{colorMul:.9})}else for(var l=0;l<e.chain.entry.length;++l)if(e.chain.entry[l].meta.flash||e.chain.entry[l].meta.flashDelta>0){f=!0;break}for(var l=0;l<e.properties.length;++l)i(e.properties[l].inputMeta,u,a,a,{colorMul:.9}),i(e.properties[l].outputMeta,u,a,a,{colorMul:.9});var c=e.color;this._highlightNode===e&&(c=this.__blendColors(e.color,o,.25)),i(e._meta,c,o,o,{keepBroken:!0,forceActive:f,colorMul:.5});if(e._meta.dirty){e._meta.dirty=!1,e._meta.bounds={node:e};var h=this.__measureEntryLinkOuter(e,n),p=this.__measureOuter(e,n,h.height),d=this.__measureExitLinkOuter(e,n,h.height+p.height),v=this.__expandRect([h,p,d]);v.top=p.top,v.height=p.height,v.propWidth=p.propWidth,v.valueWidth=p.valueWidth,v.initialWidth=p.initialWidth,e._meta.bounds.entryOuter=h,e._meta.bounds.exitOuter=d,e._meta.bounds.centerOuter=p,e._meta.bounds.rect=this.__expandRect([h,p,d]),e._meta.bounds.inner=this.__expandRect([p]),e._meta.bounds.inner.left=e._meta.bounds.rect.left,e._meta.bounds.inner.width=e._meta.bounds.rect.width,e._meta.bounds.rect.top-=3,e._meta.bounds.rect.left-=this._drawStyle.links.length+3,e._meta.bounds.rect.width+=this._drawStyle.links.length*2+6,e._meta.bounds.rect.height+=6,e.chain.entry.length?(e._meta.bounds.inner.top-=this._drawStyle.links.padding+this._font.links.size,e._meta.bounds.inner.height+=this._drawStyle.links.padding+this._font.links.size):(e._meta.bounds.rect.top-=this._drawStyle.links.length,e._meta.bounds.rect.height+=this._drawStyle.links.length),e.chain.exit.length?e._meta.bounds.inner.height+=this._drawStyle.links.padding+this._font.links.size:e._meta.bounds.rect.height+=this._drawStyle.links.length;var m=e._meta.bounds.inner.width-this._drawStyle.node.margin*2-v.propWidth;if(m>v.valueWidth+v.initialWidth){var g=(m-(v.valueWidth+v.initialWidth))/2;v.valueWidth+=g,v.initialWidth+=g}this.__measureCenter(e,n,v),this.__measureEntryLinks(e,n,h.width),this.__measureExitLinks(e,n,h.height+p.height,d.width),e._meta.bounds.farRect={top:e._meta.bounds.inner.top-30,left:e._meta.bounds.inner.left-30,width:e._meta.bounds.inner.width+60,height:e._meta.bounds.inner.height+60},e._meta.bounds.debugLog={left:e._meta.bounds.inner.left+4,top:e._meta.bounds.inner.top+4+(e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0),width:this._drawStyle.node.margin-5,height:this._font.title.size-4},e._meta.bounds.breakpoint={left:e._meta.bounds.inner.left+e._meta.bounds.inner.width-this._drawStyle.node.margin+2,top:e._meta.bounds.inner.top+4+(e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0),width:this._drawStyle.node.margin-5,height:this._font.title.size-4}}},__typeIndex:function(e){switch(e){case wcPlay.NODE.ENTRY:return 0;case wcPlay.NODE.PROCESS:return 1;case wcPlay.NODE.STORAGE:return 2;case wcPlay.NODE.COMPOSITE:return 3}},__setupMenu:function(){function e(e){wcPlayEditorClipboard.nodes=[];var t=[],n=[];for(var r=0;r<e._selectedNodes.length;++r){var i=e._selectedNodes[r],s=i.export();t.push(i._meta.bounds.farRect),n.push(i.pos),wcPlayEditorClipboard.nodes.push(s)}wcPlayEditorClipboard.bounds=e.__expandRect(t,n)}function u(){i&&(r=i.nodesBySearch(s),r.length>0&&(t._parent=r[o]._parent,t.focus([r[o]]),t._selectedNodes=r))}function a(){r.length&&(o-=1,o<0&&(o=r.length-1),t._parent=r[o]._parent,t.focus([r[o]]),t._selectedNodes=r)}function f(){r.length&&(o+=1,o>=r.length&&(o=0),t._parent=r[o]._parent,t.focus([r[o]]),t._selectedNodes=r)}this._menu=new wcMenu(this.$top,{outer:this.$main,manualUpdate:!0,data:this,version:"v1.0.0"}),this._menu.addOption("File","New Script",{hotkeys:"Alt+N",icon:"fa fa-file-o fa-lg",description:"Start a new script...",toolbarIndex:-1,condition:function(e){return!e._options.readOnly},onActivated:function(e){e._engine&&(e._engine.clear(),e._undoManager&&e._undoManager.clear(),e._parent=e._engine)}}),this._menu.addOption("File","Open Script...",{hotkeys:"Ctrl+O",icon:"fa fa-folder-open-o fa-lg",description:"Open a script file...",toolbarIndex:-1,condition:function(e){return!e._options.readOnly},onActivated:function(e){if(e._engine&&document.createEvent){var t=document.createEvent("MouseEvents");t.initEvent("click",!0,!1),e.$container.prepend(e.$hiddenFileLoader),e.$hiddenFileLoader[0].dispatchEvent(t)}}}),this._menu.addOption("File","Save Script",{hotkeys:"Ctrl+S",icon:"fa fa-save fa-lg",description:"Save this script...",toolbarIndex:-1,condition:function(e){return!e._options.readOnly},onActivated:function(e){if(e._engine){if(!saveAs){console.log("ERROR: Attempted to save the script when external dependency 'FileSaver' was not included.");return}e.triggerEvent("onBeforeSave",[]);var t=e._engine.save(),n;try{n=new Blob([t],{type:"text/plain"})}catch(r){var i=new BlobBuilder;i.append(t),n=i.getBlob("text/plain")}saveAs(n,"script.wcplay"),e._engine._undoManager.clearModified(),e.triggerEvent("onSaved",[])}}}),this._menu.addOption("File","Import...",{icon:"wcPlayEditorImportIcon",description:"Import a script file as a Composite Node.",toolbarIndex:-1,condition:function(e){return!e._options.readOnly},onActivated:function(e){if(e._engine&&document.createEvent){var t=document.createEvent("MouseEvents");t.initEvent("click",!0,!1),e.$container.prepend(e.$hiddenFileImporter),e.$hiddenFileImporter[0].dispatchEvent(t)}}}),this._menu.addOption("Edit","Undo",{hotkeys:"Ctrl+Z",icon:"fa fa-undo fa-lg",toolbarIndex:-1,description:function(e){return"Undo "+(e._undoManager&&e._undoManager.undoInfo()||"Event")},condition:function(e){return e._undoManager&&e._undoManager.canUndo()},onActivated:function(e){e._undoManager&&e._undoManager.undo()}}),this._menu.addOption("Edit","Redo",{hotkeys:"Ctrl+Y,Ctrl+Shift+Z",icon:"fa fa-undo fa-flip-horizontal fa-lg",toolbarIndex:-1,description:function(e){return"Redo "+(e._undoManager&&e._undoManager.redoInfo()||"Event")},condition:function(e){return e._undoManager&&e._undoManager.canRedo()},onActivated:function(e){e._undoManager&&e._undoManager.redo()}}),this._menu.addOption("Edit","Cut",{hotkeys:"Ctrl+X",icon:"fa fa-cut fa-lg",toolbarIndex:-1,description:"Cut selected node(s) out of your script and into the clipboard.",condition:function(e){return e._selectedNodes.length>0},onActivated:function(t){e(t,t._engine),t._undoManager&&t._undoManager.beginGroup("Cut Nodes to clipboard");for(var n=0;n<t._selectedNodes.length;++n)t.__onDestroyNode(t._selectedNodes[n]),t._selectedNodes[n].destroy();t._selectedNodes=[],t._undoManager&&t._undoManager.endGroup()}}),this._menu.addOption("Edit","Copy",{hotkeys:"Ctrl+C",icon:"fa fa-copy fa-lg",toolbarIndex:-1,description:"Copy selected node(s) to your clipboard.",condition:function(e){return e._selectedNodes.length>0},onActivated:e}),this._menu.addOption("Edit","Paste",{hotkeys:"Ctrl+V",icon:"fa fa-paste fa-lg",toolbarIndex:-1,description:"Paste node(s) in clipboard into your script.",condition:function(e){return wcPlayEditorClipboard.nodes.length>0},onActivated:function(e){var t={x:e._mouse.x,y:e._mouse.y};e._mouseInViewport||(t.x=e.$viewport.width()/2,t.y=e.$viewport.height()/2),e._selectedNode=null,e._selectedNodes=[];var n=[],r=[];e._undoManager&&e._undoManager.beginGroup("Paste Nodes from clipboard");var i=wcPlayEditorClipboard.bounds;for(var s=0;s<wcPlayEditorClipboard.nodes.length;++s){var o=wcPlayEditorClipboard.nodes[s],u=new window.wcPlayNodes[o.className](e._parent,o.pos);n[o.id]=u.id,r.push(u)}for(var s=0;s<wcPlayEditorClipboard.nodes.length;++s){var o=wcPlayEditorClipboard.nodes[s],u=r[s];e._selectedNodes.push(u),e._selectedNode||(e._selectedNode=u),u.import(o,n),u.pos.x=(t.x-e._viewportCamera.x)/e._viewportCamera.z-i.width/2+(o.pos.x-i.left),u.pos.y=(t.y-e._viewportCamera.y)/e._viewportCamera.z-i.height/2+(o.pos.y-i.top),e.__onCreateNode(u)}e._undoManager&&e._undoManager.endGroup()}}),this._menu.addOption("Edit","Delete",{hotkeys:"Delete",icon:"fa fa-trash fa-lg",toolbarIndex:-1,description:"Delete selected node(s).",condition:function(e){return e._selectedNodes.length>0},onActivated:function(e){if(e._selectedNodes.length){e._undoManager&&e._undoManager.beginGroup("Removed Nodes");for(var t=0;t<e._selectedNodes.length;++t)e.__onDestroyNode(e._selectedNodes[t]),e._selectedNodes[t].destroy();e._selectedNode=null,e._selectedNodes=[],e._undoManager&&e._undoManager.endGroup()}}}),this._menu.addOption("Edit","Create Node",{hotkeys:"N",icon:"fa fa-plus fa-lg",toolbarIndex:-1,description:"Create a new node.",condition:function(e){return!e._options.readOnly},onActivated:function(e){e._mouse&&e.__drawPalettePopup(e._mouse)}}),this._menu.addOption("Edit","Create Composite",{hotkeys:"C",icon:"fa fa-object-group fa-lg",toolbarIndex:-1,description:"Combine all selected nodes into a new 'Composite' Node.",condition:function(e){return!e._options.readOnly&&e._selectedNodes.length>0},onActivated:function(e){if(e._selectedNodes.length&&e._parent){e._undoManager&&e._undoManager.beginGroup("Combined Nodes into Composite");for(var t=0;t<e._selectedNodes.length;++t)e.__onDestroyNode(e._selectedNodes[t]),e._selectedNodes[t].id=++window.wcNodeNextID;var n=new wcPlayNodes.wcNodeCompositeScript(e._parent,{x:0,y:0},e._selectedNodes),r=[],i=[];for(var t=0;t<e._selectedNodes.length;++t){var s=e._selectedNodes[t];r.push(s._meta.bounds.farRect),i.push(s.pos)}var o=e.__expandRect(r,i),u=[];for(var t=0;t<e._selectedNodes.length;++t){var s=e._selectedNodes[t];e._parent.__removeNode(s);var a=s.listEntryChains(undefined,e._selectedNodes),f=s.listExitChains(undefined,e._selectedNodes),l=s.listInputChains(undefined,e._selectedNodes),c=s.listOutputChains(undefined,e._selectedNodes),h=[];for(var p=0;p<a.length;++p){var d=e._engine.nodeById(a[p].outNodeId),v=a[p].outName,s=e._engine.nodeById(a[p].inNodeId),m=a[p].inName,g=null;for(var y=0;y<h.length;++y)if(h[y].name===m){g=h[y].node;break}g||(g=new wcPlayNodes.wcNodeCompositeEntry(n,{x:s.pos.x,y:o.top-100},m),h.push({name:m,node:g})),g.connectExit("out",s,m),n.connectEntry(g.name,d,v),d.disconnectExit(v,s,m)}h=[];for(var p=0;p<f.length;++p){var d=e._engine.nodeById(f[p].inNodeId),v=f[p].inName,s=e._engine.nodeById(f[p].outNodeId),m=f[p].outName,g=null;for(var y=0;y<h.length;++y)if(h[y].name===m){g=h[y].node;break}g||(g=new wcPlayNodes.wcNodeCompositeExit(n,{x:s.pos.x,y:o.top+o.height+50},m),h.push({name:m,node:g})),g.connectEntry("in",s,m),n.connectExit(g.name,d,v),d.disconnectEntry(v,s,m)}h=[];for(var p=0;p<l.length;++p){var d=e._engine.nodeById(l[p].outNodeId),v=l[p].outName,s=e._engine.nodeById(l[p].inNodeId),m=l[p].inName,g=null;for(var y=0;y<h.length;++y)if(h[y].name===m){g=h[y].node;break}g||(g=new wcPlayNodes.wcNodeCompositeProperty(n,{x:o.left-200,y:s.pos.y},m),h.push({name:m,node:g})),g.connectOutput("value",s,m),n.connectInput(g.name,d,v),d.disconnectOutput(v,s,m)}h=[];for(var p=0;p<c.length;++p){var d=e._engine.nodeById(c[p].inNodeId),v=c[p].inName,s=e._engine.nodeById(c[p].outNodeId),m=c[p].outName,g=null;for(var y=0;y<h.length;++y)if(h[y].name===m){g=h[y].node;break}g||(g=new wcPlayNodes.wcNodeCompositeProperty(n,{x:o.left+o.width+200,y:s.pos.y},m),h.push({name:m,node:g})),g.connectInput("value",s,m),n.connectOutput(g.name,d,v),d.disconnectInput(v,s,m)}}e._selectedNode=null,e._selectedNodes=[],n.pos.x=o.left+o.width/2,n.pos.y=o.top+o.height/2,e.__onCreateNode(n),e._undoManager&&e._undoManager.endGroup(),e.__setupPalette()}}}),this._menu.addOption("Debugging","Toggle Debug Mode",{icon:function(e){return e._engine&&e._engine.debugging()?"fa fa-dot-circle-o fa-lg":"fa fa-circle-o fa-lg"},toolbarIndex:-1,description:"Toggle debugging mode (does not break on breakpoints).",onActivated:function(e){e._engine&&(e._engine.debugging(!e._engine.debugging()),e._engine.paused(!1))}}),this._menu.addOption("Debugging","Toggle Silence Mode",{icon:function(e){return e._engine&&e._engine.silent()?"fa fa-volume-off fa-lg":"fa fa-volume-up fa-lg"},toolbarIndex:-1,description:"Toggle silent mode (disables console log messages).",onActivated:function(e){e._engine&&e._engine.silent(!e._engine.silent())}}),this._menu.addOption("Debugging","Start Script",{hotkeys:"Shift+Enter",icon:function(e){return e._engine&&e._engine.isRunning()?"fa fa-stop fa-lg":"fa fa-play fa-lg"},toolbarIndex:-1,display:function(e){return e._engine&&e._engine.isRunning()?"Stop Script":"Start Script"},description:"Starts or Stops execution of the script.",condition:function(e){return!e._options.readOnly&&e._options.playable},onActivated:function(e){e._engine&&(e._engine.isRunning()?e._engine.stop():e._engine.start())}}),this._menu.addOption("Debugging","Pause Script",{hotkeys:"Return",icon:"fa fa-pause fa-lg",toggle:function(e){return e._engine&&e._engine.paused()},display:function(e){return e._engine&&e._engine.paused()?"Resume Script":"Pause Script"},toolbarIndex:-1,description:"Pause or Continue the script.",condition:function(e){return!e._options.readOnly&&e._engine&&e._engine.isRunning()},onActivated:function(e){e._engine&&(e._engine.paused()||e._engine.stepping()?(e._engine.paused(!1),e._engine.stepping(!1)):e._engine.stepping(!0))}}),this._menu.addOption("Debugging","Step Script",{hotkeys:"Spacebar",icon:"fa fa-fast-forward fa-lg",toolbarIndex:-1,description:"Perform a single script update.",condition:function(e){return!e._options.readOnly&&e._engine&&e._engine.isRunning()},onActivated:function(e){e._engine&&(e._engine.paused(!1),e._engine.stepping(!0))}}),this._menu.addOption("View","Fit in View",{hotkeys:"F",icon:"fa fa-crosshairs fa-lg",categoryIndex:2,toolbarIndex:-1,description:"Center view on selected node(s).",onActivated:function(e){e._selectedNodes.length?e.focus(e._selectedNodes):e.center()}}),this._menu.addOption("View","Exit Composite",{hotkeys:"O",icon:"fa fa-level-up fa-lg",toolbarIndex:-1,description:"Step out of this Composite Node.",condition:function(e){return e._parent&&e._parent.instanceOf("wcNodeCompositeScript")},onActivated:function(e){var t=e._parent;e._parent=e._parent._parent,e._selectedNode=t,e._selectedNodes=[t],e.focus(e._selectedNodes)}}),this._menu.addOption("View","Enter Composite",{hotkeys:"I",icon:"fa fa-level-down fa-lg",toolbarIndex:-1,description:"Step in to this Composite Node.",condition:function(e){return e._selectedNodes.length===1&&e._selectedNodes[0].instanceOf("wcNodeCompositeScript")},onActivated:function(e){e._parent=e._selectedNodes[0],e._selectedNode=null,e._selectedNodes=[],e.center()}}),this._menu.addOption("View","Chain Style",{hotkeys:"V",icon:"fa fa-sitemap fa-lg",toolbarIndex:-1,description:"Toggle the visual style of the chains.",toggle:function(e){return e._chainStyle===0},onActivated:function(e){e._chainStyle+=1,e._chainStyle>e._chainStyleMax&&(e._chainStyle=0)}});var t=this,n=this.$search.children("input"),r=[],i=null,s="",o=0;this.$search.children(".wcPlayEditorSearchPrev").click(a),this.$search.children(".wcPlayEditorSearchNext").click(f),this.$search.keydown(function(e){if(e.keyCode===27)t.$search.hasClass("wcPlayHidden")||t.$search.addClass("wcPlayHidden");else{if(e.keyCode===13||e.keyCode===40||e.keyCode===9)return f(),e.stopPropagation(),e.preventDefault(),!0;if(e.keyCode===38)return a(),e.stopPropagation(),e.preventDefault(),!0}}),this.$search.keyup(function(e){var r=n.val().toLowerCase();s!==r&&(o=0,i=t._parent,s=r,u())}),this._menu.addOption("View","Search...",{hotkeys:"Ctrl+F",icon:"fa fa-search fa-lg",toolbarIndex:-1,description:"Toggle the visual style of the chains.",onActivated:function(e){e.$search.removeClass("wcPlayHidden"),n.focus(),n.select(),r.length&&u()}}),this._menu.addOption("Help","Documentation...",{icon:"fa fa-file-pdf-o fa-lg",description:"Open the documentation for wcPlay in another window.",onActivated:function(e){window.open("http://play.api.webcabin.org/","_blank")}}),this._menu.addSpacer("File","Save Script"),this._menu.addSpacer("File","Import..."),this._menu.addSpacer("Edit","Redo"),this._menu.addSpacer("Edit","Delete"),this._menu.addSpacer("View","Enter Composite"),this._menu.addSpacer("View","Chain Style"),this._menu.addSpacer("Debugging","Toggle Silence Mode"),this._menu.addToolbarSpacer("File","Save Script"),this._menu.addToolbarSpacer("File","Import..."),this._menu.addToolbarSpacer("Edit","Redo"),this._menu.addToolbarSpacer("Edit","Delete"),this._menu.addToolbarSpacer("Edit","Create Composite"),this._menu.addToolbarSpacer("View","Enter Composite"),this._menu.addToolbarSpacer("View","Chain Style"),this._menu.addToolbarSpacer("Debugging","Toggle Silence Mode"),this._menu.addToolbarSpacer("Debugging","Step Script")},__setupPalette:function(){if(!this._engine)return;this._nodeLibrary=[];for(var e=0;e<wcPlay.NODE_LIBRARY.length;++e){var t=wcPlay.NODE_LIBRARY[e];if(t.className==="wcNodeCompositeScript")continue;var n=this._options.category.items.indexOf(t.category);if(!this._options.category.isBlacklist&&n===-1||this._options.category.isBlacklist&&n>-1)continue;var r=new window.wcPlayNodes[t.className](null);t.entry=r.chain.entry.map(function(e){return{name:e.name,desc:""}}),t.exit=r.chain.exit.map(function(e){return{name:e.name,desc:""}}),t.input=r.properties.filter(function(e){return e.options.input}).map(function(e){return{name:e.name,desc:e.options.description}}),t.output=r.properties.filter(function(e){return e.options.output}).map(function(e){return{name:e.name,desc:e.options.description}}),t.desc=r._meta.description,t.node=r,t.id=this._nodeLibrary.length,this._nodeLibrary.push(t),this.__updateNode(r,0,this._viewportContext)}},__drawNodes:function(e,t){for(var n=0;n<e.length;++n)this.__drawNode(e[n],t)},__drawNode:function(e,t,n){if(!n&&!this.__rectOnRect(e._meta.bounds.farRect,this._viewportBounds,e.pos)){e._meta.visible=!1;return}e._meta.visible=!0,this._selectedNodes.indexOf(e)>-1&&(this.__drawRoundedRect(e._meta.bounds.rect,"rgba(0, 255, 255, 0.25)",-1,10,t,e.pos),this.__drawRoundedRect(e._meta.bounds.rect,"darkcyan",2,10,t,e.pos)),this.__drawCenter(e,t,n),this.__drawEntryLinks(e,t,e._meta.bounds.entryOuter.width),this.__drawExitLinks(e,t,e._meta.bounds.entryOuter.height+e._meta.bounds.centerOuter.height,e._meta.bounds.exitOuter.width),t.save(),t.fillStyle=this._highlightDebugLog&&this._highlightNode===e?"black":"white",t.strokeStyle="black",t.lineWidth=1,t.fillRect(e.pos.x+e._meta.bounds.debugLog.left,e.pos.y+e._meta.bounds.debugLog.top,e._meta.bounds.debugLog.width,e._meta.bounds.debugLog.height),t.strokeRect(e.pos.x+e._meta.bounds.debugLog.left,e.pos.y+e._meta.bounds.debugLog.top,e._meta.bounds.debugLog.width,e._meta.bounds.debugLog.height),t.strokeStyle=e._log?"red":this._highlightDebugLog&&this._highlightNode===e?"white":"black",t.lineWidth=2,t.beginPath(),t.moveTo(e.pos.x+e._meta.bounds.debugLog.left+1,e.pos.y+e._meta.bounds.debugLog.top+1),t.lineTo(e.pos.x+e._meta.bounds.debugLog.left+e._meta.bounds.debugLog.width/2,e.pos.y+e._meta.bounds.debugLog.top+e._meta.bounds.debugLog.height/2),t.lineTo(e.pos.x+e._meta.bounds.debugLog.left+1,e.pos.y+e._meta.bounds.debugLog.top+e._meta.bounds.debugLog.height-1),t.moveTo(e.pos.x+e._meta.bounds.debugLog.left+e._meta.bounds.debugLog.width/2,e.pos.y+e._meta.bounds.debugLog.top+e._meta.bounds.debugLog.height-2),t.lineTo(e.pos.x+e._meta.bounds.debugLog.left+e._meta.bounds.debugLog.width,e.pos.y+e._meta.bounds.debugLog.top+e._meta.bounds.debugLog.height-2),t.stroke(),t.restore(),t.save(),t.fillStyle=this._highlightBreakpoint&&this._highlightNode===e?"black":"white",t.fillRect(e.pos.x+e._meta.bounds.breakpoint.left,e.pos.y+e._meta.bounds.breakpoint.top,e._meta.bounds.breakpoint.width,e._meta.bounds.breakpoint.height),t.strokeStyle=e._break?"red":this._highlightBreakpoint&&this._highlightNode===e?"white":"black",t.fillStyle="red",t.lineWidth=2,t.beginPath(),t.arc(e.pos.x+e._meta.bounds.breakpoint.left+e._meta.bounds.breakpoint.width/2,e.pos.y+e._meta.bounds.breakpoint.top+e._meta.bounds.breakpoint.height/2,Math.min(e._meta.bounds.breakpoint.width/2-2,e._meta.bounds.breakpoint.height/2-2),0,2*Math.PI),e._break&&t.fill(),t.stroke(),t.strokeStyle="black",t.lineWidth=1,t.strokeRect(e.pos.x+e._meta.bounds.breakpoint.left,e.pos.y+e._meta.bounds.breakpoint.top,e._meta.bounds.breakpoint.width,e._meta.bounds.breakpoint.height),t.restore(),e.isBroken()?this.__drawRoundedRect(e._meta.bounds.inner,"#CC0000",5,this._drawStyle.node.radius,t,e.pos):e._meta.flashDelta&&this.__drawRoundedRect(e._meta.bounds.inner,"yellow",2,this._drawStyle.node.radius,t,e.pos)},__measureEntryLinkOuter:function(e,t){var n={top:0,left:0,width:0,height:0};this.__setCanvasFont(this._font.links,t);var r=e.chain.entry;for(var i=0;i<r.length;++i)n.width+=t.measureText(r[i].name).width+this._drawStyle.links.spacing;return n.left-=n.width/2+this._drawStyle.links.margin,n.width+=this._drawStyle.links.margin*2,e.chain.entry.length&&(n.height=this._font.links.size+this._drawStyle.links.padding+this._drawStyle.links.length),n},__measureExitLinkOuter:function(e,t,n){var r={top:n,left:0,width:0,height:0};this.__setCanvasFont(this._font.links,t);var i=e.chain.exit;for(var s=0;s<i.length;++s)r.width+=t.measureText(i[s].name).width+this._drawStyle.links.spacing;return r.left-=r.width/2+this._drawStyle.links.margin,r.width+=this._drawStyle.links.margin*2,e.chain.exit.length&&(r.height=this._font.links.size+this._drawStyle.links.padding+this._drawStyle.links.length),r},__measureOuter:function(e,t,n){var r={top:n,left:0,width:0,height:this._font.title.size+this._drawStyle.title.spacing+this._drawStyle.links.padding};this.__setCanvasFont(this._font.title,t),r.width=t.measureText(this._drawStyle.title.wrapL+e.type+": "+this._drawStyle.title.wrapR).width,this.__setCanvasFont(this._font.titleDesc,t),r.width+=t.measureText(this._drawStyle.title.nameWrapL+(e.name||this._drawStyle.title.placeholder)+this._drawStyle.title.nameWrapR).width;if(e.description()||e.details())this.__setCanvasFont(this._font.details,t),r.width+=t.measureText(this._drawStyle.title.details).width;e._viewportSize&&(r.width=Math.max(r.width,e._viewportSize.x),r.height+=e._viewportSize.y+this._drawStyle.property.spacing),r.height+=this._font.property.size+this._drawStyle.property.spacing;var i=0,s=0,o=0,u=0,a=e.properties;for(var f=0;f<a.length;++f){r.height+=this._font.property.size+this._drawStyle.property.spacing,this.__setCanvasFont(this._font.property,t),i=Math.max(t.measureText(a[f].name+": ").width,i);var l=this._engine.isRunning()&&!a[f].options.linked;this.__setCanvasFont(this._font.value,t);var c=t.measureText(this._drawStyle.property.valueWrapL+this.__drawPropertyValue(e,a[f])+this._drawStyle.property.valueWrapR).width;this.__setCanvasFont(this._font.initialValue,t);var h=t.measureText(this._drawStyle.property.initialWrapL+this.__drawPropertyValue(e,a[f],!0)+this._drawStyle.property.initialWrapR).width;l?(s=Math.max(c,this._drawStyle.property.minLength,s),o=Math.max(h,this._drawStyle.property.minLength,o)):u=Math.max(c+h,this._drawStyle.property.minLength,u)}return u=Math.max(u,s+o),r.width=Math.max(i+u,r.width)+this._drawStyle.node.margin*2,r.left-=r.width/2,r.propWidth=i,r.valueWidth=s,r.initialWidth=o,r},__measureCenter:function(e,t,n){var r=e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0,i=e.chain.exit.length?this._font.links.size+this._drawStyle.links.padding:0;e._meta.bounds.center=n,e._meta.bounds.inputBounds=[],e._meta.bounds.outputBounds=[],e._meta.bounds.propertyBounds=[],e._meta.bounds.valueBounds=[],e._meta.bounds.initialBounds=[],t.save(),this.__setCanvasFont(this._font.title,t);var s=t.measureText(this._drawStyle.title.wrapL+e.type+": ").width,o=t.measureText(this._drawStyle.title.wrapR).width;this.__setCanvasFont(this._font.titleDesc,t);var u=t.measureText(this._drawStyle.title.nameWrapL+(e.name||this._drawStyle.title.placeholder)+this._drawStyle.title.nameWrapR).width,a=0;if(e.description()||e.details())this.__setCanvasFont(this._font.details,t),a=t.measureText(this._drawStyle.title.details).width;e._meta.bounds.titleBounds={top:n.top,left:n.left+s+(n.width-(s+o+u+a))/2,width:u,height:this._font.title.size+this._drawStyle.title.spacing-1,typeWidth:s,wrapRWidth:o,textWidth:u},e._meta.bounds.detailsBounds={top:n.top,left:n.left+n.width-this._drawStyle.node.margin-a,width:a,height:this._font.details.size+this._drawStyle.title.spacing-1},r=this._font.title.size,r+=this._drawStyle.title.spacing,e._viewportSize&&(e._meta.bounds.viewportBounds={top:n.top+r,left:n.left+(n.width/2-e._viewportSize.x/2),width:e._viewportSize.x,height:e._viewportSize.y},r+=e._viewportSize.y+this._drawStyle.property.spacing),r+=this._font.property.size+this._drawStyle.property.spacing;var f,l=e.properties;for(var c=0;c<l.length;++c){r+=this._font.property.size;var h={rect:{top:n.top+r-this._font.property.size,left:n.left+this._drawStyle.node.margin,width:n.width-this._drawStyle.node.margin*2,height:this._font.property.size+this._drawStyle.property.spacing},name:l[c].name};e._meta.bounds.propertyBounds.push(h);var p=this._engine.isRunning()&&!l[c].options.linked,d={rect:{top:n.top+r-this._font.property.size,left:n.left+n.width-this._drawStyle.node.margin-n.initialWidth-(p?0:n.valueWidth),width:n.initialWidth+(p?0:n.valueWidth),height:this._font.property.size+this._drawStyle.property.spacing},name:l[c].name};e._meta.bounds.initialBounds.push(d);var v={rect:{top:n.top+r-this._font.property.size,left:n.left+n.width-this._drawStyle.node.margin-n.valueWidth-n.initialWidth,width:p?n.valueWidth:0,height:this._font.property.size+this._drawStyle.property.spacing},name:l[c].name};e._meta.bounds.valueBounds.push(v),f={top:n.top+r-this._font.property.size/3-this._drawStyle.links.width/2-5,left:n.left-this._drawStyle.links.length,width:this._drawStyle.links.length,height:l[c].options&&l[c].options.input?this._drawStyle.links.width+10:0},e._meta.bounds.inputBounds.push({rect:f,point:{x:f.left+f.width/3-2,y:f.top+f.height/2},name:l[c].name}),f={top:n.top+r-this._font.property.size/3-this._drawStyle.links.width/2-5,left:n.left+n.width,width:this._drawStyle.links.length,height:l[c].options&&l[c].options.output?this._drawStyle.links.width+10:0},e._meta.bounds.outputBounds.push({rect:f,point:{x:f.left+f.width+1,y:f.top+f.height/2},name:l[c].name}),r+=this._drawStyle.property.spacing}t.restore()},__measureEntryLinks:function(e,t,n){e._meta.bounds.entryBounds=[];var r=-n/2+this._drawStyle.links.margin,i=this._drawStyle.links.length+this._font.links.size;t.save(),this.__setCanvasFont(this._font.links,t);var s=e.chain.entry;for(var o=0;o<s.length;++o){var u=t.measureText(s[o].name).width+this._drawStyle.links.spacing,a={top:i-this._drawStyle.links.length-this._font.links.size,left:r+u/2-this._drawStyle.links.width/2,width:this._drawStyle.links.width,height:this._drawStyle.links.length};a.left-=5,a.width+=10,e._meta.bounds.entryBounds.push({rect:a,point:{x:a.left+a.width/2,y:a.top+a.height/3-2},name:s[o].name}),r+=u}t.restore()},__measureExitLinks:function(e,t,n,r){e._meta.bounds.exitBounds=[];var i=-r/2+this._drawStyle.links.margin,s=n+this._font.links.size;t.save(),this.__setCanvasFont(this._font.links,t);var o=e.chain.exit;for(var u=0;u<o.length;++u){var a=t.measureText(o[u].name).width+this._drawStyle.links.spacing,f={top:s+this._drawStyle.links.padding,left:i+a/2-this._drawStyle.links.width/2,width:this._drawStyle.links.width,height:this._drawStyle.links.length};f.left-=5,f.width+=10,e._meta.bounds.exitBounds.push({rect:f,point:{x:f.left+f.width/2,y:f.top+f.height+1},name:o[u].name}),i+=a}t.restore()},__drawCenter:function(e,t,n){var r=e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0,i=e.chain.exit.length?this._font.links.size+this._drawStyle.links.padding:0;t.save();var s=e.pos.x+e._meta.bounds.center.left+e._meta.bounds.center.width/2,o=e.pos.y+e._meta.bounds.center.top+e._meta.bounds.center.height/2,u=t.createRadialGradient(s,o,10,s,o,Math.max(e._meta.bounds.center.width,e._meta.bounds.center.height));u.addColorStop(0,e.enabled()?e._meta.color:"#555"),u.addColorStop(1,"white"),t.fillStyle=t.strokeStyle=u,t.lineJoin="round";var a=this._drawStyle.node.radius*2;t.lineWidth=a,t.fillRect(e.pos.x+e._meta.bounds.center.left+a/2,e.pos.y+e._meta.bounds.center.top-r+a/2,e._meta.bounds.center.width-a,e._meta.bounds.center.height+r+i-a),t.strokeRect(e.pos.x+e._meta.bounds.center.left+a/2,e.pos.y+e._meta.bounds.center.top-r+a/2,e._meta.bounds.center.width-a,e._meta.bounds.center.height+r+i-a),t.restore(),this.__drawRoundedRect({left:e._meta.bounds.center.left,top:e._meta.bounds.center.top-r,width:e._meta.bounds.center.width,height:e._meta.bounds.center.height+r+i},e._meta.color,3,this._drawStyle.node.radius,t,e.pos),r=0,e.chain.entry.length&&(t.strokeStyle=e._meta.color,t.beginPath(),t.moveTo(e.pos.x+e._meta.bounds.center.left,e.pos.y+e._meta.bounds.center.top+r),t.lineTo(e.pos.x+e._meta.bounds.center.left+e._meta.bounds.center.width,e.pos.y+e._meta.bounds.center.top+r),t.stroke()),!this._options.readOnly&&!n&&(this._highlightTitle&&this._highlightNode===e?this.__drawRoundedRect(e._meta.bounds.titleBounds,this._drawStyle.property.highlightColor,this._drawStyle.property.highlightBorder,this._font.title.size/2,t,e.pos):this._highlightNode===e&&this.__drawRoundedRect(e._meta.bounds.titleBounds,this._drawStyle.property.normalColor,this._drawStyle.property.normalBorder,this._font.title.size/2,t,e.pos)),!this._options.readOnly&&e._meta.bounds.detailsBounds.width>0&&!n&&(this._highlightDetails&&this._highlightNode===e?this.__drawRoundedRect(e._meta.bounds.detailsBounds,this._drawStyle.property.highlightColor,this._drawStyle.property.highlightBorder,this._font.title.size/2,t,e.pos):this._highlightNode===e&&this.__drawRoundedRect(e._meta.bounds.detailsBounds,this._drawStyle.property.normalColor,this._drawStyle.property.normalBorder,this._font.title.size/2,t,e.pos)),t.save(),r+=this._font.title.size,t.fillStyle="black",t.strokeStyle="black",t.textAlign="left",this.__setCanvasFont(this._font.title,t),t.fillText(this._drawStyle.title.wrapL+e.type+": ",e.pos.x+e._meta.bounds.titleBounds.left-e._meta.bounds.titleBounds.typeWidth,e.pos.y+e._meta.bounds.titleBounds.top+r),this.__setCanvasFont(this._font.titleDesc,t),t.fillText(this._drawStyle.title.nameWrapL+(e.name||this._drawStyle.title.placeholder)+this._drawStyle.title.nameWrapR,e.pos.x+e._meta.bounds.titleBounds.left,e.pos.y+e._meta.bounds.titleBounds.top+r),t.textAlign="right",this.__setCanvasFont(this._font.title,t),t.fillText(this._drawStyle.title.wrapR,e.pos.x+e._meta.bounds.titleBounds.left,e.pos.y+e._meta.bounds.titleBounds.top+r);if(e.description()||e.details())this.__setCanvasFont(this._font.details,t),t.fillText(this._drawStyle.title.details,e.pos.x+e._meta.bounds.detailsBounds.left+e._meta.bounds.detailsBounds.width,e.pos.y+e._meta.bounds.detailsBounds.top+this._font.details.size);t.restore(),r+=this._drawStyle.title.spacing,e._meta.bounds.viewportBounds&&(t.save(),t.translate(e.pos.x+e._meta.bounds.viewportBounds.left,e.pos.y+e._meta.bounds.viewportBounds.top),e.onViewportDraw(t,this._options.readOnly),t.translate(-e.pos.x-e._meta.bounds.viewportBounds.left,-e.pos.y-e._meta.bounds.viewportBounds.top),t.restore(),r+=e._viewportSize.y+this._drawStyle.property.spacing),r+=this._font.property.size,t.save();var f={top:e._meta.bounds.center.top+r-this._font.property.size,left:e._meta.bounds.center.left+this._drawStyle.node.margin,height:this._font.property.size+this._drawStyle.property.spacing/2,width:e._meta.bounds.center.width-this._drawStyle.node.margin*2};this.__drawRoundedRect(f,this._drawStyle.property.headerColor,this._drawStyle.property.headerBorder,this._font.property.size/2,t,e.pos),e._meta.bounds.centerOuter.valueWidth?(t.fillStyle="black",t.textAlign="right",this.__setCanvasFont(this._font.propertyHeader,t),t.fillText("Initial",e.pos.x+e._meta.bounds.center.left+e._meta.bounds.center.width-this._drawStyle.node.margin-this._drawStyle.property.headerSpace,e.pos.y+e._meta.bounds.center.top+r),t.fillStyle="#444444",this.__setCanvasFont(this._font.propertyHeader,t),t.fillText("Current",e.pos.x+e._meta.bounds.center.left+e._meta.bounds.center.width-this._drawStyle.node.margin-this._drawStyle.property.headerSpace-e._meta.bounds.center.initialWidth,e.pos.y+e._meta.bounds.center.top+r)):(t.fillStyle="black",t.textAlign="right",this.__setCanvasFont(this._font.propertyHeader,t),t.fillText("Initial",e.pos.x+e._meta.bounds.center.left+e._meta.bounds.center.width-this._drawStyle.node.margin-this._drawStyle.property.headerSpace,e.pos.y+e._meta.bounds.center.top+r)),r+=this._drawStyle.property.spacing;var l=e.properties;for(var c=0;c<l.length;++c){r+=this._font.property.size;var h=null;for(var p=0;p<e._meta.bounds.propertyBounds.length;++p)if(e._meta.bounds.propertyBounds[p].name===l[c].name){h=e._meta.bounds.propertyBounds[p];break}var d=null;for(var p=0;p<e._meta.bounds.initialBounds.length;++p)if(e._meta.bounds.initialBounds[p].name===l[c].name){d=e._meta.bounds.initialBounds[p];break}var v=null;for(var p=0;p<e._meta.bounds.valueBounds.length;++p)if(e._meta.bounds.valueBounds[p].name===l[c].name){v=e._meta.bounds.valueBounds[p];break}var m=this._engine.isRunning()&&!l[c].options.linked;!this._options.readOnly&&!n&&!l[c].options.readOnly&&(this._engine&&m&&(this._highlightNode===e&&this._highlightPropertyValue&&this._highlightPropertyValue.name===l[c].name?this.__drawRoundedRect(v.rect,this._drawStyle.property.highlightColor,this._drawStyle.property.highlightBorder,this._font.property.size/2,t,e.pos):this._highlightNode===e&&this.__drawRoundedRect(v.rect,this._drawStyle.property.normalColor,this._drawStyle.property.normalBorder,this._font.property.size/2,t,e.pos)),this._highlightNode===e&&this._highlightPropertyInitialValue&&this._highlightPropertyInitialValue.name===l[c].name?this.__drawRoundedRect(d.rect,this._drawStyle.property.highlightColor,this._drawStyle.property.highlightBorder,this._font.property.size/2,t,e.pos):this._highlightNode===e&&this.__drawRoundedRect(d.rect,this._drawStyle.property.normalColor,this._drawStyle.property.normalBorder,this._font.property.size/2,t,e.pos)),t.fillStyle="black",t.textAlign="left",this.__setCanvasFont(this._font.property,t),t.fillText(l[c].name+": ",e.pos.x+e._meta.bounds.center.left+this._drawStyle.node.margin,e.pos.y+e._meta.bounds.center.top+r),t.fillStyle="black",t.textAlign="right",this.__setCanvasFont(this._font.initialValue,t),t.fillText(this._drawStyle.property.initialWrapL+this.__drawPropertyValue(e,l[c],!0,!m)+this._drawStyle.property.initialWrapR,e.pos.x+e._meta.bounds.center.left+e._meta.bounds.center.width-this._drawStyle.node.margin,e.pos.y+e._meta.bounds.center.top+r),this._engine&&m&&(t.fillStyle="#444444",this.__setCanvasFont(this._font.value,t),t.fillText(this._drawStyle.property.valueWrapL+this.__drawPropertyValue(e,l[c])+this._drawStyle.property.valueWrapR,e.pos.x+e._meta.bounds.center.left+e._meta.bounds.center.width-this._drawStyle.node.margin-e._meta.bounds.center.initialWidth,e.pos.y+e._meta.bounds.center.top+r));var g=null;for(var p=0;p<e._meta.bounds.inputBounds.length;++p)if(e._meta.bounds.inputBounds[p].name===l[c].name){g=e._meta.bounds.inputBounds[p].rect;break}l[c].options&&l[c].options.input&&(t.fillStyle=this._highlightInputLink&&this._highlightInputLink.name===l[c].name&&this._highlightNode===e?"cyan":l[c].inputMeta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(e.pos.x+g.left,e.pos.y+g.top+5),t.lineTo(e.pos.x+g.left+g.width,e.pos.y+g.top+5),t.lineTo(e.pos.x+g.left+g.width,e.pos.y+g.top+g.height-5),t.lineTo(e.pos.x+g.left,e.pos.y+g.top+g.height-5),t.lineTo(e.pos.x+g.left+g.width/3,e.pos.y+g.top+g.height/2),t.closePath(),t.stroke(),t.fill());var g=null;for(var p=0;p<e._meta.bounds.outputBounds.length;++p)if(e._meta.bounds.outputBounds[p].name===l[c].name){g=e._meta.bounds.outputBounds[p].rect;break}l[c].options&&l[c].options.output&&(t.fillStyle=this._highlightOutputLink&&this._highlightOutputLink.name===l[c].name&&this._highlightNode===e?"cyan":l[c].outputMeta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(e.pos.x+g.left,e.pos.y+g.top+5),t.lineTo(e.pos.x+g.left+g.width/2,e.pos.y+g.top+5),t.lineTo(e.pos.x+g.left+g.width,e.pos.y+g.top+g.height/2),t.lineTo(e.pos.x+g.left+g.width/2,e.pos.y+g.top+g.height-5),t.lineTo(e.pos.x+g.left,e.pos.y+g.top+g.height-5),t.closePath(),t.stroke(),t.fill()),r+=this._drawStyle.property.spacing}e.chain.exit.length&&(t.strokeStyle=e._meta.color,t.beginPath(),t.moveTo(e.pos.x+e._meta.bounds.center.left,e.pos.y+e._meta.bounds.center.top+e._meta.bounds.center.height),t.lineTo(e.pos.x+e._meta.bounds.center.left+e._meta.bounds.center.width,e.pos.y+e._meta.bounds.center.top+e._meta.bounds.center.height),t.stroke()),t.restore()},__drawEntryLinks:function(e,t,n){var r=e.pos.x-n/2+this._drawStyle.links.margin,i=e.pos.y+this._drawStyle.links.length+this._font.links.size;t.save(),this.__setCanvasFont(this._font.links,t);var s=e.chain.entry;for(var o=0;o<s.length;++o){t.fillStyle="black";var u=t.measureText(s[o].name).width+this._drawStyle.links.spacing;t.fillText(s[o].name,r+this._drawStyle.links.spacing/2,i);var a=null;for(var f=0;f<e._meta.bounds.entryBounds.length;++f)if(e._meta.bounds.entryBounds[f].name===s[o].name){a=e._meta.bounds.entryBounds[f].rect;break}t.fillStyle=this._highlightEntryLink&&this._highlightEntryLink.name===s[o].name&&this._highlightNode===e?"cyan":s[o].meta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(e.pos.x+a.left+5,e.pos.y+a.top),t.lineTo(e.pos.x+a.left+a.width/2,e.pos.y+a.top+a.height/3),t.lineTo(e.pos.x+a.left+a.width-5,e.pos.y+a.top),t.lineTo(e.pos.x+a.left+a.width-5,e.pos.y+a.top+a.height),t.lineTo(e.pos.x+a.left+5,e.pos.y+a.top+a.height),t.closePath(),t.stroke(),t.fill(),r+=u}t.restore()},__drawExitLinks:function(e,t,n,r){var i=e.pos.x-r/2+this._drawStyle.links.margin,s=e.pos.y+n+this._font.links.size;t.save(),this.__setCanvasFont(this._font.links,t);var o=e.chain.exit;for(var u=0;u<o.length;++u){t.fillStyle="black";var a=t.measureText(o[u].name).width+this._drawStyle.links.spacing;t.fillText(o[u].name,i+this._drawStyle.links.spacing/2,s);var f=null;for(var l=0;l<e._meta.bounds.exitBounds.length;++l)if(e._meta.bounds.exitBounds[l].name===o[u].name){f=e._meta.bounds.exitBounds[l].rect;break}t.fillStyle=this._highlightExitLink&&this._highlightExitLink.name===o[u].name&&this._highlightNode===e?"cyan":o[u].meta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(e.pos.x+f.left+5,e.pos.y+f.top),t.lineTo(e.pos.x+f.left+f.width-5,e.pos.y+f.top),t.lineTo(e.pos.x+f.left+f.width-5,e.pos.y+f.top+f.height/2),t.lineTo(e.pos.x+f.left+f.width/2,e.pos.y+f.top+f.height),t.lineTo(e.pos.x+f.left+5,e.pos.y+f.top+f.height/2),t.closePath(),t.stroke(),t.fill(),i+=a}t.restore()},__drawChains:function(e,t){for(var n=0;n<e.length;++n)this.__drawNodeChains(e[n],t)},__drawNodeChains:function(e,t){for(var n=0;n<e.chain.exit.length;++n){var r=e.chain.exit[n];if(!r.links.length)continue;var i;for(var s=0;s<e._meta.bounds.exitBounds.length;++s)if(e._meta.bounds.exitBounds[s].name===r.name){i=e._meta.bounds.exitBounds[s].point;break}if(!i){console.log("ERROR: Attempted to draw chains for an exit link that has no meta data.");continue}for(var s=0;s<r.links.length;++s){var o=r.links[s].node,u=r.links[s].name,a;if(!e._meta.visible&&!o._meta.visible)continue;for(var f=0;f<o.chain.entry.length;++f)if(o.chain.entry[f].name===u){a=o.chain.entry[f];break}if(!a){console.log("ERROR: Attempted to chain an exit link to an entry link that was not found.");continue}var l;for(var f=0;f<o._meta.bounds.entryBounds.length;++f)if(o._meta.bounds.entryBounds[f].name===a.name){l=o._meta.bounds.entryBounds[f].point;break}if(!l){console.log("ERROR: Attempted to draw chains to an entry link that has no meta data.");continue}var c=r.meta.flashDelta>0&&a.meta.flashDelta>0,h=this._highlightNode===o&&this._highlightEntryLink&&this._highlightEntryLink.name===a.name||this._highlightNode===e&&this._highlightExitLink&&this._highlightExitLink.name===r.name;this.__drawChain(e.pos,o.pos,i,l,e._meta.bounds.rect,o._meta.bounds.rect,t,c,h)}}for(var n=0;n<e.properties.length;++n){var p=e.properties[n];if(!p.outputs.length)continue;var d;for(var s=0;s<e._meta.bounds.outputBounds.length;++s)if(e._meta.bounds.outputBounds[s].name===p.name){d=e._meta.bounds.outputBounds[s].point;break}if(!d){console.log("ERROR: Attempted to draw chains for an output link that has no meta data.");continue}for(var s=0;s<p.outputs.length;++s){var o=p.outputs[s].node,u=p.outputs[s].name,v;if(!e._meta.visible&&!o._meta.visible)continue;for(var f=0;f<o.properties.length;++f)o.properties[f].name===u&&(v=o.properties[f]);if(!v){console.log("ERROR: Attempted to chain a property link to a property that was not found.");continue}var m;for(var f=0;f<o._meta.bounds.inputBounds.length;++f)if(o._meta.bounds.inputBounds[f].name===v.name){m=o._meta.bounds.inputBounds[f].point;break}if(!m){console.log("ERROR: Attempted to draw chains to a property input link that has no meta data.");continue}var c=p.outputMeta.flashDelta>0||v.inputMeta.flashDelta>0,h=this._highlightNode===o&&this._highlightInputLink&&this._highlightInputLink.name===v.name||this._highlightNode===e&&this._highlightOutputLink&&this._highlightOutputLink.name===p.name;this.__drawChain(e.pos,o.pos,d,m,e._meta.bounds.rect,o._meta.bounds.rect,t,c,h,!0)}}if(this._selectedNode===e&&this._selectedEntryLink){var g,y=null,b=null,h=!1;this._highlightNode&&this._highlightExitLink?(g=this._highlightExitLink.point,y=this._highlightExitLink.rect,b=this._highlightNode.pos,h=!0):(g={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z},y={left:g.x,top:g.y,width:1,height:1},b={x:0,y:0});var w;for(var n=0;n<e._meta.bounds.entryBounds.length;++n)e._meta.bounds.entryBounds[n].name===this._selectedEntryLink.name&&(w=e._meta.bounds.entryBounds[n].point);this.__drawChain(b,e.pos,g,w,y,e._meta.bounds.rect,t,h)}if(this._selectedNode===e&&this._selectedExitLink){var g,y=null,b=null,h=!1;this._highlightNode&&this._highlightEntryLink?(g=this._highlightEntryLink.point,y=this._highlightEntryLink.rect,b=this._highlightNode.pos,h=!0):(g={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z},y={left:g.x,top:g.y,width:1,height:1},b={x:0,y:0});var w;for(var n=0;n<e._meta.bounds.exitBounds.length;++n)e._meta.bounds.exitBounds[n].name===this._selectedExitLink.name&&(w=e._meta.bounds.exitBounds[n].point);this.__drawChain(e.pos,b,w,g,e._meta.bounds.rect,y,t,h)}if(this._selectedNode===e&&this._selectedInputLink){var g,y=null,b=null,h=!1;this._highlightNode&&this._highlightOutputLink?(g=this._highlightOutputLink.point,y=this._highlightOutputLink.rect,b=this._highlightNode.pos,h=!0):(g={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z},y={left:g.x,top:g.y,width:1,height:1},b={x:0,y:0});var w;for(var n=0;n<e._meta.bounds.inputBounds.length;++n)e._meta.bounds.inputBounds[n].name===this._selectedInputLink.name&&(w=e._meta.bounds.inputBounds[n].point);this.__drawChain(b,e.pos,g,w,y,e._meta.bounds.rect,t,h,!1,!0)}if(this._selectedNode===e&&this._selectedOutputLink){var g,y=null,b=null,h=!1;this._highlightNode&&this._highlightInputLink?(g=this._highlightInputLink.point,y=this._highlightInputLink.rect,b=this._highlightNode.pos,h=!0):(g={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z},y={left:g.x,top:g.y,width:1,height:1},b={x:0,y:0});var w;for(var n=0;n<e._meta.bounds.outputBounds.length;++n)e._meta.bounds.outputBounds[n].name===this._selectedOutputLink.name&&(w=e._meta.bounds.outputBounds[n].point);this.__drawChain(e.pos,b,w,g,e._meta.bounds.rect,y,t,h,!1,!0)}},__drawChain:function(e,t,n,r,i,s,o,u,a,f){function l(e,t){f?o.lineTo(t,e):o.lineTo(e,t)}function c(e,t,n,r,i){f?o.arcTo(t,e,r,n,i):o.arcTo(e,t,n,r,i)}function h(e,t,n,r,i,s){f?o.bezierCurveTo(t,e,r,n,s,i):o.bezierCurveTo(e,t,n,r,i,s)}o.save(),o.lineWidth=2,o.lineCap="round",o.lineJoin="round",o.beginPath(),o.moveTo(e.x+n.x,e.y+n.y);var p,d,v,m;f?(p={x:e.y+n.y,y:e.x+n.x},d={x:t.y+r.y,y:t.x+r.x},v={top:i.left+e.x,left:i.top+e.y,width:i.height,height:i.width},m={top:s.left+t.x,left:s.top+t.y,width:s.height,height:s.width},o.strokeStyle=a?"cyan":u?"#CCCC00":"#33CC33"):(p={x:e.x+n.x,y:e.y+n.y},d={x:t.x+r.x,y:t.y+r.y},v={top:i.top+e.y,left:i.left+e.x,width:i.width,height:i.height},m={top:s.top+t.y,left:s.left+t.x,width:s.width,height:s.height},o.strokeStyle=a?"cyan":u?"#CCCC00":"#000000");switch(this._chainStyle){case 0:var g=15;if(p.y<d.y){var y=(d.x+p.x)/2,b=(d.y+p.y)/2,w=Math.min(g,Math.abs(d.x-p.x)/2,Math.abs(d.y-p.y)/2);c(p.x,b,y,b,w),c(d.x,b,d.x,d.y,w)}else if(v.left+v.width<m.left){var y=(m.left+v.left+v.width)/2-2,b=(d.y+p.y)/2,E=(y+p.x)/2,S=(d.x+y)/2,w=Math.min(g,Math.abs(d.y-p.y)/4,Math.abs(y-E),Math.abs(y-S));c(p.x,p.y+w,E,p.y+w,w),c(y,p.y+w,y,b,w),c(y,d.y-w,S,d.y-w,w),c(d.x,d.y-w,d.x,d.y,w)}else if(v.left>m.left+m.width){var y=(v.left+m.left+m.width)/2+2,b=(d.y+p.y)/2,E=(y+d.x)/2,S=(p.x+y)/2,w=Math.min(g,Math.abs(d.y-p.y)/4,Math.abs(y-E),Math.abs(y-S));c(p.x,p.y+w,S,p.y+w,w),c(y,p.y+w,y,b,w),c(y,d.y-w,E,d.y-w,w),c(d.x,d.y-w,d.x,d.y,w)}else if(p.y>d.y&&Math.abs(p.y-d.y)>this._drawStyle.links.length){var x=p.x,T=Math.min(v.top-g,m.top-g),N=Math.max(v.top+v.height+g,m.top+m.height+g),b=(p.y+d.y)/2;Math.abs(Math.min(v.left,m.left)-p.x)<=Math.abs(Math.max(v.left+v.width,m.left+m.width)-d.x)?(x=Math.min(v.left-g,m.left-g),N-=2):(x=Math.max(v.left+v.width+g,m.left+m.width+g),N+=2);var y=(p.x+x)/2,w=Math.min(g,Math.abs(x-p.x)/2,Math.abs(x-d.x)/2);c(p.x,N,y,N,w),c(x,N,x,b,w),c(x,T,y,T,w),c(d.x,T,d.x,d.y,w)}break;case 1:if(p.y<d.y){var b=(p.y+d.y)/2,y=(p.x+d.x)/2;h(p.x,b,d.x,b,d.x,d.y)}else if(v.left+v.width<m.left||v.left>m.left+m.width){var w=Math.abs(p.y-d.y)/2,T=m.top-w,N=v.top+v.height+w;h(p.x,N,d.x,T,d.x,d.y)}else if(p.y>d.y&&Math.abs(p.y-d.y)>this._drawStyle.links.length){var C=p.x;Math.abs(Math.min(v.left,m.left)-p.x)<=Math.abs(Math.max(v.left+v.width,m.left+m.width)-d.x)?C=Math.min(v.left,m.left)-15:C=Math.max(v.left+v.width,m.left+m.width)+15;var T=m.top-30,N=Math.max(v.top+v.height+30,m.top+m.height+30),b=(p.y+d.y)/2;h(p.x,N,C,N,C,b),h(C,T,d.x,T,d.x,d.y)}}o.lineTo(t.x+r.x,t.y+r.y),o.stroke(),o.restore()},__drawPropertyValue:function(e,t,n,r){var i;n?i=e.initialProperty(t.name):i=e.property(t.name);if(typeof t.options.display=="function")i=t.options.display.call(e,i);else switch(t.type){case wcPlay.PROPERTY.TOGGLE:return i?"yes":"no";case wcPlay.PROPERTY.SELECT:var s="";t.options.hasOwnProperty("noneValue")&&(s=t.options.noneValue);if((!t.options.hasOwnProperty("allowNone")||t.options.allowNone)&&i==s)return"<none>";var o=t.options.items;$.isFunction(o)&&(o=o.call(e));if($.isArray(o)){var u=!1;for(var a=0;a<o.length;++a)if(typeof o[a]=="object"){if(o[a].value==i){i=o[a].name,u=!0;break}}else if(typeof o[a]=="string"&&o[a]==i){u=!0;break}u||(i="<unknown>")}}return this.__clampString(String(i),r?this._drawStyle.property.longStrLen:this._drawStyle.property.strLen)},__drawDetailsPopup:function(e){var t=e.type+" Node",n=e.description();n&&(n+="\n\n"),n+=e.details();var r=$('<div class="wcPlayDetailsPopupBlocker">'),i=$('<div class="wcPlayDetailsPopup">'),s=$("<h3>"+t+"</h3>"),o=$('<pre class="wcPlayDetailsPopupText">'+n+"</pre>");i.append(s),i.append(o),r.append(i),$("body").append(r),r.click(function(){$(this).remove()})},__drawPalettePopup:function(e,t,n,r,i){if(!this._showingSelector){var s=this,o=null,u=null;this._showingSelector=!0;var a="";switch(r){case wcNode.LINK_TYPE.ENTRY:a="exit";break;case wcNode.LINK_TYPE.EXIT:a="entry";break;case wcNode.LINK_TYPE.INPUT:a="output";break;case wcNode.LINK_TYPE.OUTPUT:a="input"}var f="Create Node";a&&(f+=" and connect to an "+a);var l=$('<div class="wcPlayEditorBlocker">'),c=$('<div id="wcPlayEditorPalettePopup"><label>'+f+":</label></div>");c.css("width",this._drawStyle.palettePopup.width),c.css("height",this._drawStyle.palettePopup.height),this.$main.append(l),this.$main.append(c),l.click(function(){$(this).remove(),c.remove(),s._showingSelector=!1,i&&i(u)});var h=$('<input type="text" id="wcPlayEditorPaletteInput">');c.append(h),h.focus(),h.select(),h.keydown(function(e){e.stopPropagation();if(e.keyCode===27)l.click();else{if(e.keyCode===13)return y(),l.click(),e.preventDefault(),!0;if(e.keyCode===40||e.keyCode===9&&!e.shiftKey){if(o){var t=$("#"+o);if(t.length){var n=t.next(".wcSelectable");n.length||(n=t.parents("li").next(),n=n.find(".wcSelectable").first()),n.length&&(n.addClass("wcSelected"),o=n.attr("id"),t.removeClass("wcSelected"),g(n))}}return e.preventDefault(),!0}if(e.keyCode===38||e.keyCode===9&&e.shiftKey){if(o){var t=$("#"+o);if(t.length){var n=t.prev(".wcSelectable");n.length||(n=t.parents("li").prev(),n=n.find(".wcSelectable").last()),n.length&&(n.addClass("wcSelected"),o=n.attr("id"),t.removeClass("wcSelected"),g(n))}}return e.preventDefault(),!0}}return!0});var p="";h.keyup(function(e){var t=h.val().toLowerCase();p!==t&&(p=t,console.log("new search"),m(t))});var d=new Fuse(this._nodeLibrary,{caseSensitive:!1,shouldSort:!0,tokenize:!1,threshold:.2,location:0,distance:100,maxPatternLength:32,keys:["displayName","category",a+".name"]}),v=null;function m(e){var i=d.search(e);!i.length&&!e&&(i=s._nodeLibrary);var u=$('<div id="wcPlayEditorPaletteList">'),f=$("<ul>");u.append(f);for(var h=0;h<i.length;++h){var p=i[h],m=null,b=null;if(a){if(!p[a].length)continue;m=p[a]}var w="";m||(w=' class="wcSelectable"');var E=!1,S=$('<li id="wcNode-'+p.id+'"'+w+' title="'+p.desc+'">'+p.displayName+"</li>");if(m){var x=$("<ul>");S.append(x);for(var T=0;T<m.length;++T)t.onRequestConnect(n,r,p.node,m[T].name,a)&&p.node.onRequestConnect(m[T].name,a,t,n,r)&&(E=!0,x.append('<li id="wcNode-'+p.id+"-"+T+'" class="wcSelectable wcLinkItem" title="'+m[T].desc+'"><span class="wcLinkType">'+a+' -- </span><span class="wcLinkName">'+m[T].name+"</span></li>"))}else E=!0;E&&f.append(S)}var N=[],C=!1;o&&(N=f.find("#"+o)),N.length||(N=f.find(".wcSelectable").first()),o=null,N.length&&(N.addClass("wcSelected"),o=N.attr("id")),v&&v.remove(),v=u,c.append(v),g(N),$("#wcPlayEditorPaletteList .wcSelectable").click(function(){return o=this.id,y($(this)),l.click(),event.preventDefault(),!0})}function g(e){if(e.length&&e[0].scrollIntoView){var t=e[0].getBoundingClientRect(),n=v[0].getBoundingClientRect();t.top<n.top?(e.hasClass("wcLinkItem")&&(e=e.parents("li")),e[0].scrollIntoView(!0)):t.bottom>n.bottom&&e[0].scrollIntoView(!1)}}function y(){if(!o)return;var i=o.split("-")[1],u=o.split("-")[2],f=s._nodeLibrary[i];if(!f)return;var l=new window.wcPlayNodes[f.className](s._parent,{x:0,y:0}),c=f.node.export();c.id=l.id,c.pos.x=(e.x-s._viewportCamera.x)/s._viewportCamera.z,c.pos.y=(e.y-s._viewportCamera.y)/s._viewportCamera.z;var h=null;switch(r){case wcNode.LINK_TYPE.ENTRY:h=f.node._meta.bounds.exitBounds;break;case wcNode.LINK_TYPE.EXIT:h=f.node._meta.bounds.entryBounds;break;case wcNode.LINK_TYPE.INPUT:h=f.node._meta.bounds.outputBounds;break;case wcNode.LINK_TYPE.OUTPUT:h=f.node._meta.bounds.inputBounds}if(h){var p=h.find(function(e){return e.name===f[a][u].name});p&&(c.pos.x-=p.point.x,c.pos.y-=p.point.y)}l.import(c,[]);switch(r){case wcNode.LINK_TYPE.ENTRY:t.connectEntry(n,l,f[a][u].name);break;case wcNode.LINK_TYPE.EXIT:t.connectExit(n,l,f[a][u].name);break;case wcNode.LINK_TYPE.INPUT:t.connectInput(n,l,f[a][u].name);break;case wcNode.LINK_TYPE.OUTPUT:t.connectOutput(n,l,f[a][u].name)}s.__onCreateNode(l),s._selectedNode=l,s._selectedNodes=[l],s.__updateNode(l,0,s._viewportContext),s.__drawNode(l,s._viewportContext)}m("")}if(c){var b=this.$main.width(),w=this.$main.height(),E=e.x-this._drawStyle.palettePopup.width/2,S=e.y;switch(r){case wcNode.LINK_TYPE.INPUT:E=e.x-this._drawStyle.palettePopup.width,S=e.y-this._drawStyle.palettePopup.searchOffset;break;case wcNode.LINK_TYPE.OUTPUT:E=e.x,S=e.y-this._drawStyle.palettePopup.searchOffset;break;case wcNode.LINK_TYPE.ENTRY:S=e.y-this._drawStyle.palettePopup.height}E=Math.min(Math.max(E,this._drawStyle.palettePopup.padding),b-this._drawStyle.palettePopup.width-this._drawStyle.palettePopup.padding),S=Math.min(Math.max(S,this._drawStyle.palettePopup.padding),w-this._drawStyle.palettePopup.height-this._drawStyle.palettePopup.padding),c.css("left",E+"px"),c.css("top",S+"px")}},__drawTitleEditor:function(e,t){if(this._options.readOnly)return;var n=this,r=!1,i="",s=e.onNameEditSuggestion();if(Array.isArray(s)){i=' list="wcDynamicSuggestionList"';var o=$('<datalist id="wcDynamicSuggestionList"/>');for(var u=0;u<s.length;++u)typeof s[u]=="object"?o.append($('<option value="'+s[u].value+'">'+s[u].name+"</option>")):o.append($('<option value="'+s[u]+'">'+s[u]+"</option>"));$("body").append(o)}var a=$('<input type="text" maxlength="40"'+i+"/>");a.val(e.name),a.change(function(){$("#wcDynamicSuggestionList").remove();if(!r){n._undoManager&&(n._undoManager.beginGroup('Title changed for Node "'+e.category+"."+e.type+'"'),n._undoManager.addEvent("",{id:e.id,oldValue:e.name,newValue:a.val(),engine:n._engine},function(){var e=this.engine.nodeById(this.id),t=e.name,n=e.onNameChanging(t,this.oldValue);n===undefined&&(n=this.oldValue),e.name=n,e.onNameChanged(t,n)},function(){var e=this.engine.nodeById(this.id),t=e.name,n=e.onNameChanging(t,this.newValue);n===undefined&&(n=this.newValue),e.name=n,e.onNameChanged(t,n)}));var t=e.name,i=e.onNameChanging(t,a.val());i===undefined&&(i=a.val()),e.name=i,e.onNameChanged(t,i,n._undoManager),n._undoManager&&n._undoManager.endGroup()}});var f={top:0,left:this.$palette.width()};this.$main.append(a),a.addClass("wcPlayEditorControl"),a.focus(),a.select(),a.blur(function(){$("#wcDynamicSuggestionList").remove(),$(this).remove()}),a.keydown(function(e){e.stopPropagation()}),a.keyup(function(e){switch(e.keyCode){case 13:a.blur();break;case 27:r=!0,a.blur()}return!1}),a.css("top",f.top+(e.pos.y+t.top)*this._viewportCamera.z+this._viewportCamera.y).css("left",f.left+(e.pos.x+t.left)*this._viewportCamera.z+this._viewportCamera.x).css("width",Math.max(t.width*this._viewportCamera.z,200)).css("height",Math.max(t.height*this._viewportCamera.z,15))},__drawPropertyEditor:function(e,t,n,r){function f(t,n,r){a._undoManager&&(a._undoManager.beginGroup('Property "'+t+'" changed for Node "'+e.category+"."+e.type+'"'),a._undoManager.addEvent("",{id:e.id,name:t,propFn:u,oldValue:n,newValue:r,engine:a._engine},function(){var e=this.engine.nodeById(this.id);e&&e[this.propFn](this.name,this.oldValue,!0,!0)},function(){var e=this.engine.nodeById(this.id);e&&e[this.propFn](this.name,this.newValue,!0,!0)}))}function l(){a._undoManager&&a._undoManager.endGroup()}if(this._options.readOnly||t.options.readOnly)return;var i=null,s=!1,o=!0,u=r?"initialProperty":"property",a=this,c=$('<div class="wcPlayEditorBlocker">');switch(t.type){case wcPlay.PROPERTY.TOGGLE:var h=e[u](t.name);f(t.name,h,!h),e[u](t.name,!h,!0,!0,this._undoManager),l();break;case wcPlay.PROPERTY.NUMBER:i=$('<input type="number"'+(t.options.min?' min="'+t.options.min+'"':"")+(t.options.max?' max="'+t.options.max+'"':"")+(t.options.step?' step="'+t.options.step+'"':"")+">"),i.val(parseFloat(e[u](t.name))),i.change(function(){if(!s){var n=$(this).attr("min")!==undefined?parseFloat($(this).attr("min")):-Infinity,r=$(this).attr("max")!==undefined?parseFloat($(this).attr("max")):Infinity;g=Math.min(r,Math.max(n,parseFloat(i.val()))),f(t.name,g,i.val()),e[u](t.name,i.val(),!0,!0,this._undoManager),l()}}),i.keyup(function(e){e.keyCode===13&&c.click()});break;case wcPlay.PROPERTY.STRING:case wcPlay.PROPERTY.DYNAMIC:var p="",d=t.options.items;$.isFunction(d)&&(d=d.call(e));if(Array.isArray(d)){p=' list="wcDynamicSuggestionList"';var v=$('<datalist id="wcDynamicSuggestionList"/>');for(var m=0;m<d.length;++m)typeof d[m]=="object"?v.append($('<option value="'+d[m].value+'">'+d[m].name+"</option>")):v.append($('<option value="'+d[m]+'">'+d[m]+"</option>"));$("body").append(v)}t.options.multiline?(i=$("<textarea"+(t.options.maxlength?' maxlength="'+t.options.maxlength+'"':"")+p+"/>"),o=!1):i=$('<input type="text" maxlength="'+(t.options.maxlength||524288)+'"'+p+"/>"),i.val(e[u](t.name).toString()),i.change(function(){$("#wcDynamicSuggestionList").remove(),s||(g=e[u](t.name),f(t.name,g,i.val()),e[u](t.name,i.val(),!0,!0,this._undoManager),l(),c.click())});break;case wcPlay.PROPERTY.SELECT:var g=e[u](t.name);i=$("<select>");var d=t.options.items;$.isFunction(d)&&(d=d.call(e));if(!Array.isArray(d)){console.log("ERROR: Tried to display a Select type property when no selection list was provided.");return}var y="";t.options.hasOwnProperty("noneValue")&&(y=t.options.noneValue);var b=!1;if(!t.options.hasOwnProperty("allowNone")||t.options.allowNone)i.append($('<option value=""'+(y==g?" selected":"")+">&lt;none&gt;</option>")),y==g&&(b=!0);for(var m=0;m<d.length;++m)typeof d[m]=="object"?(i.append($('<option value="'+d[m].value+'"'+(d[m].value==g?" selected":"")+">"+d[m].name+"</option>")),d[m].value==g&&(b=!0)):(i.append($('<option value="'+d[m]+'"'+(d[m]==g?" selected":"")+">"+d[m]+"</option>")),d[m]==g&&(b=!0));b||i.prepend($('<option value="'+g+'" selected>&lt;unknown&gt;</option>')),i.change(function(){if(!s){g=e[u](t.name);var n=i.val();n==""&&t.options.hasOwnProperty("noneValue")&&(n=t.options.noneValue),f(t.name,g,n),e[u](t.name,n,!0,!0,this._undoManager),l(),c.click()}});break;case wcPlay.PROPERTY.CUSTOM:if(typeof t.options.onCreate=="function"){var g=e[u](t.name);i=$(t.options.onCreate(e,t.name,g,r,function(n){s||(g=e[u](t.name),f(t.name,g,n),e[u](t.name,n,!0,!0,this._undoManager),l(),c.click())}))}}if(i){var w={top:0,left:this.$palette.width()};this.$main.append(c),this.$main.append(i),i.addClass("wcPlayEditorControl"),i.focus(),i.select(),c.click(function(e){$("#wcDynamicSuggestionList").remove(),e.stopPropagation(),c.remove(),i.remove()}),i.keydown(function(e){e.stopPropagation()}),i.keyup(function(e){switch(e.keyCode){case 13:(o||e.ctrlKey)&&i.blur();break;case 27:s=!0,i.blur()}return!1}),i.css("top",w.top+(e.pos.y+n.rect.top)*this._viewportCamera.z+this._viewportCamera.y).css("left",w.left+(e.pos.x+n.rect.left)*this._viewportCamera.z+this._viewportCamera.x).css("width",Math.max(n.rect.width*this._viewportCamera.z,200)).css("height",Math.max(n.rect.height*this._viewportCamera.z,15))}},__onCreateNode:function(e){this._undoManager&&this._undoManager.addEvent('Created Node "'+e.category+"."+e.type+'"',{id:e.id,className:e.className,data:e.export(),engine:this._engine,parent:this._parent.id||this._parent},function(){var e=this.engine.nodeById(this.id);for(var t=0;t<this.engine._editors.length;++t){var n=this.engine._editors[t]._parent;while(!n||!n.instanceOf("wcPlay")){if(n==e){this.engine._editors[t]._parent=e._parent,this.engine._editors[t].center();break}n=n._parent}}e.destroy()},function(){var e=this.parent;typeof e=="number"&&(e=this.engine.nodeById(e));var t=new window.wcPlayNodes[this.className](e,this.data.pos);t.id=this.id,t.import(this.data)})},__onDestroyNode:function(e){this._undoManager&&this._undoManager.addEvent("",{data:e.export(),parent:this._parent,engine:this._engine},function(){var e=new window.wcPlayNodes[this.data.className](this.parent,this.data.pos);e.import(this.data)},function(){var e=this.engine.nodeById(this.data.id);for(var t=0;t<this.engine._editors.length;++t){var n=this.engine._editors[t]._parent;while(!n||!n.instanceOf("wcPlay")){if(n==e){this.engine._editors[t]._parent=e._parent,this.engine._editors[t].center();break}n=n._parent}}e.destroy()})},__handleAutoScroll:function(e,t){var n=!1,r=this.$viewport.width(),i=this.$viewport.height(),s=Math.min(100,r/2,i/2),o=.15;this._autoScrollNodes=t,e&&(this._mouse.x>=r-s?(n=!0,this._autoScrollDirection.x=this._mouse.x-r+s,this._autoScrollDirection.y=0):this._mouse.x<=s&&(n=!0,this._autoScrollDirection.x=this._mouse.x-s,this._autoScrollDirection.y=0),this._mouse.y>=i-s?(n=!0,this._autoScrollDirection.x=0,this._autoScrollDirection.y=this._mouse.y-i+s):this._mouse.y<=s&&(n=!0,this._autoScrollDirection.x=0,this._autoScrollDirection.y=this._mouse.y-s));if(n&&!this._autoScrollInterval){var u=this;this._autoScrollInterval=setInterval(function(){var e=u._autoScrollDirection.x*o,t=u._autoScrollDirection.y*o;u._viewportCamera.x-=e,u._viewportCamera.y-=t;if(u._autoScrollNodes)for(var n=0;n<u._selectedNodes.length;++n){var r=u._selectedNodes[n],i={x:r.pos.x,y:r.pos.y},s={x:r.pos.x+e/u._viewportCamera.z,y:r.pos.y+t/u._viewportCamera.z},s=r.onMoving(i,s)||s;if(i.x!==s.x||i.y!==s.y)r.pos.x=s.x,r.pos.y=s.y,r.onMoved(i,s)}},10)}else this._autoScrollInterval&&!n&&(clearInterval(this._autoScrollInterval),this._autoScrollInterval=0)},__setupControls:function(){var e=this;this.__bindMenuHandlers(),this.$viewport.on("mousemove",function(t){e.__onViewportMouseMove(t,this)}),this.$viewport.on("mousedown",function(t){e.__onViewportMouseDown(t,this)}),this.$viewport.on("mouseup",function(t){e.__onViewportMouseUp(t,this)}),this.$viewport.on("mouseenter",function(t){e.__onViewportMouseEnter(t,this)}),this.$viewport.on("mouseleave",function(t){e.__onViewportMouseLeave(t,this)}),this.$viewport.on("click",function(t){e.__onViewportMouseClick(t,this)}),this.$viewport.on("dblclick",function(t){e.__onViewportMouseDoubleClick(t,this)}),this.$viewport.on("mousewheel DOMMouseScroll",function(t){e.__onViewportMouseWheel(t,this)})},__bindMenuHandlers:function(){function t(t,n){n?e.triggerEvent("onBeforeImport",[]):e.triggerEvent("onBeforeLoad",[]);var r=new FileReader;r.onload=function(r){e._engine&&(n?e._engine.import(r.target.result,t.name)&&(e.__setupPalette(),e.triggerEvent("onImported",[]),e.$typeButton[3].click()):e._engine.load(r.target.result)?(e._parent=e._engine,e._selectedNode=null,e._selectedNodes=[],e._undoManager&&e._undoManager.clear(),e.center(),e.triggerEvent("onLoaded",[])):alert('Failed to open file "'+t.name+'"\nPlease check to ensure it is actually a wcPlay script file.'))},r.readAsText(t)}var e=this;$("body").on("change","#wcPlayEditorHiddenFileLoader",function(e){if($(this).hasClass("disabled"))return;e.target.files.length&&(t(e.target.files[0]),$(this).val(""),$(this).remove())}),$("body").on("change","#wcPlayEditorHiddenFileImporter",function(e){if($(this).hasClass("disabled"))return;e.target.files.length&&(t(e.target.files[0],!0),$(this).val(""),$(this).remove())}),this.$container.on("dragover",function(e){e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy"}),this.$container.on("drop",function(e){e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.files.length&&t(e.originalEvent.dataTransfer.files[0],e.ctrlKey)})},__onViewportMouseMove:function(e,t){var n=this.__mouse(e,this.$viewport.offset());if(n.x!==this._mouse.x||n.y!==this._mouse.y)this._mouseMoved=!0;if(this._highlightRect&&this._parent){this._highlightRect.x=(n.x-this._viewportCamera.x)/this._viewportCamera.z-this._highlightRect.ox,this._highlightRect.y=(n.y-this._viewportCamera.y)/this._viewportCamera.z-this._highlightRect.oy,this._highlightRect.width=this._highlightRect.x,this._highlightRect.height=this._highlightRect.y,this._highlightRect.width<0&&(this._highlightRect.left=this._highlightRect.ox+this._highlightRect.width,this._highlightRect.width*=-1),this._highlightRect.height<0&&(this._highlightRect.top=this._highlightRect.oy+this._highlightRect.height,this._highlightRect.height*=-1),this._selectedNodes=[];var r=this;function i(e){for(var t=0;t<e.length;++t)r.__rectOnRect(e[t]._meta.bounds.inner,r._highlightRect,e[t].pos)&&r._selectedNodes.push(e[t])}i(this._parent._storageNodes),i(this._parent._compositeNodes),i(this._parent._processNodes),i(this._parent._entryNodes),this._mouse=n,this.__handleAutoScroll(!0);return}if(this._viewportMoving){var s=n.x-this._mouse.x,o=n.y-this._mouse.y;this._viewportCamera.x+=s,this._viewportCamera.y+=o,this._mouse=n,!this._viewportMoved&&this._mouseMoved&&(this._viewportMoved=!0,this.$viewport.addClass("wcMoving")),this.__handleAutoScroll(!1);return}if(this._viewportMovingNode){var s=n.x-this._mouse.x,o=n.y-this._mouse.y;for(var u=0;u<this._selectedNodes.length;++u){var a=this._selectedNodes[u],f={x:a.pos.x,y:a.pos.y},l={x:a.pos.x+s/this._viewportCamera.z,y:a.pos.y+o/this._viewportCamera.z},l=a.onMoving(f,l)||l;if(f.x!==l.x||f.y!==l.y)a.pos.x=l.x,a.pos.y=l.y,a.onMoved(f,l)}this._mouse=n,this.__handleAutoScroll(!0,!0);return}this._mouse=n,this._highlightNode=null,this._highlightCrumb=-1,this._highlightTitle=!1,this._highlightDetails=!1,this._highlightDebugLog=!1,this._highlightBreakpoint=!1,this._highlightEntryLink=!1,this._highlightExitLink=!1,this._highlightInputLink=!1,this._highlightOutputLink=!1,this._highlightPropertyValue=!1,this._highlightPropertyInitialValue=!1,this.__handleAutoScroll(this._selectedEntryLink||this._selectedExitLink||this._selectedInputLink||this._selectedOutputLink);var c=this._highlightViewport;this._highlightViewport=!1,this.$viewport.removeClass("wcClickable wcMoving wcGrab wcNoDrop"),this.$viewport.attr("title","");for(var u=0;u<this._crumbBounds.length;++u)if(this.__inRect(n,this._crumbBounds[u].rect)){this._highlightCrumb=u,this.$viewport.addClass("wcClickable"),this.$viewport.attr("title","Click to go to this level in the hierarchy.");break}var a=null;this._highlightCrumb===-1&&(a=this.__findNodeAtPos(n,this._viewportCamera));if(a){!this._options.readOnly&&this.__inRect(n,a._meta.bounds.farRect,a.pos,this._viewportCamera)&&(this._highlightNode=a,this.$viewport.attr("title",a._meta.description?a._meta.description+"\n":""),this.$viewport.addClass("wcMoving")),!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedInputLink&&!this._selectedOutputLink&&(this.__inRect(n,a._meta.bounds.debugLog,a.pos,this._viewportCamera)&&(this._highlightDebugLog=!0,this._highlightNode=a,this.$viewport.addClass("wcClickable"),a._log?this.$viewport.attr("title","Disable debug logging for this node."):this.$viewport.attr("title","Enable debug logging for this node.")),this.__inRect(n,a._meta.bounds.breakpoint,a.pos,this._viewportCamera)&&(this._highlightBreakpoint=!0,this._highlightNode=a,this.$viewport.addClass("wcClickable"),this.$viewport.attr("title","Toggle debug breakpoint on this node.")));if(!this._options.readOnly&&!this._selectedEntryLink&&!this._selectedInputLink&&!this._selectedOutputLink)for(var u=0;u<a._meta.bounds.entryBounds.length;++u)if(this.__inRect(n,a._meta.bounds.entryBounds[u].rect,a.pos,this._viewportCamera)){this._highlightNode=a,this._highlightEntryLink=a._meta.bounds.entryBounds[u];var h;for(var p=0;p<a.chain.entry.length;++p)if(a.chain.entry[p].name==this._highlightEntryLink.name){h=a.chain.entry[p];break}this.$viewport.attr("title",(h.meta.description?h.meta.description+"\n":"")+"Click and drag to create a new flow chain from another node. Double click to manually fire this entry link."),this.$viewport.addClass("wcGrab");break}if(!this._options.readOnly&&!this._selectedExitLink&&!this._selectedInputLink&&!this._selectedOutputLink)for(var u=0;u<a._meta.bounds.exitBounds.length;++u)if(this.__inRect(n,a._meta.bounds.exitBounds[u].rect,a.pos,this._viewportCamera)){this._highlightNode=a,this._highlightExitLink=a._meta.bounds.exitBounds[u];var h;for(var p=0;p<a.chain.exit.length;++p)if(a.chain.exit[p].name==this._highlightExitLink.name){h=a.chain.exit[p];break}this.$viewport.attr("title",(h.meta.description?h.meta.description+"\n":"")+"Click and drag to create a new flow chain to another node. Double click to manually fire this exit link."),this.$viewport.addClass("wcGrab");break}if(!this._options.readOnly&&!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedInputLink)for(var u=0;u<a._meta.bounds.inputBounds.length;++u)if(this.__inRect(n,a._meta.bounds.inputBounds[u].rect,a.pos,this._viewportCamera)){var d=!0;this._highlightNode=a,this._selectedOutputLink&&(!this._selectedNode.onRequestConnect(this._selectedOutputLink.name,wcNode.LINK_TYPE.OUTPUT,a,a._meta.bounds.inputBounds[u].name,wcNode.LINK_TYPE.INPUT)||!a.onRequestConnect(a._meta.bounds.inputBounds[u].name,wcNode.LINK_TYPE.INPUT,this._selectedNode,this._selectedOutputLink.name,wcNode.LINK_TYPE.OUTPUT))&&(d=!1),d?(this._highlightInputLink=a._meta.bounds.inputBounds[u],this.$viewport.attr("title","Click and drag to chain this property to another."),this.$viewport.addClass("wcGrab")):this.$viewport.addClass("wcNoDrop");break}if(!this._options.readOnly&&!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedOutputLink)for(var u=0;u<a._meta.bounds.outputBounds.length;++u)if(this.__inRect(n,a._meta.bounds.outputBounds[u].rect,a.pos,this._viewportCamera)){var d=!0;this._highlightNode=a,this._selectedInputLink&&(!this._selectedNode.onRequestConnect(this._selectedInputLink.name,wcNode.LINK_TYPE.INPUT,a,a._meta.bounds.inputBounds[u].name,wcNode.LINK_TYPE.OUTPUT)||!a.onRequestConnect(a._meta.bounds.inputBounds[u].name,wcNode.LINK_TYPE.OUTPUT,this._selectedNode,this._selectedInputLink.name,wcNode.LINK_TYPE.INPUT))&&(d=!1),d?(this._highlightOutputLink=a._meta.bounds.outputBounds[u],this.$viewport.attr("title","Click and drag to chain this property to another. Double click to send its value through the chain."),this.$viewport.addClass("wcGrab")):this.$viewport.addClass("wcNoDrop");break}if(!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedInputLink&&!this._selectedOutputLink){if(!this._options.readOnly){this.__inRect(this._mouse,a._meta.bounds.titleBounds,a.pos,this._viewportCamera)&&(this._highlightNode=a,this._highlightTitle=!0,this.$viewport.attr("title","Click to add or modify an additional label for this title."),this.$viewport.addClass("wcClickable")),this.__inRect(this._mouse,a._meta.bounds.detailsBounds,a.pos,this._viewportCamera)&&(this._highlightNode=a,this._highlightDetails=!0,this.$viewport.attr("title","Click to see futher details for this node."),this.$viewport.addClass("wcClickable"));var v;for(var u=0;u<a._meta.bounds.propertyBounds.length;++u)if(this.__inRect(this._mouse,a._meta.bounds.propertyBounds[u].rect,a.pos,this._viewportCamera)){v=a._meta.bounds.propertyBounds[u];break}if(v)for(var u=0;u<a.properties.length;++u)if(a.properties[u].name===v.name){this.$viewport.attr("title",a.properties[u].options.description?a.properties[u].options.description+"\n":"");break}var m;for(var u=0;u<a._meta.bounds.valueBounds.length;++u)if(this.__inRect(this._mouse,a._meta.bounds.valueBounds[u].rect,a.pos,this._viewportCamera)){m=a._meta.bounds.valueBounds[u];break}if(m)for(var u=0;u<a.properties.length;++u)if(a.properties[u].name===m.name){this._highlightNode=a,this._highlightPropertyValue=m,this.$viewport.attr("title",(a.properties[u].options.description?a.properties[u].options.description+"\n":"")+'Click to change the current value of this property.\nValue = "'+a.properties[u].value+'"\n'),a.properties[u].options.readOnly||this.$viewport.addClass("wcClickable");break}var g;for(var u=0;u<a._meta.bounds.initialBounds.length;++u)if(this.__inRect(this._mouse,a._meta.bounds.initialBounds[u].rect,a.pos,this._viewportCamera)){g=a._meta.bounds.initialBounds[u];break}if(g)for(var u=0;u<a.properties.length;++u)if(a.properties[u].name===g.name){this._highlightNode=a,this._highlightPropertyInitialValue=g,this.$viewport.attr("title",(a.properties[u].options.description?a.properties[u].options.description+"\n":"")+'Click to change the initial value of this property.\nValue = "'+a.properties[u].initialValue+'"\n'),a.properties[u].options.readOnly||this.$viewport.addClass("wcClickable");break}}if(a._meta.bounds.viewportBounds){var y={x:(n.x-this._viewportCamera.x)/this._viewportCamera.z-(a.pos.x+a._meta.bounds.viewportBounds.left),y:(n.y-this._viewportCamera.y)/this._viewportCamera.z-(a.pos.y+a._meta.bounds.viewportBounds.top)};this.__inRect(this._mouse,a._meta.bounds.viewportBounds,a.pos,this._viewportCamera)?(this._highlightNode=a,this._highlightViewport=!0,this.$viewport.addClass("wcClickable"),c||a.onViewportMouseEnter(e,y,this._options.readOnly),a.onViewportMouseMove(e,y,this._options.readOnly)):c&&a.onViewportMouseLeave(e,y,this._options.readOnly)}}}},__onViewportMouseDown:function(e,t){this._mouse=this.__mouse(e,this.$viewport.offset()),this._mouseMoved=!1;if(e.ctrlKey||this._mouse.which===2){this._highlightRect={top:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z,left:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,oy:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z,ox:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,x:0,y:0,width:0,height:0};return}var n=!1,r=this.__findNodeAtPos(this._mouse,this._viewportCamera);if(r){if(!n&&!this._options.readOnly)for(var i=0;i<r._meta.bounds.entryBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.entryBounds[i].rect,r.pos,this._viewportCamera)){n=!0;if(e.altKey){this.onDisconnectEntryChains(r,r._meta.bounds.entryBounds[i].name);break}this._selectedNode=r,this._selectedNodes=[r],this._selectedEntryLink=r._meta.bounds.entryBounds[i],this.$viewport.addClass("wcGrabbing");break}if(!n&&!this._options.readOnly)for(var i=0;i<r._meta.bounds.exitBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.exitBounds[i].rect,r.pos,this._viewportCamera)){n=!0;if(e.altKey){this.onDisconnectExitChains(r,r._meta.bounds.exitBounds[i].name);break}if(e.shiftKey){r.activateExit(r._meta.bounds.exitBounds[i].name);break}this._selectedNode=r,this._selectedNodes=[r],this._selectedExitLink=r._meta.bounds.exitBounds[i],this.$viewport.addClass("wcGrabbing");break}if(!n&&!this._options.readOnly)for(var i=0;i<r._meta.bounds.inputBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.inputBounds[i].rect,r.pos,this._viewportCamera)){n=!0;if(e.altKey){this.onDisconnectInputChains(r,r._meta.bounds.inputBounds[i].name);break}this._selectedNode=r,this._selectedNodes=[r],this._selectedInputLink=r._meta.bounds.inputBounds[i],this.$viewport.addClass("wcGrabbing");break}if(!n&&!this._options.readOnly)for(var i=0;i<r._meta.bounds.outputBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.outputBounds[i].rect,r.pos,this._viewportCamera)){n=!0;if(e.altKey){this.onDisconnectOutputChains(r,r._meta.bounds.outputBounds[i].name);break}this._selectedNode=r,this._selectedNodes=[r],this._selectedOutputLink=r._meta.bounds.outputBounds[i],this.$viewport.addClass("wcGrabbing");break}if(!n&&r._meta.bounds.viewportBounds){var s={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z-r._meta.bounds.viewportBounds.left,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z-r._meta.bounds.viewportBounds.top};this.__inRect(this._mouse,r._meta.bounds.viewportBounds,r.pos,this._viewportCamera)&&(this._selectedNode=r,this._selectedNodes=[r],r.onViewportMouseDown(e,s,this._options.readOnly)&&(n=!0))}if(!n&&this.__inRect(this._mouse,r._meta.bounds.farRect,r.pos,this._viewportCamera)){n=!0;if(!this._selectedNodes.length||this._selectedNodes.indexOf(r)===-1)this._selectedNode=r,this._selectedNodes=[r];this._viewportMovingNode=!this._options.readOnly,this._selectedNodeOrigins=[];for(var i=0;i<this._selectedNodes.length;++i){var o=this._selectedNodes[i];this._selectedNodeOrigins.push({x:o.pos.x,y:o.pos.y})}}}n||(this._viewportMoving=!0,this._viewportMoved=!1)},__onViewportMouseUp:function(e,t){function u(){o._selectedEntryLink=!1,o._selectedExitLink=!1,o._selectedInputLink=!1,o._selectedOutputLink=!1,o._viewportMovingNode=!1,o._viewportMoving&&(o._viewportMoving=!1,o._viewportMoved?(o._viewportMoved=!1,o.$viewport.removeClass("wcMoving")):(o._selectedNode=null,o._selectedNodes=[]))}this.$viewport.removeClass("wcGrabbing");if(this._highlightRect&&this._parent){this._highlightRect=null;return}if(this._selectedNodes.length&&this._selectedNodeOrigins.length){this._undoManager&&this._undoManager.beginGroup("Node(s) moved.");for(var n=0;n<this._selectedNodes.length;++n){var r=this._selectedNodes[n];if(r.pos.x!==this._selectedNodeOrigins[n].x||r.pos.y!==this._selectedNodeOrigins[n].y)r.onMoved({x:this._selectedNodeOrigins[n].x,y:this._selectedNodeOrigins[n].y},{x:r.pos.x,y:r.pos.y}),this._undoManager&&this._undoManager.addEvent('Moved Node "'+r.category+"."+r.type+'"',{id:r.id,start:{x:this._selectedNodeOrigins[n].x,y:this._selectedNodeOrigins[n].y},end:{x:r.pos.x,y:r.pos.y},engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=e.onMoving({x:this.end.x,y:this.end.y},{x:this.start.x,y:this.start.y})||this.start;e.pos.x=this.start.x,e.pos.y=this.start.y,e.onMoved({x:this.end.x,y:this.end.y},{x:t.x,y:t.y})},function(){var e=this.engine.nodeById(this.id),t=e.onMoving({x:this.start.x,y:this.start.y},{x:this.end.x,y:this.end.y})||this.end;e.pos.x=this.end.x,e.pos.y=this.end.y,e.onMoved({x:this.start.x,y:this.start.y},{x:t.x,y:t.y})})}this._undoManager&&this._undoManager.endGroup(),this._selectedNodeOrigins=[]}this._selectedNode&&this._selectedEntryLink&&this._highlightNode&&this._highlightExitLink&&(this._selectedNode.connectEntry(this._selectedEntryLink.name,this._highlightNode,this._highlightExitLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectEntry(this._selectedEntryLink.name,this._highlightNode,this._highlightExitLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Entry Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedEntryLink.name+'" to Exit Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightExitLink.name+'"',{id:this._selectedNode.id,name:this._selectedEntryLink.name,targetId:this._highlightNode.id,targetName:this._highlightExitLink.name,engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.connectEntry(this.name,t,this.targetName)},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.disconnectEntry(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Entry Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedEntryLink.name+'" to Exit Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightExitLink.name+'"',{id:this._selectedNode.id,name:this._selectedEntryLink.name,targetId:this._highlightNode.id,targetName:this._highlightExitLink.name,engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.disconnectEntry(this.name,t,this.targetName)},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.connectEntry(this.name,t,this.targetName)})),this._selectedNode&&this._selectedExitLink&&this._highlightNode&&this._highlightEntryLink&&(this._selectedNode.connectExit(this._selectedExitLink.name,this._highlightNode,this._highlightEntryLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectExit(this._selectedExitLink.name,this._highlightNode,this._highlightEntryLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Exit Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedExitLink.name+'" to Entry Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightEntryLink.name+'"',{id:this._selectedNode.id,name:this._selectedExitLink.name,targetId:this._highlightNode.id,targetName:this._highlightEntryLink.name,engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.connectExit(this.name,t,this.targetName)},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.disconnectExit(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Exit Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedExitLink.name+'" to Entry Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightEntryLink.name+'"',{id:this._selectedNode.id,name:this._selectedExitLink.name,targetId:this._highlightNode.id,targetName:this._highlightEntryLink.name,engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.disconnectExit(this.name,t,this.targetName)},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.connectExit(this.name,t,this.targetName)})),this._selectedNode&&this._selectedInputLink&&this._highlightNode&&this._highlightOutputLink&&(this._selectedNode.connectInput(this._selectedInputLink.name,this._highlightNode,this._highlightOutputLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectInput(this._selectedInputLink.name,this._highlightNode,this._highlightOutputLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Property Input Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedInputLink.name+'" to Property Output Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightOutputLink.name+'"',{id:this._selectedNode.id,name:this._selectedInputLink.name,targetId:this._highlightNode.id,targetName:this._highlightOutputLink.name,engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.connectInput(this.name,t,this.targetName)},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.disconnectInput(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Property Input Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedInputLink.name+'" to Property Output Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightOutputLink.name+'"',{id:this._selectedNode.id,name:this._selectedInputLink.name,targetId:this._highlightNode.id,targetName:this._highlightOutputLink.name,engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.disconnectInput(this.name,t,this.targetName)},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.connectInput(this.name,t,this.targetName)})),this._selectedNode&&this._selectedOutputLink&&this._highlightNode&&this._highlightInputLink&&(this._selectedNode.connectOutput(this._selectedOutputLink.name,this._highlightNode,this._highlightInputLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectOutput(this._selectedOutputLink.name,this._highlightNode,this._highlightInputLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Property Output Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedOutputLink.name+'" to Property Input Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightInputLink.name+'"',{id:this._selectedNode.id,name:this._selectedOutputLink.name,targetId:this._highlightNode.id,targetName:this._highlightInputLink.name,engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.connectOutput(this.name,t,this.targetName)},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.disconnectOutput(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Property Output Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedOutputLink.name+'" to Property Input Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightInputLink.name+'"',{id:this._selectedNode.id,name:this._selectedOutputLink.name,targetId:this._highlightNode.id,targetName:this._highlightInputLink.name,engine:this._engine},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.disconnectOutput(this.name,t,this.targetName)},function(){var e=this.engine.nodeById(this.id),t=this.engine.nodeById(this.targetId);e.connectOutput(this.name,t,this.targetName)}));if(this._selectedNode&&this._highlightViewport){var i=this.__mouse(e,this.$viewport.offset()),s={x:(i.x-this._viewportCamera.x)/this._viewportCamera.z-this._selectedNode._meta.bounds.viewportBounds.left,y:(i.y-this._viewportCamera.y)/this._viewportCamera.z-this._selectedNode._meta.bounds.viewportBounds.top};this._selectedNode.onViewportMouseUp(e,s,this._options.readOnly)}var o=this;if(this._selectedNode&&!this._highlightNode&&!this._highlightViewport){var a=null,f=null;this._selectedEntryLink&&(a=this._selectedEntryLink.name,f=wcNode.LINK_TYPE.ENTRY),this._selectedExitLink&&(a=this._selectedExitLink.name,f=wcNode.LINK_TYPE.EXIT),this._selectedInputLink&&(a=this._selectedInputLink.name,f=wcNode.LINK_TYPE.INPUT),this._selectedOutputLink&&(a=this._selectedOutputLink.name,f=wcNode.LINK_TYPE.OUTPUT);if(a&&f){var i=this.__mouse(e,this.$viewport.offset());this.__drawPalettePopup(i,this._selectedNode,a,f,function(e){u()});return}}u(),!this._selectedNode&&!this._mouseMoved&&this._mouse.which===3&&this.__drawPalettePopup(this._mouse)},__onViewportMouseEnter:function(e,t){this._mouseInViewport=!0},__onViewportMouseLeave:function(e,t){this._mouseInViewport=!1,this.__handleAutoScroll(!1),this.__onViewportMouseUp(e,t)},__onViewportMouseClick:function(e,t){if(!this._mouseMoved){if(this._highlightCrumb>-1){if(this._crumbBounds[this._highlightCrumb].parent!==this._parent){var n=this._crumbBounds[this._highlightCrumb+1].parent;this._parent=this._crumbBounds[this._highlightCrumb].parent,this._selectedNode=n,this._selectedNodes=[n],this.focus(this._selectedNodes)}return}this._mouse=this.__mouse(e,this.$viewport.offset());var r=this.__findNodeAtPos(this._mouse,this._viewportCamera);if(r){if(this.__inRect(this._mouse,r._meta.bounds.debugLog,r.pos,this._viewportCamera)){var i=!r._log;r.debugLog(i),this._undoManager&&this._undoManager.addEvent((i?"Enabled":"Disabled")+' Debug Logging for Node "'+r.category+"."+r.type+'"',{id:r.id,state:i,engine:this._engine},function(){var e=this.engine.nodeById(this.id);e.debugLog(!this.state)},function(){var e=this.engine.nodeById(this.id);e.debugLog(this.state)})}if(this.__inRect(this._mouse,r._meta.bounds.breakpoint,r.pos,this._viewportCamera)){var i=!r._break;r.debugBreak(i),this._undoManager&&this._undoManager.addEvent((i?"Enabled":"Disabled")+' Breakpoint on Node "'+r.category+"."+r.type+'"',{id:r.id,state:i,engine:this._engine},function(){var e=this.engine.nodeById(this.id);e.debugBreak(!this.state)},function(){var e=this.engine.nodeById(this.id);e.debugBreak(this.state)})}this.__inRect(this._mouse,r._meta.bounds.titleBounds,r.pos,this._viewportCamera)&&this.__drawTitleEditor(r,r._meta.bounds.titleBounds),this.__inRect(this._mouse,r._meta.bounds.detailsBounds,r.pos,this._viewportCamera)&&this.__drawDetailsPopup(r);var s;for(var o=0;o<r._meta.bounds.valueBounds.length;++o)if(this.__inRect(this._mouse,r._meta.bounds.valueBounds[o].rect,r.pos,this._viewportCamera)){s=r._meta.bounds.valueBounds[o];break}if(s)for(var o=0;o<r.properties.length;++o)if(r.properties[o].name===s.name){this.__drawPropertyEditor(r,r.properties[o],s);break}var u;for(var o=0;o<r._meta.bounds.initialBounds.length;++o)if(this.__inRect(this._mouse,r._meta.bounds.initialBounds[o].rect,r.pos,this._viewportCamera)){u=r._meta.bounds.initialBounds[o];break}if(u)for(var o=0;o<r.properties.length;++o)if(r.properties[o].name===u.name){this.__drawPropertyEditor(r,r.properties[o],u,!0);break}if(r._meta.bounds.viewportBounds){var a={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z-r._meta.bounds.viewportBounds.left,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z-r._meta.bounds.viewportBounds.top};this.__inRect(this._mouse,r._meta.bounds.viewportBounds,r.pos,this._viewportCamera)&&r.onViewportMouseClick(e,a,this._options.readOnly)}}}},__onViewportMouseDoubleClick:function(e,t){this._mouse=this.__mouse(e,this.$viewport.offset());var n=!1,r=this.__findNodeAtPos(this._mouse,this._viewportCamera);if(r){this.__inRect(this._mouse,r._meta.bounds.debugLog,r.pos,this._viewportCamera)&&(n=!0),this.__inRect(this._mouse,r._meta.bounds.breakpoint,r.pos,this._viewportCamera)&&(n=!0);for(var i=0;i<r._meta.bounds.valueBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.valueBounds[i].rect,r.pos,this._viewportCamera)){n=!0;break}if(!this._options.readOnly&&!n)for(var i=0;i<r._meta.bounds.entryBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.entryBounds[i].rect,r.pos,this._viewportCamera)){n=!0,r.activateEntry(r._meta.bounds.entryBounds[i].name);break}if(!this._options.readOnly&&!n)for(var i=0;i<r._meta.bounds.exitBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.exitBounds[i].rect,r.pos,this._viewportCamera)){n=!0,r.activateExit(r._meta.bounds.exitBounds[i].name);break}if(!this._options.readOnly&&!n)for(var i=0;i<r._meta.bounds.outputBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.outputBounds[i].rect,r.pos,this._viewportCamera)){n=!0,r.property(r._meta.bounds.outputBounds[i].name,r.property(r._meta.bounds.outputBounds[i].name),!0);break}if(!n&&r._meta.bounds.viewportBounds){var s={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z-r._meta.bounds.viewportBounds.left,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z-r._meta.bounds.viewportBounds.top};this.__inRect(this._mouse,r._meta.bounds.viewportBounds,r.pos,this._viewportCamera)&&(n=r.onViewportMouseDoubleClick(e,s,this._options.readOnly))}if(!n&&this.__inRect(this._mouse,r._meta.bounds.inner,r.pos,this._viewportCamera)){n=!0;if(r.instanceOf("wcNodeCompositeScript"))this._parent=r,this._selectedNode=null,this._selectedNodes=[],this.center();else if(r.instanceOf("wcNodeComposite")&&this._parent.instanceOf("wcNodeCompositeScript")){var o=this._parent;this._parent=this._parent._parent,this._selectedNode=o,this._selectedNodes=[o],this.focus(this._selectedNodes)}else r.instanceOf("wcNodeEntry")&&r.onActivated()}}},__onViewportMouseWheel:function(e,t){var n=this._viewportCamera.z;if(this._highlightNode&&this._highlightNode._meta.bounds.viewportBounds){var r={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z-this._highlightNode._meta.bounds.viewportBounds.left,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z-this._highlightNode._meta.bounds.viewportBounds.top};if(this.__inRect(this._mouse,this._highlightNode._meta.bounds.viewportBounds,this._highlightNode.pos,this._viewportCamera)&&this._highlightNode.onViewportMouseWheel(e,r,e.originalEvent.wheelDelta>0||e.originalEvent.detail<0,this._options.readOnly))return}e.originalEvent.wheelDelta>0||e.originalEvent.detail<0?this._viewportCamera.z=Math.min(this._viewportCamera.z*1.25,5):this._viewportCamera.z=Math.max(this._viewportCamera.z*.75,.1),this._viewportCamera.x=(this._viewportCamera.x-this._mouse.x)/(n/this._viewportCamera.z)+this._mouse.x,this._viewportCamera.y=(this._viewportCamera.y-this._mouse.y)/(n/this._viewportCamera.z)+this._mouse.y},__findNodeAtPos:function(e,t,n){if(this._parent){var r=this;function i(n){for(var i=n.length-1;i>=0;--i)if(n[i]._meta.bounds&&r.__inRect(e,n[i]._meta.bounds.rect,n[i].pos,t))return n[i];return null}return n===undefined?i(this._parent._storageNodes)||i(this._parent._compositeNodes)||i(this._parent._processNodes)||i(this._parent._entryNodes):i(n)}return null}}