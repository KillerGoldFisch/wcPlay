/*!
 * Web Cabin Play - Node based visual scripting tool.
 *
 * Dependancies:
 *  JQuery 1.11.1
 *  font-awesome 4.2.0
 * Optional Dependencies:
 *  FileSaver.js
 *  wcUndoManager
 *
 * Author: Jeff Houde (lochemage@webcabin.org)
 * Web: https://play.webcabin.org/
 * API: https://play.api.webcabin.org/
 *
 * Licensed under
 *   MIT License http://www.opensource.org/licenses/mit-license
 *
 */
function wcPlayEditor(e,t){this.$container=$(e),this.$viewport=null,this._viewportContext=null,this.$palette=null,this._paletteSize=300,this.$typeButton=[],this.$typeArea=[],this._size={x:0,y:0},this._engine=null,this._parent=null,this._nodeLibrary={},this._font={breadcrumbs:{size:15,family:"Arial",weight:"bold"},title:{size:15,family:"Arial",weight:"bold"},titleDesc:{size:15,family:"Arial",weight:"italic"},links:{size:10,family:"Arial"},property:{size:10,family:"Arial",weight:"italic"},value:{size:10,family:"Arial",weight:"bold"},initialValue:{size:10,family:"Arial",weight:"bold italic"}},this._drawStyle={palette:{spacing:20},node:{radius:10,margin:15},title:{spacing:5,wrapL:"  ",wrapR:"  ",placeholder:"  ",nameWrapL:" (",nameWrapR:") "},links:{length:15,width:10,spacing:10,padding:5,margin:10},property:{spacing:5,strLen:10,minLength:30,valueWrapL:" ",valueWrapR:" ",initialWrapL:" [",initialWrapR:"] ",highlightColor:"rgba(255, 255, 255, 0.5)",normalColor:"rgba(255, 255, 255, 0.5)",highlightBorder:-1,normalBorder:1}},this._lastUpdate=0,this._viewportCamera={x:0,y:0,z:1},this._viewportMovingNode=!1,this._viewportMoving=!1,this._viewportMoved=!1,this._paletteMoving=!1,this._mouse={x:0,y:0},this._mouseInViewport=!1,this._highlightRect=null,this._highlightNode=null,this._selectedNode=null,this._selectedNodes=[],this._expandedHighlightNode=null,this._expandedSelectedNode=null,this._highlightTitle=!1,this._highlightDebugLog=!1,this._highlightBreakpoint=!1,this._highlightEntryLink=!1,this._highlightExitLink=!1,this._highlightInputLink=!1,this._highlightOutputLink=!1,this._highlightPropertyValue=!1,this._highlightPropertyInitialValue=!1,this._highlightViewport=!1,this._selectedEntryLink=!1,this._selectedExitLink=!1,this._selectedInputLink=!1,this._selectedOutputLink=!1,this._selectedNodeOrigins=[],this._draggingNodeData=null,this._highlightCrumb=-1,this._crumbBounds=[],this._undoManager=null,this._options={readOnly:!1,category:{items:[],isBlacklist:!0}};for(var n in t)this._options[n]=t[n];this.$top=$('<div class="wcPlayEditorTop">'),this.$main=$('<div class="wcPlayEditorMain">'),this.$palette=$('<div class="wcPlayPalette wcPlayNoHighlights">'),this.$paletteScroller=$('<div class="wcPlayPaletteScroller">'),this.$paletteInner=$('<div class="wcPlayPaletteInner">'),this.$viewport=$('<canvas class="wcPlayViewport">'),this._viewportContext=this.$viewport[0].getContext("2d"),this.$palette.append(this.$paletteScroller),this.$paletteScroller.append(this.$paletteInner),this.$main.append(this.$palette),this.$main.append(this.$viewport),this.$container.append(this.$top),this.$container.append(this.$main),this.$hiddenFileLoader=$('<input type="file" id="wcPlayEditorHiddenFileLoader"/>'),this.$hiddenFileImporter=$('<input type="file" id="wcPlayEditorHiddenFileImporter"/>'),this.onResized(),this.__setupMenu(),this.__setupControls(),window.requestAnimationFrame(this.__update.bind(this))}window.wcPlayEditorClipboard={bounds:{top:0,left:0,width:0,height:0},nodes:[]},wcPlayEditor.prototype={engine:function(e){if(e!==undefined&&e!==this._engine){if(this._engine){var t=this._engine._editors.indexOf(this);t>-1&&this._engine._editors.splice(t,1),this._engine._undoManager=this._undoManager,this._undoManager=null}this._engine=e,this._parent=e,this.__setupPalette(),this.center(),this._engine&&(this._engine._editors.push(this),this._undoManager=this._engine._undoManager,!this._undoManager&&window.wcUndoManager&&(this._undoManager=new wcUndoManager,this._engine._undoManager=this._undoManager))}return this._engine},center:function(){this._parent&&this.focus(this._parent._entryNodes.concat(this._parent._processNodes,this._parent._storageNodes,this._parent._compositeNodes))},focus:function(e){if(e.length){this.__updateNodes(e,0,this._viewportContext),this.__drawNodes(e,this._viewportContext);var t=[];for(var n=0;n<e.length;++n)t.push(e[n]._meta.bounds.farRect);var r=this.__expandRect(t);r.width<1e3&&(r.left-=(1e3-r.width)/2,r.width=1e3),this.focusRect(r)}},focusRect:function(e){var t=this.$viewport.width()/(e.width+100),n=this.$viewport.height()/(e.height+100);this._viewportCamera.z=Math.min(t,n),t>n?e.left-=(this.$viewport.width()/n-(e.width+100))/2:e.top-=(this.$viewport.height()/t-(e.height+100))/2,this._viewportCamera.x=-(e.left-50)*this._viewportCamera.z,this._viewportCamera.y=-(e.top-50)*this._viewportCamera.z},onResized:function(){var e=this.$main.width(),t=this.$main.height();if(this._size.x!==e||this._size.y!==t||this._size.z!==this._paletteSize)this._size.x=e,this._size.y=t,this._size.z=this._paletteSize,this.$palette.css("width",this._size.z).attr("width",this._size.z).attr("height",t),this.$viewport.css("width",e-this._size.z).attr("width",e-this._size.z).attr("height",t)},__mouse:function(e,t,n){if(e.originalEvent&&(e.originalEvent.touches||e.originalEvent.changedTouches)){var r=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0];return{x:r.clientX-(t?t.left:0)-(n?n.x:0),y:r.clientY-(t?t.top:0)-(n?n.y:0),gx:r.clientX,gy:r.clientY,which:1}}return{x:(e.clientX||e.pageX)-(t?t.left:0)-(n?n.x:0),y:(e.clientY||e.pageY)-(t?t.top:0)-(n?n.y:0),gx:e.clientX||e.pageX,gy:e.clientY||e.pageY,which:e.which||1}},__setCanvasFont:function(e,t){t.font=(e.weight?e.weight+" ":"")+(e.size+"px ")+e.family},__clampString:function(e,t){return e.length>t?e.substr(0,t)+"...":e},__blendColors:function(e,t,n){var r=n<0?n*-1:n,i=Math.round,s=parseInt;if(e.length>7){var o=e.split(","),u=(t?t:n<0?"rgb(0,0,0)":"rgb(255,255,255)").split(","),a=s(o[0].slice(4)),f=s(o[1]),l=s(o[2]);return"rgb("+(i((s(u[0].slice(4))-a)*r)+a)+","+(i((s(u[1])-f)*r)+f)+","+(i((s(u[2])-l)*r)+l)+")"}var o=s(e.slice(1),16),u=s((t?t:n<0?"#000000":"#FFFFFF").slice(1),16),c=o>>16,h=o>>8&255,p=o&255;return"#"+(16777216+(i(((u>>16)-c)*r)+c)*65536+(i(((u>>8&255)-h)*r)+h)*256+(i(((u&255)-p)*r)+p)).toString(16).slice(1)},__expandRect:function(e){var t={top:e[0].top,left:e[0].left,width:e[0].width,height:e[0].height};for(var n=1;n<e.length;++n)e[n].top<t.top&&(t.top=e[n].top),e[n].left<t.left&&(t.left=e[n].left);for(var n=1;n<e.length;++n)e[n].top+e[n].height>t.top+t.height&&(t.height=e[n].top+e[n].height-t.top),e[n].left+e[n].width>t.left+t.width&&(t.width=e[n].left+e[n].width-t.left);return t},__inRect:function(e,t,n){return n===undefined&&(n={x:0,y:0,z:1}),(e.y-n.y)/n.z>=t.top&&(e.x-n.x)/n.z>=t.left&&(e.y-n.y)/n.z<=t.top+t.height&&(e.x-n.x)/n.z<=t.left+t.width?!0:!1},__rectInRect:function(e,t){return!(t.left>e.left+e.width||t.left+t.width<e.left||t.top>e.top+e.height||t.top+t.height<e.top)},__drawRect:function(e,t,n){n.strokeStyle=t,n.strokeRect(e.left,e.top,e.width,e.height)},__drawRoundedRect:function(e,t,n,r,i){i.save(),i.strokeStyle=t,i.fillStyle=t,i.lineWidth=n>0?n:1,i.beginPath(),i.moveTo(e.left+r,e.top),i.arcTo(e.left+e.width,e.top,e.left+e.width,e.top+r,r),i.arcTo(e.left+e.width,e.top+e.height,e.left+e.width-r,e.top+e.height,r),i.arcTo(e.left,e.top+e.height,e.left,e.top+e.height-r,r),i.arcTo(e.left,e.top,e.left+r,e.top,r),i.closePath(),n==-1?i.fill():i.stroke(),i.restore()},__update:function(e){this._lastUpdate||(this._lastUpdate=e);var t=(e-this._lastUpdate)/1e3;this._lastUpdate=e;var n=this;$(".wcPlayEditorMenuOptionNew").toggleClass("disabled",this._options.readOnly),$(".wcPlayEditorMenuOptionOpen").toggleClass("disabled",this._options.readOnly),$(".wcPlayEditorMenuOptionImport").toggleClass("disabled",this._options.readOnly),n._undoManager&&($(".wcPlayEditorMenuOptionUndo").each(function(){$(this).toggleClass("disabled",!n._undoManager.canUndo()).find(".wcButton").toggleClass("disabled",!n._undoManager.canUndo()),$(this).attr("title","Undo "+n._undoManager.undoInfo()+" (Ctrl+Z)")}),$(".wcPlayEditorMenuOptionRedo").each(function(){$(this).toggleClass("disabled",!n._undoManager.canRedo()).find(".wcButton").toggleClass("disabled",!n._undoManager.canRedo()),$(this).attr("title","Redo "+n._undoManager.redoInfo()+" (Ctrl+Y)")})),$(".wcPlayEditorMenuOptionDebugging").children("i:first-child, span:first-child").toggleClass("fa-dot-circle-o",this._engine.debugging()).toggleClass("fa-circle-o",!this._engine.debugging()),$(".wcPlayEditorMenuOptionSilence").children(":first-child, span:first-child").toggleClass("fa-volume-off",this._engine.silent()).toggleClass("fa-volume-up",!this._engine.silent()),$(".wcPlayEditorMenuOptionPausePlay").children("i:first-child, span:first-child").toggleClass("fa-play",this._engine.paused()).toggleClass("fa-pause",!this._engine.paused()),$(".wcPlayEditorMenuOptionCut").toggleClass("disabled",this._selectedNodes.length===0||this._options.readOnly),$(".wcPlayEditorMenuOptionCopy").toggleClass("disabled",this._selectedNodes.length===0||this._options.readOnly),$(".wcPlayEditorMenuOptionPaste").toggleClass("disabled",window.wcPlayEditorClipboard.nodes.length===0||this._options.readOnly),$(".wcPlayEditorMenuOptionDelete").toggleClass("disabled",this._selectedNodes.length===0||this._options.readOnly),$(".wcPlayEditorMenuOptionComposite").toggleClass("disabled",this._selectedNodes.length===0||this._options.readOnly),$(".wcPlayEditorMenuOptionCompositeExit").toggleClass("disabled",this._parent instanceof wcPlay),$(".wcPlayEditorMenuOptionCompositeEnter").toggleClass("disabled",this._selectedNodes.length!==1||!(this._selectedNodes[0]instanceof wcNodeCompositeScript)),$(".wcPlayEditorMenuOptionRestart").toggleClass("disabled",this._options.readOnly),this.onResized();if(this._parent){this.__drawPalette(t),this._viewportContext.clearRect(0,0,this.$viewport.width(),this.$viewport.height()),this._viewportContext.save(),this._viewportContext.translate(this._viewportCamera.x,this._viewportCamera.y),this._viewportContext.scale(this._viewportCamera.z,this._viewportCamera.z),this.__updateNodes(this._parent._entryNodes,t,this._viewportContext),this.__updateNodes(this._parent._processNodes,t,this._viewportContext),this.__updateNodes(this._parent._storageNodes,t,this._viewportContext),this.__updateNodes(this._parent._compositeNodes,t,this._viewportContext),this.__drawNodes(this._parent._entryNodes,this._viewportContext),this.__drawNodes(this._parent._processNodes,this._viewportContext),this.__drawNodes(this._parent._compositeNodes,this._viewportContext),this.__drawNodes(this._parent._storageNodes,this._viewportContext),this.__drawChains(this._parent._entryNodes,this._viewportContext),this.__drawChains(this._parent._processNodes,this._viewportContext),this.__drawChains(this._parent._compositeNodes,this._viewportContext),this.__drawChains(this._parent._storageNodes,this._viewportContext);if(this._highlightRect){var r=Math.min(10,this._highlightRect.width/2,this._highlightRect.height/2);this.__drawRoundedRect(this._highlightRect,"rgba(0, 255, 255, 0.25)",-1,r,this._viewportContext),this.__drawRoundedRect(this._highlightRect,"darkcyan",2,r,this._viewportContext)}this._viewportContext.restore();var i=[],s=[],o=this._parent;while(!(o instanceof wcPlay))i.unshift(o),s.unshift(o.type+(o.name?" ("+o.name+")":"")),o=o._parent;i.unshift(this._engine),s.unshift("Root"),this._viewportContext.fillStyle="black",this.__setCanvasFont(this._font.breadcrumbs,this._viewportContext),this._crumbBounds=[];var u=2;for(var a=0;a<s.length;++a){var f=this._viewportContext.measureText(s[a]).width,l=this._viewportContext.measureText(" / ").width,c={rect:{top:0,left:u,width:f+6,height:this._font.breadcrumbs.size+this._drawStyle.property.spacing},parent:i[a]};this._crumbBounds.push(c),u+=f+l,this._highlightCrumb===a&&(this.__drawRoundedRect(c.rect,"rgba(0, 255, 255, 0.25)",-1,3,this._viewportContext),this.__drawRoundedRect(c.rect,"darkcyan",2,3,this._viewportContext))}this._viewportContext.fillText(s.join(" / "),5,this._font.breadcrumbs.size)}window.requestAnimationFrame(this.__update.bind(this))},__updateNodes:function(e,t,n){for(var r=0;r<e.length;++r)this.__updateNode(e[r],t,e[r].pos,n)},__updateNode:function(e,t,n,r){function s(e,n,r,s,o,u){e.flash?(e.flashDelta+=t*10,e.flashDelta>=1&&(e.flashDelta=1,!e.awake&&(!e.paused||!o&&!i._engine.paused())&&(e.flash=!1))):e.flashDelta>0&&(e.flashDelta-=t*5,e.flashDelta<=0&&(e.flashDelta=0,e.paused=o?e.paused:e.paused-1)),e.color=i.__blendColors(n,e.paused?s:r,e.flashDelta*u)}e.onDraw();var i=this,o=e.color;this._highlightNode===e&&(o=this.__blendColors(e.color,"#FFFFFF",.25)),s(e._meta,o,"#FFFFFF","#FFFFFF",!0,.5);var u="#000000",a="#117711",f="#FFFF00";for(var l=0;l<e.chain.entry.length;++l)s(e.chain.entry[l].meta,u,f,f,!1,.9);for(var l=0;l<e.chain.exit.length;++l)s(e.chain.exit[l].meta,u,f,f,!1,.9);for(var l=0;l<e.properties.length;++l)s(e.properties[l].inputMeta,a,f,f,!1,.9),s(e.properties[l].outputMeta,a,f,f,!1,.9);if(e._meta.dirty){e._meta.dirty=!1,e._meta.bounds={node:e};var c=this.__measureEntryLinkOuter(e,r,n),h=this.__measureOuter(e,r,{x:n.x,y:n.y+c.height}),p=this.__measureExitLinkOuter(e,r,{x:n.x,y:n.y+c.height+h.height}),d=this.__expandRect([c,h,p]);d.top=h.top,d.height=h.height,d.propWidth=h.propWidth,d.valueWidth=h.valueWidth,d.initialWidth=h.initialWidth,e._meta.bounds.entryOuter=c,e._meta.bounds.exitOuter=p,e._meta.bounds.centerOuter=h,e._meta.bounds.rect=this.__expandRect([c,h,p]),e._meta.bounds.inner=this.__expandRect([h]),e._meta.bounds.inner.left=e._meta.bounds.rect.left,e._meta.bounds.inner.width=e._meta.bounds.rect.width,e._meta.bounds.rect.top-=3,e._meta.bounds.rect.left-=this._drawStyle.links.length+3,e._meta.bounds.rect.width+=this._drawStyle.links.length*2+6,e._meta.bounds.rect.height+=6,e.chain.entry.length?(e._meta.bounds.inner.top-=this._drawStyle.links.padding+this._font.links.size,e._meta.bounds.inner.height+=this._drawStyle.links.padding+this._font.links.size):(e._meta.bounds.rect.top-=this._drawStyle.links.length,e._meta.bounds.rect.height+=this._drawStyle.links.length),e.chain.exit.length?e._meta.bounds.inner.height+=this._drawStyle.links.padding+this._font.links.size:e._meta.bounds.rect.height+=this._drawStyle.links.length;var v=e._meta.bounds.inner.width-this._drawStyle.node.margin*2-d.propWidth;if(v>d.valueWidth+d.initialWidth){var m=(v-(d.valueWidth+d.initialWidth))/2;d.valueWidth+=m,d.initialWidth+=m}this.__measureCenter(e,r,d),this.__measureEntryLinks(e,r,n,c.width),this.__measureExitLinks(e,r,{x:n.x,y:n.y+c.height+h.height},p.width),e._meta.bounds.farRect={top:e._meta.bounds.inner.top-30,left:e._meta.bounds.inner.left-30,width:e._meta.bounds.inner.width+60,height:e._meta.bounds.inner.height+60},e._meta.bounds.debugLog={left:e._meta.bounds.inner.left+4,top:e._meta.bounds.inner.top+4+(e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0),width:this._drawStyle.node.margin-5,height:this._font.title.size-4},e._meta.bounds.breakpoint={left:e._meta.bounds.inner.left+e._meta.bounds.inner.width-this._drawStyle.node.margin+2,top:e._meta.bounds.inner.top+4+(e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0),width:this._drawStyle.node.margin-5,height:this._font.title.size-4}}},__typeIndex:function(e){switch(e){case wcPlay.NODE.ENTRY:return 0;case wcPlay.NODE.PROCESS:return 1;case wcPlay.NODE.STORAGE:return 2;case wcPlay.NODE.COMPOSITE:return 3}},__setupMenu:function(){var e=$('      <ul class="wcPlayEditorMenu wcPlayNoHighlights">        <span class="wcPlayVersionTag wcPlayNoHighlights">0.0.0 Alpha</span>        <li><span>File</span>          <ul>            <li><span class="wcPlayEditorMenuOptionNew wcPlayMenuItem"><i class="wcPlayEditorMenuIcon wcButton fa fa-file-o fa-lg"/>New Script...<span>Alt+N</span></span></li>            <li><span class="wcPlayEditorMenuOptionOpen wcPlayMenuItem"><i class="wcPlayEditorMenuIcon wcButton fa fa-folder-open-o fa-lg"/>Open Script...<span>Ctrl+O</span></span></li>            <li><span class="wcPlayEditorMenuOptionSave wcPlayMenuItem"><i class="wcPlayEditorMenuIcon wcButton fa fa-save fa-lg"/>Save Script<span>Ctrl+S</span></span></li>            <li><hr class="wcPlayMenuSeparator"></li>            <li><span class="wcPlayEditorMenuOptionImport wcPlayMenuItem"><i class="wcPlayEditorMenuIcon wcButton fa fa-plus-square-o fa-lg"/>Import...<span>Ctrl+I</span></span></li>          </ul>        </li>        <li><span>Edit</span>          <ul>            <li><span class="wcPlayEditorMenuOptionUndo wcPlayMenuItem disabled"><i class="wcPlayEditorMenuIcon wcButton fa fa-undo fa-lg"/>Undo<span>Ctrl+Z</span></span></li>            <li><span class="wcPlayEditorMenuOptionRedo wcPlayMenuItem disabled"><i class="wcPlayEditorMenuIcon wcButton fa fa-undo fa-flip-horizontal fa-lg"/>Redo<span>Ctrl+Y</span></span></li>            <li><hr class="wcPlayMenuSeparator"></li>            <li><span class="wcPlayEditorMenuOptionCut wcPlayMenuItem"><i class="wcPlayEditorMenuIcon wcButton fa fa-cut fa-lg"/>Cut<span>Ctrl+X</span></span></li>            <li><span class="wcPlayEditorMenuOptionCopy wcPlayMenuItem"><i class="wcPlayEditorMenuIcon wcButton fa fa-copy fa-lg"/>Copy<span>Ctrl+C</span></span></li>            <li><span class="wcPlayEditorMenuOptionPaste wcPlayMenuItem"><i class="wcPlayEditorMenuIcon wcButton fa fa-paste fa-lg"/>Paste<span>Ctrl+P</span></span></li>            <li><span class="wcPlayEditorMenuOptionDelete wcPlayMenuItem"><i class="wcPlayEditorMenuIcon wcButton fa fa-trash-o fa-lg"/>Delete<span>Del</span></span></li>            <li><hr class="wcPlayMenuSeparator"></li>            <li><span class="wcPlayEditorMenuOptionComposite wcPlayMenuItem" title="Combine all selected nodes into a new \'Composite\' Node."><i class="wcPlayEditorMenuIcon wcButton fa fa-share-alt-square fa-lg"/>Create Composite<span>C</span></span></li>          </ul>        </li>        <li><span>View</span>          <ul>            <li><span class="wcPlayEditorMenuOptionCenter wcPlayMenuItem" title="Fit selected nodes into view."><i class="wcPlayEditorMenuIcon wcButton fa fa-crosshairs fa-lg"/>Fit in View<span>F</span></span></li>            <li><span class="wcPlayEditorMenuOptionCompositeExit wcPlayMenuItem" title="Step out of Composite Node."><i class="wcPlayEditorMenuIcon wcButton fa fa-level-up fa-lg"/>Exit Composite<span>O</span></span></li>            <li><span class="wcPlayEditorMenuOptionCompositeEnter wcPlayMenuItem" title="Step in to selected Composite Node."><i class="wcPlayEditorMenuIcon wcButton fa fa-level-down fa-lg"/>Enter Composite<span>I</span></span></li>            <li><hr class="wcPlayMenuSeparator"></li>            <li><span class="wcPlayEditorMenuOptionCompositeSearch wcPlayMenuItem disabled" title="Search for nodes in your script."><i class="wcPlayEditorMenuIcon wcButton fa fa-search fa-lg"/>Search Nodes<span>Ctrl+F</span></span></li>          </ul>        </li>        <li><span>Debugging</span>          <ul>            <li><span class="wcPlayEditorMenuOptionDebugging wcPlayMenuItem" title="Toggle debugging mode for the entire script."><i class="wcPlayEditorMenuIcon wcButton fa fa-dot-circle-o fa-lg"/>Toggle Debug Mode<span></span></span></li>            <li><span class="wcPlayEditorMenuOptionSilence wcPlayMenuItem" title="Toggle silent mode for the entire script (Nodes with debug log enabled will not log when this is active)."><i class="wcPlayEditorMenuIcon wcButton fa fa-volume-up fa-lg"/>Toggle Silence Mode<span></span></span></li>            <li><hr class="wcPlayMenuSeparator"></li>            <li><span class="wcPlayEditorMenuOptionRestart wcPlayMenuItem" title="Runs or restarts the script."><i class="wcPlayEditorMenuIcon wcButton fa fa-play-circle fa-lg"/>Run/Restart Script<span></span></span></li>            <li><span class="wcPlayEditorMenuOptionPausePlay wcPlayMenuItem" title="Pause or Continue the script."><i class="wcPlayEditorMenuIcon wcButton fa fa-pause fa-lg"/>Pause/Continue Script<span>Enter</span></span></li>            <li><span class="wcPlayEditorMenuOptionStep wcPlayMenuItem" title="Perform a single script update."><i class="wcPlayEditorMenuIcon wcButton fa fa-fast-forward fa-lg"/>Step Script<span>Spacebar</span></span></li>          </ul>        </li>        <li><span>Help</span>          <ul>            <li><span class="wcPlayEditorMenuOptionDocs wcPlayMenuItem" title="Open the documentation for wcPlay in another window."><i class="wcPlayEditorMenuIcon wcButton fa fa-file-pdf-o fa-lg"/>Documentation...<span></span></span></li>          </ul>        </li>      </ul>    '),t=$('      <div class="wcPlayEditorToolbar wcPlayNoHighlights">        <div class="wcPlayEditorMenuOptionNew wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-file-o fa-lg" title="New Project. (Alt+N)"/></div>        <div class="wcPlayEditorMenuOptionOpen wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-folder-open-o fa-lg" title="Open Project. (Ctrl+O)"></div>        <div class="wcPlayEditorMenuOptionSave wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-save fa-lg" title="Save Project. (Ctrl+S)"></div>        <div class="wcPlayEditorMenuOptionImport wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-plus-square-o fa-lg" title="Import..."></div>        <div class="ARPG_Separator"></div>        <div class="wcPlayEditorMenuOptionUndo wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-undo fa-lg"/></div>        <div class="wcPlayEditorMenuOptionRedo wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-undo fa-flip-horizontal fa-lg"/></div>        <div class="ARPG_Separator"></div>        <div class="wcPlayEditorMenuOptionCut wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-cut fa-lg" title="Cut Selected Nodes. (Ctrl+X)"/></div>        <div class="wcPlayEditorMenuOptionCopy wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-copy fa-lg" title="Copy Selected Nodes. (Ctrl+C)"/></div>        <div class="wcPlayEditorMenuOptionPaste wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-paste fa-lg" title="Paste Copied Nodes. (Ctrl+V)"/></div>        <div class="wcPlayEditorMenuOptionDelete wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-trash-o fa-lg" title="Delete Selected Nodes. (Del)"/></div>        <div class="ARPG_Separator"></div>        <div class="wcPlayEditorMenuOptionComposite wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-share-alt-square fa-lg" title="Combine all selected nodes into a new \'Composite\' Node. (C)"/></div>        <div class="ARPG_Separator"></div>        <div class="wcPlayEditorMenuOptionDebugging wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-dot-circle-o fa-lg" title="Toggle debugging mode for the entire script."/></div>        <div class="wcPlayEditorMenuOptionSilence wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-volume-up fa-lg" title="Toggle silent mode for the entire script (Nodes with debug log enabled will not log when this is active)."/></div>        <div class="ARPG_Separator"></div>        <div class="wcPlayEditorMenuOptionRestart wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-play-circle fa-lg" title="Runs or restarts the script."/></div>        <div class="wcPlayEditorMenuOptionPausePlay wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-pause fa-lg" title="Pause or Continue script. (Enter)"/></div>        <div class="wcPlayEditorMenuOptionStep wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-fast-forward fa-lg" title="Perform a single script update. (Spacebar)"/></div>        <div class="ARPG_Separator"></div>        <div class="wcPlayEditorMenuOptionCenter wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-crosshairs fa-lg" title="Fit selected nodes into view. (F)"/></div>        <div class="wcPlayEditorMenuOptionCompositeExit wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-level-up fa-lg" title="Step out of Composite node. (O)"/></div>        <div class="wcPlayEditorMenuOptionCompositeEnter wcPlayMenuItem"><span class="wcPlayEditorMenuIcon wcButton fa fa-level-down fa-lg" title="Step in to selected Composite node. (I)"/></div>        <div class="ARPG_Separator"></div>        <div class="wcPlayEditorMenuOptionCompositeSearch wcPlayMenuItem disabled"><span class="wcPlayEditorMenuIcon wcButton fa fa-search fa-lg" title="Search for nodes in your script. (Ctrl+F)"/></div>      </div>    ');this.$top.append(e),this.$top.append(t)},__setupPalette:function(){function i(e){this._nodeLibrary.hasOwnProperty(e.category)||(this._nodeLibrary[e.category]={});if(!this._nodeLibrary[e.category].hasOwnProperty(e.nodeType)){var t={$category:$('<div class="wcPlayTypeCategory">'),$button:$('<button class="wcPlayCategoryButton" title="Toggle visibility of this category.">'+e.category+"</button>"),$canvas:$('<canvas class="wcPlayTypeCategoryArea">'),context:null,nodes:[]};t.context=t.$canvas[0].getContext("2d"),t.$category.append(t.$button),t.$category.append(t.$canvas),this.$typeArea[this.__typeIndex(e.nodeType)].append(t.$category),function(t){t.$button.click(function(){t.$button.hasClass("wcToggled")?(t.$button.removeClass("wcToggled"),t.$canvas.removeClass("wcPlayHidden")):(t.$button.addClass("wcToggled"),t.$canvas.addClass("wcPlayHidden"))})}(t),this._nodeLibrary[e.category][e.nodeType]=t}}if(!this._engine)return;this._paletteSize=this._options.readOnly?0:300,this.onResized(),this.$typeButton.length==0&&(this.$typeButton.push($('<button class="wcPlayEditorButton" title="Show Entry Nodes.">Entry</button>')),this.$typeButton.push($('<button class="wcPlayEditorButton wcToggled" title="Show Process Nodes.">Process</button>')),this.$typeButton.push($('<button class="wcPlayEditorButton" title="Show Storage Nodes.">Storage</button>')),this.$typeButton.push($('<button class="wcPlayEditorButton" title="Show Composite Nodes.">Composite</button>')),this.$palette.append(this.$typeButton[0]),this.$palette.append(this.$typeButton[1]),this.$palette.append(this.$typeButton[2]),this.$palette.append(this.$typeButton[3]),this.$typeArea.push($('<div class="wcPlayTypeArea wcPlayHidden">')),this.$typeArea.push($('<div class="wcPlayTypeArea">')),this.$typeArea.push($('<div class="wcPlayTypeArea wcPlayHidden">')),this.$typeArea.push($('<div class="wcPlayTypeArea wcPlayHidden">')),this.$paletteInner.append(this.$typeArea[0]),this.$paletteInner.append(this.$typeArea[1]),this.$paletteInner.append(this.$typeArea[2]),this.$paletteInner.append(this.$typeArea[3]));if(this._nodeLibrary){for(var e in this._nodeLibrary)for(var t in this._nodeLibrary[e]){var n=this._nodeLibrary[e][t];n.$button.remove(),n.$canvas.remove(),n.$category.remove();for(var r=0;r<n.nodes.length;++r)n.nodes[r].destroy()}this._nodeLibrary={}}for(var r=0;r<wcPlay.NODE_LIBRARY.length;++r){var s=wcPlay.NODE_LIBRARY[r];if(s.nodeType!==wcPlay.NODE.COMPOSITE){var o=this._options.category.items.indexOf(s.category);if(!this._options.category.isBlacklist&&o===-1||this._options.category.isBlacklist&&o>-1)continue}else if(s.className==="wcNodeCompositeScript")continue;i.call(this,s);var u=new window[s.className](null);u.collapsed(!1),this._nodeLibrary[s.category][s.nodeType].nodes.push(u)}var a=this._engine.importedComposites();for(var r=0;r<a.length;++r){var u=a[r];i.call(this,u),this._nodeLibrary[u.category][u.nodeType].nodes.push(u)}for(var e in this._nodeLibrary)for(var t in this._nodeLibrary[e]){var n=this._nodeLibrary[e][t];n.$canvas.attr("width",this.$paletteInner.width());var f=this._drawStyle.palette.spacing,l=this.$paletteInner.width()/2;for(var r=0;r<n.nodes.length;++r)this.__updateNode(n.nodes[r],0,{x:l,y:f},n.context),this.__drawNode(n.nodes[r],{x:l,y:f},n.context,!0),f+=n.nodes[r]._meta.bounds.rect.height+this._drawStyle.palette.spacing;n.$canvas.attr("height",f)}var c=this;this.$typeButton[0].click(function(){c.$typeButton[0].addClass("wcToggled"),c.$typeButton[1].removeClass("wcToggled"),c.$typeButton[2].removeClass("wcToggled"),c.$typeButton[3].removeClass("wcToggled"),c.$typeArea[0].removeClass("wcPlayHidden"),c.$typeArea[1].addClass("wcPlayHidden"),c.$typeArea[2].addClass("wcPlayHidden"),c.$typeArea[3].addClass("wcPlayHidden")}),this.$typeButton[1].click(function(){c.$typeButton[0].removeClass("wcToggled"),c.$typeButton[1].addClass("wcToggled"),c.$typeButton[2].removeClass("wcToggled"),c.$typeButton[3].removeClass("wcToggled"),c.$typeArea[0].addClass("wcPlayHidden"),c.$typeArea[1].removeClass("wcPlayHidden"),c.$typeArea[2].addClass("wcPlayHidden"),c.$typeArea[3].addClass("wcPlayHidden")}),this.$typeButton[2].click(function(){c.$typeButton[0].removeClass("wcToggled"),c.$typeButton[1].removeClass("wcToggled"),c.$typeButton[2].addClass("wcToggled"),c.$typeButton[3].removeClass("wcToggled"),c.$typeArea[0].addClass("wcPlayHidden"),c.$typeArea[1].addClass("wcPlayHidden"),c.$typeArea[2].removeClass("wcPlayHidden"),c.$typeArea[3].addClass("wcPlayHidden")}),this.$typeButton[3].click(function(){c.$typeButton[0].removeClass("wcToggled"),c.$typeButton[1].removeClass("wcToggled"),c.$typeButton[2].removeClass("wcToggled"),c.$typeButton[3].addClass("wcToggled"),c.$typeArea[0].addClass("wcPlayHidden"),c.$typeArea[1].addClass("wcPlayHidden"),c.$typeArea[2].addClass("wcPlayHidden"),c.$typeArea[3].removeClass("wcPlayHidden")})},__drawPalette:function(e){for(var t in this._nodeLibrary)for(var n in this._nodeLibrary[t]){if(!this.$typeButton[this.__typeIndex(n)].hasClass("wcToggled"))continue;var r=this._nodeLibrary[t][n];if(r.$button.hasClass("wcToggled"))continue;var i=this._drawStyle.palette.spacing,s=this.$paletteInner.width()/2;r.$canvas.attr("width",this.$paletteInner.width()),r.context.clearRect(0,0,r.$canvas.width(),r.$canvas.height()),r.context.save();for(var o=0;o<r.nodes.length;++o)this.__updateNode(r.nodes[o],0,{x:s,y:i},r.context),this.__drawNode(r.nodes[o],{x:s,y:i},r.context,!0),i+=r.nodes[o]._meta.bounds.rect.height+this._drawStyle.palette.spacing;r.context.restore()}},__drawNodes:function(e,t,n){for(var r=0;r<e.length;++r)this.__drawNode(e[r],e[r].pos,t,n)},__drawNode:function(e,t,n,r){this._selectedNodes.indexOf(e)>-1&&(this.__drawRoundedRect(e._meta.bounds.rect,"rgba(0, 255, 255, 0.25)",-1,10,n),this.__drawRoundedRect(e._meta.bounds.rect,"darkcyan",2,10,n)),this.__drawCenter(e,n,r),this.__drawEntryLinks(e,n,t,e._meta.bounds.entryOuter.width),this.__drawExitLinks(e,n,{x:t.x,y:t.y+e._meta.bounds.entryOuter.height+e._meta.bounds.centerOuter.height},e._meta.bounds.exitOuter.width),n.save(),n.fillStyle=this._highlightDebugLog&&this._highlightNode===e?"black":"white",n.strokeStyle="black",n.lineWidth=1,n.fillRect(e._meta.bounds.debugLog.left,e._meta.bounds.debugLog.top,e._meta.bounds.debugLog.width,e._meta.bounds.debugLog.height),n.strokeRect(e._meta.bounds.debugLog.left,e._meta.bounds.debugLog.top,e._meta.bounds.debugLog.width,e._meta.bounds.debugLog.height),n.strokeStyle=e._log?"red":this._highlightDebugLog&&this._highlightNode===e?"white":"black",n.lineWidth=2,n.beginPath(),n.moveTo(e._meta.bounds.debugLog.left+1,e._meta.bounds.debugLog.top+1),n.lineTo(e._meta.bounds.debugLog.left+e._meta.bounds.debugLog.width/2,e._meta.bounds.debugLog.top+e._meta.bounds.debugLog.height/2),n.lineTo(e._meta.bounds.debugLog.left+1,e._meta.bounds.debugLog.top+e._meta.bounds.debugLog.height-1),n.moveTo(e._meta.bounds.debugLog.left+e._meta.bounds.debugLog.width/2,e._meta.bounds.debugLog.top+e._meta.bounds.debugLog.height-2),n.lineTo(e._meta.bounds.debugLog.left+e._meta.bounds.debugLog.width,e._meta.bounds.debugLog.top+e._meta.bounds.debugLog.height-2),n.stroke(),n.restore(),n.save(),n.fillStyle=this._highlightBreakpoint&&this._highlightNode===e?"black":"white",n.fillRect(e._meta.bounds.breakpoint.left,e._meta.bounds.breakpoint.top,e._meta.bounds.breakpoint.width,e._meta.bounds.breakpoint.height),n.strokeStyle=e._break?"red":this._highlightBreakpoint&&this._highlightNode===e?"white":"black",n.fillStyle="red",n.lineWidth=2,n.beginPath(),n.arc(e._meta.bounds.breakpoint.left+e._meta.bounds.breakpoint.width/2,e._meta.bounds.breakpoint.top+e._meta.bounds.breakpoint.height/2,Math.min(e._meta.bounds.breakpoint.width/2-2,e._meta.bounds.breakpoint.height/2-2),0,2*Math.PI),e._break&&n.fill(),n.stroke(),n.strokeStyle="black",n.lineWidth=1,n.strokeRect(e._meta.bounds.breakpoint.left,e._meta.bounds.breakpoint.top,e._meta.bounds.breakpoint.width,e._meta.bounds.breakpoint.height),n.restore(),e.isPaused()?this.__drawRoundedRect(e._meta.bounds.inner,"#CC0000",5,10,n):e._meta.flashDelta&&this.__drawRoundedRect(e._meta.bounds.inner,"yellow",2,10,n)},__measureEntryLinkOuter:function(e,t,n){var r={top:n.y,left:n.x,width:0,height:0};this.__setCanvasFont(this._font.links,t);var i=e.chain.entry;for(var s=0;s<i.length;++s)r.width+=t.measureText(i[s].name).width+this._drawStyle.links.spacing;return r.left-=r.width/2+this._drawStyle.links.margin,r.width+=this._drawStyle.links.margin*2,e.chain.entry.length&&(r.height=this._font.links.size+this._drawStyle.links.padding+this._drawStyle.links.length),r},__measureExitLinkOuter:function(e,t,n){var r={top:n.y,left:n.x,width:0,height:0};this.__setCanvasFont(this._font.links,t);var i=e.chain.exit;for(var s=0;s<i.length;++s)r.width+=t.measureText(i[s].name).width+this._drawStyle.links.spacing;return r.left-=r.width/2+this._drawStyle.links.margin,r.width+=this._drawStyle.links.margin*2,e.chain.exit.length&&(r.height=this._font.links.size+this._drawStyle.links.padding+this._drawStyle.links.length),r},__measureOuter:function(e,t,n){var r={top:n.y,left:n.x,width:0,height:this._font.title.size+this._drawStyle.title.spacing+this._drawStyle.links.padding};this.__setCanvasFont(this._font.title,t),r.width=t.measureText(this._drawStyle.title.wrapL+e.type+": "+this._drawStyle.title.wrapR).width,this.__setCanvasFont(this._font.titleDesc,t),r.width+=t.measureText(this._drawStyle.title.nameWrapL+(e.name||this._drawStyle.title.placeholder)+this._drawStyle.title.nameWrapR).width,e._viewportSize&&(r.width=Math.max(r.width,e._viewportSize.x),r.height+=e._viewportSize.y+this._drawStyle.property.spacing);var i=0,s=0,o=0,u=e.collapsed(),a=e.properties;for(var f=0;f<a.length;++f)r.height+=this._font.property.size+this._drawStyle.property.spacing,this.__setCanvasFont(this._font.property,t),i=Math.max(t.measureText(a[f].name+": ").width,i),this.__setCanvasFont(this._font.value,t),s=Math.max(t.measureText(this._drawStyle.property.valueWrapL+this.__drawPropertyValue(e,a[f])+this._drawStyle.property.valueWrapR).width,this._drawStyle.property.minLength,s),this.__setCanvasFont(this._font.initialValue,t),o=Math.max(t.measureText(this._drawStyle.property.initialWrapL+this.__drawPropertyValue(e,a[f],!0)+this._drawStyle.property.initialWrapR).width,this._drawStyle.property.minLength,o);return r.width=Math.max(i+s+o,r.width)+this._drawStyle.node.margin*2,r.left-=r.width/2,r.propWidth=i,r.valueWidth=s,r.initialWidth=o,r},__measureCenter:function(e,t,n){var r=e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0,i=e.chain.exit.length?this._font.links.size+this._drawStyle.links.padding:0;e._meta.bounds.center=n,e._meta.bounds.inputBounds=[],e._meta.bounds.outputBounds=[],e._meta.bounds.propertyBounds=[],e._meta.bounds.valueBounds=[],e._meta.bounds.initialBounds=[],t.save(),this.__setCanvasFont(this._font.title,t);var s=t.measureText(this._drawStyle.title.wrapL+e.type+": ").width,o=t.measureText(this._drawStyle.title.wrapR).width;this.__setCanvasFont(this._font.titleDesc,t);var u=t.measureText(this._drawStyle.title.nameWrapL+(e.name||this._drawStyle.title.placeholder)+this._drawStyle.title.nameWrapR).width;e._meta.bounds.titleBounds={top:n.top,left:n.left+s+(n.width-(s+o+u))/2,width:u,height:this._font.title.size+this._drawStyle.title.spacing-1,typeWidth:s,wrapRWidth:o,textWidth:u},r=this._font.title.size,r+=this._drawStyle.title.spacing,e._viewportSize&&(e._meta.bounds.viewportBounds={top:n.top+r,left:n.left+(n.width/2-e._viewportSize.x/2),width:e._viewportSize.x,height:e._viewportSize.y},r+=e._viewportSize.y+this._drawStyle.property.spacing);var a,f=e.collapsed(),l=e.properties;for(var c=0;c<l.length;++c){r+=this._font.property.size;if(!f||!l[c].options.collapsible||l[c].inputs.length||l[c].outputs.length){var h={rect:{top:n.top+r-this._font.property.size,left:n.left+this._drawStyle.node.margin,width:n.width-this._drawStyle.node.margin*2,height:this._font.property.size+this._drawStyle.property.spacing},name:l[c].name};e._meta.bounds.propertyBounds.push(h);var p={rect:{top:n.top+r-this._font.property.size,left:n.left+n.width-this._drawStyle.node.margin-n.initialWidth,width:n.initialWidth,height:this._font.property.size+this._drawStyle.property.spacing},name:l[c].name};e._meta.bounds.initialBounds.push(p);var d={rect:{top:n.top+r-this._font.property.size,left:n.left+n.width-this._drawStyle.node.margin-n.valueWidth-n.initialWidth,width:n.valueWidth,height:this._font.property.size+this._drawStyle.property.spacing},name:l[c].name};e._meta.bounds.valueBounds.push(d);if(!f||l[c].inputs.length)a={top:n.top+r-this._font.property.size/3-this._drawStyle.links.width/2,left:n.left-this._drawStyle.links.length,width:this._drawStyle.links.length,height:this._drawStyle.links.width},a.top-=5,a.height+=10,e._meta.bounds.inputBounds.push({rect:a,point:{x:a.left+a.width/3-2,y:a.top+a.height/2},name:l[c].name});if(!f||l[c].outputs.length)a={top:n.top+r-this._font.property.size/3-this._drawStyle.links.width/2,left:n.left+n.width,width:this._drawStyle.links.length,height:this._drawStyle.links.width},a.top-=5,a.height+=10,e._meta.bounds.outputBounds.push({rect:a,point:{x:a.left+a.width+1,y:a.top+a.height/2},name:l[c].name});r+=this._drawStyle.property.spacing}}t.restore()},__measureEntryLinks:function(e,t,n,r){e._meta.bounds.entryBounds=[];var i=n.x-r/2+this._drawStyle.links.margin,s=n.y+this._drawStyle.links.length+this._font.links.size;t.save(),this.__setCanvasFont(this._font.links,t);var o=e.collapsed(),u=e.chain.entry;for(var a=0;a<u.length;++a){var f=t.measureText(u[a].name).width+this._drawStyle.links.spacing,l={top:s-this._drawStyle.links.length-this._font.links.size,left:i+f/2-this._drawStyle.links.width/2,width:this._drawStyle.links.width,height:this._drawStyle.links.length};l.left-=5,l.width+=10,e._meta.bounds.entryBounds.push({rect:l,point:{x:l.left+l.width/2,y:l.top+l.height/3-2},name:u[a].name}),i+=f}t.restore()},__measureExitLinks:function(e,t,n,r){e._meta.bounds.exitBounds=[];var i=n.x-r/2+this._drawStyle.links.margin,s=n.y+this._font.links.size;t.save(),this.__setCanvasFont(this._font.links,t);var o=e.collapsed(),u=e.chain.exit;for(var a=0;a<u.length;++a){var f=t.measureText(u[a].name).width+this._drawStyle.links.spacing;t.fillText(u[a].name,i+this._drawStyle.links.spacing/2,s);var l={top:s+this._drawStyle.links.padding,left:i+f/2-this._drawStyle.links.width/2,width:this._drawStyle.links.width,height:this._drawStyle.links.length};l.left-=5,l.width+=10,e._meta.bounds.exitBounds.push({rect:l,point:{x:l.left+l.width/2,y:l.top+l.height+1},name:u[a].name}),i+=f}t.restore()},__drawCenter:function(e,t,n){var r=e.chain.entry.length?this._font.links.size+this._drawStyle.links.padding:0,i=e.chain.exit.length?this._font.links.size+this._drawStyle.links.padding:0;t.save();var s=e._meta.bounds.center.left+e._meta.bounds.center.width/2,o=e._meta.bounds.center.top+e._meta.bounds.center.height/2,u=t.createRadialGradient(s,o,10,s,o,Math.max(e._meta.bounds.center.width,e._meta.bounds.center.height));u.addColorStop(0,e.enabled()?e._meta.color:"#555"),u.addColorStop(1,"white"),t.fillStyle=t.strokeStyle=u,t.lineJoin="round";var a=this._drawStyle.node.radius*2;t.lineWidth=a,t.fillRect(e._meta.bounds.center.left+a/2,e._meta.bounds.center.top-r+a/2,e._meta.bounds.center.width-a,e._meta.bounds.center.height+r+i-a),t.strokeRect(e._meta.bounds.center.left+a/2,e._meta.bounds.center.top-r+a/2,e._meta.bounds.center.width-a,e._meta.bounds.center.height+r+i-a),t.restore(),this.__drawRoundedRect({left:e._meta.bounds.center.left,top:e._meta.bounds.center.top-r,width:e._meta.bounds.center.width,height:e._meta.bounds.center.height+r+i},e._meta.color,3,this._drawStyle.node.radius,t),r=0,e.chain.entry.length&&(t.strokeStyle=e._meta.color,t.beginPath(),t.moveTo(e._meta.bounds.center.left,e._meta.bounds.center.top+r),t.lineTo(e._meta.bounds.center.left+e._meta.bounds.center.width,e._meta.bounds.center.top+r),t.stroke()),this._options.readOnly||(this._highlightTitle&&this._highlightNode===e?this.__drawRoundedRect(e._meta.bounds.titleBounds,this._drawStyle.property.highlightColor,this._drawStyle.property.highlightBorder,this._font.title.size/2,t):!n&&this._highlightNode===e&&this.__drawRoundedRect(e._meta.bounds.titleBounds,this._drawStyle.property.normalColor,this._drawStyle.property.normalBorder,this._font.title.size/2,t)),t.save(),r+=this._font.title.size,t.fillStyle="black",t.strokeStyle="black",t.textAlign="left",this.__setCanvasFont(this._font.title,t),t.fillText(this._drawStyle.title.wrapL+e.type+": ",e._meta.bounds.titleBounds.left-e._meta.bounds.titleBounds.typeWidth,e._meta.bounds.titleBounds.top+r),this.__setCanvasFont(this._font.titleDesc,t),t.fillText(this._drawStyle.title.nameWrapL+(e.name||this._drawStyle.title.placeholder)+this._drawStyle.title.nameWrapR,e._meta.bounds.titleBounds.left,e._meta.bounds.titleBounds.top+r),t.textAlign="right",this.__setCanvasFont(this._font.title,t),t.fillText(this._drawStyle.title.wrapR,e._meta.bounds.titleBounds.left,e._meta.bounds.titleBounds.top+r),t.restore(),r+=this._drawStyle.title.spacing,e._meta.bounds.viewportBounds&&(t.save(),t.translate(e._meta.bounds.viewportBounds.left,e._meta.bounds.viewportBounds.top),e.onViewportDraw(t,this._options.readOnly),t.translate(-e._meta.bounds.viewportBounds.left,-e._meta.bounds.viewportBounds.top),t.restore(),r+=e._viewportSize.y+this._drawStyle.property.spacing),t.save();var f=e.collapsed(),l=e.properties;for(var c=0;c<l.length;++c){r+=this._font.property.size;var h=null;for(var p=0;p<e._meta.bounds.propertyBounds.length;++p)if(e._meta.bounds.propertyBounds[p].name===l[c].name){h=e._meta.bounds.propertyBounds[p];break}var d=null;for(var p=0;p<e._meta.bounds.initialBounds.length;++p)if(e._meta.bounds.initialBounds[p].name===l[c].name){d=e._meta.bounds.initialBounds[p];break}var v=null;for(var p=0;p<e._meta.bounds.valueBounds.length;++p)if(e._meta.bounds.valueBounds[p].name===l[c].name){v=e._meta.bounds.valueBounds[p];break}this._options.readOnly||(this._highlightNode===e&&this._highlightPropertyValue&&this._highlightPropertyValue.name===l[c].name?this.__drawRoundedRect(v.rect,this._drawStyle.property.highlightColor,this._drawStyle.property.highlightBorder,this._font.property.size/2,t):!n&&this._highlightNode===e&&this.__drawRoundedRect(v.rect,this._drawStyle.property.normalColor,this._drawStyle.property.normalBorder,this._font.property.size/2,t),this._highlightNode===e&&this._highlightPropertyInitialValue&&this._highlightPropertyInitialValue.name===l[c].name?this.__drawRoundedRect(d.rect,this._drawStyle.property.highlightColor,this._drawStyle.property.highlightBorder,this._font.property.size/2,t):!n&&this._highlightNode===e&&this.__drawRoundedRect(d.rect,this._drawStyle.property.normalColor,this._drawStyle.property.normalBorder,this._font.property.size/2,t)),t.fillStyle="black",t.textAlign="left",this.__setCanvasFont(this._font.property,t),t.fillText(l[c].name+": ",e._meta.bounds.center.left+this._drawStyle.node.margin,e._meta.bounds.center.top+r),t.textAlign="right",this.__setCanvasFont(this._font.initialValue,t),t.fillStyle="#444444",t.fillText(this._drawStyle.property.initialWrapL+this.__drawPropertyValue(e,l[c],!0)+this._drawStyle.property.initialWrapR,e._meta.bounds.center.left+e._meta.bounds.center.width-this._drawStyle.node.margin,e._meta.bounds.center.top+r),this.__setCanvasFont(this._font.value,t),t.fillStyle="black",t.fillText(this._drawStyle.property.valueWrapL+this.__drawPropertyValue(e,l[c])+this._drawStyle.property.valueWrapR,e._meta.bounds.center.left+e._meta.bounds.center.width-this._drawStyle.node.margin-e._meta.bounds.center.initialWidth,e._meta.bounds.center.top+r);if(!f||l[c].inputs.length){var m=null;for(var p=0;p<e._meta.bounds.inputBounds.length;++p)if(e._meta.bounds.inputBounds[p].name===l[c].name){m=e._meta.bounds.inputBounds[p].rect;break}t.fillStyle=this._highlightInputLink&&this._highlightInputLink.name===l[c].name&&this._highlightNode===e?"cyan":l[c].inputMeta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(m.left,m.top+5),t.lineTo(m.left+m.width,m.top+5),t.lineTo(m.left+m.width,m.top+m.height-5),t.lineTo(m.left,m.top+m.height-5),t.lineTo(m.left+m.width/3,m.top+m.height/2),t.closePath(),t.stroke(),t.fill()}if(!f||l[c].outputs.length){var m=null;for(var p=0;p<e._meta.bounds.outputBounds.length;++p)if(e._meta.bounds.outputBounds[p].name===l[c].name){m=e._meta.bounds.outputBounds[p].rect;break}t.fillStyle=this._highlightOutputLink&&this._highlightOutputLink.name===l[c].name&&this._highlightNode===e?"cyan":l[c].outputMeta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(m.left,m.top+5),t.lineTo(m.left+m.width/2,m.top+5),t.lineTo(m.left+m.width,m.top+m.height/2),t.lineTo(m.left+m.width/2,m.top+m.height-5),t.lineTo(m.left,m.top+m.height-5),t.closePath(),t.stroke(),t.fill()}r+=this._drawStyle.property.spacing}e.chain.exit.length&&(t.strokeStyle=e._meta.color,t.beginPath(),t.moveTo(e._meta.bounds.center.left,e._meta.bounds.center.top+e._meta.bounds.center.height),t.lineTo(e._meta.bounds.center.left+e._meta.bounds.center.width,e._meta.bounds.center.top+e._meta.bounds.center.height),t.stroke()),t.restore()},__drawEntryLinks:function(e,t,n,r){var i=n.x-r/2+this._drawStyle.links.margin,s=n.y+this._drawStyle.links.length+this._font.links.size;t.save(),this.__setCanvasFont(this._font.links,t);var o=e.collapsed(),u=e.chain.entry;for(var a=0;a<u.length;++a){t.fillStyle="black";var f=t.measureText(u[a].name).width+this._drawStyle.links.spacing;t.fillText(u[a].name,i+this._drawStyle.links.spacing/2,s);if(!o||u[a].links.length){var l=null;for(var c=0;c<e._meta.bounds.entryBounds.length;++c)if(e._meta.bounds.entryBounds[c].name===u[a].name){l=e._meta.bounds.entryBounds[c].rect;break}t.fillStyle=this._highlightEntryLink&&this._highlightEntryLink.name===u[a].name&&this._highlightNode===e?"cyan":u[a].meta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(l.left+5,l.top),t.lineTo(l.left+l.width/2,l.top+l.height/3),t.lineTo(l.left+l.width-5,l.top),t.lineTo(l.left+l.width-5,l.top+l.height),t.lineTo(l.left+5,l.top+l.height),t.closePath(),t.stroke(),t.fill()}i+=f}t.restore()},__drawExitLinks:function(e,t,n,r){var i=n.x-r/2+this._drawStyle.links.margin,s=n.y+this._font.links.size;t.save(),this.__setCanvasFont(this._font.links,t);var o=e.collapsed(),u=e.chain.exit;for(var a=0;a<u.length;++a){t.fillStyle="black";var f=t.measureText(u[a].name).width+this._drawStyle.links.spacing;t.fillText(u[a].name,i+this._drawStyle.links.spacing/2,s);if(!o||u[a].links.length){var l=null;for(var c=0;c<e._meta.bounds.exitBounds.length;++c)if(e._meta.bounds.exitBounds[c].name===u[a].name){l=e._meta.bounds.exitBounds[c].rect;break}t.fillStyle=this._highlightExitLink&&this._highlightExitLink.name===u[a].name&&this._highlightNode===e?"cyan":u[a].meta.color,t.strokeStyle="black",t.beginPath(),t.moveTo(l.left+5,l.top),t.lineTo(l.left+l.width-5,l.top),t.lineTo(l.left+l.width-5,l.top+l.height/2),t.lineTo(l.left+l.width/2,l.top+l.height),t.lineTo(l.left+5,l.top+l.height/2),t.closePath(),t.stroke(),t.fill()}i+=f}t.restore()},__drawChains:function(e,t){for(var n=0;n<e.length;++n)this.__drawNodeChains(e[n],t)},__drawNodeChains:function(e,t){for(var n=0;n<e.chain.exit.length;++n){var r=e.chain.exit[n];if(!r.links.length)continue;var i;for(var s=0;s<e._meta.bounds.exitBounds.length;++s)if(e._meta.bounds.exitBounds[s].name===r.name){i=e._meta.bounds.exitBounds[s].point;break}if(!i){console.log("ERROR: Attempted to draw chains for an exit link that has no meta data.");continue}for(var s=0;s<r.links.length;++s){var o=r.links[s].node,u=r.links[s].name,a;for(var f=0;f<o.chain.entry.length;++f)if(o.chain.entry[f].name===u){a=o.chain.entry[f];break}if(!a){console.log("ERROR: Attempted to chain an exit link to an entry link that was not found.");continue}var l;for(var f=0;f<o._meta.bounds.entryBounds.length;++f)if(o._meta.bounds.entryBounds[f].name===a.name){l=o._meta.bounds.entryBounds[f].point;break}if(!l){console.log("ERROR: Attempted to draw chains to an entry link that has no meta data.");continue}var c=r.meta.flashDelta>0&&a.meta.flashDelta>0,h=this._highlightNode===o&&this._highlightEntryLink&&this._highlightEntryLink.name===a.name||this._highlightNode===e&&this._highlightExitLink&&this._highlightExitLink.name===r.name;this.__drawFlowChain(i,l,e._meta.bounds.rect,o._meta.bounds.rect,t,c,h)}}for(var n=0;n<e.properties.length;++n){var p=e.properties[n];if(!p.outputs.length)continue;var d;for(var s=0;s<e._meta.bounds.outputBounds.length;++s)if(e._meta.bounds.outputBounds[s].name===p.name){d=e._meta.bounds.outputBounds[s].point;break}if(!d){console.log("ERROR: Attempted to draw chains for an output link that has no meta data.");continue}for(var s=0;s<p.outputs.length;++s){var o=p.outputs[s].node,u=p.outputs[s].name,v;for(var f=0;f<o.properties.length;++f)o.properties[f].name===u&&(v=o.properties[f]);if(!v){console.log("ERROR: Attempted to chain a property link to a property that was not found.");continue}var m;for(var f=0;f<o._meta.bounds.inputBounds.length;++f)if(o._meta.bounds.inputBounds[f].name===v.name){m=o._meta.bounds.inputBounds[f].point;break}if(!m){console.log("ERROR: Attempted to draw chains to a property input link that has no meta data.");continue}var c=p.outputMeta.flashDelta>0||v.inputMeta.flashDelta>0,h=this._highlightNode===o&&this._highlightInputLink&&this._highlightInputLink.name===v.name||this._highlightNode===e&&this._highlightOutputLink&&this._highlightOutputLink.name===p.name;this.__drawPropertyChain(d,m,e._meta.bounds.rect,o._meta.bounds.rect,t,c,h)}}if(this._selectedNode===e&&this._selectedEntryLink){var g,y=null,h=!1;this._highlightNode&&this._highlightExitLink?(g=this._highlightExitLink.point,y=this._highlightExitLink.rect,h=!0):(g={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z},y={left:g.x,top:g.y,width:1,height:1});var b;for(var n=0;n<e._meta.bounds.entryBounds.length;++n)e._meta.bounds.entryBounds[n].name===this._selectedEntryLink.name&&(b=e._meta.bounds.entryBounds[n].point);this.__drawFlowChain(g,b,y,e._meta.bounds.rect,t,h)}if(this._selectedNode===e&&this._selectedExitLink){var g,y=null,h=!1;this._highlightNode&&this._highlightEntryLink?(g=this._highlightEntryLink.point,y=this._highlightEntryLink.rect,h=!0):(g={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z},y={left:g.x,top:g.y,width:1,height:1});var b;for(var n=0;n<e._meta.bounds.exitBounds.length;++n)e._meta.bounds.exitBounds[n].name===this._selectedExitLink.name&&(b=e._meta.bounds.exitBounds[n].point);this.__drawFlowChain(b,g,e._meta.bounds.rect,y,t,h)}if(this._selectedNode===e&&this._selectedInputLink){var g,y=null,h=!1;this._highlightNode&&this._highlightOutputLink?(g=this._highlightOutputLink.point,y=this._highlightOutputLink.rect,h=!0):(g={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z},y={left:g.x,top:g.y,width:1,height:1});var b;for(var n=0;n<e._meta.bounds.inputBounds.length;++n)e._meta.bounds.inputBounds[n].name===this._selectedInputLink.name&&(b=e._meta.bounds.inputBounds[n].point);this.__drawPropertyChain(g,b,y,e._meta.bounds.rect,t,h)}if(this._selectedNode===e&&this._selectedOutputLink){var g,y=null,h=!1;this._highlightNode&&this._highlightInputLink?(g=this._highlightInputLink.point,y=this._highlightInputLink.rect,h=!0):(g={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z},y={left:g.x,top:g.y,width:1,height:1});var b;for(var n=0;n<e._meta.bounds.outputBounds.length;++n)e._meta.bounds.outputBounds[n].name===this._selectedOutputLink.name&&(b=e._meta.bounds.outputBounds[n].point);this.__drawPropertyChain(b,g,e._meta.bounds.rect,y,t,h)}},__drawFlowChain:function(e,t,n,r,i,s,o){i.save(),i.strokeStyle=o?"cyan":s?"#CCCC00":"#000000",i.lineWidth=2,i.lineCap="round",i.lineJoin="round",i.beginPath(),i.moveTo(e.x,e.y);var u=15;if(e.y<t.y){var a=(t.x+e.x)/2,f=(t.y+e.y)/2,l=Math.min(u,Math.abs(t.x-e.x)/2,Math.abs(t.y-e.y)/2);i.arcTo(e.x,f,a,f,l),i.arcTo(t.x,f,t.x,t.y,l)}else if(n.left+n.width<r.left){var a=(r.left+n.left+n.width)/2-2,f=(t.y+e.y)/2,c=(a+e.x)/2,h=(t.x+a)/2,l=Math.min(u,Math.abs(t.y-e.y)/4,Math.abs(a-c),Math.abs(a-h));i.arcTo(e.x,e.y+l,c,e.y+l,l),i.arcTo(a,e.y+l,a,f,l),i.arcTo(a,t.y-l,h,t.y-l,l),i.arcTo(t.x,t.y-l,t.x,t.y,l)}else if(n.left>r.left+r.width){var a=(n.left+r.left+r.width)/2+2,f=(t.y+e.y)/2,c=(a+t.x)/2,h=(e.x+a)/2,l=Math.min(u,Math.abs(t.y-e.y)/4,Math.abs(a-c),Math.abs(a-h));i.arcTo(e.x,e.y+l,h,e.y+l,l),i.arcTo(a,e.y+l,a,f,l),i.arcTo(a,t.y-l,c,t.y-l,l),i.arcTo(t.x,t.y-l,t.x,t.y,l)}else if(e.y>t.y&&Math.abs(e.y-t.y)>this._drawStyle.links.length){var p=e.x,d=Math.min(n.top-u,r.top-u),v=Math.max(n.top+n.height+u,r.top+r.height+u),f=(e.y+t.y)/2;Math.abs(Math.min(n.left,r.left)-e.x)<=Math.abs(Math.max(n.left+n.width,r.left+r.width)-t.x)?(p=Math.min(n.left-u,r.left-u),v-=2):(p=Math.max(n.left+n.width+u,r.left+r.width+u),v+=2);var a=(e.x+p)/2,l=Math.min(u,Math.abs(p-e.x)/2,Math.abs(p-t.x)/2);i.arcTo(e.x,v,a,v,l),i.arcTo(p,v,p,f,l),i.arcTo(p,d,a,d,l),i.arcTo(t.x,d,t.x,t.y,l)}i.lineTo(t.x,t.y),i.stroke(),i.restore()},__drawPropertyChain:function(e,t,n,r,i,s,o){i.save(),i.strokeStyle=o?"cyan":s?"#CCCC00":"#33CC33",i.lineWidth=2,i.lineCap="round",i.lineJoin="round",i.beginPath(),i.moveTo(e.x,e.y);var u=15;if(e.x<t.x){var a=(t.x+e.x)/2,f=(t.y+e.y)/2,l=Math.min(u,Math.abs(t.x-e.x)/2,Math.abs(t.y-e.y)/2);i.arcTo(a,e.y,a,f,l),i.arcTo(a,t.y,t.x,t.y,l)}else if(n.top+n.height<r.top){var a=(t.x+e.x)/2,f=(r.top+n.top+n.height)/2-2,c=(f+e.y)/2,h=(t.y+f)/2,l=Math.min(u,Math.abs(t.x-e.x)/4,Math.abs(f-c),Math.abs(f-h));i.arcTo(e.x+l,e.y,e.x+l,c,l),i.arcTo(e.x+l,f,a,f,l),i.arcTo(t.x-l,f,t.x-l,h,l),i.arcTo(t.x-l,t.y,t.x,t.y,l)}else if(n.top>r.top+r.height){var a=(t.x+e.x)/2,f=(n.top+r.top+r.height)/2+2,c=(f+t.y)/2,h=(e.y+f)/2,l=Math.min(u,Math.abs(t.x-e.x)/4,Math.abs(f-c),Math.abs(f-h));i.arcTo(e.x+l,e.y,e.x+l,h,l),i.arcTo(e.x+l,f,a,f,l),i.arcTo(t.x-l,f,t.x-l,c,l),i.arcTo(t.x-l,t.y,t.x,t.y,l)}else if(e.x>t.x&&Math.abs(e.x-t.x)>this._drawStyle.links.length){var p=e.y,d=Math.max(n.left+n.width+u,r.left+r.width+u),v=Math.min(n.left-u,r.left-u),a=(e.x+t.x)/2;Math.abs(Math.min(n.top,r.top)-e.y)<=Math.abs(Math.max(n.top+n.height,r.top+r.height)-t.y)?(p=Math.min(n.top-u,r.top-u),d-=2):(p=Math.max(n.top+n.height+u,r.top+r.height+u),d+=2);var f=(e.y+p)/2,l=Math.min(u,Math.abs(p-e.y)/2,Math.abs(p-t.y)/2);i.arcTo(d,e.y,d,f,l),i.arcTo(d,p,a,p,l),i.arcTo(v,p,v,f,l),i.arcTo(v,t.y,t.x,t.y,l)}i.lineTo(t.x,t.y),i.stroke(),i.restore()},__drawPropertyValue:function(e,t,n){var r;n?r=e.initialProperty(t.name):r=e.property(t.name);if(typeof t.options.display=="function")r=t.options.display(r);else switch(t.type){case wcPlay.PROPERTY.TOGGLE:return r?"yes":"no";case wcPlay.PROPERTY.SELECT:if(r=="")return"<none>";var i=t.options.items;$.isFunction(i)&&(i=i.call(e));if($.isArray(i)){var s=!1;for(var o=0;o<i.length;++o)if(typeof i[o]=="object"){if(i[o].value==r){r=i[o].name,s=!0;break}}else if(typeof i[o]=="string"&&i[o]==r){s=!0;break}s||(r="Unknown")}}return this.__clampString(r.toString(),this._drawStyle.property.strLen)},__drawTitleEditor:function(e,t){if(this._options.readOnly)return;var n=this,r=!1,i=$('<input type="text">');i.val(e.name),i.change(function(){if(!r){n._undoManager&&n._undoManager.addEvent('Title changed for Node "'+e.category+"."+e.type+'"',{id:e.id,oldValue:e.name,newValue:i.val(),editor:n},function(){var e=this.editor._engine.nodeById(this.id),t=e.name,n=e.onNameChanging(t,this.oldValue);n===undefined&&(n=this.oldValue),e.name=n,e.onNameChanged(t,n)},function(){var e=this.editor._engine.nodeById(this.id),t=e.name,n=e.onNameChanging(t,this.newValue);n===undefined&&(n=this.newValue),e.name=n,e.onNameChanged(t,n)});var t=e.name,s=e.onNameChanging(t,i.val());s===undefined&&(s=i.val()),e.name=s,e.onNameChanged(t,s)}});var s={top:0,left:this.$palette.width()};this.$main.append(i),i.addClass("wcPlayEditorControl"),i.focus(),i.select(),i.blur(function(){$(this).remove()}),i.keydown(function(e){e.stopPropagation()}),i.keyup(function(e){switch(e.keyCode){case 13:i.blur();break;case 27:r=!0,i.blur()}return!1}),i.css("top",s.top+t.top*this._viewportCamera.z+this._viewportCamera.y).css("left",s.left+t.left*this._viewportCamera.z+this._viewportCamera.x).css("width",Math.max(t.width*this._viewportCamera.z,200)).css("height",Math.max(t.height*this._viewportCamera.z,15))},__drawPropertyEditor:function(e,t,n,r){function l(e,t,n,r){f._undoManager&&f._undoManager.addEvent('Property "'+t+'" changed for Node "'+e.category+"."+e.type+'"',{id:e.id,name:t,propFn:u,oldValue:n,newValue:r,editor:f},function(){var e=this.editor._engine.nodeById(this.id);e[this.propFn](this.name,this.oldValue,!0,!0)},function(){var e=this.editor._engine.nodeById(this.id);e[this.propFn](this.name,this.newValue,!0,!0)})}if(this._options.readOnly)return;var i=null,s=!1,o=!0,u=r?"initialProperty":"property",a=t.type,f=this;switch(a){case wcPlay.PROPERTY.TOGGLE:var c=e[u](t.name);l(e,t.name,c,!c),e[u](t.name,!c,!0,!0);break;case wcPlay.PROPERTY.NUMBER:i=$('<input type="number"'+(t.options.min?' min="'+t.options.min+'"':"")+(t.options.max?' max="'+t.options.max+'"':"")+(t.options.step?' step="'+t.options.step+'"':"")+">"),i.val(parseFloat(e[u](t.name))),i.change(function(){if(!s){var n=$(this).attr("min")!==undefined?parseInt($(this).attr("min")):-Infinity,r=$(this).attr("max")!==undefined?parseInt($(this).attr("max")):Infinity;h=Math.min(r,Math.max(n,parseInt(i.val()))),l(e,t.name,e[u](t.name),h),e[u](t.name,h,!0,!0)}});break;case wcPlay.PROPERTY.STRING:case wcPlay.PROPERTY.DYNAMIC:t.options.multiline?(i=$("<textarea"+(t.options.maxlength?' maxlength="'+t.options.maxlength+'"':"")+">"),o=!1):i=$('<input type="text" maxlength="'+(t.options.maxlength||524288)+'">'),i.val(e[u](t.name).toString()),i.change(function(){s||(l(e,t.name,e[u](t.name),i.val()),e[u](t.name,i.val(),!0,!0))});break;case wcPlay.PROPERTY.SELECT:var h=e[u](t.name);i=$("<select>");var p=t.options.items;$.isFunction(p)&&(p=p.call(e));if(!$.isArray(p)){console.log("ERROR: Tried to display a Select type property when no selection list was provided.");return}i.append($('<option value=""'+(""==h?" selected":"")+">&lt;none&gt;</option>"));for(var d=0;d<p.length;++d)typeof p[d]=="object"?i.append($('<option value="'+p[d].value+'"'+(p[d].value==h?" selected":"")+">"+p[d].name+"</option>")):i.append($('<option value="'+p[d]+'"'+(p[d]==h?" selected":"")+">"+p[d]+"</option>"));i.change(function(){s||(l(e,t.name,e[u](t.name),i.val()),e[u](t.name,i.val(),!0,!0),$(this).blur())})}if(i){var v={top:0,left:this.$palette.width()};this.$main.append(i),i.addClass("wcPlayEditorControl"),i.focus(),i.select(),i.blur(function(){$(this).remove()}),i.keydown(function(e){e.stopPropagation()}),i.keyup(function(e){switch(e.keyCode){case 13:(o||e.ctrlKey)&&i.blur();break;case 27:s=!0,i.blur()}return!1}),i.css("top",v.top+n.rect.top*this._viewportCamera.z+this._viewportCamera.y).css("left",v.left+n.rect.left*this._viewportCamera.z+this._viewportCamera.x).css("width",Math.max(n.rect.width*this._viewportCamera.z,200)).css("height",Math.max(n.rect.height*this._viewportCamera.z,15))}},__onCreateNode:function(e){this._undoManager&&this._undoManager.addEvent('Created Node "'+e.category+"."+e.type+'"',{id:e.id,className:e.className,pos:{x:e.pos.x,y:e.pos.y},data:e.export(),editor:this,parent:this._parent},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._parent;while(!(t instanceof wcPlay)){if(t==e){this.editor._parent=e._parent,this.editor.center();break}t=t._parent}e.destroy()},function(){var e=new window[this.className](this.parent,this.pos);e.id=this.id,e.import(this.data)})},__onDestroyNode:function(e){this._undoManager&&this._undoManager.addEvent("",{data:e.export(),parent:this._parent,editor:this},function(){var e=new window[this.data.className](this.parent,this.data.pos);e.import(this.data)},function(){var e=this.editor._engine.nodeById(this.data.id),t=this.editor._parent;while(!(t instanceof wcPlay)){if(t==e){this.editor._parent=e._parent,this.editor.center();break}t=t._parent}e.destroy()})},__setupControls:function(){var e=this;$("ul.wcPlayEditorMenu > li").on("mouseenter",this.__onMenuMouseEnter),$("ul.wcPlayEditorMenu > li > ul").on("click",this.__onMenuClicked),$("ul.wcPlayEditorMenu > li").on("mouseleave",this.__onMenuMouseLeave),$("ul.wcPlayEditorMenu > li > ul").on("mouseleave",this.__onSubMenuMouseLeave),this.__bindMenuHandlers(),this.$palette.on("mousemove",function(t){e.__onPaletteMouseMove(t,this)}),this.$palette.on("mousedown",function(t){e.__onPaletteMouseDown(t,this)}),this.$palette.on("mouseup",function(t){e.__onPaletteMouseUp(t,this)}),this.$viewport.on("mousemove",function(t){e.__onViewportMouseMove(t,this)}),this.$viewport.on("mousedown",function(t){e.__onViewportMouseDown(t,this)}),this.$viewport.on("mouseup",function(t){e.__onViewportMouseUp(t,this)}),this.$viewport.on("mouseenter",function(t){e.__onViewportMouseEnter(t,this)}),this.$viewport.on("mouseleave",function(t){e.__onViewportMouseLeave(t,this)}),this.$viewport.on("click",function(t){e.__onViewportMouseClick(t,this)}),this.$viewport.on("dblclick",function(t){e.__onViewportMouseDoubleClick(t,this)}),this.$viewport.on("mousewheel DOMMouseScroll",function(t){e.__onViewportMouseWheel(t,this)}),$(window).keydown(function(t){e.__onKey(t,this)})},__onKey:function(e,t){switch(e.keyCode){case 46:$(".wcPlayEditorMenuOptionDelete").first().click();break;case"Z".charCodeAt(0):e.ctrlKey&&!e.shiftKey&&$(".wcPlayEditorMenuOptionUndo").first().click();if(!e.shiftKey)break;case"Y".charCodeAt(0):e.ctrlKey&&$(".wcPlayEditorMenuOptionRedo").first().click();break;case 32:$(".wcPlayEditorMenuOptionStep").first().click();break;case 13:$(".wcPlayEditorMenuOptionPausePlay").first().click();break;case"F".charCodeAt(0):this._selectedNodes.length?this.focus(this._selectedNodes):this.center();break;case"O".charCodeAt(0):if(e.ctrlKey)return $(".wcPlayEditorMenuOptionOpen").first().click(),e.stopPropagation(),e.preventDefault(),!1;$(".wcPlayEditorMenuOptionCompositeExit").first().click();break;case"S".charCodeAt(0):if(e.ctrlKey)return $(".wcPlayEditorMenuOptionSave").first().click(),e.stopPropagation(),e.preventDefault(),!1;case"I".charCodeAt(0):if(e.ctrlKey){$(".wcPlayEditorMenuOptionImport").first().click();break}$(".wcPlayEditorMenuOptionCompositeEnter").first().click();break;case"C".charCodeAt(0):if(e.ctrlKey){$(".wcPlayEditorMenuOptionCopy").first().click();break}$(".wcPlayEditorMenuOptionComposite").first().click();break;case"N".charCodeAt(0):if(e.altKey)return $(".wcPlayEditorMenuOptionNew").first().click(),e.stopPropagation(),e.preventDefault(),!1;break;case"X".charCodeAt(0):e.ctrlKey&&$(".wcPlayEditorMenuOptionCut").first().click();break;case"X".charCodeAt(0):e.ctrlKey&&$(".wcPlayEditorMenuOptionCut").first().click();break;case"V".charCodeAt(0):e.ctrlKey&&$(".wcPlayEditorMenuOptionPaste").first().click()}},__onMenuMouseEnter:function(e){var t=$(this);setTimeout(function(){t.is(":hover")&&t.addClass("wcPlayEditorMenuOpen").addClass("wcMenuItemHover")},100)},__onMenuClicked:function(){$("ul.wcPlayEditorMenu li ul").css("display","none"),setTimeout(function(){$("ul.wcPlayEditorMenu li ul").css("display","")},200)},__onMenuMouseLeave:function(e){$(this).find(e.toElement).length===0&&$(this).removeClass("wcPlayEditorMenuOpen").removeClass("wcMenuItemHover")},__onSubMenuMouseLeave:function(e){$parent=$(this).parent(),$parent.find(e.toElement).length===0&&$parent.removeClass("wcPlayEditorMenuOpen").removeClass("wcMenuItemHover")},__bindMenuHandlers:function(){function n(t,n){var r=new FileReader;r.onload=function(r){e._engine&&(n?e._engine.import(r.target.result,t.name)&&(e.__setupPalette(),e.$typeButton[3].click()):e._engine.load(r.target.result)?(e._parent=e._engine,e._selectedNode=null,e._selectedNodes=[],e._undoManager&&e._undoManager.clear(),e.center()):alert('Failed to open file "'+t.name+'"\nPlease check to ensure it is actually a wcPlay script file.'))},r.readAsText(t)}var e=this,t=$("body");t.on("click",".wcPlayEditorMenuOptionNew",function(){if($(this).hasClass("disabled"))return;e._engine&&(e._engine.clear(),e._undoManager&&e._undoManager.clear(),e._parent=e._engine)}),t.on("click",".wcPlayEditorMenuOptionOpen",function(){if($(this).hasClass("disabled"))return;if(e._engine&&document.createEvent){var t=document.createEvent("MouseEvents");t.initEvent("click",!0,!1),e.$container.prepend(e.$hiddenFileLoader),e.$hiddenFileLoader[0].dispatchEvent(t)}}),t.on("click",".wcPlayEditorMenuOptionSave",function(){if($(this).hasClass("disabled"))return;if(e._engine){if(!saveAs){console.log("ERROR: Attempted to save the script when external dependency 'FileSaver' was not included.");return}var t=e._engine.save(),n;try{n=new Blob([t],{type:"text/plain"})}catch(r){var i=new BlobBuilder;i.append(t),n=i.getBlob("text/plain")}saveAs(n,"script.wcplay")}}),t.on("click",".wcPlayEditorMenuOptionImport",function(){if($(this).hasClass("disabled"))return;if(e._engine&&document.createEvent){var t=document.createEvent("MouseEvents");t.initEvent("click",!0,!1),e.$container.prepend(e.$hiddenFileImporter),e.$hiddenFileImporter[0].dispatchEvent(t)}}),$("body").on("change","#wcPlayEditorHiddenFileLoader",function(e){if($(this).hasClass("disabled"))return;e.target.files.length&&(n(e.target.files[0]),$(this).val(""),$(this).remove())}),$("body").on("change","#wcPlayEditorHiddenFileImporter",function(e){if($(this).hasClass("disabled"))return;e.target.files.length&&(n(e.target.files[0],!0),$(this).val(""),$(this).remove())}),this.$container.on("dragover",function(e){e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy"}),this.$container.on("drop",function(e){e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.files.length&&n(e.originalEvent.dataTransfer.files[0],e.ctrlKey)}),t.on("click",".wcPlayEditorMenuOptionUndo",function(){if($(this).hasClass("disabled"))return;e._undoManager&&e._undoManager.undo()}),t.on("click",".wcPlayEditorMenuOptionRedo",function(){if($(this).hasClass("disabled"))return;e._undoManager&&e._undoManager.redo()}),t.on("click",".wcPlayEditorMenuOptionCut",function(){if($(this).hasClass("disabled"))return;if(e._selectedNodes.length===0)return;$(".wcPlayEditorMenuOptionCopy").first().click(),e._undoManager&&e._undoManager.beginGroup("Cut Nodes to clipboard");for(var t=0;t<e._selectedNodes.length;++t)e.__onDestroyNode(e._selectedNodes[t]),e._selectedNodes[t].destroy();e._selectedNodes=[],e._undoManager&&e._undoManager.endGroup()}),t.on("click",".wcPlayEditorMenuOptionCopy",function(){if($(this).hasClass("disabled"))return;if(e._selectedNodes.length===0)return;window.wcPlayEditorClipboard.nodes=[];var t=[];for(var n=0;n<e._selectedNodes.length;++n){var r=e._selectedNodes[n],i=r.export();t.push(r._meta.bounds.farRect),window.wcPlayEditorClipboard.nodes.push(i)}window.wcPlayEditorClipboard.bounds=e.__expandRect(t)}),t.on("click",".wcPlayEditorMenuOptionPaste",function(){if($(this).hasClass("disabled"))return;if(window.wcPlayEditorClipboard.nodes.length===0)return;var t={x:e._mouse.x,y:e._mouse.y};e._mouseInViewport||(t.x=e.$viewport.width()/2,t.y=e.$viewport.height()/2),e._selectedNode=null,e._selectedNodes=[];var n=[],r=[];e._undoManager&&e._undoManager.beginGroup("Paste Nodes from clipboard");var i=window.wcPlayEditorClipboard.bounds;for(var s=0;s<window.wcPlayEditorClipboard.nodes.length;++s){var o=window.wcPlayEditorClipboard.nodes[s],u=new window[o.className](e._parent,o.pos);n[o.id]=u.id,r.push(u)}for(var s=0;s<window.wcPlayEditorClipboard.nodes.length;++s){var o=window.wcPlayEditorClipboard.nodes[s],u=r[s];e._selectedNodes.push(u),e._selectedNode||(e._selectedNode=u),u.import(o,n),u.pos.x=(t.x-e._viewportCamera.x)/e._viewportCamera.z-i.width/2+(o.pos.x-i.left),u.pos.y=(t.y-e._viewportCamera.y)/e._viewportCamera.z-i.height/2+(o.pos.y-i.top),e.__onCreateNode(u)}e._undoManager&&e._undoManager.endGroup()}),t.on("click",".wcPlayEditorMenuOptionDelete",function(){if($(this).hasClass("disabled"))return;if(e._selectedNodes.length){e._undoManager&&e._undoManager.beginGroup("Removed Nodes");for(var t=0;t<e._selectedNodes.length;++t)e.__onDestroyNode(e._selectedNodes[t]),e._selectedNodes[t].destroy();e._selectedNode=null,e._selectedNodes=[],e._undoManager&&e._undoManager.endGroup()}}),t.on("click",".wcPlayEditorMenuOptionComposite",function(){if($(this).hasClass("disabled"))return;if(e._selectedNodes.length&&e._parent){e._undoManager&&e._undoManager.beginGroup("Combined Nodes into Composite");for(var t=0;t<e._selectedNodes.length;++t)e.__onDestroyNode(e._selectedNodes[t]),e._selectedNodes[t].id=++window.wcNodeNextID;var n=new wcNodeCompositeScript(e._parent,{x:0,y:0},e._selectedNodes),r=[];for(var t=0;t<e._selectedNodes.length;++t){var i=e._selectedNodes[t];r.push(i._meta.bounds.farRect)}var s=e.__expandRect(r),o=[];for(var t=0;t<e._selectedNodes.length;++t){var i=e._selectedNodes[t];e._parent.__removeNode(i);var u=i.listEntryChains(undefined,e._selectedNodes),a=i.listExitChains(undefined,e._selectedNodes),f=i.listInputChains(undefined,e._selectedNodes),l=i.listOutputChains(undefined,e._selectedNodes),c=[];for(var h=0;h<u.length;++h){var p=e._engine.nodeById(u[h].outNodeId),d=u[h].outName,i=e._engine.nodeById(u[h].inNodeId),v=u[h].inName,m=null;for(var g=0;g<c.length;++g)if(c[g].name===v){m=c[g].node;break}m||(m=new wcNodeCompositeEntry(n,{x:i.pos.x,y:s.top-100},v),m.collapsed(!0),c.push({name:v,node:m})),m.connectExit("out",i,v),n.connectEntry(m.name,p,d),p.disconnectExit(d,i,v)}c=[];for(var h=0;h<a.length;++h){var p=e._engine.nodeById(a[h].inNodeId),d=a[h].inName,i=e._engine.nodeById(a[h].outNodeId),v=a[h].outName,m=null;for(var g=0;g<c.length;++g)if(c[g].name===v){m=c[g].node;break}m||(m=new wcNodeCompositeExit(n,{x:i.pos.x,y:s.top+s.height+50},v),m.collapsed(!0),c.push({name:v,node:m})),m.connectEntry("in",i,v),n.connectExit(m.name,p,d),p.disconnectEntry(d,i,v)}c=[];for(var h=0;h<f.length;++h){var p=e._engine.nodeById(f[h].outNodeId),d=f[h].outName,i=e._engine.nodeById(f[h].inNodeId),v=f[h].inName,m=null;for(var g=0;g<c.length;++g)if(c[g].name===v){m=c[g].node;break}m||(m=new wcNodeCompositeProperty(n,{x:s.left-200,y:i.pos.y},v),m.collapsed(!0),c.push({name:v,node:m})),m.connectOutput("value",i,v),n.connectInput(m.name,p,d),p.disconnectOutput(d,i,v)}c=[];for(var h=0;h<l.length;++h){var p=e._engine.nodeById(l[h].inNodeId),d=l[h].inName,i=e._engine.nodeById(l[h].outNodeId),v=l[h].outName,m=null;for(var g=0;g<c.length;++g)if(c[g].name===v){m=c[g].node;break}m||(m=new wcNodeCompositeProperty(n,{x:s.left+s.width+200,y:i.pos.y},v),m.collapsed(!0),c.push({name:v,node:m})),m.connectInput("value",i,v),n.connectOutput(m.name,p,d),p.disconnectInput(d,i,v)}}e._selectedNode=null,e._selectedNodes=[],n.pos.x=s.left+s.width/2,n.pos.y=s.top+s.height/2,e.__onCreateNode(n),e._undoManager&&e._undoManager.endGroup(),e.__setupPalette()}}),t.on("click",".wcPlayEditorMenuOptionCenter",function(){if($(this).hasClass("disabled"))return;e._selectedNodes.length?e.focus(e._selectedNodes):e.center()}),t.on("click",".wcPlayEditorMenuOptionCompositeExit",function(){if($(this).hasClass("disabled"))return;if(e._parent instanceof wcNodeCompositeScript){var t=e._parent;e._parent=e._parent._parent,e._selectedNode=t,e._selectedNodes=[t],e.focus(e._selectedNodes)}}),t.on("click",".wcPlayEditorMenuOptionCompositeEnter",function(){if($(this).hasClass("disabled"))return;e._selectedNodes.length&&e._selectedNodes[0]instanceof wcNodeCompositeScript&&(e._parent=e._selectedNodes[0],e._selectedNode=null,e._selectedNodes=[],e.center())}),t.on("click",".wcPlayEditorMenuOptionDebugging",function(){if($(this).hasClass("disabled"))return;e._engine&&(e._engine.debugging(!e._engine.debugging()),e._engine.paused(!1))}),t.on("click",".wcPlayEditorMenuOptionSilence",function(){if($(this).hasClass("disabled"))return;e._engine&&e._engine.silent(!e._engine.silent())}),t.on("click",".wcPlayEditorMenuOptionRestart",function(){if($(this).hasClass("disabled"))return;e._engine&&e._engine.start()}),t.on("click",".wcPlayEditorMenuOptionPausePlay",function(){if($(this).hasClass("disabled"))return;e._engine&&(e._engine.paused()||e._engine.stepping()?(e._engine.paused(!1),e._engine.stepping(!1)):e._engine.stepping(!0))}),t.on("click",".wcPlayEditorMenuOptionStep",function(){if($(this).hasClass("disabled"))return;e._engine&&(e._engine.paused(!1),e._engine.stepping(!0))}),t.on("click",".wcPlayEditorMenuOptionDocs",function(){if($(this).hasClass("disabled"))return;window.open("https://play.api.webcabin.org/","_blank")})},__onPaletteMouseMove:function(e,t){var n=this.__mouse(e);this._highlightTitle=!1,this._highlightDebugLog=!1,this._highlightBreakpoint=!1,this._highlightEntryLink=!1,this._highlightExitLink=!1,this._highlightInputLink=!1,this._highlightOutputLink=!1,this._highlightPropertyValue=!1,this._highlightPropertyInitialValue=!1,this._highlightViewport=!1;if(this._draggingNodeData){var r={x:n.gx+this._draggingNodeData.offset.x,y:n.gy+this._draggingNodeData.offset.y};this._draggingNodeData.$canvas.css("left",r.x).css("top",r.y);return}var i=this.__findCategoryAreaAtPos(n);if(i){var s=i.$canvas.offset();n=this.__mouse(e,s);var o=this.__findNodeAtPos(n,undefined,i.nodes);o?(this._highlightNode=o,this.$palette.addClass("wcClickable"),this.$palette.attr("title","Create a new instance of this node by dragging this into your script.")):(this._highlightNode=null,this.$palette.removeClass("wcClickable"),this.$palette.attr("title",""))}},__onPaletteMouseDown:function(e,t){if(this._highlightNode){this.__onPaletteMouseUp(e,t);var n=this.__mouse(e),r=this._highlightNode._meta.bounds.rect,i=this.__findCategoryAreaAtPos(n);if(i){var s=i.$canvas.offset();this._draggingNodeData={node:this._highlightNode,$canvas:$('<canvas class="wcPlayHoverCanvas">'),offset:{x:0,y:0}},this.$main.append(this._draggingNodeData.$canvas),this.$palette.addClass("wcMoving"),this.$viewport.addClass("wcMoving"),this._draggingNodeData.$canvas.css("left",r.left+s.left).css("top",r.top+s.top),this._draggingNodeData.$canvas.attr("width",r.width).css("width",r.width),this._draggingNodeData.$canvas.attr("height",r.height).css("height",r.height),this._draggingNodeData.offset.x=r.left+s.left-n.x,this._draggingNodeData.offset.y=r.top+s.top-n.y;var o=0;this._highlightNode.chain.entry.length||(o+=this._drawStyle.links.length),this.__drawNode(this._highlightNode,{x:r.width/2,y:o+3},this._draggingNodeData.$canvas[0].getContext("2d"),!0)}}},__onPaletteMouseUp:function(e,t){this._draggingNodeData&&(this._draggingNodeData.$canvas.remove(),this._draggingNodeData.$canvas=null,this._draggingNodeData=null,this.$palette.removeClass("wcMoving"),this.$viewport.removeClass("wcMoving"))},__onViewportMouseMove:function(e,t){var n=this.__mouse(e,this.$viewport.offset());if(n.x!==this._mouse.x||n.y!==this._mouse.y)this._mouseMoved=!0;if(this._draggingNodeData){var r={x:n.gx+this._draggingNodeData.offset.x,y:n.gy+this._draggingNodeData.offset.y};this._draggingNodeData.$canvas.css("left",r.x).css("top",r.y),this._mouse=n;return}if(this._highlightRect&&this._parent){this._highlightRect.x=(n.x-this._viewportCamera.x)/this._viewportCamera.z-this._highlightRect.ox,this._highlightRect.y=(n.y-this._viewportCamera.y)/this._viewportCamera.z-this._highlightRect.oy,this._highlightRect.width=this._highlightRect.x,this._highlightRect.height=this._highlightRect.y,this._highlightRect.width<0&&(this._highlightRect.left=this._highlightRect.ox+this._highlightRect.width,this._highlightRect.width*=-1),this._highlightRect.height<0&&(this._highlightRect.top=this._highlightRect.oy+this._highlightRect.height,this._highlightRect.height*=-1),this._selectedNodes=[];var i=this;function s(e){for(var t=0;t<e.length;++t)i.__rectInRect(e[t]._meta.bounds.inner,i._highlightRect)&&i._selectedNodes.push(e[t])}s(this._parent._storageNodes),s(this._parent._compositeNodes),s(this._parent._processNodes),s(this._parent._entryNodes),this._mouse=n;return}if(this._viewportMoving){var o=n.x-this._mouse.x,u=n.y-this._mouse.y;this._viewportCamera.x+=o,this._viewportCamera.y+=u,this._mouse=n,!this._viewportMoved&&this._mouseMoved&&(this._viewportMoved=!0,this.$viewport.addClass("wcMoving"));return}if(this._viewportMovingNode){var o=n.x-this._mouse.x,u=n.y-this._mouse.y;for(var a=0;a<this._selectedNodes.length;++a){var f=this._selectedNodes[a],l={x:f.pos.x,y:f.pos.y},c={x:f.pos.x+o/this._viewportCamera.z,y:f.pos.y+u/this._viewportCamera.z},c=f.onMoving(l,c)||c;if(l.x!==c.x||l.y!==c.y)f.pos.x=c.x,f.pos.y=c.y,f.onMoved(l,c)}this._mouse=n;return}this._mouse=n,this._highlightNode=null,this._highlightCrumb=-1,this._highlightTitle=!1,this._highlightDebugLog=!1,this._highlightBreakpoint=!1,this._highlightEntryLink=!1,this._highlightExitLink=!1,this._highlightInputLink=!1,this._highlightOutputLink=!1,this._highlightPropertyValue=!1,this._highlightPropertyInitialValue=!1;var h=this._highlightViewport;this._highlightViewport=!1,this.$viewport.removeClass("wcClickable wcMoving wcGrab"),this.$viewport.attr("title","");for(var a=0;a<this._crumbBounds.length;++a)if(this.__inRect(n,this._crumbBounds[a].rect)){this._highlightCrumb=a,this.$viewport.addClass("wcClickable"),this.$viewport.attr("title","Click to go to this level in the hierarchy.");break}var f=null;this._highlightCrumb===-1&&(f=this.__findNodeAtPos(n,this._viewportCamera));if(f){!this._options.readOnly&&this.__inRect(n,f._meta.bounds.farRect,this._viewportCamera)&&(this._highlightNode=f,this.__inRect(n,f._meta.bounds.inner,this._viewportCamera)&&(this.$viewport.attr("title",(f._meta.description?f._meta.description+"\n":"")+"Click and drag to move this node. Double click to collapse/expand this node."),this.$viewport.addClass("wcMoving"))),!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedInputLink&&!this._selectedOutputLink&&(this.__inRect(n,f._meta.bounds.debugLog,this._viewportCamera)&&(this._highlightDebugLog=!0,this._highlightNode=f,this.$viewport.addClass("wcClickable"),f._log?this.$viewport.attr("title","Disable debug logging for this node."):this.$viewport.attr("title","Enable debug logging for this node.")),this.__inRect(n,f._meta.bounds.breakpoint,this._viewportCamera)&&(this._highlightBreakpoint=!0,this._highlightNode=f,this.$viewport.addClass("wcClickable"),this.$viewport.attr("title","Toggle debug breakpoint on this node.")));if(!this._options.readOnly&&!this._selectedEntryLink&&!this._selectedInputLink&&!this._selectedOutputLink)for(var a=0;a<f._meta.bounds.entryBounds.length;++a)if(this.__inRect(n,f._meta.bounds.entryBounds[a].rect,this._viewportCamera)){this._highlightNode=f,this._highlightEntryLink=f._meta.bounds.entryBounds[a];var p;for(var d=0;d<f.chain.entry.length;++d)if(f.chain.entry[d].name==this._highlightEntryLink.name){p=f.chain.entry[d];break}this.$viewport.attr("title",(p.meta.description?p.meta.description+"\n":"")+"Click and drag to create a new flow chain from another node. Double click to manually fire this entry link."),this.$viewport.addClass("wcGrab");break}if(!this._options.readOnly&&!this._selectedExitLink&&!this._selectedInputLink&&!this._selectedOutputLink)for(var a=0;a<f._meta.bounds.exitBounds.length;++a)if(this.__inRect(n,f._meta.bounds.exitBounds[a].rect,this._viewportCamera)){this._highlightNode=f,this._highlightExitLink=f._meta.bounds.exitBounds[a];var p;for(var d=0;d<f.chain.exit.length;++d)if(f.chain.exit[d].name==this._highlightExitLink.name){p=f.chain.exit[d];break}this.$viewport.attr("title",(p.meta.description?p.meta.description+"\n":"")+"Click and drag to create a new flow chain to another node. Double click to manually fire this exit link."),this.$viewport.addClass("wcGrab");break}if(!this._options.readOnly&&!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedInputLink)for(var a=0;a<f._meta.bounds.inputBounds.length;++a)if(this.__inRect(n,f._meta.bounds.inputBounds[a].rect,this._viewportCamera)){this._highlightNode=f,this._highlightInputLink=f._meta.bounds.inputBounds[a],this.$viewport.attr("title","Click and drag to chain this property to the output of another."),this.$viewport.addClass("wcGrab");break}if(!this._options.readOnly&&!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedOutputLink)for(var a=0;a<f._meta.bounds.outputBounds.length;++a)if(this.__inRect(n,f._meta.bounds.outputBounds[a].rect,this._viewportCamera)){this._highlightNode=f,this._highlightOutputLink=f._meta.bounds.outputBounds[a],this.$viewport.attr("title","Click and drag to chain this property to the input of another. Double click to manually propagate this property through the chain."),this.$viewport.addClass("wcGrab");break}if(!this._selectedEntryLink&&!this._selectedExitLink&&!this._selectedInputLink&&!this._selectedOutputLink){if(!this._options.readOnly){this.__inRect(this._mouse,f._meta.bounds.titleBounds,this._viewportCamera)&&(this._highlightNode=f,this._highlightTitle=!0,this.$viewport.attr("title","Click to add or modify an additional label for this title."),this.$viewport.addClass("wcClickable"));var v;for(var a=0;a<f._meta.bounds.propertyBounds.length;++a)if(this.__inRect(this._mouse,f._meta.bounds.propertyBounds[a].rect,this._viewportCamera)){v=f._meta.bounds.propertyBounds[a];break}if(v)for(var a=0;a<f.properties.length;++a)if(f.properties[a].name===v.name){this.$viewport.attr("title",f.properties[a].options.description?f.properties[a].options.description+"\n":""),this.$viewport.addClass("wcClickable");break}var m;for(var a=0;a<f._meta.bounds.valueBounds.length;++a)if(this.__inRect(this._mouse,f._meta.bounds.valueBounds[a].rect,this._viewportCamera)){m=f._meta.bounds.valueBounds[a];break}if(m)for(var a=0;a<f.properties.length;++a)if(f.properties[a].name===m.name){this._highlightNode=f,this._highlightPropertyValue=m,this.$viewport.attr("title",(f.properties[a].options.description?f.properties[a].options.description+"\n":"")+'Click to change the current value of this property.\nValue = "'+f.properties[a].value+'"\n'),this.$viewport.addClass("wcClickable");break}var g;for(var a=0;a<f._meta.bounds.initialBounds.length;++a)if(this.__inRect(this._mouse,f._meta.bounds.initialBounds[a].rect,this._viewportCamera)){g=f._meta.bounds.initialBounds[a];break}if(g)for(var a=0;a<f.properties.length;++a)if(f.properties[a].name===g.name){this._highlightNode=f,this._highlightPropertyInitialValue=g,this.$viewport.attr("title",(f.properties[a].options.description?f.properties[a].options.description+"\n":"")+'Click to change the initial value of this property.\nValue = "'+f.properties[a].initialValue+'"\n'),this.$viewport.addClass("wcClickable");break}}if(f._meta.bounds.viewportBounds){var r={x:(n.x-this._viewportCamera.x)/this._viewportCamera.z-f._meta.bounds.viewportBounds.left,y:(n.y-this._viewportCamera.y)/this._viewportCamera.z-f._meta.bounds.viewportBounds.top};this.__inRect(this._mouse,f._meta.bounds.viewportBounds,this._viewportCamera)?(this._highlightNode=f,this._highlightViewport=!0,this.$viewport.addClass("wcClickable"),h||f.onViewportMouseEnter(e,r,this._options.readOnly),f.onViewportMouseMove(e,r,this._options.readOnly)):h&&f.onViewportMouseLeave(e,r,this._options.readOnly)}}}this._expandedHighlightNode&&this._expandedHighlightNode!==this._highlightNode&&(this._highlightNode||!this.__inRect(n,this._expandedHighlightNode._meta.bounds.farRect,this._viewportCamera))&&(this._expandedSelectedNode!==this._expandedHighlightNode&&this._expandedHighlightNode.collapsed(!0),this._expandedHighlightNode=null);if(!this._expandedHighlightNode&&this._highlightNode&&this.__inRect(n,f._meta.bounds.farRect,this._viewportCamera)){this._expandedHighlightNode=this._highlightNode;var i=this;i._expandedHighlightNode.collapsed(!1)}},__onViewportMouseDown:function(e,t){this._mouse=this.__mouse(e,this.$viewport.offset());if(this._mouse.which===3)return;this._mouseMoved=!1;if(e.ctrlKey||this._mouse.which===2){this._highlightRect={top:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z,left:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,oy:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z,ox:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z,x:0,y:0,width:0,height:0};return}var n=!1,r=this.__findNodeAtPos(this._mouse,this._viewportCamera);if(r){if(!n&&!this._options.readOnly)for(var i=0;i<r._meta.bounds.entryBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.entryBounds[i].rect,this._viewportCamera)){n=!0;if(e.altKey){var s=r.listEntryChains(r._meta.bounds.entryBounds[i].name);s.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Entry Links for "'+r.category+"."+r.type+"."+r._meta.bounds.entryBounds[i].name+'"',{id:r.id,name:r._meta.bounds.entryBounds[i].name,chains:s,editor:this},function(){var e=this.editor._engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.editor._engine.nodeById(this.chains[t].outNodeId),r=this.chains[t].outName;e.connectEntry(this.name,n,r)}},function(){var e=this.editor._engine.nodeById(this.id);e.disconnectEntry(this.name)}),r.disconnectEntry(r._meta.bounds.entryBounds[i].name);break}this._selectedNode=r,this._selectedNodes=[r],this._selectedEntryLink=r._meta.bounds.entryBounds[i],this.$viewport.addClass("wcGrabbing"),this._expandedSelectedNode=this._expandedHighlightNode;break}if(!n&&!this._options.readOnly)for(var i=0;i<r._meta.bounds.exitBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.exitBounds[i].rect,this._viewportCamera)){n=!0;if(e.altKey){var s=r.listExitChains(r._meta.bounds.exitBounds[i].name);s.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Exit Links for "'+r.category+"."+r.type+"."+r._meta.bounds.exitBounds[i].name+'"',{id:r.id,name:r._meta.bounds.exitBounds[i].name,chains:s,editor:this},function(){var e=this.editor._engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.editor._engine.nodeById(this.chains[t].inNodeId),r=this.chains[t].inName;e.connectExit(this.name,n,r)}},function(){var e=this.editor._engine.nodeById(this.id);e.disconnectExit(this.name)}),r.disconnectExit(r._meta.bounds.exitBounds[i].name);break}if(e.shiftKey){r.activateExit(r._meta.bounds.exitBounds[i].name);break}this._selectedNode=r,this._selectedNodes=[r],this._selectedExitLink=r._meta.bounds.exitBounds[i],this.$viewport.addClass("wcGrabbing"),this._expandedSelectedNode=this._expandedHighlightNode;break}if(!n&&!this._options.readOnly)for(var i=0;i<r._meta.bounds.inputBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.inputBounds[i].rect,this._viewportCamera)){n=!0;if(e.altKey){var s=r.listInputChains(r._meta.bounds.inputBounds[i].name);s.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Property Input Links for "'+r.category+"."+r.type+"."+r._meta.bounds.inputBounds[i].name+'"',{id:r.id,name:r._meta.bounds.inputBounds[i].name,chains:s,editor:this},function(){var e=this.editor._engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.editor._engine.nodeById(this.chains[t].outNodeId),r=this.chains[t].outName;e.connectInput(this.name,n,r)}},function(){var e=this.editor._engine.nodeById(this.id);e.disconnectInput(this.name)}),r.disconnectInput(r._meta.bounds.inputBounds[i].name);break}this._selectedNode=r,this._selectedNodes=[r],this._selectedInputLink=r._meta.bounds.inputBounds[i],this.$viewport.addClass("wcGrabbing"),this._expandedSelectedNode=this._expandedHighlightNode;break}if(!n&&!this._options.readOnly)for(var i=0;i<r._meta.bounds.outputBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.outputBounds[i].rect,this._viewportCamera)){n=!0;if(e.altKey){var s=r.listOutputChains(r._meta.bounds.outputBounds[i].name);s.length&&this._undoManager&&this._undoManager.addEvent('Disconnected Property Output Links for "'+r.category+"."+r.type+"."+r._meta.bounds.outputBounds[i].name+'"',{id:r.id,name:r._meta.bounds.outputBounds[i].name,chains:s,editor:this},function(){var e=this.editor._engine.nodeById(this.id);for(var t=0;t<this.chains.length;++t){var n=this.editor._engine.nodeById(this.chains[t].inNodeId),r=this.chains[t].inName;e.connectOutput(this.name,n,r)}},function(){var e=this.editor._engine.nodeById(this.id);e.disconnectOutput(this.name)}),r.disconnectOutput(r._meta.bounds.outputBounds[i].name);break}this._selectedNode=r,this._selectedNodes=[r],this._selectedOutputLink=r._meta.bounds.outputBounds[i],this.$viewport.addClass("wcGrabbing"),this._expandedSelectedNode=this._expandedHighlightNode;break}if(!n&&r._meta.bounds.viewportBounds){var o={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z-r._meta.bounds.viewportBounds.left,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z-r._meta.bounds.viewportBounds.top};this.__inRect(this._mouse,r._meta.bounds.viewportBounds,this._viewportCamera)&&(this._selectedNode=r,this._selectedNodes=[r],r.onViewportMouseDown(e,o,this._options.readOnly)&&(n=!0))}if(!n&&this.__inRect(this._mouse,r._meta.bounds.inner,this._viewportCamera)){n=!0;if(!this._selectedNodes.length||this._selectedNodes.indexOf(r)===-1)this._selectedNode=r,this._selectedNodes=[r];this._viewportMovingNode=!this._options.readOnly,this._selectedNodeOrigins=[];for(var i=0;i<this._selectedNodes.length;++i){var u=this._selectedNodes[i];this._selectedNodeOrigins.push({x:u.pos.x,y:u.pos.y})}}}n||(this._viewportMoving=!0,this._viewportMoved=!1)},__onViewportMouseUp:function(e,t){this.$viewport.removeClass("wcGrabbing");if(this._draggingNodeData){var n=this.__mouse(e,this.$viewport.offset(),this._viewportCamera),r=new window[this._draggingNodeData.node.className](this._parent,{x:0,y:0}),i=this._draggingNodeData.node.export();i.id=r.id,i.pos.x=n.x/this._viewportCamera.z+(this._draggingNodeData.$canvas.width()/2+this._draggingNodeData.offset.x),i.pos.y=n.y/this._viewportCamera.z+(this._draggingNodeData.offset.y+5),r.import(i),this.__onCreateNode(r),this._selectedNode=r,this._selectedNodes=[r],this._expandedHighlightNode=r,r.collapsed(!1),this.__updateNode(r,0,r.pos,this._viewportContext),this.__drawNode(r,r.pos,this._viewportContext),this._draggingNodeData.$canvas.remove(),this._draggingNodeData.$canvas=null,this._draggingNodeData=null,this.$palette.removeClass("wcMoving"),this.$viewport.removeClass("wcMoving")}if(this._highlightRect&&this._parent){this._highlightRect=null;return}if(this._selectedNodes.length&&this._selectedNodeOrigins.length){this._undoManager&&this._undoManager.beginGroup("Node(s) moved.");for(var s=0;s<this._selectedNodes.length;++s){var o=this._selectedNodes[s];if(o.pos.x!==this._selectedNodeOrigins[s].x||o.pos.y!==this._selectedNodeOrigins[s].y)o.onMoved({x:this._selectedNodeOrigins[s].x,y:this._selectedNodeOrigins[s].y},{x:o.pos.x,y:o.pos.y}),this._undoManager&&this._undoManager.addEvent('Moved Node "'+o.category+"."+o.type+'"',{id:o.id,start:{x:this._selectedNodeOrigins[s].x,y:this._selectedNodeOrigins[s].y},end:{x:o.pos.x,y:o.pos.y},editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=e.onMoving({x:this.end.x,y:this.end.y},{x:this.start.x,y:this.start.y})||this.start;e.pos.x=this.start.x,e.pos.y=this.start.y,e.onMoved({x:this.end.x,y:this.end.y},{x:t.x,y:t.y})},function(){var e=this.editor._engine.nodeById(this.id),t=e.onMoving({x:this.start.x,y:this.start.y},{x:this.end.x,y:this.end.y})||this.end;e.pos.x=this.end.x,e.pos.y=this.end.y,e.onMoved({x:this.start.x,y:this.start.y},{x:t.x,y:t.y})})}this._undoManager&&this._undoManager.endGroup(),this._selectedNodeOrigins=[]}this._selectedNode&&this._selectedEntryLink&&this._highlightNode&&this._highlightExitLink&&(this._selectedNode.connectEntry(this._selectedEntryLink.name,this._highlightNode,this._highlightExitLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectEntry(this._selectedEntryLink.name,this._highlightNode,this._highlightExitLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Entry Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedEntryLink.name+'" to Exit Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightExitLink.name+'"',{id:this._selectedNode.id,name:this._selectedEntryLink.name,targetId:this._highlightNode.id,targetName:this._highlightExitLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectEntry(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectEntry(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Entry Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedEntryLink.name+'" to Exit Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightExitLink.name+'"',{id:this._selectedNode.id,name:this._selectedEntryLink.name,targetId:this._highlightNode.id,targetName:this._highlightExitLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectEntry(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectEntry(this.name,t,this.targetName)})),this._selectedNode&&this._selectedExitLink&&this._highlightNode&&this._highlightEntryLink&&(this._selectedNode.connectExit(this._selectedExitLink.name,this._highlightNode,this._highlightEntryLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectExit(this._selectedExitLink.name,this._highlightNode,this._highlightEntryLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Exit Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedExitLink.name+'" to Entry Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightEntryLink.name+'"',{id:this._selectedNode.id,name:this._selectedExitLink.name,targetId:this._highlightNode.id,targetName:this._highlightEntryLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectExit(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectExit(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Exit Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedExitLink.name+'" to Entry Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightEntryLink.name+'"',{id:this._selectedNode.id,name:this._selectedExitLink.name,targetId:this._highlightNode.id,targetName:this._highlightEntryLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectExit(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectExit(this.name,t,this.targetName)})),this._selectedNode&&this._selectedInputLink&&this._highlightNode&&this._highlightOutputLink&&(this._selectedNode.connectInput(this._selectedInputLink.name,this._highlightNode,this._highlightOutputLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectInput(this._selectedInputLink.name,this._highlightNode,this._highlightOutputLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Property Input Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedInputLink.name+'" to Property Output Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightOutputLink.name+'"',{id:this._selectedNode.id,name:this._selectedInputLink.name,targetId:this._highlightNode.id,targetName:this._highlightOutputLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectInput(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectInput(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Property Input Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedInputLink.name+'" to Property Output Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightOutputLink.name+'"',{id:this._selectedNode.id,name:this._selectedInputLink.name,targetId:this._highlightNode.id,targetName:this._highlightOutputLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectInput(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectInput(this.name,t,this.targetName)})),this._selectedNode&&this._selectedOutputLink&&this._highlightNode&&this._highlightInputLink&&(this._selectedNode.connectOutput(this._selectedOutputLink.name,this._highlightNode,this._highlightInputLink.name)===wcNode.CONNECT_RESULT.ALREADY_CONNECTED?(this._selectedNode.disconnectOutput(this._selectedOutputLink.name,this._highlightNode,this._highlightInputLink.name),this._undoManager&&this._undoManager.addEvent('Disconnected Property Output Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedOutputLink.name+'" to Property Input Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightInputLink.name+'"',{id:this._selectedNode.id,name:this._selectedOutputLink.name,targetId:this._highlightNode.id,targetName:this._highlightInputLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectOutput(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectOutput(this.name,t,this.targetName)})):this._undoManager&&this._undoManager.addEvent('Connected Property Output Link "'+this._selectedNode.category+"."+this._selectedNode.type+"."+this._selectedOutputLink.name+'" to Property Input Link "'+this._highlightNode.category+"."+this._highlightNode.type+"."+this._highlightInputLink.name+'"',{id:this._selectedNode.id,name:this._selectedOutputLink.name,targetId:this._highlightNode.id,targetName:this._highlightInputLink.name,editor:this},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.disconnectOutput(this.name,t,this.targetName)},function(){var e=this.editor._engine.nodeById(this.id),t=this.editor._engine.nodeById(this.targetId);e.connectOutput(this.name,t,this.targetName)}));if(this._selectedNode&&this._highlightViewport){var n=this.__mouse(e,this.$viewport.offset()),u={x:(n.x-this._viewportCamera.x)/this._viewportCamera.z-this._selectedNode._meta.bounds.viewportBounds.left,y:(n.y-this._viewportCamera.y)/this._viewportCamera.z-this._selectedNode._meta.bounds.viewportBounds.top};this._selectedNode.onViewportMouseUp(e,u,this._options.readOnly)}this._expandedSelectedNode&&this._expandedSelectedNode!==this._expandedHighlightNode&&this._expandedSelectedNode.collapsed(!0),this._expandedSelectedNode=null,this._selectedEntryLink=!1,this._selectedExitLink=!1,this._selectedInputLink=!1,this._selectedOutputLink=!1,this._viewportMovingNode=!1,this._viewportMoving&&(this._viewportMoving=!1,this._viewportMoved?(this._viewportMoved=!1,this.$viewport.removeClass("wcMoving")):(this._selectedNode=null,this._selectedNodes=[]))},__onViewportMouseEnter:function(e,t){this._mouseInViewport=!0},__onViewportMouseLeave:function(e,t){this._mouseInViewport=!1},__onViewportMouseClick:function(e,t){if(!this._mouseMoved){if(this._highlightCrumb>-1){if(this._crumbBounds[this._highlightCrumb].parent!==this._parent){var n=this._crumbBounds[this._highlightCrumb+1].parent;this._parent=this._crumbBounds[this._highlightCrumb].parent,this._selectedNode=n,this._selectedNodes=[n],this.focus(this._selectedNodes)}return}this._mouse=this.__mouse(e,this.$viewport.offset());var r=!1,i=this.__findNodeAtPos(this._mouse,this._viewportCamera);if(i){if(this.__inRect(this._mouse,i._meta.bounds.debugLog,this._viewportCamera)){var s=!i._log;i.debugLog(s),this._undoManager&&this._undoManager.addEvent((s?"Enabled":"Disabled")+' Debug Logging for Node "'+i.category+"."+i.type+'"',{id:i.id,state:s,editor:this},function(){var e=this.editor._engine.nodeById(this.id);e.debugLog(!this.state)},function(){var e=this.editor._engine.nodeById(this.id);e.debugLog(this.state)})}if(this.__inRect(this._mouse,i._meta.bounds.breakpoint,this._viewportCamera)){var s=!i._break;i.debugBreak(s),this._undoManager&&this._undoManager.addEvent((s?"Enabled":"Disabled")+' Breakpoint on Node "'+i.category+"."+i.type+'"',{id:i.id,state:s,editor:this},function(){var e=this.editor._engine.nodeById(this.id);e.debugBreak(!this.state)},function(){var e=this.editor._engine.nodeById(this.id);e.debugBreak(this.state)})}this.__inRect(this._mouse,i._meta.bounds.titleBounds,this._viewportCamera)&&this.__drawTitleEditor(i,i._meta.bounds.titleBounds);var o;for(var u=0;u<i._meta.bounds.valueBounds.length;++u)if(this.__inRect(this._mouse,i._meta.bounds.valueBounds[u].rect,this._viewportCamera)){o=i._meta.bounds.valueBounds[u];break}if(o)for(var u=0;u<i.properties.length;++u)if(i.properties[u].name===o.name){this.__drawPropertyEditor(i,i.properties[u],o);break}var a;for(var u=0;u<i._meta.bounds.initialBounds.length;++u)if(this.__inRect(this._mouse,i._meta.bounds.initialBounds[u].rect,this._viewportCamera)){a=i._meta.bounds.initialBounds[u];break}if(a)for(var u=0;u<i.properties.length;++u)if(i.properties[u].name===a.name){this.__drawPropertyEditor(i,i.properties[u],a,!0);break}if(i._meta.bounds.viewportBounds){var f={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z-i._meta.bounds.viewportBounds.left,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z-i._meta.bounds.viewportBounds.top};this.__inRect(this._mouse,i._meta.bounds.viewportBounds,this._viewportCamera)&&i.onViewportMouseClick(e,f,this._options.readOnly)}}}},__onViewportMouseDoubleClick:function(e,t){this._mouse=this.__mouse(e,this.$viewport.offset());var n=!1,r=this.__findNodeAtPos(this._mouse,this._viewportCamera);if(r){this.__inRect(this._mouse,r._meta.bounds.debugLog,this._viewportCamera)&&(n=!0),this.__inRect(this._mouse,r._meta.bounds.breakpoint,this._viewportCamera)&&(n=!0);for(var i=0;i<r._meta.bounds.valueBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.valueBounds[i].rect,this._viewportCamera)){n=!0;break}if(!this._options.readOnly&&!n)for(var i=0;i<r._meta.bounds.entryBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.entryBounds[i].rect,this._viewportCamera)){n=!0,r.activateEntry(r._meta.bounds.entryBounds[i].name);break}if(!this._options.readOnly&&!n)for(var i=0;i<r._meta.bounds.exitBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.exitBounds[i].rect,this._viewportCamera)){n=!0,r.activateExit(r._meta.bounds.exitBounds[i].name);break}if(!this._options.readOnly&&!n)for(var i=0;i<r._meta.bounds.outputBounds.length;++i)if(this.__inRect(this._mouse,r._meta.bounds.outputBounds[i].rect,this._viewportCamera)){n=!0,r.property(r._meta.bounds.outputBounds[i].name,r.property(r._meta.bounds.outputBounds[i].name),!0);break}if(!n&&r._meta.bounds.viewportBounds){var s={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z-r._meta.bounds.viewportBounds.left,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z-r._meta.bounds.viewportBounds.top};this.__inRect(this._mouse,r._meta.bounds.viewportBounds,this._viewportCamera)&&(n=r.onViewportMouseDoubleClick(e,s,this._options.readOnly))}if(!n&&this.__inRect(this._mouse,r._meta.bounds.inner,this._viewportCamera)){n=!0;if(r instanceof wcNodeCompositeScript)this._parent=r,this._selectedNode=null,this._selectedNodes=[],this.center();else if(r instanceof wcNodeComposite&&this._parent instanceof wcNodeCompositeScript){var o=this._parent;this._parent=this._parent._parent,this._selectedNode=o,this._selectedNodes=[o],this.focus(this._selectedNodes)}else r instanceof wcNodeEntry&&r.onTriggered()}}},__onViewportMouseWheel:function(e,t){var n=this._viewportCamera.z;if(this._highlightNode&&this._highlightNode._meta.bounds.viewportBounds){var r={x:(this._mouse.x-this._viewportCamera.x)/this._viewportCamera.z-this._highlightNode._meta.bounds.viewportBounds.left,y:(this._mouse.y-this._viewportCamera.y)/this._viewportCamera.z-this._highlightNode._meta.bounds.viewportBounds.top};if(this.__inRect(this._mouse,this._highlightNode._meta.bounds.viewportBounds,this._viewportCamera)&&this._highlightNode.onViewportMouseWheel(e,r,e.originalEvent.wheelDelta>0||e.originalEvent.detail<0,this._options.readOnly))return}e.originalEvent.wheelDelta>0||e.originalEvent.detail<0?this._viewportCamera.z=Math.min(this._viewportCamera.z*1.25,5):this._viewportCamera.z=Math.max(this._viewportCamera.z*.75,.1),this._viewportCamera.x=(this._viewportCamera.x-this._mouse.x)/(n/this._viewportCamera.z)+this._mouse.x,this._viewportCamera.y=(this._viewportCamera.y-this._mouse.y)/(n/this._viewportCamera.z)+this._mouse.y},__findNodeAtPos:function(e,t,n){if(this._parent){var r=this;function i(n){for(var i=n.length-1;i>=0;--i)if(n[i]._meta.bounds&&r.__inRect(e,n[i]._meta.bounds.farRect,t))return n[i];return null}return n===undefined?i(this._parent._storageNodes)||i(this._parent._compositeNodes)||i(this._parent._processNodes)||i(this._parent._entryNodes):i(n)}return null},__findCategoryAreaAtPos:function(e){for(var t in this._nodeLibrary)for(var n in this._nodeLibrary[t]){if(!this.$typeButton[this.__typeIndex(n)].hasClass("wcToggled"))continue;var r=this._nodeLibrary[t][n];if(r.$button.hasClass("wcToggled"))continue;var i=r.$canvas.offset();i.width=r.$canvas.width(),i.height=r.$canvas.height();if(this.__inRect(e,i))return r}}}